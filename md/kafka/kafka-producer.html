<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>kafka producer | bytejava Java进阶手册</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/favicon.ico">
    <script charset="utf-8" async="async" src="/js/jquery.min.js"></script>
    <script charset="utf-8" async="async" src="/js/global.js"></script>
    <script charset="utf-8" async="async" src="/js/fingerprint2.min.js"></script>
    <script charset="utf-8" async="async" src="https://s9.cnzz.com/z_stat.php?id=12782949&amp;web_id=1272949"></script>
    <script>
              var _hmt = _hmt || [];
              (function() {
                var hm = document.createElement("script");
                hm.src = "https://hm.baidu.com/hm.js?fa0fbf0fef3bba94118b912a64766cee";
                var s = document.getElementsByTagName("script")[0];
                s.parentNode.insertBefore(hm, s);
              })();
            </script>
    <meta name="description" content="包含: Java 基础，高并发缓存，JVM，中间件，字节码编程...">
    <meta property="og:title" content="kafka producer">
    <meta property="og:type" content="article">
    <meta property="og:url" content="/md/kafka/kafka-producer.html">
    <meta name="twitter:title" content="kafka producer">
    <meta name="twitter:url" content="/md/kafka/kafka-producer.html">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="robots" content="all">
    <meta name="author" content="bytejava">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="keywords" content="bytejava 高级Java，Java设计模式, 字节码编程, 中间件, Spring, Java基础, 面经手册">
    <meta name="apple-mobile-web-app-capable" content="yes">
    
    <link rel="preload" href="/assets/css/0.styles.8fb5e8ac.css" as="style"><link rel="preload" href="/assets/css/styles.css?v=1729221831211" as="style"><link rel="preload" href="/assets/js/cg-styles.js?v=1729221831211" as="script"><link rel="preload" href="/assets/js/cg-app.js?v=1729221831211" as="script"><link rel="preload" href="/assets/js/cg-4.js?v=1729221831211" as="script"><link rel="preload" href="/assets/js/cg-3.js?v=1729221831211" as="script"><link rel="preload" href="/assets/js/cg-259.js?v=1729221831211" as="script">
    <link rel="stylesheet" href="/assets/css/0.styles.8fb5e8ac.css"><link rel="stylesheet" href="/assets/css/styles.css?v=1729221831211">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">bytejava Java进阶手册</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java" class="dropdown-title"><span class="title">Java</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/java/basic/java线程池.html" class="nav-link">
  Java基础
</a></li><li class="dropdown-item"><!----> <a href="/md/java/compiler/javac.html" class="nav-link">
  Java编译器
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="JVM" class="dropdown-title"><span class="title">JVM</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/jvm/bytecode/class字节码文件格式.html" class="nav-link">
  字节码
</a></li><li class="dropdown-item"><!----> <a href="/md/jvm/jvm/javaagent.html" class="nav-link">
  jvm
</a></li><li class="dropdown-item"><!----> <a href="/md/jvm/jvmti/jvmti介绍和开发.html" class="nav-link">
  jvmti
</a></li><li class="dropdown-item"><!----> <a href="/md/jvm/gc/g1/g1-all-intro.html" class="nav-link">
  G1 GC
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="缓存" class="dropdown-title"><span class="title">缓存</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/cache/redis/redis.html" class="nav-link">
  零基础到高并发应用专家，深入理解redis
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Spring" class="dropdown-title"><span class="title">Spring</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/spring/springboot启动请求处理过程.html" class="nav-link">
  Spring实现
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Kafka" class="dropdown-title"><span class="title">Kafka</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/kafka/kafka.html" class="nav-link">
  kafka
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="MyBatis" class="dropdown-title"><span class="title">MyBatis</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/mybatis/mybatis-use-general.html" class="nav-link">
  MyBatis
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="业务开发" class="dropdown-title"><span class="title">业务开发</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/develop/" class="nav-link">
  业务开发
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="中间件" class="dropdown-title"><span class="title">中间件</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/distribute/raft.html" class="nav-link">
  raft
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="算法" class="dropdown-title"><span class="title">算法</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/algorithm/leetcode.html" class="nav-link">
  算法
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="软技能通用技能" class="dropdown-title"><span class="title">软技能通用技能</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/soft/晋升答辩.html" class="nav-link">
  晋升答辩
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="专栏" class="dropdown-title"><span class="title">专栏</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/column/column.html" class="nav-link">
  订阅我的专栏
</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/liuzhengyang" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java" class="dropdown-title"><span class="title">Java</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/java/basic/java线程池.html" class="nav-link">
  Java基础
</a></li><li class="dropdown-item"><!----> <a href="/md/java/compiler/javac.html" class="nav-link">
  Java编译器
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="JVM" class="dropdown-title"><span class="title">JVM</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/jvm/bytecode/class字节码文件格式.html" class="nav-link">
  字节码
</a></li><li class="dropdown-item"><!----> <a href="/md/jvm/jvm/javaagent.html" class="nav-link">
  jvm
</a></li><li class="dropdown-item"><!----> <a href="/md/jvm/jvmti/jvmti介绍和开发.html" class="nav-link">
  jvmti
</a></li><li class="dropdown-item"><!----> <a href="/md/jvm/gc/g1/g1-all-intro.html" class="nav-link">
  G1 GC
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="缓存" class="dropdown-title"><span class="title">缓存</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/cache/redis/redis.html" class="nav-link">
  零基础到高并发应用专家，深入理解redis
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Spring" class="dropdown-title"><span class="title">Spring</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/spring/springboot启动请求处理过程.html" class="nav-link">
  Spring实现
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Kafka" class="dropdown-title"><span class="title">Kafka</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/kafka/kafka.html" class="nav-link">
  kafka
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="MyBatis" class="dropdown-title"><span class="title">MyBatis</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/mybatis/mybatis-use-general.html" class="nav-link">
  MyBatis
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="业务开发" class="dropdown-title"><span class="title">业务开发</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/develop/" class="nav-link">
  业务开发
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="中间件" class="dropdown-title"><span class="title">中间件</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/distribute/raft.html" class="nav-link">
  raft
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="算法" class="dropdown-title"><span class="title">算法</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/algorithm/leetcode.html" class="nav-link">
  算法
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="软技能通用技能" class="dropdown-title"><span class="title">软技能通用技能</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/soft/晋升答辩.html" class="nav-link">
  晋升答辩
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="专栏" class="dropdown-title"><span class="title">专栏</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/column/column.html" class="nav-link">
  订阅我的专栏
</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/liuzhengyang" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>kafka源码分析</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/md/kafka/kafka.html" class="sidebar-link">kafka</a></li><li><a href="/md/kafka/kafka-setup.html" class="sidebar-link">kafka学习环境搭建</a></li><li><a href="/md/kafka/kafka-producer.html" aria-current="page" class="active sidebar-link">kafka producer</a></li><li><a href="/md/kafka/kafka-consumer.html" class="sidebar-link">kafka consumer</a></li><li><a href="/md/kafka/kafka-rebalance.html" class="sidebar-link">kafka rebalance</a></li><li><a href="/md/kafka/kafka-replication.html" class="sidebar-link">kafka replication</a></li><li><a href="/md/kafka/kafka-consumer-offset.html" class="sidebar-link">consumer offset</a></li><li><a href="/md/kafka/kafka-raft.html" class="sidebar-link">kafka raft</a></li></ul></section></li></ul> </aside> <div><main class="page"> <div class="theme-default-content content__default"><h1 id="kafka-producer"><a href="#kafka-producer" class="header-anchor">#</a> kafka producer</h1> <p>通过本文将了解</p> <ol><li>Producer发送消息的处理过程</li> <li>RecordAccumulator如何实现消息批量合并</li> <li>内存池BufferPool如何申请、复用、回收内存</li></ol> <p>KafkaProducer内部维护一系列buffer来保存未发送的数据，通过后台io线程来发送给server。
send方法是异步的，把Record添加到buffer后就返回一个Future。</p> <h2 id="kafkaproducer-send发送流程"><a href="#kafkaproducer-send发送流程" class="header-anchor">#</a> KafkaProducer.send发送流程</h2> <p>KafkaProducer.send方法是生产者发送消息的接口，传入的参数是ProducerRecord，另外一个overload的方法中可以传入Callback用于server确认消息后的回调函数。</p> <p>send方法首先会用interceptors拦截器对record进行处理，interceptors是拦截器的列表，类似spring里的http interceptor，可以实现一些自定义的数据发送切面功能，比如打点统计、tracing等等。
拦截器处理完成后，调用doSend发送。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RecordMetadata</span><span class="token punctuation">&gt;</span></span> <span class="token function">send</span><span class="token punctuation">(</span><span class="token class-name">ProducerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">record</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">send</span><span class="token punctuation">(</span><span class="token keyword">record</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RecordMetadata</span><span class="token punctuation">&gt;</span></span> <span class="token function">send</span><span class="token punctuation">(</span><span class="token class-name">ProducerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">record</span><span class="token punctuation">,</span> <span class="token class-name">Callback</span> callback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// intercept the record, which can be potentially modified; this method does not throw exceptions</span>
    <span class="token class-name">ProducerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> interceptedRecord <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>interceptors<span class="token punctuation">.</span><span class="token function">onSend</span><span class="token punctuation">(</span><span class="token keyword">record</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">doSend</span><span class="token punctuation">(</span>interceptedRecord<span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>Producer中包含的是发送的消息的topic、key、value等信息，record可以指定partition，如果没有指定会通过Partitioner来确定最终发送到的partition。
headers类似http中的header，可以传输一些额外的信息，比如tracing框架在kafka中的上下文信息传输就是使用的header字段，key字段是一个可选字段。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ProducerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> topic<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Integer</span> partition<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Headers</span> headers<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">K</span> key<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">V</span> value<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Long</span> timestamp<span class="token punctuation">;</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>doSend方法是发送消息的核心流程</p> <p>主要步骤如下</p> <ul><li>检查producer是否关闭</li> <li>通过topic获取cluster的metadata元信息，topic第一次发送时，会等待一次网络请求获取metadata，之后NetworkClient会定期刷新metadata。</li> <li>对key、value进行序列化，得到byte数组</li> <li>计算要发送的partition</li> <li>计算消息的byte大小、验证大小不超过限制</li> <li>调用accumulator.append将消息加入到RecordAccumulator中，参数abortOnNewBatch为true</li> <li>如果append返回了abortForNewBatch，重新调用append，参数abortOnNewBatch为false</li> <li>如果append结果中返回了batchIsFull或newBatchCreated，调用sender.wakeup唤醒sender发送消息buffer</li> <li>返回future</li></ul> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RecordMetadata</span><span class="token punctuation">&gt;</span></span> <span class="token function">doSend</span><span class="token punctuation">(</span><span class="token class-name">ProducerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">record</span><span class="token punctuation">,</span> <span class="token class-name">Callback</span> callback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">TopicPartition</span> tp <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// 检查producer是否关闭</span>
        <span class="token function">throwIfProducerClosed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// first make sure the metadata for the topic is available</span>
        <span class="token comment">// 获取当前时间，为了实现超时功能</span>
        <span class="token keyword">long</span> nowMs <span class="token operator">=</span> time<span class="token punctuation">.</span><span class="token function">milliseconds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ClusterAndWaitTime</span> clusterAndWaitTime<span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// 获取ClusterAndWaitTime，每个topic第一次调用时会等待一次metadata网络请求返回，之后NetworkClient会自动刷新</span>
            clusterAndWaitTime <span class="token operator">=</span> <span class="token function">waitOnMetadata</span><span class="token punctuation">(</span><span class="token keyword">record</span><span class="token punctuation">.</span><span class="token function">topic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">record</span><span class="token punctuation">.</span><span class="token function">partition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> nowMs<span class="token punctuation">,</span> maxBlockTimeMs<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">KafkaException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>metadata<span class="token punctuation">.</span><span class="token function">isClosed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">KafkaException</span><span class="token punctuation">(</span><span class="token string">&quot;Producer closed while send in progress&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 更新下record时间戳</span>
        nowMs <span class="token operator">+=</span> clusterAndWaitTime<span class="token punctuation">.</span>waitedOnMetadataMs<span class="token punctuation">;</span>
        <span class="token comment">// send方法剩余要等待的时间，作为append方法的maxTimeToBlock参数</span>
        <span class="token keyword">long</span> remainingWaitMs <span class="token operator">=</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> maxBlockTimeMs <span class="token operator">-</span> clusterAndWaitTime<span class="token punctuation">.</span>waitedOnMetadataMs<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 从ClusterAndWaitTime对象中获取cluster，包含了PartitionInfo的信息，用于稍后计算要发送的partition</span>
        <span class="token class-name">Cluster</span> cluster <span class="token operator">=</span> clusterAndWaitTime<span class="token punctuation">.</span>cluster<span class="token punctuation">;</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> serializedKey<span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// 对key序列化得到byte数组</span>
            serializedKey <span class="token operator">=</span> keySerializer<span class="token punctuation">.</span><span class="token function">serialize</span><span class="token punctuation">(</span><span class="token keyword">record</span><span class="token punctuation">.</span><span class="token function">topic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">record</span><span class="token punctuation">.</span><span class="token function">headers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">record</span><span class="token punctuation">.</span><span class="token function">key</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ClassCastException</span> cce<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">SerializationException</span><span class="token punctuation">(</span><span class="token string">&quot;Can't convert key of class &quot;</span> <span class="token operator">+</span> <span class="token keyword">record</span><span class="token punctuation">.</span><span class="token function">key</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span>
                    <span class="token string">&quot; to class &quot;</span> <span class="token operator">+</span> producerConfig<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span>KEY_SERIALIZER_CLASS_CONFIG<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span>
                    <span class="token string">&quot; specified in key.serializer&quot;</span><span class="token punctuation">,</span> cce<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> serializedValue<span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// 对value序列化得到byte数组</span>
            serializedValue <span class="token operator">=</span> valueSerializer<span class="token punctuation">.</span><span class="token function">serialize</span><span class="token punctuation">(</span><span class="token keyword">record</span><span class="token punctuation">.</span><span class="token function">topic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">record</span><span class="token punctuation">.</span><span class="token function">headers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">record</span><span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ClassCastException</span> cce<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">SerializationException</span><span class="token punctuation">(</span><span class="token string">&quot;Can't convert value of class &quot;</span> <span class="token operator">+</span> <span class="token keyword">record</span><span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span>
                    <span class="token string">&quot; to class &quot;</span> <span class="token operator">+</span> producerConfig<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span>VALUE_SERIALIZER_CLASS_CONFIG<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span>
                    <span class="token string">&quot; specified in value.serializer&quot;</span><span class="token punctuation">,</span> cce<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 计算partition</span>
        <span class="token keyword">int</span> partition <span class="token operator">=</span> <span class="token function">partition</span><span class="token punctuation">(</span><span class="token keyword">record</span><span class="token punctuation">,</span> serializedKey<span class="token punctuation">,</span> serializedValue<span class="token punctuation">,</span> cluster<span class="token punctuation">)</span><span class="token punctuation">;</span>
        tp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TopicPartition</span><span class="token punctuation">(</span><span class="token keyword">record</span><span class="token punctuation">.</span><span class="token function">topic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> partition<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">setReadOnly</span><span class="token punctuation">(</span><span class="token keyword">record</span><span class="token punctuation">.</span><span class="token function">headers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Header</span><span class="token punctuation">[</span><span class="token punctuation">]</span> headers <span class="token operator">=</span> <span class="token keyword">record</span><span class="token punctuation">.</span><span class="token function">headers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 把key、value、header等加起来，并且按照压缩算法估算占用的空间大小</span>
        <span class="token keyword">int</span> serializedSize <span class="token operator">=</span> <span class="token class-name">AbstractRecords</span><span class="token punctuation">.</span><span class="token function">estimateSizeInBytesUpperBound</span><span class="token punctuation">(</span>apiVersions<span class="token punctuation">.</span><span class="token function">maxUsableProduceMagic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                compressionType<span class="token punctuation">,</span> serializedKey<span class="token punctuation">,</span> serializedValue<span class="token punctuation">,</span> headers<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 确保</span>
        <span class="token function">ensureValidRecordSize</span><span class="token punctuation">(</span>serializedSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> timestamp <span class="token operator">=</span> <span class="token keyword">record</span><span class="token punctuation">.</span><span class="token function">timestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> nowMs <span class="token operator">:</span> <span class="token keyword">record</span><span class="token punctuation">.</span><span class="token function">timestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 发送完成后的Callback回调</span>
        <span class="token class-name">Callback</span> interceptCallback <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InterceptorCallback</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>callback<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>interceptors<span class="token punctuation">,</span> tp<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 调用RecordAccumulator的append方法，abortOnNewBatch为true，如果append的时候创建了新的batch，返回的result中的abortOnNewBatch会为true</span>
        <span class="token comment">// abortOnNewBatch用于sticky partition策略中每次batch满了之后更换一个partition</span>
        <span class="token class-name">RecordAccumulator<span class="token punctuation">.</span>RecordAppendResult</span> result <span class="token operator">=</span> accumulator<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>tp<span class="token punctuation">,</span> timestamp<span class="token punctuation">,</span> serializedKey<span class="token punctuation">,</span>
                serializedValue<span class="token punctuation">,</span> headers<span class="token punctuation">,</span> interceptCallback<span class="token punctuation">,</span> remainingWaitMs<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> nowMs<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 如果结果返回abortOnNewBatch为true，需要调用partition.onNewBatch为sticky partition回调。</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span>abortForNewBatch<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> prevPartition <span class="token operator">=</span> partition<span class="token punctuation">;</span>
            <span class="token comment">// 回调onNewBatch</span>
            partitioner<span class="token punctuation">.</span><span class="token function">onNewBatch</span><span class="token punctuation">(</span><span class="token keyword">record</span><span class="token punctuation">.</span><span class="token function">topic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> cluster<span class="token punctuation">,</span> prevPartition<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 重新计算partition</span>
            partition <span class="token operator">=</span> <span class="token function">partition</span><span class="token punctuation">(</span><span class="token keyword">record</span><span class="token punctuation">,</span> serializedKey<span class="token punctuation">,</span> serializedValue<span class="token punctuation">,</span> cluster<span class="token punctuation">)</span><span class="token punctuation">;</span>
            tp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TopicPartition</span><span class="token punctuation">(</span><span class="token keyword">record</span><span class="token punctuation">.</span><span class="token function">topic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> partition<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// producer callback will make sure to call both 'callback' and interceptor callback</span>
            interceptCallback <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InterceptorCallback</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>callback<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>interceptors<span class="token punctuation">,</span> tp<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 重新调用append发送，这次abortOnNewBatch为false</span>
            result <span class="token operator">=</span> accumulator<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>tp<span class="token punctuation">,</span> timestamp<span class="token punctuation">,</span> serializedKey<span class="token punctuation">,</span>
                serializedValue<span class="token punctuation">,</span> headers<span class="token punctuation">,</span> interceptCallback<span class="token punctuation">,</span> remainingWaitMs<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> nowMs<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 如果有事务，调用</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>transactionManager <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            transactionManager<span class="token punctuation">.</span><span class="token function">maybeAddPartition</span><span class="token punctuation">(</span>tp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span>batchIsFull <span class="token operator">||</span> result<span class="token punctuation">.</span>newBatchCreated<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">&quot;Waking up the sender since topic {} partition {} is either full or getting a new batch&quot;</span><span class="token punctuation">,</span> <span class="token keyword">record</span><span class="token punctuation">.</span><span class="token function">topic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> partition<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>sender<span class="token punctuation">.</span><span class="token function">wakeup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> result<span class="token punctuation">.</span>future<span class="token punctuation">;</span>
        <span class="token comment">// handling exceptions and record the errors;</span>
        <span class="token comment">// for API exceptions return them in the future,</span>
        <span class="token comment">// for other exceptions throw directly</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ApiException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br></div></div><p>RecordAccumulator是kafka为了提升性能做的批量优化，在默认的异步模式下，调用producer send会将要发送的消息加入到本地的内存buffer中，内存buffer会在满了或等待一段时间后通过网络发送给kafka server，
可以类比成客车，客车如果满了或者到了发车时间都会发车。</p> <h2 id="recordaccumulator"><a href="#recordaccumulator" class="header-anchor">#</a> RecordAccumulator</h2> <p><img alt="img.png" data-src="/assets/images/kafka/kafka-accumulator.png" loading="lazy" class="lazy"></p> <p>接下来查看RecordAccumulator的append方法。</p> <p>accumulator的内部结构</p> <p>看一下RecordAccumulator的几个关键属性</p> <ul><li><code>int batchSize</code>: RecordAccumulator为每个ProducerBatch从BufferPool中申请的最小的内存大小。通过Producer配置中的<code>batch.size</code>属性配置，默认16384;</li> <li><code>BufferPool free</code>: 内存池，用于复用内存，减少GC压力。可以从BufferPool中申请byte数组来存放要发送的消息</li> <li><code>ConcurrentMap&lt;TopicPartition, Deque&lt;ProducerBatch&gt;&gt; batches</code>: topic partition到ProducerBatch队列的map映射</li> <li><code>int lingerMs</code>: 判断一个batch是否要发送，ProducerBatch最大等待lingerMs后就会发送不再等待buffer。默认为0。</li></ul> <p>Accumulator中保存了TopicPartition到ProducerBatch队列的Map映射，在append时，会从Map中获取要加入的TopicPartition的ProducerBatch队列。
如果队列中有ProducerBatch，说明有可以复用的ProducerBatch，则会尝试append到其中，如果成功返回，如果没有可用的ProducerBatch或满了，则需要创建一个新的ProducerBatch，
会通过RecordAppendResult中的字段告知KafkaProducer, KafkaProducer会给Partitioner回调onNewBatch后计算新的partition再重新调用RecordAccumulator的append方法，
重新调用后，依然会重新判断ProducerBatch队列是否可用，不可用会对队列加锁，加锁完成后double check再尝试append，因为在加锁之前可能有其他线程向队列中加入了ProducerBatch。
在确认没有可用的ProducerBatch后，会向BufferPool申请一块内存（内存大小是batchSize和消息大小的最大值），申请完成后创建ProducerBatch对象，然后将消息append到ProducerBatch中，
再把ProducerBatch对象加入到TopicPartition对应的ProducerBatch队列中。
方法最后有收尾工作，比如如果申请好的内存没有使用到（有其他线程在加锁前也创建好了可用的ProducerBatch的情况等），则会调用BufferPool的deallocate方法回收内存。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">RecordAppendResult</span> <span class="token function">append</span><span class="token punctuation">(</span><span class="token class-name">TopicPartition</span> tp<span class="token punctuation">,</span>
                                 <span class="token keyword">long</span> timestamp<span class="token punctuation">,</span>
                                 <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> key<span class="token punctuation">,</span>
                                 <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> value<span class="token punctuation">,</span>
                                 <span class="token class-name">Header</span><span class="token punctuation">[</span><span class="token punctuation">]</span> headers<span class="token punctuation">,</span>
                                 <span class="token class-name">Callback</span> callback<span class="token punctuation">,</span>
                                 <span class="token keyword">long</span> maxTimeToBlock<span class="token punctuation">,</span>
                                 <span class="token keyword">boolean</span> abortOnNewBatch<span class="token punctuation">,</span>
                                 <span class="token keyword">long</span> nowMs<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    <span class="token comment">// appendsInProgress计数加一</span>
    appendsInProgress<span class="token punctuation">.</span><span class="token function">incrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ByteBuffer</span> buffer <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>headers <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> headers <span class="token operator">=</span> <span class="token class-name">Record</span><span class="token punctuation">.</span>EMPTY_HEADERS<span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// 从batches Map中获取当前TopicPartition对应的ProducerBatch队列，如果有正在等待的ProducerBatch，比如在等待linger.ms的，则会尝试使用队尾的ProducerBatch，否则创建新的ProducerBatch并加入到队列中</span>
        <span class="token class-name">Deque</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ProducerBatch</span><span class="token punctuation">&gt;</span></span> dq <span class="token operator">=</span> <span class="token function">getOrCreateDeque</span><span class="token punctuation">(</span>tp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>dq<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>closed<span class="token punctuation">)</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">KafkaException</span><span class="token punctuation">(</span><span class="token string">&quot;Producer closed while send in progress&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 调用tryAppend尝试把消息数据写入到队列中，如果当前队列中有可以复用的ProducerBatch，且ProducerBatch中的内存空间足够放心新的消息，则会写入到已有的ProducerBatch中。</span>
            <span class="token comment">// 如果没有可复用的ProducerBatch，或者ProducerBatch没有可用的空间，返回null</span>
            <span class="token class-name">RecordAppendResult</span> appendResult <span class="token operator">=</span> <span class="token function">tryAppend</span><span class="token punctuation">(</span>timestamp<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> headers<span class="token punctuation">,</span> callback<span class="token punctuation">,</span> dq<span class="token punctuation">,</span> nowMs<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>appendResult <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> appendResult<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// send方法中第一次调用时abortOnNewBatch参数为true，如果没有可以复用的ProducerBatch，则需要创建一个新的batch，实现方式是返回一个特定的RecordAppendResult，在KafkaProducer中</span>
        <span class="token comment">// 调用完partitioner的onNewBatch方法后，重新选择partition，再调用append方法，再次调用时abortOnNewBatch会是false</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>abortOnNewBatch<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// Return a result that will cause another call to append.</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RecordAppendResult</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">byte</span> maxUsableMagic <span class="token operator">=</span> apiVersions<span class="token punctuation">.</span><span class="token function">maxUsableProduceMagic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 计算要申请的内存大小，是batchSize和消息体的最大值，如果消息体比batchSize小，则能够服用到BufferPool里的池化内存，池化内存维护的是batchSize大小的内存的列表。</span>
        <span class="token keyword">int</span> size <span class="token operator">=</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>batchSize<span class="token punctuation">,</span> <span class="token class-name">AbstractRecords</span><span class="token punctuation">.</span><span class="token function">estimateSizeInBytesUpperBound</span><span class="token punctuation">(</span>maxUsableMagic<span class="token punctuation">,</span> compression<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> headers<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">&quot;Allocating a new {} byte message buffer for topic {} partition {} with remaining timeout {}ms&quot;</span><span class="token punctuation">,</span> size<span class="token punctuation">,</span> tp<span class="token punctuation">.</span><span class="token function">topic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> tp<span class="token punctuation">.</span><span class="token function">partition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> maxTimeToBlock<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 调用BufferPool的allocate方法申请内存，如果没有可用内存会等待maxTimeToBlock</span>
        buffer <span class="token operator">=</span> free<span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span>size<span class="token punctuation">,</span> maxTimeToBlock<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 更新下时间戳</span>
        nowMs <span class="token operator">=</span> time<span class="token punctuation">.</span><span class="token function">milliseconds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 对ProducerBatch队列对象加锁</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>dq<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// Need to check if producer is closed again after grabbing the dequeue lock.</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>closed<span class="token punctuation">)</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">KafkaException</span><span class="token punctuation">(</span><span class="token string">&quot;Producer closed while send in progress&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 在加锁前可能有其他线程向队列中加入了ProducerBatch，在加锁后再次调用tryAppend</span>
            <span class="token class-name">RecordAppendResult</span> appendResult <span class="token operator">=</span> <span class="token function">tryAppend</span><span class="token punctuation">(</span>timestamp<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> headers<span class="token punctuation">,</span> callback<span class="token punctuation">,</span> dq<span class="token punctuation">,</span> nowMs<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 如果append成功，说明队列中有可能的ProducerBatch</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>appendResult <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// Somebody else found us a batch, return the one we waited for! Hopefully this doesn't happen often...</span>
                <span class="token keyword">return</span> appendResult<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            
            <span class="token comment">// append不成功，则说明没有其他线程创建ProducerBatch或者ProducerBatch不可用。</span>
            <span class="token comment">// 创建一个MemoryRecordsBuilder对象，创建好的buffer内存作为recordsBuilder方法的参数</span>
            <span class="token class-name">MemoryRecordsBuilder</span> recordsBuilder <span class="token operator">=</span> <span class="token function">recordsBuilder</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> maxUsableMagic<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 创建ProducerBatch对象，构造函数传入recordsBuilder</span>
            <span class="token class-name">ProducerBatch</span> batch <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ProducerBatch</span><span class="token punctuation">(</span>tp<span class="token punctuation">,</span> recordsBuilder<span class="token punctuation">,</span> nowMs<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 调用ProducerBatch的tryAppend方法，将消息加入到ProducerBatch中，获取返回的Future</span>
            <span class="token class-name">FutureRecordMetadata</span> future <span class="token operator">=</span> <span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">requireNonNull</span><span class="token punctuation">(</span>batch<span class="token punctuation">.</span><span class="token function">tryAppend</span><span class="token punctuation">(</span>timestamp<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> headers<span class="token punctuation">,</span>
                    callback<span class="token punctuation">,</span> nowMs<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 将ProducerBatch加入到deque队列中</span>
            dq<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span>batch<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 同时将ProducerBatch加入到incomplete集合中</span>
            incomplete<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>batch<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 修改局部变量buffer引用为null，在finally用会对申请了buffer但是没有使用的情况进行内存回收，执行到这里说明buffer已经传入给了ProducerBatch，不需要回收</span>
            buffer <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token comment">// 返回成功的RecordAppendResult, </span>
            <span class="token comment">// 第一个参数是future，会在kafka发送完成后设置结果</span>
            <span class="token comment">// 第二个参数是batchIsFull，表示batch是否已经满了需要发送，在TopicPartition对应的队列长度大于1(说明队列中第一个ProducerBatch已经满了)或者当前的ProducerBatch满了isFull的情况下设置为true</span>
            <span class="token comment">// 第三个参数是newBatchCreated，表示是否新创建了batch</span>
            <span class="token comment">// 第四个参数是abortForNewBatch，返回false</span>
            <span class="token comment">// 在bufferIsFull或newBatchCreated为true的情况下，KafkaProducer会唤醒sender，触发检查任务发送队列中的ProducerBatch</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RecordAppendResult</span><span class="token punctuation">(</span>future<span class="token punctuation">,</span> dq<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">1</span> <span class="token operator">||</span> batch<span class="token punctuation">.</span><span class="token function">isFull</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        <span class="token comment">// 如果buffer不为null，说明buffer申请了没有使用，调用free.deallocate回收内存</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>buffer <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            free<span class="token punctuation">.</span><span class="token function">deallocate</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// appendsInProgress计数减一</span>
        appendsInProgress<span class="token punctuation">.</span><span class="token function">decrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br></div></div><h3 id="内存池bufferpool"><a href="#内存池bufferpool" class="header-anchor">#</a> 内存池BufferPool</h3> <p><img alt="img.png" data-src="/assets/images/kafka/buffer-pool.png" loading="lazy" class="lazy"></p> <ul><li><code>long totalMemory</code>: 整个BufferPool的内存大小，通过buffer.memory参数控制。总内存大小包含了池化内存队列大小总和以及非池化部分的大小总和。</li> <li><code>pollableSize</code>: 池化的内存空闲列表的每个内存的大小，通过batch.size参数控制</li> <li><code>Deque&lt;ByteBuffer&gt; free</code>: 存放空闲内存列表</li> <li><code>ReentrantLock lock</code>: 锁，保证线程安全</li> <li><code>Deque&lt;Condition&gt; waiters</code>: 内存不足时，等待可用内存</li> <li><code>nonPooledAvailableMemory</code>: 非池化的内存空间中剩余可用内存大小，初始为totalMemory，每申请一个新的pollableSize，nonPooledAvailableMemory就减去一个pollableSize，回收时再加回来。</li></ul> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BufferPool</span> <span class="token punctuation">{</span>

    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> WAIT_TIME_SENSOR_NAME <span class="token operator">=</span> <span class="token string">&quot;bufferpool-wait-time&quot;</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">long</span> totalMemory<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> poolableSize<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ReentrantLock</span> lock<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Deque</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ByteBuffer</span><span class="token punctuation">&gt;</span></span> free<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Deque</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Condition</span><span class="token punctuation">&gt;</span></span> waiters<span class="token punctuation">;</span>
    <span class="token comment">/** Total available memory is the sum of nonPooledAvailableMemory and the number of byte buffers in free * poolableSize.  */</span>
    <span class="token keyword">private</span> <span class="token keyword">long</span> nonPooledAvailableMemory<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Metrics</span> metrics<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Time</span> time<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Sensor</span> waitTime<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> closed<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h4 id="bufferpool-allocate步骤"><a href="#bufferpool-allocate步骤" class="header-anchor">#</a> BufferPool allocate步骤</h4> <ul><li>加锁</li> <li>如果申请的大小是pollableSize，判断空闲列表是否有空闲buffer，如果有，返回</li> <li>如果不是pollableSize或者空闲列表没有buffer，则要判断下剩余的内存空间(空闲列表的总大小+nonPolledAvailableMemory)是否足够
<ul><li>如果足够，但是size大于nonPooledAvailableMemory，则从空闲列表释放buffer，把空间加到nonPooledAvailableMemory，然后给nonPooledAvailableMemory减去size</li> <li>如果不够，则创建Condition进行条件等待，只要当前已经申请的内存不够size，就一直等待，直到申请的空间达到size或者超时
<ul><li>每次await唤醒后，尝试从空闲列表、nonPooledAvailableMemory中累加获取内存，直到size大小的内存获取完成</li></ul></li></ul></li> <li>如果使用的空闲列表中的buffer，直接返回</li> <li>否则通过ByteBuffer.allocate创建size大小的ByteBuffer</li> <li>如果可能还有可以使用的内存空间，继续唤醒下一个等待的Condition</li> <li>释放锁</li></ul> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">ByteBuffer</span> <span class="token function">allocate</span><span class="token punctuation">(</span><span class="token keyword">int</span> size<span class="token punctuation">,</span> <span class="token keyword">long</span> maxTimeToBlockMs<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>size <span class="token operator">&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>totalMemory<span class="token punctuation">)</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;Attempt to allocate &quot;</span> <span class="token operator">+</span> size
                                           <span class="token operator">+</span> <span class="token string">&quot; bytes, but there is a hard limit of &quot;</span>
                                           <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>totalMemory
                                           <span class="token operator">+</span> <span class="token string">&quot; on memory allocations.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">ByteBuffer</span> buffer <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token comment">// 加锁</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>closed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">KafkaException</span><span class="token punctuation">(</span><span class="token string">&quot;Producer closed while allocating memory&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// 如果申请的内存大小等于pollableSize并且空闲列表中有内存，则从空闲列表中获取一个ByteBuffer</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>size <span class="token operator">==</span> poolableSize <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>free<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>free<span class="token punctuation">.</span><span class="token function">pollFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// now check if the request is immediately satisfiable with the</span>
        <span class="token comment">// memory on hand or if we need to block</span>
        <span class="token comment">// 计算下现在已经使用的内存的总量</span>
        <span class="token comment">// 计算空闲内存队列中内存大小</span>
        <span class="token keyword">int</span> freeListSize <span class="token operator">=</span> <span class="token function">freeSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token keyword">this</span><span class="token punctuation">.</span>poolableSize<span class="token punctuation">;</span>
        <span class="token comment">// nonPooledAvailableMemory + freeListSize &gt;= size，说明剩余的可用内存空间足够分配size大小的内存</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>nonPooledAvailableMemory <span class="token operator">+</span> freeListSize <span class="token operator">&gt;=</span> size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 如果nonPooledAvailableMemory小于size，则从free空闲列表中释放出足够的内存，加到nonPooledAvailableMemory中，使得能够分配</span>
            <span class="token function">freeUp</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 给nonPooledAvailableMemory减去size大小</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>nonPooledAvailableMemory <span class="token operator">-=</span> size<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// 空闲的内存不足以分配size大小的内存，需要block等待。accumulated是目前已经等待到分配的内存</span>
            <span class="token keyword">int</span> accumulated <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token comment">// 利用lock.newCondition创建一个新的Condition，关于条件队列、AQS等分析可以参考我的相关文章</span>
            <span class="token class-name">Condition</span> moreMemory <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">newCondition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token keyword">long</span> remainingTimeToBlockNs <span class="token operator">=</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">.</span><span class="token function">toNanos</span><span class="token punctuation">(</span>maxTimeToBlockMs<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 将condition加到waiters中</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>waiters<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span>moreMemory<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 条件等待，只有当前的可用内存不够分配size大小，就一直等待</span>
                <span class="token keyword">while</span> <span class="token punctuation">(</span>accumulated <span class="token operator">&lt;</span> size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">long</span> startWaitNs <span class="token operator">=</span> time<span class="token punctuation">.</span><span class="token function">nanoseconds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">long</span> timeNs<span class="token punctuation">;</span>
                    <span class="token keyword">boolean</span> waitingTimeElapsed<span class="token punctuation">;</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{</span>
                        <span class="token comment">// 等待的超时时间的remainingTimeToBlockNs</span>
                        waitingTimeElapsed <span class="token operator">=</span> <span class="token operator">!</span>moreMemory<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span>remainingTimeToBlockNs<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>NANOSECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                        <span class="token keyword">long</span> endWaitNs <span class="token operator">=</span> time<span class="token punctuation">.</span><span class="token function">nanoseconds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        timeNs <span class="token operator">=</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token number">0L</span><span class="token punctuation">,</span> endWaitNs <span class="token operator">-</span> startWaitNs<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token function">recordWaitTime</span><span class="token punctuation">(</span>timeNs<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>closed<span class="token punctuation">)</span>
                        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">KafkaException</span><span class="token punctuation">(</span><span class="token string">&quot;Producer closed while allocating memory&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token keyword">if</span> <span class="token punctuation">(</span>waitingTimeElapsed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">this</span><span class="token punctuation">.</span>metrics<span class="token punctuation">.</span><span class="token function">sensor</span><span class="token punctuation">(</span><span class="token string">&quot;buffer-exhausted-records&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">record</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BufferExhaustedException</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to allocate &quot;</span> <span class="token operator">+</span> size <span class="token operator">+</span> <span class="token string">&quot; bytes within the configured max blocking time &quot;</span>
                            <span class="token operator">+</span> maxTimeToBlockMs <span class="token operator">+</span> <span class="token string">&quot; ms. Total memory: &quot;</span> <span class="token operator">+</span> <span class="token function">totalMemory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; bytes. Available memory: &quot;</span> <span class="token operator">+</span> <span class="token function">availableMemory</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                            <span class="token operator">+</span> <span class="token string">&quot; bytes. Poolable size: &quot;</span> <span class="token operator">+</span> <span class="token function">poolableSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; bytes&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                    <span class="token comment">// 更新剩余等待时间</span>
                    remainingTimeToBlockNs <span class="token operator">-=</span> timeNs<span class="token punctuation">;</span>

                    <span class="token comment">// check if we can satisfy this request from the free list,</span>
                    <span class="token comment">// otherwise allocate memory</span>
                    <span class="token comment">// 如果accumulated是0，并且现在要申请的大小是poolableSize并且空闲队列不空了</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>accumulated <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> size <span class="token operator">==</span> <span class="token keyword">this</span><span class="token punctuation">.</span>poolableSize <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>free<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment">// 则从空闲队列中获取一个Buffer</span>
                        buffer <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>free<span class="token punctuation">.</span><span class="token function">pollFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment">// 修改accumulated值</span>
                        accumulated <span class="token operator">=</span> size<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        <span class="token comment">// 要么size大小不是pollableSize，要么空闲队列还是空的</span>
                        <span class="token comment">// 尝试从空闲队列中释放需要内存(size - accumulated)</span>
                        <span class="token comment">// we'll need to allocate memory, but we may only get</span>
                        <span class="token comment">// part of what we need on this iteration</span>
                        <span class="token function">freeUp</span><span class="token punctuation">(</span>size <span class="token operator">-</span> accumulated<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment">// 最多还需要size - accumulated大小的内存</span>
                        <span class="token keyword">int</span> got <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>size <span class="token operator">-</span> accumulated<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>nonPooledAvailableMemory<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment">// 给nonPooledAvailableMemory减去got，已经获取到的内存大小</span>
                        <span class="token keyword">this</span><span class="token punctuation">.</span>nonPooledAvailableMemory <span class="token operator">-=</span> got<span class="token punctuation">;</span>
                        <span class="token comment">// accumulated加上本次获取到的内存大小</span>
                        accumulated <span class="token operator">+=</span> got<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token comment">// 申请成功，设置accumulated为0</span>
                <span class="token comment">// Don't reclaim memory on throwable since nothing was thrown</span>
                accumulated <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                <span class="token comment">// 如果等待过程中超时，把已经获取到的部分加回到nonPooledAvailableMemory中。</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>nonPooledAvailableMemory <span class="token operator">+=</span> accumulated<span class="token punctuation">;</span>
                <span class="token comment">// waiter中删除ConditionObject</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>waiters<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>moreMemory<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        <span class="token comment">// 如果还有可能可以使用的内存空间，继续唤醒下一个等待的Condition，类似于AQS中acquireShared acquire成功后尝试唤醒下一个shared node。</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>nonPooledAvailableMemory <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>free<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>waiters<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>waiters<span class="token punctuation">.</span><span class="token function">peekFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">signal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token comment">// Another finally... otherwise find bugs complains</span>
            <span class="token comment">// 释放锁</span>
            lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// buffer == null，说明要申请新的内存</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>buffer <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token function">safeAllocateByteBuffer</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span>
        <span class="token comment">// buffer不为null说明从空闲列表中复用了内存</span>
        <span class="token keyword">return</span> buffer<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br></div></div><p>safeAllocateByteBuffer会调用ByteBuffer.allocate方法申请ByteBuffer，还会catch住申请的一层，如果有异常，归还大小给nonPolledAvailableMemory</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token class-name">ByteBuffer</span> <span class="token function">safeAllocateByteBuffer</span><span class="token punctuation">(</span><span class="token keyword">int</span> size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">boolean</span> error <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token class-name">ByteBuffer</span> buffer <span class="token operator">=</span> <span class="token function">allocateByteBuffer</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
        error <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> buffer<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>nonPooledAvailableMemory <span class="token operator">+=</span> size<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>waiters<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>waiters<span class="token punctuation">.</span><span class="token function">peekFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">signal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><h4 id="bufferpool-回收"><a href="#bufferpool-回收" class="header-anchor">#</a> BufferPool 回收</h4> <p>在Sender发送完ProducerBatch后, 会通过RecordAccumulator.deallocate释放内存</p> <p>Sender代码</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">completeBatch</span><span class="token punctuation">(</span><span class="token class-name">ProducerBatch</span> batch<span class="token punctuation">,</span> <span class="token class-name">ProduceResponse<span class="token punctuation">.</span>PartitionResponse</span> response<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>transactionManager <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        transactionManager<span class="token punctuation">.</span><span class="token function">handleCompletedBatch</span><span class="token punctuation">(</span>batch<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>batch<span class="token punctuation">.</span><span class="token function">complete</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>baseOffset<span class="token punctuation">,</span> response<span class="token punctuation">.</span>logAppendTime<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">maybeRemoveAndDeallocateBatch</span><span class="token punctuation">(</span>batch<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">maybeRemoveAndDeallocateBatch</span><span class="token punctuation">(</span><span class="token class-name">ProducerBatch</span> batch<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">maybeRemoveFromInflightBatches</span><span class="token punctuation">(</span>batch<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>accumulator<span class="token punctuation">.</span><span class="token function">deallocate</span><span class="token punctuation">(</span>batch<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>RecordAccumulator的deallocate代码</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">deallocate</span><span class="token punctuation">(</span><span class="token class-name">ProducerBatch</span> batch<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    incomplete<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>batch<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Only deallocate the batch if it is not a split batch because split batch are allocated outside the</span>
    <span class="token comment">// buffer pool.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>batch<span class="token punctuation">.</span><span class="token function">isSplitBatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        free<span class="token punctuation">.</span><span class="token function">deallocate</span><span class="token punctuation">(</span>batch<span class="token punctuation">.</span><span class="token function">buffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> batch<span class="token punctuation">.</span><span class="token function">initialCapacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>最终调用到BufferPool的deallocate方法。</p> <p>如果buffer的大小等于pollableSize，就把buffer加到free空闲列表中回收，否则把空间大小加到nonPooledAvailableMemory中buffer被GC。
然后从waiters等待的Condition中弹出一个ConditionObject,调用signal方法唤醒，让等待获取内存的线程唤醒继续获取内存大小。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">deallocate</span><span class="token punctuation">(</span><span class="token class-name">ByteBuffer</span> buffer<span class="token punctuation">,</span> <span class="token keyword">int</span> size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>size <span class="token operator">==</span> <span class="token keyword">this</span><span class="token punctuation">.</span>poolableSize <span class="token operator">&amp;&amp;</span> size <span class="token operator">==</span> buffer<span class="token punctuation">.</span><span class="token function">capacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            buffer<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>free<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>nonPooledAvailableMemory <span class="token operator">+=</span> size<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">Condition</span> moreMem <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>waiters<span class="token punctuation">.</span><span class="token function">peekFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>moreMem <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            moreMem<span class="token punctuation">.</span><span class="token function">signal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>关于kafka网络相关的内容，在其他文章中进行介绍</p> <h2 id="配置参数"><a href="#配置参数" class="header-anchor">#</a> 配置参数</h2> <p>acks: 0, 1, all</p> <p>min.insync.replicas: 默认1，在acks=all的情况下，min.insync.replicas能够控制有多少个in sync replica完成了这条消息的replica才能够返回成功，
可以提供更高的数据可靠性保证，但是会损失一定的可用性，因为当没有足够的isr时写入会失败，所以要进行权衡，默认是1，即如果isr只要有一个follower写入成功即可。</p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/liuzhengyang/liuzhengyang.github.io/edit/master/docs/md/kafka/kafka-producer.md" target="_blank" rel="noopener noreferrer">Edit this page</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/md/kafka/kafka-setup.html" class="prev">
          kafka学习环境搭建
        </a></span> <span class="next"><a href="/md/kafka/kafka-consumer.html">
          kafka consumer
        </a>
        →
      </span></p></div> </main></div> <aside class="page-sidebar"> <div class="page-side-toolbar"><div class="option-box-toc-fixed"><div class="toc-container-sidebar"><div class="pos-box"><div class="icon-arrow"></div> <div class="scroll-box" style="max-height:650px"><div style="font-weight:bold;text-align:center;">kafka producer</div> <hr> <div class="toc-box"><ul class="toc-sidebar-links"><li><a href="/md/kafka/kafka-producer.html#kafkaproducer-send发送流程" class="toc-sidebar-link">KafkaProducer.send发送流程</a><ul class="toc-sidebar-sub-headers"></ul></li><li><a href="/md/kafka/kafka-producer.html#recordaccumulator" class="toc-sidebar-link">RecordAccumulator</a><ul class="toc-sidebar-sub-headers"><li class="toc-sidebar-sub-header"><a href="/md/kafka/kafka-producer.html#内存池bufferpool" class="toc-sidebar-link">内存池BufferPool</a></li></ul></li><li><a href="/md/kafka/kafka-producer.html#配置参数" class="toc-sidebar-link">配置参数</a><ul class="toc-sidebar-sub-headers"></ul></li></ul></div></div></div></div></div> <div class="option-box-toc-over"><img src="/images/system/toc.png" class="nozoom"> <span class="show-txt">目录</span> <div class="toc-container"><div class="pos-box"><div class="icon-arrow"></div> <div class="scroll-box" style="max-height:550px"><div style="font-weight:bold;text-align:center;">kafka producer</div> <hr> <div class="toc-box"><ul class="toc-sidebar-links"><li><a href="/md/kafka/kafka-producer.html#kafkaproducer-send发送流程" class="toc-sidebar-link">KafkaProducer.send发送流程</a><ul class="toc-sidebar-sub-headers"></ul></li><li><a href="/md/kafka/kafka-producer.html#recordaccumulator" class="toc-sidebar-link">RecordAccumulator</a><ul class="toc-sidebar-sub-headers"><li class="toc-sidebar-sub-header"><a href="/md/kafka/kafka-producer.html#内存池bufferpool" class="toc-sidebar-link">内存池BufferPool</a></li></ul></li><li><a href="/md/kafka/kafka-producer.html#配置参数" class="toc-sidebar-link">配置参数</a><ul class="toc-sidebar-sub-headers"></ul></li></ul></div></div></div></div></div> <div class="option-box"><img src="/images/system/wechat.png" class="nozoom"> <span class="show-txt">手机看</span> <div class="toc-container"><div class="pos-box"><div class="icon-arrow"></div> <div class="scroll-box" style="text-align:center"><span style="font-size:0.9rem">微信扫一扫</span> <img height="180px" src="https://api.qrserver.com/v1/create-qr-code/?data=https://bytejava.cn/md/kafka/kafka-producer.html" style="margin:10px;">
                可以<b>手机看</b>或分享至<b>朋友圈</b></div></div></div></div> <div class="option-box"><img src="/images/personal/wechat-mp-logo.jpg" height="20" class="nozoom"> <span class="show-txt">公众号</span> <div class="toc-container"><div class="pos-box"><div class="icon-arrow"></div> <div class="scroll-box" style="text-align:center"><span style="font-size:0.9rem">关注公众号bytejava</span> <img src="/images/personal/wechat-mp.png" height="180" width></div></div></div></div> <div class="option-box"><img src="/images/system/toggle.png" width="30px" class="nozoom"> <span class="show-txt">左栏</span></div> <div class="option-box"><img src="/images/system/heart-1.png" width="25px" class="nozoom"> <span class="show-txt">赞赏我</span> <div class="toc-container"><div class="pos-box"><div class="icon-arrow"></div> <div class="scroll-box" style="text-align:center"><span style="font-size:0.8rem;font-weight:bold;">鼓励/支持/赞赏我</span> <img height="180px" src="/images/personal/encourage-head.jpg" style="margin:5px;"> <br>1. 不靠它生存但仍希望得到你的鼓励；
                <br>2. 时刻警醒自己保持技术人的初心，沉淀，分享，成长；
              </div></div></div></div> <div title="kafka学习环境搭建" class="option-box" style="padding-left:2px;text-align:center;"><a href="/md/kafka/kafka-setup.html"><img src="/images/system/pre2.png" width="30px" class="nozoom"> <span class="show-txt">上一篇</span></a></div> <div title="kafka consumer" class="option-box" style="padding-left:2px;text-align:center;"><a href="/md/kafka/kafka-consumer.html"><img src="/images/system/next2.png" width="30px" class="nozoom"> <span class="show-txt">下一篇</span></a></div></div>  <!----> </aside></div><div class="global-ui"></div></div>
    <script src="/assets/js/cg-styles.js?v=1729221831211" defer></script><script src="/assets/js/cg-4.js?v=1729221831211" defer></script><script src="/assets/js/cg-3.js?v=1729221831211" defer></script><script src="/assets/js/cg-259.js?v=1729221831211" defer></script><script src="/assets/js/cg-app.js?v=1729221831211" defer></script>
  </body>
</html>
