<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>性能分析利器: async-profiler | bytejava Java进阶手册</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/favicon.ico">
    <script charset="utf-8" async="async" src="/js/jquery.min.js"></script>
    <script charset="utf-8" async="async" src="/js/global.js"></script>
    <script charset="utf-8" async="async" src="/js/fingerprint2.min.js"></script>
    <script charset="utf-8" async="async" src="https://s9.cnzz.com/z_stat.php?id=12782949&amp;web_id=1272949"></script>
    <script>
              var _hmt = _hmt || [];
              (function() {
                var hm = document.createElement("script");
                hm.src = "https://hm.baidu.com/hm.js?fa0fbf0fef3bba94118b912a64766cee";
                var s = document.getElementsByTagName("script")[0];
                s.parentNode.insertBefore(hm, s);
              })();
            </script>
    <meta name="description" content="包含: Java 基础，高并发缓存，JVM，中间件，字节码编程...">
    <meta property="og:title" content="性能分析利器: async-profiler">
    <meta property="og:type" content="article">
    <meta property="og:url" content="/md/performance/async-profiler/async-profiler.html">
    <meta name="twitter:title" content="性能分析利器: async-profiler">
    <meta name="twitter:url" content="/md/performance/async-profiler/async-profiler.html">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="robots" content="all">
    <meta name="author" content="bytejava">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="keywords" content="bytejava 高级Java，Java设计模式, 字节码编程, 中间件, Spring, Java基础, 面经手册">
    <meta name="apple-mobile-web-app-capable" content="yes">
    
    <link rel="preload" href="/assets/css/0.styles.8fb5e8ac.css" as="style"><link rel="preload" href="/assets/css/styles.css?v=1729221831211" as="style"><link rel="preload" href="/assets/js/cg-styles.js?v=1729221831211" as="script"><link rel="preload" href="/assets/js/cg-app.js?v=1729221831211" as="script"><link rel="preload" href="/assets/js/cg-4.js?v=1729221831211" as="script"><link rel="preload" href="/assets/js/cg-3.js?v=1729221831211" as="script"><link rel="preload" href="/assets/js/cg-294.js?v=1729221831211" as="script">
    <link rel="stylesheet" href="/assets/css/0.styles.8fb5e8ac.css"><link rel="stylesheet" href="/assets/css/styles.css?v=1729221831211">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">bytejava Java进阶手册</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java" class="dropdown-title"><span class="title">Java</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/java/basic/java线程池.html" class="nav-link">
  Java基础
</a></li><li class="dropdown-item"><!----> <a href="/md/java/compiler/javac.html" class="nav-link">
  Java编译器
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="JVM" class="dropdown-title"><span class="title">JVM</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/jvm/bytecode/class字节码文件格式.html" class="nav-link">
  字节码
</a></li><li class="dropdown-item"><!----> <a href="/md/jvm/jvm/javaagent.html" class="nav-link">
  jvm
</a></li><li class="dropdown-item"><!----> <a href="/md/jvm/jvmti/jvmti介绍和开发.html" class="nav-link">
  jvmti
</a></li><li class="dropdown-item"><!----> <a href="/md/jvm/gc/g1/g1-all-intro.html" class="nav-link">
  G1 GC
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="缓存" class="dropdown-title"><span class="title">缓存</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/cache/redis/redis.html" class="nav-link">
  零基础到高并发应用专家，深入理解redis
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Spring" class="dropdown-title"><span class="title">Spring</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/spring/springboot启动请求处理过程.html" class="nav-link">
  Spring实现
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Kafka" class="dropdown-title"><span class="title">Kafka</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/kafka/kafka.html" class="nav-link">
  kafka
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="MyBatis" class="dropdown-title"><span class="title">MyBatis</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/mybatis/mybatis-use-general.html" class="nav-link">
  MyBatis
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="业务开发" class="dropdown-title"><span class="title">业务开发</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/develop/" class="nav-link">
  业务开发
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="中间件" class="dropdown-title"><span class="title">中间件</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/distribute/raft.html" class="nav-link">
  raft
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="算法" class="dropdown-title"><span class="title">算法</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/algorithm/leetcode.html" class="nav-link">
  算法
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="软技能通用技能" class="dropdown-title"><span class="title">软技能通用技能</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/soft/晋升答辩.html" class="nav-link">
  晋升答辩
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="专栏" class="dropdown-title"><span class="title">专栏</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/column/column.html" class="nav-link">
  订阅我的专栏
</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/liuzhengyang" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java" class="dropdown-title"><span class="title">Java</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/java/basic/java线程池.html" class="nav-link">
  Java基础
</a></li><li class="dropdown-item"><!----> <a href="/md/java/compiler/javac.html" class="nav-link">
  Java编译器
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="JVM" class="dropdown-title"><span class="title">JVM</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/jvm/bytecode/class字节码文件格式.html" class="nav-link">
  字节码
</a></li><li class="dropdown-item"><!----> <a href="/md/jvm/jvm/javaagent.html" class="nav-link">
  jvm
</a></li><li class="dropdown-item"><!----> <a href="/md/jvm/jvmti/jvmti介绍和开发.html" class="nav-link">
  jvmti
</a></li><li class="dropdown-item"><!----> <a href="/md/jvm/gc/g1/g1-all-intro.html" class="nav-link">
  G1 GC
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="缓存" class="dropdown-title"><span class="title">缓存</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/cache/redis/redis.html" class="nav-link">
  零基础到高并发应用专家，深入理解redis
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Spring" class="dropdown-title"><span class="title">Spring</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/spring/springboot启动请求处理过程.html" class="nav-link">
  Spring实现
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Kafka" class="dropdown-title"><span class="title">Kafka</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/kafka/kafka.html" class="nav-link">
  kafka
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="MyBatis" class="dropdown-title"><span class="title">MyBatis</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/mybatis/mybatis-use-general.html" class="nav-link">
  MyBatis
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="业务开发" class="dropdown-title"><span class="title">业务开发</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/develop/" class="nav-link">
  业务开发
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="中间件" class="dropdown-title"><span class="title">中间件</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/distribute/raft.html" class="nav-link">
  raft
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="算法" class="dropdown-title"><span class="title">算法</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/algorithm/leetcode.html" class="nav-link">
  算法
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="软技能通用技能" class="dropdown-title"><span class="title">软技能通用技能</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/soft/晋升答辩.html" class="nav-link">
  晋升答辩
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="专栏" class="dropdown-title"><span class="title">专栏</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/column/column.html" class="nav-link">
  订阅我的专栏
</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/liuzhengyang" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <!----> </aside> <div><main class="withouttoc page"> <div class="theme-default-content content__default"><h1 id="性能分析利器-async-profiler"><a href="#性能分析利器-async-profiler" class="header-anchor">#</a> 性能分析利器: async-profiler</h1> <h2 id="介绍"><a href="#介绍" class="header-anchor">#</a> 介绍</h2> <p>性能分析优化是高级工程师的必备能力，在需要提升服务性能、降低成本、排查定位服务性能问题时，工程师需要能够
及时的了解服务运行状态、了解性能瓶颈并进行优化。</p> <p>了解服务运行状态，最重要的是服务的内部运行状态观测，即我的程序在执行什么代码？哪些方法消耗CPU最多？哪些方法申请内存最多？</p> <p>在出现线上问题时，我想很多同学都了解通过java自带的一些命令和linux自带的命令比如top、jstat、jstack等来进行简单的问题定位，
但是有时使用这些工具仍然不能很好的发现问题，比如一些一些方法的执行分散在多个线程中，通过jstack并不能直观的统计出来，因为jstack只能
按照线程维度统计，而不是方法维度。</p> <p>这时，我们就需要一些其他的工具来帮助我们查看运行状态，async-profiler就是一个非常使用的工具，通过async-profiler，我们能够
绘制CPU火焰图、内存分配火焰图，直观的看出消耗CPU最多的函数。</p> <p>并且async-profiler不同于jstack的是解决了safepoint bias问题（简单来解释是jstack捕获的状态并不准确）。</p> <p>async-profiler能够追踪的事件有</p> <ul><li>CPU cycles即CPU运行</li> <li>perf count, 比如cache missed, branch missed, page faults, context switches</li> <li>Allocation内存申请</li> <li>lock加锁，包含monitor lock和ReentrantLock</li></ul> <h2 id="使用"><a href="#使用" class="header-anchor">#</a> 使用</h2> <h3 id="直接安装使用async-profiler"><a href="#直接安装使用async-profiler" class="header-anchor">#</a> 直接安装使用async-profiler</h3> <h4 id="安装"><a href="#安装" class="header-anchor">#</a> 安装</h4> <p>在<a href="https://github.com/async-profiler/async-profiler/releases" target="_blank" rel="noopener noreferrer">github release<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>中查找最新的安装包</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment">## 下载async-profiler包，对于其他系统可以参考</span>
<span class="token function">wget</span> https://github.com/async-profiler/async-profiler/releases/download/v3.0/async-profiler-3.0-linux-arm64.tar.gz
<span class="token comment">## 解压</span>
<span class="token function">tar</span> -zxvf async-profiler-3.0-linux-arm64.tar.gz
<span class="token builtin class-name">cd</span> async-profiler-3.0-linux-x64/bin
<span class="token comment"># 通过jps等方式找到目标pid</span>
./asprof list <span class="token variable">${pid}</span> 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>采集cpu信息</p> <p>如下命令，表示给进程id为123的Java进行进行60s的采样，输出结果到/tmp/profile.html文件中，完成之后，我们就可以打开/tmp/profile.html文件
查看火焰图信息。</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>./asprof -d <span class="token number">60</span> -f /tmp/profile.html <span class="token number">123</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="启动时开启async-profiler"><a href="#启动时开启async-profiler" class="header-anchor">#</a> 启动时开启async-profiler</h3> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>java -agentpath:/path/to/libasyncProfiler.so<span class="token operator">=</span>start,event<span class="token operator">=</span>cpu,timeout<span class="token operator">=</span>60s,file<span class="token operator">=</span>profile.html
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="通过arthas使用async-profiler"><a href="#通过arthas使用async-profiler" class="header-anchor">#</a> 通过arthas使用async-profiler</h3> <h3 id="使用asyncprofiler查看特定方法调用"><a href="#使用asyncprofiler查看特定方法调用" class="header-anchor">#</a> 使用asyncprofiler查看特定方法调用</h3> <p>比如通过asyncprofiler查看堆外内存的申请情况</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>./asprof -d <span class="token number">60</span> -e java.nio.Bits.reserveMemory <span class="token variable">${pid}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h2 id="通过火焰图查看代码问题"><a href="#通过火焰图查看代码问题" class="header-anchor">#</a> 通过火焰图查看代码问题</h2> <p>./asprof -d 60 -e cpu -f /tmp/profile.html ${pid}</p> <p>完成之后即可通过查看html文件，寻找横向比较宽的代码来确认cpu开销是否合理。</p> <h2 id="内存申请"><a href="#内存申请" class="header-anchor">#</a> 内存申请</h2> <p>如果有gc、内存相关问题，除了使用jmap -histo、dump内存之后mat分析，来可以通过asyncprofiler查看内存申请的代码。
只需要把event换成alloc即可。</p> <h2 id="async-profiler代码实现分析"><a href="#async-profiler代码实现分析" class="header-anchor">#</a> async-profiler代码实现分析</h2> <h3 id="启动脚本"><a href="#启动脚本" class="header-anchor">#</a> 启动脚本</h3> <p>async-profiler提供了一个shell脚本profiler.sh，提供了常用的命令支持。
profiler.sh核心的执行逻辑是通过java attach机制attach到目标jvm进程，加载async-profiler的jvmti实现libasyncProfiler.so(linux下)，
libasyncProfiler中实现了async-profiler的实行逻辑。</p> <p>jattach是async-profiler封装的attach工具</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token keyword">case</span> <span class="token variable">$ACTION</span> <span class="token keyword">in</span>
    start<span class="token operator">|</span>resume<span class="token punctuation">)</span>
        fdtransfer
        jattach <span class="token string">&quot;<span class="token variable">$ACTION</span>,file=<span class="token variable">$FILE</span>,<span class="token variable">$OUTPUT</span><span class="token variable">$FORMAT</span><span class="token variable">$PARAMS</span>&quot;</span>
        <span class="token punctuation">;</span><span class="token punctuation">;</span>
    check<span class="token punctuation">)</span>
        jattach <span class="token string">&quot;<span class="token variable">$ACTION</span>,file=<span class="token variable">$FILE</span>,<span class="token variable">$OUTPUT</span><span class="token variable">$FORMAT</span><span class="token variable">$PARAMS</span>&quot;</span>
        <span class="token punctuation">;</span><span class="token punctuation">;</span>
  <span class="token punctuation">..</span>.
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>java attach机制在之前讲解jstack实现的文章中有详细介绍，交互方式是通过socket进行通信，async-profiler这里通过c语言实现了attach。</p> <div class="language-text line-numbers-mode"><pre class="language-text"><code>int jattach_hotspot(int pid, int nspid, int argc, char** argv) {
    if (check_socket(nspid) != 0 &amp;amp;&amp;amp; start_attach_mechanism(pid, nspid) != 0) {
        perror(&quot;Could not start attach mechanism&quot;);
        return 1;
    }

    int fd = connect_socket(nspid);
    if (fd == -1) {
        perror(&quot;Could not connect to socket&quot;);
        return 1;
    }

    printf(&quot;Connected to remote JVM\n&quot;);

    if (write_command(fd, argc, argv) != 0) {
        perror(&quot;Error writing to socket&quot;);
        close(fd);
        return 1;
    }

    int result = read_response(fd, argc, argv);
    close(fd);

    return result;
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><h3 id="libasyncprofiler"><a href="#libasyncprofiler" class="header-anchor">#</a> libasyncProfiler</h3> <h4 id="vmentry"><a href="#vmentry" class="header-anchor">#</a> vmEntry</h4> <p>vmEntry是async-profiler的入口类，里面提供了Agent_OnAttach等jvmti要求的接口实现，
在运行时attach async-profiler时，jvm会调用Agent_OnAttach。</p> <ol><li>解析参数</li> <li>VM::init，初始化，会获取jvm的AsyncGetCallTrace方法。</li> <li>Profiler::instance()-&gt;run(args)：</li></ol> <div class="language-text line-numbers-mode"><pre class="language-text"><code>extern &quot;C&quot; DLLEXPORT jint JNICALL
Agent_OnAttach(JavaVM* vm, char* options, void* reserved) {
    Arguments args(true);
    Error error = args.parse(options);

    Log::open(args);

    if (error) {
        Log::error(&quot;%s&quot;, error.message());
        return ARGUMENTS_ERROR;
    }

    if (!VM::init(vm, true)) {
        Log::error(&quot;JVM does not support Tool Interface&quot;);
        return COMMAND_ERROR;
    }

    // Save the arguments in case of shutdown
    if (args._action == ACTION_START || args._action == ACTION_RESUME) {
        _agent_args.save(args);
    }

    error = Profiler::instance()-&gt;run(args);
    if (error) {
        Log::error(&quot;%s&quot;, error.message());
        return COMMAND_ERROR;
    }

    return 0;
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><h3 id="vm-init"><a href="#vm-init" class="header-anchor">#</a> VM::init</h3> <ul><li>获取AsyncGetCallTrace</li> <li>Profiler::instance-&gt;updateSymbols</li></ul> <div class="language-text line-numbers-mode"><pre class="language-text"><code>bool VM::init(JavaVM* vm, bool attach) {
    _libjvm = getLibraryHandle(&quot;libjvm.so&quot;);
    _asyncGetCallTrace = (AsyncGetCallTrace)dlsym(_libjvm, &quot;AsyncGetCallTrace&quot;);
    _getManagement = (JVM_GetManagement)dlsym(_libjvm, &quot;JVM_GetManagement&quot;);

    Profiler* profiler = Profiler::instance();
    profiler-&gt;updateSymbols(false);
    CodeCache* lib = isOpenJ9()
        ? profiler-&gt;findJvmLibrary(&quot;libj9vm&quot;)
        : profiler-&gt;findLibraryByAddress((const void*)_asyncGetCallTrace);
    if (lib == NULL) {
        return false;
    }

    VMStructs::init(lib);
    
    if (attach) {
        ready();
    }

    jvmtiCapabilities capabilities = {0};
    capabilities.can_generate_all_class_hook_events = 1;
    capabilities.can_retransform_classes = 1;
    capabilities.can_retransform_any_class = isOpenJ9() ? 0 : 1;
    capabilities.can_generate_vm_object_alloc_events = isOpenJ9() ? 1 : 0;
    capabilities.can_generate_sampled_object_alloc_events = _can_sample_objects ? 1 : 0;
    capabilities.can_get_bytecodes = 1;
    capabilities.can_get_constant_pool = 1;
    capabilities.can_get_source_file_name = 1;
    capabilities.can_get_line_numbers = 1;
    capabilities.can_generate_compiled_method_load_events = 1;
    capabilities.can_generate_monitor_events = 1;
    capabilities.can_tag_objects = 1;
    if (_jvmti-&gt;AddCapabilities(&amp;amp;capabilities) != 0) {
        _can_sample_objects = false;
        capabilities.can_generate_sampled_object_alloc_events = 0;
        _jvmti-&gt;AddCapabilities(&amp;amp;capabilities);
    }

    jvmtiEventCallbacks callbacks = {0};
    callbacks.VMInit = VMInit;
    callbacks.VMDeath = VMDeath;
    callbacks.ClassLoad = ClassLoad;
    callbacks.ClassPrepare = ClassPrepare;
    callbacks.ClassFileLoadHook = Instrument::ClassFileLoadHook;
    callbacks.CompiledMethodLoad = Profiler::CompiledMethodLoad;
    callbacks.DynamicCodeGenerated = Profiler::DynamicCodeGenerated;
    callbacks.ThreadStart = Profiler::ThreadStart;
    callbacks.ThreadEnd = Profiler::ThreadEnd;
    callbacks.MonitorContendedEnter = LockTracer::MonitorContendedEnter;
    callbacks.MonitorContendedEntered = LockTracer::MonitorContendedEntered;
    callbacks.VMObjectAlloc = J9ObjectSampler::VMObjectAlloc;
    callbacks.SampledObjectAlloc = ObjectSampler::SampledObjectAlloc;
    _jvmti-&gt;SetEventCallbacks(&amp;amp;callbacks, sizeof(callbacks));

    _jvmti-&gt;SetEventNotificationMode(JVMTI_ENABLE, JVMTI_EVENT_VM_DEATH, NULL);
    _jvmti-&gt;SetEventNotificationMode(JVMTI_ENABLE, JVMTI_EVENT_CLASS_LOAD, NULL);
    _jvmti-&gt;SetEventNotificationMode(JVMTI_ENABLE, JVMTI_EVENT_CLASS_PREPARE, NULL);
    _jvmti-&gt;SetEventNotificationMode(JVMTI_ENABLE, JVMTI_EVENT_DYNAMIC_CODE_GENERATED, NULL);

    if (hotspot_version() == 0 || !CodeHeap::available()) {
        // Workaround for JDK-8173361: avoid CompiledMethodLoad events when possible
        _jvmti-&gt;SetEventNotificationMode(JVMTI_ENABLE, JVMTI_EVENT_COMPILED_METHOD_LOAD, NULL);
    } else {
        // DebugNonSafepoints is automatically enabled with CompiledMethodLoad,
        // otherwise we set the flag manually
        char* flag_addr = (char*)JVMFlag::find(&quot;DebugNonSafepoints&quot;);
        if (flag_addr != NULL) {
            *flag_addr = 1;
        }
    }

    if (attach) {
        loadAllMethodIDs(jvmti(), jni());
        _jvmti-&gt;GenerateEvents(JVMTI_EVENT_DYNAMIC_CODE_GENERATED);
        _jvmti-&gt;GenerateEvents(JVMTI_EVENT_COMPILED_METHOD_LOAD);
    } else {
        _jvmti-&gt;SetEventNotificationMode(JVMTI_ENABLE, JVMTI_EVENT_VM_INIT, NULL);
    }

    OS::installSignalHandler(WAKEUP_SIGNAL, NULL, wakeupHandler);

}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br></div></div><h3 id="asyncgetcalltrace"><a href="#asyncgetcalltrace" class="header-anchor">#</a> AsyncGetCallTrace</h3> <p>通过<code>perf_event</code>获取线程调用栈，通过<code>AsyncGetCallTree</code>方法进行匹配。</p> <p>async-profiler通过jvm内部提供的一个<code>AsyncGetCallTrace</code>方法来获得线程栈，这也是async-profiler名称中async的来源。
<code>AsyncGetCallTrace</code></p> <h3 id="allocation-profiling"><a href="#allocation-profiling" class="header-anchor">#</a> allocation profiling</h3> <p>allocation profiling可以对内存申请进行采样，用来排查GC频繁等内存相关问题，脚本中-e参数增加alloc，比如-e cpu,alloc开启。</p> <p>allocation profiling的实现，不是在Object对象中加入采样逻辑（会有非常大的性能开销），是通过TLAB采样的方式实现的，hotspot jdk
在TLAB的创建、TLAB外分配对象时会发送相关event事件。</p> <ul><li>对象在新创建的TLAB中分配内存时</li> <li>对象因为在TLAB剩余空间放不下需要在TLAB外分配时</li></ul> <p>如果发现使用G1收集器时，humonguous区比较多，可以通过
G1CollectedHeap::humongous_obj_allocate这个event来查看humongous对象申请的栈</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>./asprof -d <span class="token number">20</span> -e G1CollectedHeap::humongous_obj_allocate <span class="token variable">$pid</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="deoptimization"><a href="#deoptimization" class="header-anchor">#</a> deoptimization</h3> <p>通过<code>Deoptimization::uncommon_trap_inner</code>这个event可以获取deoptimize事件的路径。</p> <h3 id="其他的native方法"><a href="#其他的native方法" class="header-anchor">#</a> 其他的native方法</h3> <p>如何找到类似Deoptimization::uncommon_trap_inner其他的方法？</p> <p>通过<code>nm $JAVA_HOME/lib/server/libjvm.so</code>查看所有的方法（mac平台libjvm.so换成libjvm.dylib)，然后找自己关心的方法，第三列就是方法名可以传入<code>-e</code>的参数中</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>nm <span class="token variable">$JAVA_HOME</span>/lib/server/libjvm.so 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="java-api"><a href="#java-api" class="header-anchor">#</a> Java API</h3> <h3 id="no-java-frame问题"><a href="#no-java-frame问题" class="header-anchor">#</a> no_java_frame问题</h3> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># sysctl kernel.perf_event_paranoid=1</span>
<span class="token comment"># sysctl kernel.kptr_restrict=0</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h2 id="实现层面"><a href="#实现层面" class="header-anchor">#</a> 实现层面</h2> <h3 id="为什么async-profiler不会遇到常规的sampling-profiler的safepoint-bias问题"><a href="#为什么async-profiler不会遇到常规的sampling-profiler的safepoint-bias问题" class="header-anchor">#</a> 为什么async-profiler不会遇到常规的sampling profiler的safepoint bias问题？</h3> <p>sampling profiler通常使用Java提供的获取所有线程的线程栈的API实现，而这个API是通过VM_Operation这个包装来实现的，
即会停止所有的线程（进入safepoint），然后采集所有线程的线程栈。</p> <p>为什么需要暂停所有的线程？如果不暂停，采集线程在遍历栈数据时，被采集线程也可能在修改栈，产生并发异常问题。</p> <p>safepoint有哪些问题呢？线程要进入safepoint需要检查当前是否需要进入safepoint了，并且在进入safepoint之前需要准备好oopMap数据。
oopMap是记录当前frame中哪些位置存储了对象指针，这是为gc时进行gc tracing遍历使用的，因为栈上引用的对象会作为gc root。</p> <p>为了性能考虑，不能在所有的代码执行位置都去检查是否要进入safepoint以及生成oopMap数据，所以在目前hotspot中，之后在方法调用、非有最大次数循环回边、阻塞操作等
位置去检查safepoint状态，所以safepoint内的操作看到的当前线程状态也是在这些位置，这就导致线程栈数据看到的总是方法调用、回边等这些位置的栈。</p> <p>那么async-profiler是如何实现的？</p> <p>async-profiler在kernel中注册信号处理器，信号出现时（比如间隔10ms一个信号），每个线程都会收到信号并去执行
信号处理代码，在信号处理代码中完成sample数据采集比如获取当前线程栈，因为每个线程各自负责自己的栈并且此时线程不会执行代码不会修改栈内存，
这样也就不需要同时在一个safepoint内暂停所有的线程，也就没有了safepiont带来的safepoint bias问题。</p> <p>async-profiler当前使用的是hotspot jvm内的一个内部方法AsyncGetCallTrace，但是由于是一个内部API在用起来难度很大，也没有充分的测试底阿妈。
现在有一个<a href="https://openjdk.org/jeps/435" target="_blank" rel="noopener noreferrer">JEP435<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>提议创建一个新的AsyncGetStackTrace API，这个新的API能够像getThreadInfos接口一样在其他线程执行，
即通过一个线程获取其他线程的线程栈，在获取一个线程的线程栈时暂停对应线程的执行。</p> <h2 id="参考资料"><a href="#参考资料" class="header-anchor">#</a> 参考资料</h2> <ul><li><a href="https://netflixtechblog.com/java-in-flames-e763b3d32166" target="_blank" rel="noopener noreferrer">Java in Flames<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://www.brendangregg.com/FlameGraphs/cpuflamegraphs.html" target="_blank" rel="noopener noreferrer">CPU Flame Graphs<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://www.brendangregg.com/blog/2014-11-09/differential-flame-graphs.html" target="_blank" rel="noopener noreferrer">Differential Flame Graphs<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://www.brendangregg.com/FlameGraphs/offcpuflamegraphs.html" target="_blank" rel="noopener noreferrer">Off-CPU Flame Graphs<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://krzysztofslusarski.github.io/2022/12/12/async-manual.html" target="_blank" rel="noopener noreferrer">async-profiler manual<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/liuzhengyang/liuzhengyang.github.io/edit/master/docs/md/performance/async-profiler/async-profiler.md" target="_blank" rel="noopener noreferrer">Edit this page</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <!----></footer> <!----> </main></div> <aside class="page-sidebar"> <div class="page-side-toolbar"><!----> <div class="option-box-toc-over"><img src="/images/system/toc.png" class="nozoom"> <span class="show-txt">目录</span> <div class="toc-container"><div class="pos-box"><div class="icon-arrow"></div> <div class="scroll-box" style="max-height:550px"><div style="font-weight:bold;text-align:center;">性能分析利器: async-profiler</div> <hr> <div class="toc-box"><ul class="toc-sidebar-links"><li><a href="/md/performance/async-profiler/async-profiler.html#介绍" class="toc-sidebar-link">介绍</a><ul class="toc-sidebar-sub-headers"></ul></li><li><a href="/md/performance/async-profiler/async-profiler.html#使用" class="toc-sidebar-link">使用</a><ul class="toc-sidebar-sub-headers"><li class="toc-sidebar-sub-header"><a href="/md/performance/async-profiler/async-profiler.html#直接安装使用async-profiler" class="toc-sidebar-link">直接安装使用async-profiler</a></li><li class="toc-sidebar-sub-header"><a href="/md/performance/async-profiler/async-profiler.html#启动时开启async-profiler" class="toc-sidebar-link">启动时开启async-profiler</a></li><li class="toc-sidebar-sub-header"><a href="/md/performance/async-profiler/async-profiler.html#通过arthas使用async-profiler" class="toc-sidebar-link">通过arthas使用async-profiler</a></li><li class="toc-sidebar-sub-header"><a href="/md/performance/async-profiler/async-profiler.html#使用asyncprofiler查看特定方法调用" class="toc-sidebar-link">使用asyncprofiler查看特定方法调用</a></li></ul></li><li><a href="/md/performance/async-profiler/async-profiler.html#通过火焰图查看代码问题" class="toc-sidebar-link">通过火焰图查看代码问题</a><ul class="toc-sidebar-sub-headers"></ul></li><li><a href="/md/performance/async-profiler/async-profiler.html#内存申请" class="toc-sidebar-link">内存申请</a><ul class="toc-sidebar-sub-headers"></ul></li><li><a href="/md/performance/async-profiler/async-profiler.html#async-profiler代码实现分析" class="toc-sidebar-link">async-profiler代码实现分析</a><ul class="toc-sidebar-sub-headers"><li class="toc-sidebar-sub-header"><a href="/md/performance/async-profiler/async-profiler.html#启动脚本" class="toc-sidebar-link">启动脚本</a></li><li class="toc-sidebar-sub-header"><a href="/md/performance/async-profiler/async-profiler.html#libasyncprofiler" class="toc-sidebar-link">libasyncProfiler</a></li><li class="toc-sidebar-sub-header"><a href="/md/performance/async-profiler/async-profiler.html#vm-init" class="toc-sidebar-link">VM::init</a></li><li class="toc-sidebar-sub-header"><a href="/md/performance/async-profiler/async-profiler.html#asyncgetcalltrace" class="toc-sidebar-link">AsyncGetCallTrace</a></li><li class="toc-sidebar-sub-header"><a href="/md/performance/async-profiler/async-profiler.html#allocation-profiling" class="toc-sidebar-link">allocation profiling</a></li><li class="toc-sidebar-sub-header"><a href="/md/performance/async-profiler/async-profiler.html#deoptimization" class="toc-sidebar-link">deoptimization</a></li><li class="toc-sidebar-sub-header"><a href="/md/performance/async-profiler/async-profiler.html#其他的native方法" class="toc-sidebar-link">其他的native方法</a></li><li class="toc-sidebar-sub-header"><a href="/md/performance/async-profiler/async-profiler.html#java-api" class="toc-sidebar-link">Java API</a></li><li class="toc-sidebar-sub-header"><a href="/md/performance/async-profiler/async-profiler.html#no-java-frame问题" class="toc-sidebar-link">nojavaframe问题</a></li></ul></li><li><a href="/md/performance/async-profiler/async-profiler.html#实现层面" class="toc-sidebar-link">实现层面</a><ul class="toc-sidebar-sub-headers"><li class="toc-sidebar-sub-header"><a href="/md/performance/async-profiler/async-profiler.html#为什么async-profiler不会遇到常规的sampling-profiler的safepoint-bias问题" class="toc-sidebar-link">为什么async-profiler不会遇到常规的sampling profiler的safepoint bias问题？</a></li></ul></li><li><a href="/md/performance/async-profiler/async-profiler.html#参考资料" class="toc-sidebar-link">参考资料</a><ul class="toc-sidebar-sub-headers"></ul></li></ul></div></div></div></div></div> <div class="option-box"><img src="/images/system/wechat.png" class="nozoom"> <span class="show-txt">手机看</span> <div class="toc-container"><div class="pos-box"><div class="icon-arrow"></div> <div class="scroll-box" style="text-align:center"><span style="font-size:0.9rem">微信扫一扫</span> <img height="180px" src="https://api.qrserver.com/v1/create-qr-code/?data=https://bytejava.cn/md/performance/async-profiler/async-profiler.html" style="margin:10px;">
                可以<b>手机看</b>或分享至<b>朋友圈</b></div></div></div></div> <div class="option-box"><img src="/images/personal/wechat-mp-logo.jpg" height="20" class="nozoom"> <span class="show-txt">公众号</span> <div class="toc-container"><div class="pos-box"><div class="icon-arrow"></div> <div class="scroll-box" style="text-align:center"><span style="font-size:0.9rem">关注公众号bytejava</span> <img src="/images/personal/wechat-mp.png" height="180" width></div></div></div></div> <div class="option-box"><img src="/images/system/toggle.png" width="30px" class="nozoom"> <span class="show-txt">左栏</span></div> <div class="option-box"><img src="/images/system/heart-1.png" width="25px" class="nozoom"> <span class="show-txt">赞赏我</span> <div class="toc-container"><div class="pos-box"><div class="icon-arrow"></div> <div class="scroll-box" style="text-align:center"><span style="font-size:0.8rem;font-weight:bold;">鼓励/支持/赞赏我</span> <img height="180px" src="/images/personal/encourage-head.jpg" style="margin:5px;"> <br>1. 不靠它生存但仍希望得到你的鼓励；
                <br>2. 时刻警醒自己保持技术人的初心，沉淀，分享，成长；
              </div></div></div></div> <!----> <!----></div>  <!----> </aside></div><div class="global-ui"></div></div>
    <script src="/assets/js/cg-styles.js?v=1729221831211" defer></script><script src="/assets/js/cg-4.js?v=1729221831211" defer></script><script src="/assets/js/cg-3.js?v=1729221831211" defer></script><script src="/assets/js/cg-294.js?v=1729221831211" defer></script><script src="/assets/js/cg-app.js?v=1729221831211" defer></script>
  </body>
</html>
