<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>字符串使用和内部原理 | bytejava Java进阶手册</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/favicon.ico">
    <script charset="utf-8" async="async" src="/js/jquery.min.js"></script>
    <script charset="utf-8" async="async" src="/js/global.js"></script>
    <script charset="utf-8" async="async" src="/js/fingerprint2.min.js"></script>
    <script charset="utf-8" async="async" src="https://s9.cnzz.com/z_stat.php?id=12782949&amp;web_id=1272949"></script>
    <script>
              var _hmt = _hmt || [];
              (function() {
                var hm = document.createElement("script");
                hm.src = "https://hm.baidu.com/hm.js?fa0fbf0fef3bba94118b912a64766cee";
                var s = document.getElementsByTagName("script")[0];
                s.parentNode.insertBefore(hm, s);
              })();
            </script>
    <meta name="description" content="包含: Java 基础，高并发缓存，JVM，中间件，字节码编程...">
    <meta property="og:title" content="字符串使用和内部原理">
    <meta property="og:type" content="article">
    <meta property="og:url" content="/md/cache/redis/%E5%AD%97%E7%AC%A6%E4%B8%B2%E4%BD%BF%E7%94%A8%E5%92%8C%E5%86%85%E9%83%A8%E5%8E%9F%E7%90%86.html">
    <meta name="twitter:title" content="字符串使用和内部原理">
    <meta name="twitter:url" content="/md/cache/redis/%E5%AD%97%E7%AC%A6%E4%B8%B2%E4%BD%BF%E7%94%A8%E5%92%8C%E5%86%85%E9%83%A8%E5%8E%9F%E7%90%86.html">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="robots" content="all">
    <meta name="author" content="bytejava">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="keywords" content="bytejava 高级Java，Java设计模式, 字节码编程, 中间件, Spring, Java基础, 面经手册">
    <meta name="apple-mobile-web-app-capable" content="yes">
    
    <link rel="preload" href="/assets/css/0.styles.8fb5e8ac.css" as="style"><link rel="preload" href="/assets/css/styles.css?v=1729221831211" as="style"><link rel="preload" href="/assets/js/cg-styles.js?v=1729221831211" as="script"><link rel="preload" href="/assets/js/cg-app.js?v=1729221831211" as="script"><link rel="preload" href="/assets/js/cg-4.js?v=1729221831211" as="script"><link rel="preload" href="/assets/js/cg-3.js?v=1729221831211" as="script"><link rel="preload" href="/assets/js/cg-68.js?v=1729221831211" as="script">
    <link rel="stylesheet" href="/assets/css/0.styles.8fb5e8ac.css"><link rel="stylesheet" href="/assets/css/styles.css?v=1729221831211">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">bytejava Java进阶手册</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java" class="dropdown-title"><span class="title">Java</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/java/basic/java线程池.html" class="nav-link">
  Java基础
</a></li><li class="dropdown-item"><!----> <a href="/md/java/compiler/javac.html" class="nav-link">
  Java编译器
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="JVM" class="dropdown-title"><span class="title">JVM</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/jvm/bytecode/class字节码文件格式.html" class="nav-link">
  字节码
</a></li><li class="dropdown-item"><!----> <a href="/md/jvm/jvm/javaagent.html" class="nav-link">
  jvm
</a></li><li class="dropdown-item"><!----> <a href="/md/jvm/jvmti/jvmti介绍和开发.html" class="nav-link">
  jvmti
</a></li><li class="dropdown-item"><!----> <a href="/md/jvm/gc/g1/g1-all-intro.html" class="nav-link">
  G1 GC
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="缓存" class="dropdown-title"><span class="title">缓存</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/cache/redis/redis.html" class="nav-link">
  零基础到高并发应用专家，深入理解redis
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Spring" class="dropdown-title"><span class="title">Spring</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/spring/springboot启动请求处理过程.html" class="nav-link">
  Spring实现
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Kafka" class="dropdown-title"><span class="title">Kafka</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/kafka/kafka.html" class="nav-link">
  kafka
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="MyBatis" class="dropdown-title"><span class="title">MyBatis</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/mybatis/mybatis-use-general.html" class="nav-link">
  MyBatis
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="业务开发" class="dropdown-title"><span class="title">业务开发</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/develop/" class="nav-link">
  业务开发
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="中间件" class="dropdown-title"><span class="title">中间件</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/distribute/raft.html" class="nav-link">
  raft
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="算法" class="dropdown-title"><span class="title">算法</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/algorithm/leetcode.html" class="nav-link">
  算法
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="软技能通用技能" class="dropdown-title"><span class="title">软技能通用技能</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/soft/晋升答辩.html" class="nav-link">
  晋升答辩
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="专栏" class="dropdown-title"><span class="title">专栏</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/column/column.html" class="nav-link">
  订阅我的专栏
</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/liuzhengyang" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java" class="dropdown-title"><span class="title">Java</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/java/basic/java线程池.html" class="nav-link">
  Java基础
</a></li><li class="dropdown-item"><!----> <a href="/md/java/compiler/javac.html" class="nav-link">
  Java编译器
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="JVM" class="dropdown-title"><span class="title">JVM</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/jvm/bytecode/class字节码文件格式.html" class="nav-link">
  字节码
</a></li><li class="dropdown-item"><!----> <a href="/md/jvm/jvm/javaagent.html" class="nav-link">
  jvm
</a></li><li class="dropdown-item"><!----> <a href="/md/jvm/jvmti/jvmti介绍和开发.html" class="nav-link">
  jvmti
</a></li><li class="dropdown-item"><!----> <a href="/md/jvm/gc/g1/g1-all-intro.html" class="nav-link">
  G1 GC
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="缓存" class="dropdown-title"><span class="title">缓存</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/cache/redis/redis.html" class="nav-link">
  零基础到高并发应用专家，深入理解redis
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Spring" class="dropdown-title"><span class="title">Spring</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/spring/springboot启动请求处理过程.html" class="nav-link">
  Spring实现
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Kafka" class="dropdown-title"><span class="title">Kafka</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/kafka/kafka.html" class="nav-link">
  kafka
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="MyBatis" class="dropdown-title"><span class="title">MyBatis</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/mybatis/mybatis-use-general.html" class="nav-link">
  MyBatis
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="业务开发" class="dropdown-title"><span class="title">业务开发</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/develop/" class="nav-link">
  业务开发
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="中间件" class="dropdown-title"><span class="title">中间件</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/distribute/raft.html" class="nav-link">
  raft
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="算法" class="dropdown-title"><span class="title">算法</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/algorithm/leetcode.html" class="nav-link">
  算法
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="软技能通用技能" class="dropdown-title"><span class="title">软技能通用技能</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/soft/晋升答辩.html" class="nav-link">
  晋升答辩
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="专栏" class="dropdown-title"><span class="title">专栏</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/column/column.html" class="nav-link">
  订阅我的专栏
</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/liuzhengyang" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>redis数据结构</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/md/cache/redis/redis数据结构.html" class="sidebar-link">redis数据结构介绍</a></li><li><a href="/md/cache/redis/redis源码本地调试.html" class="sidebar-link">redis源码本地调试.md</a></li><li><a href="/md/cache/redis/redis数据结构dict.html" class="sidebar-link">redis数据结构dict</a></li><li><a href="/md/cache/redis/字符串使用和内部原理.html" class="active sidebar-link">字符串使用和内部原理</a></li><li><a href="/md/cache/redis/redis过期机制.html" class="sidebar-link">Redis过期策略</a></li><li><a href="/md/cache/redis/淘汰机制.html" class="sidebar-link">内存逐出淘汰机制</a></li><li><a href="/md/cache/redis/hyperloglog.html" class="sidebar-link">hyperloglog</a></li><li><a href="/md/cache/redis/redis可靠性.html" class="sidebar-link">Redis可靠性（持久化、主从同步、sentinel、集群）</a></li><li><a href="/md/cache/redis/redis.html" class="sidebar-link">redis概述</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>高并发应用缓存设计与实现</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/md/cache/redis/高并发应用缓存设计与实现.html" class="sidebar-link">高并发应用缓存设计与实现</a></li></ul></section></li></ul> </aside> <div><main class="page"> <div class="theme-default-content content__default"><h1 id="字符串使用和内部原理"><a href="#字符串使用和内部原理" class="header-anchor">#</a> 字符串使用和内部原理</h1> <h2 id="使用场景"><a href="#使用场景" class="header-anchor">#</a> 使用场景</h2> <p>redis中的字符串常用于存储key value数据或计数数据。</p> <h3 id="key-value字符串存储"><a href="#key-value字符串存储" class="header-anchor">#</a> key value字符串存储</h3> <p>在平时的需求中存在大量的存储key value数据的场景，比如存储一个用户的用户名，我们把用户id作为key，用户名字符串作为value值；
如果是复杂的对象，则可以通过json等方式序列化成字符串存储，比如一篇文章的文章标题、内容、创建时间等信息作为一个对象序列化成json存储。</p> <p>常用命令</p> <table><thead><tr><th>命令</th> <th>命令说明</th> <th>时间复杂度</th></tr></thead> <tbody><tr><td>get key</td> <td>获取可以对应的value值，如果没有返回null</td> <td>O(1)</td></tr> <tr><td>set key value [过期时间/KEEPTTL] [NX/XX] [GET]</td> <td>设置key对应的value值, 可以传入过期时间，过期时间可以是相对时间或绝对时间。如果没有传过期时间，则set方法会覆盖实现的过期时间设置即把key变成不过期的，可以传入KEEPTTL避免保存之前的过期时间，如果传入NX标记，则只有当对应的key不存在的时候才会设置值。如果传入XX标记，则只有在key存在的时候才会设置值。如果set操作成功，返回OK字符串，否则返回空(比如因为NX或XX导致没有设置值)。如果传入GET，则会返回key对应的旧的值。</td> <td>O(1)</td></tr> <tr><td>mget</td> <td>批量获取一批key的value</td> <td>O(N) N是key的数量</td></tr> <tr><td>mset</td> <td>批量设置一批key的value</td> <td>O(N) N是key的数量</td></tr> <tr><td>setnx</td> <td>相当于前面的set key value NX的简化版本，区别是setnx操作成功返回1否则返回0</td> <td>O(1)</td></tr></tbody></table> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> <span class="token builtin class-name">set</span> hello world
OK
<span class="token punctuation">(</span><span class="token number">4</span>.37s<span class="token punctuation">)</span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> get hello
<span class="token string">&quot;world&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h4 id="实现分布式锁"><a href="#实现分布式锁" class="header-anchor">#</a> 实现分布式锁</h4> <p>通过redis可以快速实现一个简单的分布式锁。给要锁的资源生成key（比如userId对应userId的字符串），然后再生成一个随机字符串做为value。
然后尝试通过set带有nx标记以及过期时间写入key value值，过期时间目的是为了防止宕机等异常导致锁一直不释放。
如果成功，说明获取到了这个分布式锁，然后在锁内执行业务逻辑，执行完成后（finally模块中)，删除对应的key value（删除之前需要再get获取判断
value值是否还是前面生成的随机数，防止持有锁超时后误删其他客户端的加锁，这个操作分为了两步所以尽量放到一个lua script保证原子删除）。</p> <p><a href="https://redis.io/docs/reference/patterns/distributed-locks/" target="_blank" rel="noopener noreferrer">distributed-locks<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h3 id="计数"><a href="#计数" class="header-anchor">#</a> 计数</h3> <p>字符串类型也可以作为数值来存储(可以存储整数或浮点数），由于redis使用单线程处理用户请求，有原子操作保证并发使用线程安全，可以类比成Java里的AtomicLong。</p> <table><thead><tr><th>命令</th> <th>命令说明</th> <th>时间复杂度</th></tr></thead> <tbody><tr><td>incr key</td> <td>给指定的key的值加1，如果对应的key不存在，则会先初始化为0再加一</td> <td>O(1)</td></tr> <tr><td>decr key</td> <td>给指定的key的值减1，如果对应的key不存在，则会先初始化为0再减一</td> <td>O(1)</td></tr> <tr><td>incrby key</td> <td>给指定的key增加指定的值，如果对应的key不存在，则会先初始化为0再加</td> <td>O(1)</td></tr> <tr><td>decrby key</td> <td>给指定的key减去指定的值，如果对应的key不存在，则会先初始化为0再减</td> <td>O(1)</td></tr></tbody></table> <p>通过计数功能能够实现非常多的计数场景需求，比如评论数、粉丝数等等。除此之外分布式的计数器还有很多业务架构上的应用场景比如实现分布式限流等。</p> <h4 id="实现分布式计数"><a href="#实现分布式计数" class="header-anchor">#</a> 实现分布式计数</h4> <p>实现分布式计数的注意事项</p> <p>在实现分布式计数时，我们需要分析使用场景，评估请求量、请求数据热点情况、读写请求比例、是否对计数一致性要求高，来做出更合适的取舍。</p> <p>比如有的场景对计数数据一致性要求不高，比如展示某个活动的参数人数，我们可以在读取计数时增加本地缓存配合本地缓存过期时间/刷新时间，减少
redis的请求压力；如果写入量比较大，则对写入请求在本地进行聚合（类似kafka的内存buffer)，每隔一定时间异步写入redis；
如果对一致性要求比较高，比如使用redis存储一件商品的库存数量，则在扣减库存时，可以先读取本地缓存判断有库存后，再调用decr尝试扣减库存，decr结果&gt;=0
说明扣减成功否则失败。</p> <p>更多的redis使用技巧可以参考高并发应用缓存设计与实现这篇文章。</p> <h4 id="实现分布式限流、分布式计数限制"><a href="#实现分布式限流、分布式计数限制" class="header-anchor">#</a> 实现分布式限流、分布式计数限制</h4> <p>在系统稳定性保护中，限流是一个重要的功能，然而现有的大部分限流都是进程内的限流，比如各种ratelimiter。
加入我们现在的服务会调用数据库，数据库能够支持1w qps的写流量，那么我们需要限制全局的写入qps小于1w，这就需要实现分布式限流。
通过redis的计数即可实现，我们分析可知这个限流限制不需要保证严格的一致性，所以可以使用缓存、buffer等策略降低redis的调用量。
比如我们把每一秒作为一个key来统计调用次数，本地缓存每100ms从redis中读取当前秒调用次数到本地，本地的调用量也按照每100ms一次聚合写入到redis
中，如果调用次数超过阈值，说明超限不能继续请求抛出异常。</p> <p>上述的间隔、key表示的时间范围都可以按照实际情况进行调整。</p> <p>另外在业务需求中，还有一类比较常见的计数限制，比如限制一个用户一天只能发表N个文章，则我们可以把用户和日期作为key，用户发表文章调用incr判断是否超过N
如果没有超过继续执行否则返回超过阈值异常。如果要考虑异常情况比如发表过程中因为某种原因失败了，我们还可以通过decr回退计数。</p> <h2 id="字符串实现"><a href="#字符串实现" class="header-anchor">#</a> 字符串实现</h2> <h3 id="编码"><a href="#编码" class="header-anchor">#</a> 编码</h3> <p>编码选择</p> <p>int类型: 如果在LONG_MIN和LONG_MAX之间，使用OBJ_ENCODING_INT编码。否则使用OBJ_ENCODING_RAW编码(long转换成字符串表示)。
string类型: 长度小于44字符时，使用OBJ_ENCODING_EMBSTR编码，长度大于等于55字符时使用OBJ_ENCODING_RAW编码</p> <p>OBJ_ENCODING_EMBSTR和OBJ_ENCODING_RAW有什么区别？</p> <h3 id="空间预分配"><a href="#空间预分配" class="header-anchor">#</a> 空间预分配</h3> <p>当字符串长度增加后，redis会增加对应字符串的空间，同时为了避免拼接字符串命令时频繁申请新的空间的开销，redis会通过预分配的策略提前多预留一些空间。
预留需要和内存占用进行取舍。</p> <p>预分配的优化思想在计算机中非常常用，比如Java中ArrayList、HashMap等扩容时会进行进行充分的扩容而不是只增加到需要的大小。</p> <h2 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h2></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/liuzhengyang/liuzhengyang.github.io/edit/master/docs/md/cache/redis/字符串使用和内部原理.md" target="_blank" rel="noopener noreferrer">Edit this page</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/md/cache/redis/redis数据结构dict.html" class="prev">
          redis数据结构dict
        </a></span> <span class="next"><a href="/md/cache/redis/redis过期机制.html">
          Redis过期策略
        </a>
        →
      </span></p></div> </main></div> <aside class="page-sidebar"> <div class="page-side-toolbar"><div class="option-box-toc-fixed"><div class="toc-container-sidebar"><div class="pos-box"><div class="icon-arrow"></div> <div class="scroll-box" style="max-height:650px"><div style="font-weight:bold;text-align:center;">字符串使用和内部原理</div> <hr> <div class="toc-box"><ul class="toc-sidebar-links"><li><a href="/md/cache/redis/%E5%AD%97%E7%AC%A6%E4%B8%B2%E4%BD%BF%E7%94%A8%E5%92%8C%E5%86%85%E9%83%A8%E5%8E%9F%E7%90%86.html#使用场景" class="toc-sidebar-link">使用场景</a><ul class="toc-sidebar-sub-headers"><li class="toc-sidebar-sub-header"><a href="/md/cache/redis/%E5%AD%97%E7%AC%A6%E4%B8%B2%E4%BD%BF%E7%94%A8%E5%92%8C%E5%86%85%E9%83%A8%E5%8E%9F%E7%90%86.html#key-value字符串存储" class="toc-sidebar-link">key value字符串存储</a></li><li class="toc-sidebar-sub-header"><a href="/md/cache/redis/%E5%AD%97%E7%AC%A6%E4%B8%B2%E4%BD%BF%E7%94%A8%E5%92%8C%E5%86%85%E9%83%A8%E5%8E%9F%E7%90%86.html#计数" class="toc-sidebar-link">计数</a></li></ul></li><li><a href="/md/cache/redis/%E5%AD%97%E7%AC%A6%E4%B8%B2%E4%BD%BF%E7%94%A8%E5%92%8C%E5%86%85%E9%83%A8%E5%8E%9F%E7%90%86.html#字符串实现" class="toc-sidebar-link">字符串实现</a><ul class="toc-sidebar-sub-headers"><li class="toc-sidebar-sub-header"><a href="/md/cache/redis/%E5%AD%97%E7%AC%A6%E4%B8%B2%E4%BD%BF%E7%94%A8%E5%92%8C%E5%86%85%E9%83%A8%E5%8E%9F%E7%90%86.html#编码" class="toc-sidebar-link">编码</a></li><li class="toc-sidebar-sub-header"><a href="/md/cache/redis/%E5%AD%97%E7%AC%A6%E4%B8%B2%E4%BD%BF%E7%94%A8%E5%92%8C%E5%86%85%E9%83%A8%E5%8E%9F%E7%90%86.html#空间预分配" class="toc-sidebar-link">空间预分配</a></li></ul></li><li><a href="/md/cache/redis/%E5%AD%97%E7%AC%A6%E4%B8%B2%E4%BD%BF%E7%94%A8%E5%92%8C%E5%86%85%E9%83%A8%E5%8E%9F%E7%90%86.html#总结" class="toc-sidebar-link">总结</a><ul class="toc-sidebar-sub-headers"></ul></li></ul></div></div></div></div></div> <div class="option-box-toc-over"><img src="/images/system/toc.png" class="nozoom"> <span class="show-txt">目录</span> <div class="toc-container"><div class="pos-box"><div class="icon-arrow"></div> <div class="scroll-box" style="max-height:550px"><div style="font-weight:bold;text-align:center;">字符串使用和内部原理</div> <hr> <div class="toc-box"><ul class="toc-sidebar-links"><li><a href="/md/cache/redis/%E5%AD%97%E7%AC%A6%E4%B8%B2%E4%BD%BF%E7%94%A8%E5%92%8C%E5%86%85%E9%83%A8%E5%8E%9F%E7%90%86.html#使用场景" class="toc-sidebar-link">使用场景</a><ul class="toc-sidebar-sub-headers"><li class="toc-sidebar-sub-header"><a href="/md/cache/redis/%E5%AD%97%E7%AC%A6%E4%B8%B2%E4%BD%BF%E7%94%A8%E5%92%8C%E5%86%85%E9%83%A8%E5%8E%9F%E7%90%86.html#key-value字符串存储" class="toc-sidebar-link">key value字符串存储</a></li><li class="toc-sidebar-sub-header"><a href="/md/cache/redis/%E5%AD%97%E7%AC%A6%E4%B8%B2%E4%BD%BF%E7%94%A8%E5%92%8C%E5%86%85%E9%83%A8%E5%8E%9F%E7%90%86.html#计数" class="toc-sidebar-link">计数</a></li></ul></li><li><a href="/md/cache/redis/%E5%AD%97%E7%AC%A6%E4%B8%B2%E4%BD%BF%E7%94%A8%E5%92%8C%E5%86%85%E9%83%A8%E5%8E%9F%E7%90%86.html#字符串实现" class="toc-sidebar-link">字符串实现</a><ul class="toc-sidebar-sub-headers"><li class="toc-sidebar-sub-header"><a href="/md/cache/redis/%E5%AD%97%E7%AC%A6%E4%B8%B2%E4%BD%BF%E7%94%A8%E5%92%8C%E5%86%85%E9%83%A8%E5%8E%9F%E7%90%86.html#编码" class="toc-sidebar-link">编码</a></li><li class="toc-sidebar-sub-header"><a href="/md/cache/redis/%E5%AD%97%E7%AC%A6%E4%B8%B2%E4%BD%BF%E7%94%A8%E5%92%8C%E5%86%85%E9%83%A8%E5%8E%9F%E7%90%86.html#空间预分配" class="toc-sidebar-link">空间预分配</a></li></ul></li><li><a href="/md/cache/redis/%E5%AD%97%E7%AC%A6%E4%B8%B2%E4%BD%BF%E7%94%A8%E5%92%8C%E5%86%85%E9%83%A8%E5%8E%9F%E7%90%86.html#总结" class="toc-sidebar-link">总结</a><ul class="toc-sidebar-sub-headers"></ul></li></ul></div></div></div></div></div> <div class="option-box"><img src="/images/system/wechat.png" class="nozoom"> <span class="show-txt">手机看</span> <div class="toc-container"><div class="pos-box"><div class="icon-arrow"></div> <div class="scroll-box" style="text-align:center"><span style="font-size:0.9rem">微信扫一扫</span> <img height="180px" src="https://api.qrserver.com/v1/create-qr-code/?data=https://bytejava.cn/md/cache/redis/%E5%AD%97%E7%AC%A6%E4%B8%B2%E4%BD%BF%E7%94%A8%E5%92%8C%E5%86%85%E9%83%A8%E5%8E%9F%E7%90%86.html" style="margin:10px;">
                可以<b>手机看</b>或分享至<b>朋友圈</b></div></div></div></div> <div class="option-box"><img src="/images/personal/wechat-mp-logo.jpg" height="20" class="nozoom"> <span class="show-txt">公众号</span> <div class="toc-container"><div class="pos-box"><div class="icon-arrow"></div> <div class="scroll-box" style="text-align:center"><span style="font-size:0.9rem">关注公众号bytejava</span> <img src="/images/personal/wechat-mp.png" height="180" width></div></div></div></div> <div class="option-box"><img src="/images/system/toggle.png" width="30px" class="nozoom"> <span class="show-txt">左栏</span></div> <div class="option-box"><img src="/images/system/heart-1.png" width="25px" class="nozoom"> <span class="show-txt">赞赏我</span> <div class="toc-container"><div class="pos-box"><div class="icon-arrow"></div> <div class="scroll-box" style="text-align:center"><span style="font-size:0.8rem;font-weight:bold;">鼓励/支持/赞赏我</span> <img height="180px" src="/images/personal/encourage-head.jpg" style="margin:5px;"> <br>1. 不靠它生存但仍希望得到你的鼓励；
                <br>2. 时刻警醒自己保持技术人的初心，沉淀，分享，成长；
              </div></div></div></div> <div title="redis数据结构dict" class="option-box" style="padding-left:2px;text-align:center;"><a href="/md/cache/redis/redis数据结构dict.html"><img src="/images/system/pre2.png" width="30px" class="nozoom"> <span class="show-txt">上一篇</span></a></div> <div title="Redis过期策略" class="option-box" style="padding-left:2px;text-align:center;"><a href="/md/cache/redis/redis过期机制.html"><img src="/images/system/next2.png" width="30px" class="nozoom"> <span class="show-txt">下一篇</span></a></div></div>  <!----> </aside></div><div class="global-ui"></div></div>
    <script src="/assets/js/cg-styles.js?v=1729221831211" defer></script><script src="/assets/js/cg-4.js?v=1729221831211" defer></script><script src="/assets/js/cg-3.js?v=1729221831211" defer></script><script src="/assets/js/cg-68.js?v=1729221831211" defer></script><script src="/assets/js/cg-app.js?v=1729221831211" defer></script>
  </body>
</html>
