<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>JDK Virtual Thread的实现 | bytejava Java进阶手册</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/favicon.ico">
    <script charset="utf-8" async="async" src="/js/jquery.min.js"></script>
    <script charset="utf-8" async="async" src="/js/global.js"></script>
    <script charset="utf-8" async="async" src="/js/fingerprint2.min.js"></script>
    <script charset="utf-8" async="async" src="https://s9.cnzz.com/z_stat.php?id=12782949&amp;web_id=1272949"></script>
    <script>
              var _hmt = _hmt || [];
              (function() {
                var hm = document.createElement("script");
                hm.src = "https://hm.baidu.com/hm.js?fa0fbf0fef3bba94118b912a64766cee";
                var s = document.getElementsByTagName("script")[0];
                s.parentNode.insertBefore(hm, s);
              })();
            </script>
    <meta name="description" content="包含: Java 基础，高并发缓存，JVM，中间件，字节码编程...">
    <meta property="og:title" content="JDK Virtual Thread的实现">
    <meta property="og:type" content="article">
    <meta property="og:url" content="/md/jvm/jvm/virtualthread/virtual-thread.html">
    <meta name="twitter:title" content="JDK Virtual Thread的实现">
    <meta name="twitter:url" content="/md/jvm/jvm/virtualthread/virtual-thread.html">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="robots" content="all">
    <meta name="author" content="bytejava">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="keywords" content="bytejava 高级Java，Java设计模式, 字节码编程, 中间件, Spring, Java基础, 面经手册">
    <meta name="apple-mobile-web-app-capable" content="yes">
    
    <link rel="preload" href="/assets/css/0.styles.8fb5e8ac.css" as="style"><link rel="preload" href="/assets/css/styles.css?v=1729221831211" as="style"><link rel="preload" href="/assets/js/cg-styles.js?v=1729221831211" as="script"><link rel="preload" href="/assets/js/cg-app.js?v=1729221831211" as="script"><link rel="preload" href="/assets/js/cg-4.js?v=1729221831211" as="script"><link rel="preload" href="/assets/js/cg-3.js?v=1729221831211" as="script"><link rel="preload" href="/assets/js/cg-225.js?v=1729221831211" as="script">
    <link rel="stylesheet" href="/assets/css/0.styles.8fb5e8ac.css"><link rel="stylesheet" href="/assets/css/styles.css?v=1729221831211">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">bytejava Java进阶手册</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java" class="dropdown-title"><span class="title">Java</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/java/basic/java线程池.html" class="nav-link">
  Java基础
</a></li><li class="dropdown-item"><!----> <a href="/md/java/compiler/javac.html" class="nav-link">
  Java编译器
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="JVM" class="dropdown-title"><span class="title">JVM</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/jvm/bytecode/class字节码文件格式.html" class="nav-link">
  字节码
</a></li><li class="dropdown-item"><!----> <a href="/md/jvm/jvm/javaagent.html" class="nav-link">
  jvm
</a></li><li class="dropdown-item"><!----> <a href="/md/jvm/jvmti/jvmti介绍和开发.html" class="nav-link">
  jvmti
</a></li><li class="dropdown-item"><!----> <a href="/md/jvm/gc/g1/g1-all-intro.html" class="nav-link">
  G1 GC
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="缓存" class="dropdown-title"><span class="title">缓存</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/cache/redis/redis.html" class="nav-link">
  零基础到高并发应用专家，深入理解redis
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Spring" class="dropdown-title"><span class="title">Spring</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/spring/springboot启动请求处理过程.html" class="nav-link">
  Spring实现
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Kafka" class="dropdown-title"><span class="title">Kafka</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/kafka/kafka.html" class="nav-link">
  kafka
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="MyBatis" class="dropdown-title"><span class="title">MyBatis</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/mybatis/mybatis-use-general.html" class="nav-link">
  MyBatis
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="业务开发" class="dropdown-title"><span class="title">业务开发</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/develop/" class="nav-link">
  业务开发
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="中间件" class="dropdown-title"><span class="title">中间件</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/distribute/raft.html" class="nav-link">
  raft
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="算法" class="dropdown-title"><span class="title">算法</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/algorithm/leetcode.html" class="nav-link">
  算法
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="软技能通用技能" class="dropdown-title"><span class="title">软技能通用技能</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/soft/晋升答辩.html" class="nav-link">
  晋升答辩
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="专栏" class="dropdown-title"><span class="title">专栏</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/column/column.html" class="nav-link">
  订阅我的专栏
</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/liuzhengyang" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java" class="dropdown-title"><span class="title">Java</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/java/basic/java线程池.html" class="nav-link">
  Java基础
</a></li><li class="dropdown-item"><!----> <a href="/md/java/compiler/javac.html" class="nav-link">
  Java编译器
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="JVM" class="dropdown-title"><span class="title">JVM</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/jvm/bytecode/class字节码文件格式.html" class="nav-link">
  字节码
</a></li><li class="dropdown-item"><!----> <a href="/md/jvm/jvm/javaagent.html" class="nav-link">
  jvm
</a></li><li class="dropdown-item"><!----> <a href="/md/jvm/jvmti/jvmti介绍和开发.html" class="nav-link">
  jvmti
</a></li><li class="dropdown-item"><!----> <a href="/md/jvm/gc/g1/g1-all-intro.html" class="nav-link">
  G1 GC
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="缓存" class="dropdown-title"><span class="title">缓存</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/cache/redis/redis.html" class="nav-link">
  零基础到高并发应用专家，深入理解redis
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Spring" class="dropdown-title"><span class="title">Spring</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/spring/springboot启动请求处理过程.html" class="nav-link">
  Spring实现
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Kafka" class="dropdown-title"><span class="title">Kafka</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/kafka/kafka.html" class="nav-link">
  kafka
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="MyBatis" class="dropdown-title"><span class="title">MyBatis</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/mybatis/mybatis-use-general.html" class="nav-link">
  MyBatis
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="业务开发" class="dropdown-title"><span class="title">业务开发</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/develop/" class="nav-link">
  业务开发
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="中间件" class="dropdown-title"><span class="title">中间件</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/distribute/raft.html" class="nav-link">
  raft
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="算法" class="dropdown-title"><span class="title">算法</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/algorithm/leetcode.html" class="nav-link">
  算法
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="软技能通用技能" class="dropdown-title"><span class="title">软技能通用技能</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/soft/晋升答辩.html" class="nav-link">
  晋升答辩
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="专栏" class="dropdown-title"><span class="title">专栏</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/column/column.html" class="nav-link">
  订阅我的专栏
</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/liuzhengyang" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>JVM</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/md/jvm/jvm/build-jdk.html" class="sidebar-link">在2024年使用Clion编译、debug、开发Java虚拟机(Mac版本)</a></li><li><a href="/md/jvm/jvm/javaagent.html" class="sidebar-link">javaagent</a></li><li><a href="/md/jvm/jvm/jstack.html" class="sidebar-link">jstack实现原理分析</a></li><li><a href="/md/jvm/jvm/string-deduplication.html" class="sidebar-link">String Deduplication</a></li><li><a href="/md/jvm/jvm/tlab.html" class="sidebar-link">TLAB</a></li><li><a href="/md/jvm/jvm/synchronizer.html" class="sidebar-link">synchronzier</a></li><li><a href="/md/jvm/jvm/monitor.html" class="sidebar-link">synchronized、monitor lock加锁流程</a></li><li><a href="/md/jvm/jvm/virtualthread/virtual-thread.html" aria-current="page" class="active sidebar-link">JDK Virtual Thread的实现</a></li></ul></section></li></ul> </aside> <div><main class="page"> <div class="theme-default-content content__default"><h1 id="jdk-virtual-thread的实现"><a href="#jdk-virtual-thread的实现" class="header-anchor">#</a> JDK Virtual Thread的实现</h1> <h2 id="简介"><a href="#简介" class="header-anchor">#</a> 简介</h2> <p>Virtual Thread是JDK21正式发布的虚拟线程特性，上JDK近年来的一个重大特性。
虚拟线程也可以称为协程、轻量级线程，在以往Java中的线程和内核线程是一对一的，线程数量过多对于内存占用、线程调度、上下文切换等
都带来很多资源开销。为此不得不使用一些其他技术解决，比如NIO、线程池、异步化等，这些技术也带来了开发维护难度高等缺点。
现在JDK提供了可以和golang的goroutine类比的Virtual Thread，相对能够给开发者带来更大的便利。</p> <h2 id="优势"><a href="#优势" class="header-anchor">#</a> 优势</h2> <p>为什么使用协程？</p> <p>使用协程可以更加自由的创建异步代码，在以往我们想实现异步代码时，需要使用线程池，因为线程是开销比较大的资源。
而使用协程，不需要再担心内存、上下文切换等问题。</p> <p>为什么协程的性能比线程更好？</p> <ol><li>切换开销，阻塞唤醒操作从内核改成了用户态控制，减少了用户态内核态切换开销和内核态的调度开销</li> <li>由于协程的底层Carrier线程数和核数相关，在容器场景下，能够控制同一时间使用的核数在有限范围内，从而降低了核数并发非常多时的可能出现的缓存冲突问题。</li> <li>由于底层Carrier线程数和核数相关，在容器场景下，核数不超过容器的CPU配额，所以几乎不会出现CPU节流等问题。相反如果不使用协程，则可能会同时使用超过容器配合数量的CPU，使得linux cgroup的配额超过阈值导致被throttle。</li></ol> <h2 id="核心组件说明"><a href="#核心组件说明" class="header-anchor">#</a> 核心组件说明</h2> <ul><li>VirtualThread, Runnable target: VirtualThread类继承于Thread，重写了Thread.start方法，实现是将Continuation提交到Scheduler。</li> <li>Continuation: Continuation用来存储协程的运行状态，当VirtualThread因为阻塞需要切换时，会把运行栈和运行状态保存到Continuation中。阻塞会调用到Continuation的yield方法保存状态，下次再运行Continuation的run时会从内存中复制运行栈和上下文到线程栈，从而能够继续运行。</li> <li>Scheduler: 调度器，用来运行Continuation。当前Scheduler使用的是ForkJoinPool，支持work steal。</li> <li>Carrier: ForkJoinPool中的线程，也可以称为Worker。Worker线程不断执行ForkJoinPool中的Task，即运行Continuation的run方法。</li></ul> <p><img alt="img.png" data-src="/assets/images/jvm/virtualthread/virtual-thread-1.png" loading="lazy" class="lazy"></p> <h2 id="核心流程"><a href="#核心流程" class="header-anchor">#</a> 核心流程</h2> <ul><li>阻塞(LockSupport.park等)，调用到Continuation.yield0，在jvm内保存栈信息到堆内存(thaw)。</li> <li>thaw也就是yield执行完成后，Worker会从当前的Runnable.run退出</li> <li>Worker会继续执行ForkJoinPool中的本地队列任务，没有任务之后尝试work steal，再没有会park，直到有新任务到来。</li> <li>恢复(LockSupport.unpark等），调用submitRunContinuation把runContinuation放到scheduler调度器（ForkJoinPool）中，等待Worker运行。
<ul><li>Worker运行时，会再次运行run方法也就是Continuation的run方法，通过enterSpecial方法(isContinue参数为true），jvm会从堆内存中复制该VirtualThread的栈到当前线程栈，并从上次的pc开始继续运行，从而完成了VirtualThread的切换。</li></ul></li></ul> <h2 id="一些汇编基础"><a href="#一些汇编基础" class="header-anchor">#</a> 一些汇编基础</h2> <p>线程运行时通过一块内存维护线程的运行栈信息。</p> <p>一些重要的寄存器</p> <ul><li><code>ebp</code>: 指向当前方法的栈基(base pointer)寄存器，base pointer以下（x86汇编中栈是从高位向低位增长的）到esp中间为当前栈的内容范围，在这块内容里能够获取参数、生成临时结果等。</li> <li><code>esp</code>: 指向当前方法栈顶(stack pointer)寄存器，结合push pop等指令能够对栈顶进行读写并修改esp的值</li> <li><code>CS:IP</code>: 指向下一个要运行的指令位置(Code segment, instruction pointer)的寄存器，代码指令位于代码段中，在该代码段中下一个要运行的指令通过偏移表示，整体作为CS:IP寄存器的内容，也是Java中的pc。</li></ul> <p>汇编中能在一个方法中通过call指令调用另一个方法，调用方自动在call指令前保存ip到esp栈顶（并修改esp），被调用方要保存调用方的ebp到栈顶（并修改esp），然后再设置被调用方的ebp为当前的esp的值，再修改esp的值为被调用方法申请调用栈空间。</p> <h2 id="虚拟线程创建、运行"><a href="#虚拟线程创建、运行" class="header-anchor">#</a> 虚拟线程创建、运行</h2> <h3 id="第一次运行时-enterspecial"><a href="#第一次运行时-enterspecial" class="header-anchor">#</a> 第一次运行时（enterSpecial）</h3> <p>VirtualThread中的运行状态保存在Continuation中，Continuation可以理解为可以多次暂停、恢复执行的Runnable。
当VirtualThread因为一些原因需要切换调度时会yield让出资源，在合适的时机再切换回来继续从之前执行的代码位置继续执行。</p> <p>VirtualThread的构造函数，设置scheduler、创建VThreadContinuation对象，保存runContinuation</p> <div class="language-text line-numbers-mode"><pre class="language-text"><code>class VirtualThread {
    private final Executor scheduler;
    private final Continuation cont;
    private final Runnable runContinuation;
    VirtualThread(Executor scheduler, String name, int characteristics, Runnable task) {
        super(name, characteristics, /*bound*/ false);
        if (scheduler == null) {
            Thread parent = Thread.currentThread();
            if (parent instanceof VirtualThread vparent) {
                scheduler = vparent.scheduler;
            } else {
                scheduler = DEFAULT_SCHEDULER;
            }
        }
    
        this.scheduler = scheduler;
        this.cont = new VThreadContinuation(this, task);
        this.runContinuation = this::runContinuation;
    }
    @Override
    void start(ThreadContainer container) {
        // ...
            submitRunContinuation();
        // ...
    }
    private void runContinuation() {
        // ...
        try {
            cont.run();
        } finally {
            if (cont.isDone()) {
                afterTerminate();
            } else {
                afterYield();
            }
        }
    }
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br></div></div><p>在运行完start方法后，调用submitRunContinuation将Continuation::run这个任务提交给Scheduler有Scheduler运行。
在Scheduler运行此任务时，线程栈和寄存器状态如下。</p> <p><img alt="img.png" data-src="/assets/images/jvm/virtualthread/scheduler-run.png" loading="lazy" class="lazy"></p> <p>Continuation的run方法在VirtualThread第一次运行时，会调用enterSpecial，是一个native方法，第二个参数isContinue
表示是否是Continuation非第一次调用run方法</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">class</span> <span class="token class-name">Continuation</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// ...</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token keyword">boolean</span> isVirtualThread <span class="token operator">=</span> <span class="token punctuation">(</span>scope <span class="token operator">==</span> JLA<span class="token punctuation">.</span><span class="token function">virtualThreadContinuationScope</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isStarted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// is this the first run? (at this point we know !done)</span>
                    <span class="token function">enterSpecial</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> isVirtualThread<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token function">enterSpecial</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> isVirtualThread<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token comment">// ...</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@IntrinsicCandidate</span>
    <span class="token keyword">private</span> <span class="token keyword">native</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">enterSpecial</span><span class="token punctuation">(</span><span class="token class-name">Continuation</span> c<span class="token punctuation">,</span> <span class="token keyword">boolean</span> isContinue<span class="token punctuation">,</span> <span class="token keyword">boolean</span> isVirtualThread<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p><code>Continuation.run</code>方法在调用enterSpecial时，run方法会负责将当前run方法的pc保存到线程栈顶，再去执行enterSpecial的代码。
此时esp上方（相对高位）保存了pc（CS:IP的值)、enterSpecial的三个参数。</p> <p><img alt="img.png" data-src="/assets/images/jvm/virtualthread/before-enterspecial.png" loading="lazy" class="lazy"></p> <p>enterSpecial方法的实现在JVM中通过汇编实现，因为需要操作寄存器来控制执的代码、且需要更高的性能。</p> <p><strong><strong><code>sharedRuntime_x86_64.cpp</code></strong></strong></p> <div class="language-text line-numbers-mode"><pre class="language-text"><code>nmethod* SharedRuntime::generate_native_wrapper(MacroAssembler* masm,
                                                const methodHandle&amp;amp; method,
                                                int compile_id,
                                                BasicType* in_sig_bt,
                                                VMRegPair* in_regs,
                                                BasicType ret_type) {
  if (method-&gt;is_continuation_native_intrinsic()) {
  // ...
    if (method-&gt;is_continuation_enter_intrinsic()) {
      gen_continuation_enter(masm,
                             in_regs,
                             exception_offset,
                             oop_maps,
                             frame_complete,
                             stack_slots,
                             interpreted_entry_offset,
                             vep_offset);
    } else if (method-&gt;is_continuation_yield_intrinsic()) {
      gen_continuation_yield(masm,
                             in_regs,
                             oop_maps,
                             frame_complete,
                             stack_slots,
                             vep_offset);
    } else {
      guarantee(false, &quot;Unknown Continuation native intrinsic&quot;);
    }
    // ...
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><p>enterSpecial的代码在<code>gen_continuation_enter</code>中，我们只分析关键的一些指令。</p> <p>resolve定义了一个static方法，这个会解析到Continuation的enter方法。</p> <div class="language-text line-numbers-mode"><pre class="language-text"><code>AddressLiteral resolve(SharedRuntime::get_resolve_static_call_stub(),
                         relocInfo::static_call_type);
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>resolve的过程在<code>sharedRuntime.cpp</code>中，当要解析enterSpecial中调用的static方法时，会直接返回Continuation的enter方法。</p> <div class="language-text line-numbers-mode"><pre class="language-text"><code>Handle SharedRuntime::find_callee_info_helper(vframeStream&amp;amp; vfst, Bytecodes::Code&amp;amp; bc,
                                              CallInfo&amp;amp; callinfo, TRAPS) {
  Handle receiver;
  Handle nullHandle;  // create a handy null handle for exception returns
  JavaThread* current = THREAD;
  methodHandle caller(current, vfst.method());
  int          bci   = vfst.bci();

  if (caller-&gt;is_continuation_enter_intrinsic()) {
    bc = Bytecodes::_invokestatic;
    LinkResolver::resolve_continuation_enter(callinfo, CHECK_NH);
    return receiver;
  }
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p><code>linkResolver.cpp</code></p> <div class="language-text line-numbers-mode"><pre class="language-text"><code>void LinkResolver::resolve_continuation_enter(CallInfo&amp;amp; callinfo, TRAPS) {
  Klass* resolved_klass = vmClasses::Continuation_klass();
  Symbol* method_name = vmSymbols::enter_name();
  Symbol* method_signature = vmSymbols::continuationEnter_signature();
  Klass*  current_klass = resolved_klass;
  LinkInfo link_info(resolved_klass, method_name, method_signature, current_klass);
  Method* resolved_method = resolve_method(link_info, Bytecodes::_invokestatic, CHECK);
  callinfo.set_static(resolved_klass, methodHandle(THREAD, resolved_method), CHECK);
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>接下来enterSpecial先pop pc到rax寄存器，然后读取enterSpecial的三个参数到r1,r2,r3寄存器，读取完后把pc写回到栈上。</p> <div class="language-text line-numbers-mode"><pre class="language-text"><code>__ pop(rax); // return address
// Read interpreter arguments into registers (this is an ad-hoc i2c adapter)
__ movptr(c_rarg1, Address(rsp, Interpreter::stackElementSize*2));
__ movl(c_rarg2,   Address(rsp, Interpreter::stackElementSize*1));
__ movl(c_rarg3,   Address(rsp, Interpreter::stackElementSize*0));
__ andptr(rsp, -16); // Ensure compiled code always sees stack at proper alignment
__ push(rax); // return address
__ push_cont_fastpath();
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>接下来执行enter，enter执行的指令是<code>push(rbp);mov(rbp, rsp);</code>
会将run方法栈帧的栈基rbp保存到栈中，然后设置新的rsp为enterSpecial方法栈的栈基。</p> <div class="language-text line-numbers-mode"><pre class="language-text"><code>__ enter()
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>下面调用continuation_enter_setup方法</p> <div class="language-text line-numbers-mode"><pre class="language-text"><code>stack_slots = 2; // will be adjusted in setup
OopMap* map = continuation_enter_setup(masm, stack_slots);
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>continuation_enter_setup方法会向下调整rsp，以便容纳一个ContinuationEntry, ContinuationEntry中保存continuation entry frame的元数据。
然后保存rsp的值到JavaThread中的_cont_entry指针。
OopMap和gc相关，能够表示哪些位置有对象引用。</p> <div class="language-text line-numbers-mode"><pre class="language-text"><code>static OopMap* continuation_enter_setup(MacroAssembler* masm, int&amp;amp; stack_slots) {
  stack_slots += checked_cast&amp;lt;int&gt;(ContinuationEntry::size()) / wordSize;
  __ subptr(rsp, checked_cast&amp;lt;int32_t&gt;(ContinuationEntry::size()));
  int frame_size = (checked_cast&amp;lt;int&gt;(ContinuationEntry::size()) + wordSize) / VMRegImpl::stack_slot_size;
  OopMap* map = new OopMap(frame_size, 0);
  __ movptr(rax, Address(r15_thread, JavaThread::cont_entry_offset()));
  __ movptr(Address(rsp, ContinuationEntry::parent_offset()), rax);
  __ movptr(Address(r15_thread, JavaThread::cont_entry_offset()), rsp);
  return map;
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>然后fill_continuation_entry会填充ContinuationEntry区域数据</p> <p><img alt="img.png" data-src="/assets/images/jvm/virtualthread/fill_continuation_entry.png" loading="lazy" class="lazy"></p> <p>再判断是否是continue，Continuation第一次运行run时是false，否则为true，如果是true，则走L_thaw分支走解冻流程。
当前我们按照isContinue为false看第一次运行流程。</p> <p>下面执行<code>call(resolve)</code>，调用enter方法, enter方法调用enter0，再调用target(VirtualThread的Runnable代码定义）的run方法。</p> <div class="language-text line-numbers-mode"><pre class="language-text"><code> __ call(resolve);
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><img alt="img.png" data-src="/assets/images/jvm/virtualthread/continuation-enter.png" loading="lazy" class="lazy"></p> <h3 id="遇到需要yield的情况"><a href="#遇到需要yield的情况" class="header-anchor">#</a> 遇到需要yield的情况</h3> <p>直到遇到需要切换VirtualThread的场景，比如阻塞，jdk中将相关阻塞逻辑修改成调用Continuation的yield方法，目的当前的VirtualThread因为一些原因不能
继续执行代码比如因为锁等待，让出cpu资源，让Carrier能够去 执行其他的VirtualThread。</p> <p>doYield方法类似enterSpecial，也是通过汇编生成代码的方法。
核心流程为</p> <ul><li><code>enter</code>: 记录rbp</li> <li><code>movptr(c_rarg0, r15_thread)</code>： r0寄存器指向当前线程</li> <li><code>movptr(c_rarg1, rsp)</code>: 将r1寄存器指向rsp（当前实际上当前和rbp一致，因为yield栈内还没有数据）</li> <li><code>call_VM_leaf(Continuation::freeze_entry(), 2)</code>: 调用Continuation的freeze_entry方法将VirtualThread的线程栈保存到堆内存。</li></ul> <div class="language-text line-numbers-mode"><pre class="language-text"><code>static void gen_continuation_yield(MacroAssembler* masm,
                                   const VMRegPair* regs,
                                   OopMapSet* oop_maps,
                                   int&amp;amp; frame_complete,
                                   int&amp;amp; stack_slots,
                                   int&amp;amp; compiled_entry_offset) {
  // ...
  __ enter();

  __ set_last_Java_frame(rsp, rbp, the_pc, rscratch1);
  __ movptr(c_rarg0, r15_thread);
  __ movptr(c_rarg1, rsp);
  __ call_VM_leaf(Continuation::freeze_entry(), 2);
  __ reset_last_Java_frame(true);
  // ...
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>调用freeze_entry时，doYield方法会将自己的pc入栈。</p> <p>freeze_entry方法将_cont_entry到前面保存的rsp之间的内存栈（也就是属于VirtualThread代码的栈到doYield之间的线程栈，不包含doYield栈帧）复制到堆内存，
并通过Continuation中的StackChunk类型的tail字段引用。</p> <p><img alt="img.png" data-src="/assets/images/jvm/virtualthread/freeze-entry.png" loading="lazy" class="lazy"></p> <p>调用完freeze_entry后，会判断freeze_entry的结果，如果发生pinned（比如有synchronized加锁），则进入L_pinned分支。</p> <p>否则继续执行doYield剩下来的指令，先把rsp设置为之前保存的进入enter方法时的rsp（在JavaThread的_cont_entry字段保存)，然后调用continuation_enter_cleanup，continuation_enter_cleanup会给rsp增加使其跳过ContinuationEntry部分。
rsp会指向Continuation:run的rbp，通过<code>pop(rbp)</code>恢复Continuation:run方法的rbp寄存器，<code>ret(0)</code>恢复Continuation:run方法调用enterSpecial的CS:IP寄存器，
从而能够实现继续执行Continuation:run中的代码，Continuation:run方法执行完成后，Worker会继续执行ForkJoinPool中的其他任务（其他VirtualThread的Continuation代码）</p> <p><img alt="img.png" data-src="/assets/images/jvm/virtualthread/after-freeze.png" loading="lazy" class="lazy"></p> <div class="language-text line-numbers-mode"><pre class="language-text"><code>__ reset_last_Java_frame(true);

Label L_pinned;

__ testptr(rax, rax);
__ jcc(Assembler::notZero, L_pinned);

__ movptr(rsp, Address(r15_thread, JavaThread::cont_entry_offset()));
continuation_enter_cleanup(masm);
__ pop(rbp);
__ ret(0);
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h3 id="yield结束需要切换回来时"><a href="#yield结束需要切换回来时" class="header-anchor">#</a> yield结束需要切换回来时</h3> <p>当阻塞等待的条件已经满足（比如锁释放、IO事件抵达、超时时间到达等），VirtualThread会被唤醒（比如通过LockSupport的unpark），
unpark会将该VirtualThread的Continuation对象重新加入到scheduler调度器中运行。</p> <p>在scheduler再次运行该Continuation的run方法时，还会走到enterSpecial方法，但是isContinue参数会是true。</p> <div class="language-text line-numbers-mode"><pre class="language-text"><code>if (!isStarted()) { // is this the first run? (at this point we know !done)
    enterSpecial(this, false, isVirtualThread);
} else {
    enterSpecial(this, true, isVirtualThread);
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>此时会走到enterSpecial汇编的L_thaw分支。</p> <div class="language-text line-numbers-mode"><pre class="language-text"><code>// If continuation, call to thaw. Otherwise, resolve the call and exit.
__ testptr(reg_is_cont, reg_is_cont);
__ jcc(Assembler::notZero, L_thaw);
// ...
__ bind(L_thaw);
__ call(RuntimeAddress(StubRoutines::cont_thaw()));
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p><code>call(RuntimeAddress(StubRoutines::cont_thaw()))</code>执行cont_thaw指令。
cont_thaw通过汇编生成。</p> <p>先调用prepare_thaw做一些状态检查。</p> <div class="language-text line-numbers-mode"><pre class="language-text"><code>__ movptr(c_rarg0, r15_thread);
__ movptr(c_rarg1, (return_barrier ? 1 : 0));
__ call_VM_leaf(CAST_FROM_FN_PTR(address, Continuation::prepare_thaw), 2);
__ movptr(rbx, rax);
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>再调用Continuation::thaw_entry把堆内存中保存的栈复制到当前线程栈。</p> <div class="language-text line-numbers-mode"><pre class="language-text"><code>// If we want, we can templatize thaw by kind, and have three different entries.
__ movptr(c_rarg0, r15_thread);
__ movptr(c_rarg1, kind);
__ call_VM_leaf(Continuation::thaw_entry(), 2);
__ movptr(rbx, rax);
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><div class="language-text line-numbers-mode"><pre class="language-text"><code>frame caller; // the thawed caller on the stack
recurse_thaw(heap_frame, caller, num_frames, true);
finish_thaw(caller); // caller is now the topmost thawed frame
_cont.write();
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p><img alt="img.png" data-src="/assets/images/jvm/virtualthread/after-thaw.png" loading="lazy" class="lazy"></p> <p>thaw完成后，修改rsp为最后一个yielding的frame，再给rsp减2个word，这里面存放了pc和rbp，然后pop(rbp)，在ret(0)就能继续Continuation
之前的代码继续运行了。</p> <div class="language-text line-numbers-mode"><pre class="language-text"><code>// After thawing, rbx is the SP of the yielding frame.
// Move there, and then to saved RBP slot.
__ movptr(rsp, rbx);
__ subptr(rsp, 2*wordSize);
// ...
// We are &quot;returning&quot; into the topmost thawed frame; see Thaw::push_return_frame
__ pop(rbp);
__ ret(0);
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p><img alt="img.png" data-src="/assets/images/jvm/virtualthread/thaw-finish.png" loading="lazy" class="lazy"></p> <h2 id="虚拟线程park阻塞的处理"><a href="#虚拟线程park阻塞的处理" class="header-anchor">#</a> 虚拟线程park阻塞的处理</h2> <p>对于可能导致线程阻塞的位置，比如<code>Thread.sleep</code>、<code>LockSupport.park</code>，
JDK都会判断当前的线程是否是VirtualThread，如果是，会进行VirtualThread切换，切换底层的线程去运行其他的VirtualThread。
等待阻塞结束后再切换回来，这时就需要模拟操作系统的线程切换，要记录线程切换前的运行上下文，以便切换回来后能继续运行。
上下文包含线程的栈帧、程序计数器。
在JDK VirtualThread的设计中，栈切换是通过复制的方式实现的，即从A切换到B时，会将A的栈复制到一个共享栈池中，等切换回来再复制回来，
这种设计在切换时开销相对更大，优点是能够同时容纳海量的VirtualThread。在Wisp的协程中，每个协程有自己独立的栈空间，切换时没有复制开销。</p> <p>目前的局限性</p> <ul><li>如果当前线程持有synchronized锁，无法进行切换</li> <li>如果当前线程栈中有native方法，无法进行切换</li></ul> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">class</span> <span class="token class-name">LockSupport</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">park</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isVirtual</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">VirtualThreads</span><span class="token punctuation">.</span><span class="token function">park</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">park</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token number">0L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>VirtualThread的park调用Continuation的yield静态方法、yield最终调用到<code>doYield()</code>这个native方法。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">class</span> <span class="token class-name">VirtualThread</span> <span class="token punctuation">{</span>
    <span class="token keyword">void</span> <span class="token function">park</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            yielded <span class="token operator">=</span> <span class="token function">yieldContinuation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// may throw</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        <span class="token comment">// ...</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@Hidden</span>
    <span class="token annotation punctuation">@ChangesCurrentThread</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">yieldContinuation</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token class-name">Continuation</span><span class="token punctuation">.</span><span class="token keyword">yield</span><span class="token punctuation">(</span>VTHREAD_SCOPE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> 
        <span class="token comment">// ...</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">class</span> <span class="token class-name">Continuation</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Hidden</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> <span class="token keyword">yield</span><span class="token punctuation">(</span><span class="token class-name">ContinuationScope</span> scope<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Continuation</span> cont <span class="token operator">=</span> JLA<span class="token punctuation">.</span><span class="token function">getContinuation</span><span class="token punctuation">(</span><span class="token function">currentCarrierThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Continuation</span> c<span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>c <span class="token operator">=</span> cont<span class="token punctuation">;</span> c <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> c<span class="token punctuation">.</span>scope <span class="token operator">!=</span> scope<span class="token punctuation">;</span> c <span class="token operator">=</span> c<span class="token punctuation">.</span>parent<span class="token punctuation">)</span>
            <span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">&quot;Not in scope &quot;</span> <span class="token operator">+</span> scope<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> cont<span class="token punctuation">.</span><span class="token function">yield0</span><span class="token punctuation">(</span>scope<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@Hidden</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">yield0</span><span class="token punctuation">(</span><span class="token class-name">ContinuationScope</span> scope<span class="token punctuation">,</span> <span class="token class-name">Continuation</span> child<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// ...</span>
        <span class="token keyword">int</span> res <span class="token operator">=</span> <span class="token function">doYield</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// ...</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@IntrinsicCandidate</span>
    <span class="token keyword">private</span> <span class="token keyword">native</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">doYield</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>doYield是由jvm通过汇编生成的方法， x86_64的实现在sharedRuntime_x86_64.cpp中</p> <p>有如下关键步骤</p> <ul><li><code>__ enter();</code>: 会生成<code>push(rbp); mov(rbp, rsp);</code>即保存调用函数的栈基到栈中，将rsp的值赋值到rbp。</li> <li><code>movptr(c_rarg0, r15_thread); movptr(c_rarg1, rsp)</code>：用于将当前线程(virtualthread)和rsp保存到调用freeze方法的参数上</li> <li><code>call_VM_leaf(Continuation::freeze_entry(), 2);</code> : 调用freeze_entry，freeze_entry会把VirtualThread运行的栈复制到堆内存。</li> <li><code>testptr(rax, rax)</code>; jcc(Assembler::notZero, L_pinned): 检查freeze的返回值是否是0，如果不是0，则走到L_pinned分支即yield因为synchronized等原因pinned住了</li> <li><code>movptr(rsp, Address(r15_thread, JavaThread::cont_entry_offset()));</code>：设置rsp寄存器的值为当前线程的cont_entry_offset值，这个值指向Continuation第一次运行时的enterSpecial方法的栈顶，所以完成yield后会继续enterSpecial的运行。</li> <li><code>continuation_enter_cleanup</code>: 调整rsp，跳过ContinuationEntry</li> <li><code>pop(rbp)</code>: 弹出栈顶数据并设置到rbp</li> <li><code>ret(0)</code>: 弹出eip到CS:IP寄存器，从而能够继续enterSpecial方法的调用。</li></ul> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">gen_continuation_yield</span><span class="token punctuation">(</span><span class="token class-name">MacroAssembler</span><span class="token operator">*</span> masm<span class="token punctuation">,</span>
                                   <span class="token keyword">const</span> <span class="token class-name">VMRegPair</span><span class="token operator">*</span> regs<span class="token punctuation">,</span>
                                   <span class="token class-name">OopMapSet</span><span class="token operator">*</span> oop_maps<span class="token punctuation">,</span>
                                   <span class="token keyword">int</span><span class="token operator">&amp;</span> frame_complete<span class="token punctuation">,</span>
                                   <span class="token keyword">int</span><span class="token operator">&amp;</span> stack_slots<span class="token punctuation">,</span>
                                   <span class="token keyword">int</span><span class="token operator">&amp;</span> compiled_entry_offset<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">enum</span> layout <span class="token punctuation">{</span>
    rbp_off<span class="token punctuation">,</span>
    rbpH_off<span class="token punctuation">,</span>
    return_off<span class="token punctuation">,</span>
    return_off2<span class="token punctuation">,</span>
    framesize <span class="token comment">// inclusive of return address</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  stack_slots <span class="token operator">=</span> framesize <span class="token operator">/</span>  <span class="token class-name">VMRegImpl</span><span class="token operator">::</span><span class="token function">slots_per_word</span><span class="token punctuation">;</span>
  <span class="token keyword">assert</span><span class="token punctuation">(</span>stack_slots <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">&quot;recheck layout&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  address start <span class="token operator">=</span> __ <span class="token function">pc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  compiled_entry_offset <span class="token operator">=</span> __ <span class="token function">pc</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start<span class="token punctuation">;</span>
  __ <span class="token function">enter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  address the_pc <span class="token operator">=</span> __ <span class="token function">pc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  frame_complete <span class="token operator">=</span> the_pc <span class="token operator">-</span> start<span class="token punctuation">;</span>

  <span class="token comment">// This nop must be exactly at the PC we push into the frame info.</span>
  <span class="token comment">// We use this nop for fast CodeBlob lookup, associate the OopMap</span>
  <span class="token comment">// with it right away.</span>
  __ <span class="token function">post_call_nop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">OopMap</span><span class="token operator">*</span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OopMap</span><span class="token punctuation">(</span>framesize<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  oop_maps<span class="token operator">-&gt;</span><span class="token function">add_gc_map</span><span class="token punctuation">(</span>frame_complete<span class="token punctuation">,</span> map<span class="token punctuation">)</span><span class="token punctuation">;</span>

  __ <span class="token function">set_last_Java_frame</span><span class="token punctuation">(</span>rsp<span class="token punctuation">,</span> rbp<span class="token punctuation">,</span> the_pc<span class="token punctuation">,</span> rscratch1<span class="token punctuation">)</span><span class="token punctuation">;</span>
  __ <span class="token function">movptr</span><span class="token punctuation">(</span>c_rarg0<span class="token punctuation">,</span> r15_thread<span class="token punctuation">)</span><span class="token punctuation">;</span>
  __ <span class="token function">movptr</span><span class="token punctuation">(</span>c_rarg1<span class="token punctuation">,</span> rsp<span class="token punctuation">)</span><span class="token punctuation">;</span>
  __ <span class="token function">call_VM_leaf</span><span class="token punctuation">(</span><span class="token class-name">Continuation</span><span class="token operator">::</span><span class="token function">freeze_entry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  __ <span class="token function">reset_last_Java_frame</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token class-name">Label</span> <span class="token class-name">L_pinned</span><span class="token punctuation">;</span>

  __ <span class="token function">testptr</span><span class="token punctuation">(</span>rax<span class="token punctuation">,</span> rax<span class="token punctuation">)</span><span class="token punctuation">;</span>
  __ <span class="token function">jcc</span><span class="token punctuation">(</span><span class="token class-name">Assembler</span><span class="token operator">::</span><span class="token function">notZero</span><span class="token punctuation">,</span> <span class="token class-name">L_pinned</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  __ <span class="token function">movptr</span><span class="token punctuation">(</span>rsp<span class="token punctuation">,</span> <span class="token class-name">Address</span><span class="token punctuation">(</span>r15_thread<span class="token punctuation">,</span> <span class="token class-name">JavaThread</span><span class="token operator">::</span><span class="token function">cont_entry_offset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">continuation_enter_cleanup</span><span class="token punctuation">(</span>masm<span class="token punctuation">)</span><span class="token punctuation">;</span>
  __ <span class="token function">pop</span><span class="token punctuation">(</span>rbp<span class="token punctuation">)</span><span class="token punctuation">;</span>
  __ <span class="token function">ret</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  __ <span class="token function">bind</span><span class="token punctuation">(</span><span class="token class-name">L_pinned</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Pinned, return to caller</span>

  <span class="token comment">// handle pending exception thrown by freeze</span>
  __ <span class="token function">cmpptr</span><span class="token punctuation">(</span><span class="token class-name">Address</span><span class="token punctuation">(</span>r15_thread<span class="token punctuation">,</span> <span class="token class-name">Thread</span><span class="token operator">::</span><span class="token function">pending_exception_offset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> NULL_WORD<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">Label</span> ok<span class="token punctuation">;</span>
  __ <span class="token function">jcc</span><span class="token punctuation">(</span><span class="token class-name">Assembler</span><span class="token operator">::</span><span class="token function">equal</span><span class="token punctuation">,</span> ok<span class="token punctuation">)</span><span class="token punctuation">;</span>
  __ <span class="token function">leave</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  __ <span class="token function">jump</span><span class="token punctuation">(</span><span class="token class-name">RuntimeAddress</span><span class="token punctuation">(</span><span class="token class-name">StubRoutines</span><span class="token operator">::</span><span class="token function">forward_exception_entry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  __ <span class="token function">bind</span><span class="token punctuation">(</span>ok<span class="token punctuation">)</span><span class="token punctuation">;</span>

  __ <span class="token function">leave</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  __ <span class="token function">ret</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br></div></div><p>汇编中</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>__ <span class="token function">movptr</span><span class="token punctuation">(</span>c_rarg0<span class="token punctuation">,</span> r15_thread<span class="token punctuation">)</span><span class="token punctuation">;</span>
__ <span class="token function">movptr</span><span class="token punctuation">(</span>c_rarg1<span class="token punctuation">,</span> rsp<span class="token punctuation">)</span><span class="token punctuation">;</span>
__ <span class="token function">call_VM_leaf</span><span class="token punctuation">(</span><span class="token class-name">Continuation</span><span class="token operator">::</span><span class="token function">freeze_entry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
__ <span class="token function">reset_last_Java_frame</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>是将当前的线程对象(VirtualThread)和rsp(pc即程序计数器，记录程序运行到的代码位置)作为参数
调用<code>Continuation::freeze_entry()</code>，目的是保存当前的线程栈和pc。
freeze即冻结的意思，在yield即VirtualThread希望进行切换调度时运行，对应的解冻操作是thaw，会在unpark时调用。</p> <div class="language-text line-numbers-mode"><pre class="language-text"><code> freeze_entry = (address)freeze&amp;lt;SelectedConfigT&gt;;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// Entry point to freeze. Transitions are handled manually</span>
<span class="token comment">// Called from gen_continuation_yield() in sharedRuntime_&lt;cpu&gt;.cpp through Continuation::freeze_entry();</span>
template<span class="token generics"><span class="token punctuation">&lt;</span>typename <span class="token class-name">ConfigT</span><span class="token punctuation">&gt;</span></span>
<span class="token keyword">static</span> <span class="token function">JRT_BLOCK_ENTRY</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token function">freeze</span><span class="token punctuation">(</span><span class="token class-name">JavaThread</span><span class="token operator">*</span> current<span class="token punctuation">,</span> intptr_t<span class="token operator">*</span> sp<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token keyword">assert</span><span class="token punctuation">(</span>sp <span class="token operator">==</span> current<span class="token operator">-&gt;</span><span class="token function">frame_anchor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">last_Java_sp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>current<span class="token operator">-&gt;</span><span class="token function">raw_cont_fastpath</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> current<span class="token operator">-&gt;</span><span class="token function">last_continuation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">entry_sp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> current<span class="token operator">-&gt;</span><span class="token function">raw_cont_fastpath</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> sp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    current<span class="token operator">-&gt;</span><span class="token function">set_cont_fastpath</span><span class="token punctuation">(</span>nullptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token class-name">ConfigT</span><span class="token operator">::</span><span class="token function">freeze</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> sp<span class="token punctuation">)</span><span class="token punctuation">;</span>
JRT_END
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">enum</span> <span class="token keyword">class</span> oop_kind <span class="token punctuation">{</span> NARROW<span class="token punctuation">,</span> WIDE <span class="token punctuation">}</span><span class="token punctuation">;</span>
template <span class="token generics"><span class="token punctuation">&lt;</span>oop_kind oops<span class="token punctuation">,</span> typename <span class="token class-name">BarrierSetT</span><span class="token punctuation">&gt;</span></span>
<span class="token keyword">class</span> <span class="token class-name">Config</span> <span class="token punctuation">{</span>
<span class="token keyword">public</span><span class="token operator">:</span>
  typedef <span class="token class-name">Config</span><span class="token generics"><span class="token punctuation">&lt;</span>oops<span class="token punctuation">,</span> <span class="token class-name">BarrierSetT</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">SelfT</span><span class="token punctuation">;</span>
  using <span class="token class-name">OopT</span> <span class="token operator">=</span> std<span class="token operator">::</span><span class="token function">conditional_t</span><span class="token operator">&lt;</span>oops <span class="token operator">==</span> oop_kind<span class="token operator">::</span>NARROW<span class="token punctuation">,</span> narrowOop<span class="token punctuation">,</span> oop<span class="token operator">&gt;</span><span class="token punctuation">;</span>

  <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">freeze</span><span class="token punctuation">(</span><span class="token class-name">JavaThread</span><span class="token operator">*</span> thread<span class="token punctuation">,</span> intptr_t<span class="token operator">*</span> <span class="token keyword">const</span> sp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> freeze_internal<span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SelfT</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>thread<span class="token punctuation">,</span> sp<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">static</span> intptr_t<span class="token operator">*</span> <span class="token function">thaw</span><span class="token punctuation">(</span><span class="token class-name">JavaThread</span><span class="token operator">*</span> thread<span class="token punctuation">,</span> <span class="token class-name">Continuation</span><span class="token operator">::</span><span class="token function">thaw_kind</span> kind<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> thaw_internal<span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SelfT</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>thread<span class="token punctuation">,</span> kind<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>freeze_internal会判断</p> <ul><li>如果当前continuation持有monitor lock，返回pinned状态，目前版本VirtualThread不能在synchronized加锁过程中yield，如果有阻塞操作，底层的CarrierThread也会阻塞。</li> <li>判断能否使用fast freeze，如果可以调用freeze_fast_existing_chunk</li></ul> <div class="language-java line-numbers-mode"><pre class="language-java"><code>template<span class="token generics"><span class="token punctuation">&lt;</span>typename <span class="token class-name">ConfigT</span><span class="token punctuation">&gt;</span></span>
<span class="token keyword">static</span> inline <span class="token keyword">int</span> <span class="token function">freeze_internal</span><span class="token punctuation">(</span><span class="token class-name">JavaThread</span><span class="token operator">*</span> current<span class="token punctuation">,</span> intptr_t<span class="token operator">*</span> <span class="token keyword">const</span> sp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">assert</span><span class="token punctuation">(</span><span class="token operator">!</span>current<span class="token operator">-&gt;</span><span class="token function">has_pending_exception</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

#ifdef <span class="token class-name">ASSERT</span>
  <span class="token function">log_trace</span><span class="token punctuation">(</span>continuations<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token string">&quot;~~~~ freeze sp: &quot;</span> INTPTR_FORMAT<span class="token punctuation">,</span> <span class="token function">p2i</span><span class="token punctuation">(</span>current<span class="token operator">-&gt;</span><span class="token function">last_continuation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">entry_sp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">log_frames</span><span class="token punctuation">(</span>current<span class="token punctuation">)</span><span class="token punctuation">;</span>
#endif

  <span class="token function">CONT_JFR_ONLY</span><span class="token punctuation">(</span><span class="token class-name">EventContinuationFreeze</span> event<span class="token punctuation">;</span><span class="token punctuation">)</span>

  <span class="token class-name">ContinuationEntry</span><span class="token operator">*</span> entry <span class="token operator">=</span> current<span class="token operator">-&gt;</span><span class="token function">last_continuation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  oop oopCont <span class="token operator">=</span> entry<span class="token operator">-&gt;</span><span class="token function">cont_oop</span><span class="token punctuation">(</span>current<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">assert</span><span class="token punctuation">(</span>oopCont <span class="token operator">==</span> current<span class="token operator">-&gt;</span><span class="token function">last_continuation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">cont_oop</span><span class="token punctuation">(</span>current<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">assert</span><span class="token punctuation">(</span><span class="token class-name">ContinuationEntry</span><span class="token operator">::</span><span class="token function">assert_entry_frame_laid_out</span><span class="token punctuation">(</span>current<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">verify_continuation</span><span class="token punctuation">(</span>oopCont<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">ContinuationWrapper</span> <span class="token function">cont</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> oopCont<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">log_develop_debug</span><span class="token punctuation">(</span>continuations<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token string">&quot;FREEZE #&quot;</span> INTPTR_FORMAT <span class="token string">&quot; &quot;</span> INTPTR_FORMAT<span class="token punctuation">,</span> cont<span class="token punctuation">.</span><span class="token function">hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">p2i</span><span class="token punctuation">(</span><span class="token punctuation">(</span>oopDesc<span class="token operator">*</span><span class="token punctuation">)</span>oopCont<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">assert</span><span class="token punctuation">(</span>entry<span class="token operator">-&gt;</span><span class="token function">is_virtual_thread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token punctuation">(</span>entry<span class="token operator">-&gt;</span><span class="token function">scope</span><span class="token punctuation">(</span>current<span class="token punctuation">)</span> <span class="token operator">==</span> java_lang_VirtualThread<span class="token operator">::</span><span class="token function">vthread_scope</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">assert</span><span class="token punctuation">(</span><span class="token function">monitors_on_stack</span><span class="token punctuation">(</span>current<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>current<span class="token operator">-&gt;</span><span class="token function">held_monitor_count</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> current<span class="token operator">-&gt;</span><span class="token function">jni_monitor_count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
         <span class="token string">&quot;Held monitor count and locks on stack invariant: &quot;</span> INT64_FORMAT <span class="token string">&quot; JNI: &quot;</span> INT64_FORMAT<span class="token punctuation">,</span> <span class="token punctuation">(</span>int64_t<span class="token punctuation">)</span>current<span class="token operator">-&gt;</span><span class="token function">held_monitor_count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>int64_t<span class="token punctuation">)</span>current<span class="token operator">-&gt;</span><span class="token function">jni_monitor_count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>entry<span class="token operator">-&gt;</span><span class="token function">is_pinned</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> current<span class="token operator">-&gt;</span><span class="token function">held_monitor_count</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">log_develop_debug</span><span class="token punctuation">(</span>continuations<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token string">&quot;PINNED due to critical section/hold monitor&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">verify_continuation</span><span class="token punctuation">(</span>cont<span class="token punctuation">.</span><span class="token function">continuation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    freeze_result res <span class="token operator">=</span> entry<span class="token operator">-&gt;</span><span class="token function">is_pinned</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> freeze_pinned_cs <span class="token operator">:</span> freeze_pinned_monitor<span class="token punctuation">;</span>
    <span class="token function">log_develop_trace</span><span class="token punctuation">(</span>continuations<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token string">&quot;=== end of freeze (fail %d)&quot;</span><span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> res<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token class-name">Freeze</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ConfigT</span><span class="token punctuation">&gt;</span></span> <span class="token function">freeze</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> cont<span class="token punctuation">,</span> sp<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// There are no interpreted frames if we're not called from the interpreter and we haven't ancountered an i2c</span>
  <span class="token comment">// adapter or called Deoptimization::unpack_frames. Calls from native frames also go through the interpreter</span>
  <span class="token comment">// (see JavaCalls::call_helper).</span>
  <span class="token keyword">assert</span><span class="token punctuation">(</span><span class="token operator">!</span>current<span class="token operator">-&gt;</span><span class="token function">cont_fastpath</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
         <span class="token operator">||</span> <span class="token punctuation">(</span>current<span class="token operator">-&gt;</span><span class="token function">cont_fastpath_thread_state</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>freeze<span class="token punctuation">.</span><span class="token function">interpreted_native_or_deoptimized_on_stack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  bool fast <span class="token operator">=</span> <span class="token class-name">UseContinuationFastPath</span> <span class="token operator">&amp;&amp;</span> current<span class="token operator">-&gt;</span><span class="token function">cont_fastpath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>fast <span class="token operator">&amp;&amp;</span> freeze<span class="token punctuation">.</span><span class="token function">size_if_fast_freeze_available</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    freeze<span class="token punctuation">.</span><span class="token function">freeze_fast_existing_chunk</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">CONT_JFR_ONLY</span><span class="token punctuation">(</span>freeze<span class="token punctuation">.</span><span class="token function">jfr_info</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">post_jfr_event</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>event<span class="token punctuation">,</span> oopCont<span class="token punctuation">,</span> current<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">)</span>
    <span class="token function">freeze_epilog</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> cont<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">log_develop_trace</span><span class="token punctuation">(</span>continuations<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token string">&quot;chunk unavailable; transitioning to VM&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">assert</span><span class="token punctuation">(</span>current <span class="token operator">==</span> <span class="token class-name">JavaThread</span><span class="token operator">::</span><span class="token function">current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;must be current thread except for preempt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  JRT_BLOCK
    <span class="token comment">// delays a possible JvmtiSampledObjectAllocEventCollector in alloc_chunk</span>
    <span class="token class-name">JvmtiSampledObjectAllocEventCollector</span> <span class="token function">jsoaec</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    freeze<span class="token punctuation">.</span><span class="token function">set_jvmti_event_collector</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>jsoaec<span class="token punctuation">)</span><span class="token punctuation">;</span>

    freeze_result res <span class="token operator">=</span> fast <span class="token operator">?</span> freeze<span class="token punctuation">.</span><span class="token function">try_freeze_fast</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> freeze<span class="token punctuation">.</span><span class="token function">freeze_slow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">CONT_JFR_ONLY</span><span class="token punctuation">(</span>freeze<span class="token punctuation">.</span><span class="token function">jfr_info</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">post_jfr_event</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>event<span class="token punctuation">,</span> oopCont<span class="token punctuation">,</span> current<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">)</span>
    <span class="token function">freeze_epilog</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> cont<span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span>
    cont<span class="token punctuation">.</span><span class="token function">done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// allow safepoint in the transition back to Java</span>
    <span class="token keyword">return</span> res<span class="token punctuation">;</span>
  JRT_BLOCK_END
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br></div></div><div class="language-java line-numbers-mode"><pre class="language-java"><code>NOINLINE freeze_result <span class="token class-name">FreezeBase</span><span class="token operator">::</span><span class="token function">freeze_slow</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
#ifdef ASSERT
  <span class="token class-name">ResourceMark</span> rm<span class="token punctuation">;</span>
#endif

  <span class="token function">log_develop_trace</span><span class="token punctuation">(</span>continuations<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token string">&quot;freeze_slow  #&quot;</span> INTPTR_FORMAT<span class="token punctuation">,</span> _cont<span class="token punctuation">.</span><span class="token function">hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">assert</span><span class="token punctuation">(</span>_thread<span class="token operator">-&gt;</span><span class="token function">thread_state</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> _thread_in_vm <span class="token operator">||</span> _thread<span class="token operator">-&gt;</span><span class="token function">thread_state</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> _thread_blocked<span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

#<span class="token keyword">if</span> CONT_JFR
  <span class="token class-name">EventContinuationFreezeSlow</span> e<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">should_commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    e<span class="token punctuation">.</span><span class="token function">set_id</span><span class="token punctuation">(</span>cast_from_oop<span class="token generics"><span class="token punctuation">&lt;</span>u8<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>_cont<span class="token punctuation">.</span><span class="token function">continuation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    e<span class="token punctuation">.</span><span class="token function">commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
#endif

  <span class="token function">init_rest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token class-name">HandleMark</span> <span class="token function">hm</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token operator">::</span><span class="token function">current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  frame f <span class="token operator">=</span> <span class="token function">freeze_start_frame</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token class-name">LogTarget</span><span class="token punctuation">(</span><span class="token class-name">Debug</span><span class="token punctuation">,</span> continuations<span class="token punctuation">)</span> lt<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>lt<span class="token punctuation">.</span><span class="token function">develop_is_enabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">LogStream</span> <span class="token function">ls</span><span class="token punctuation">(</span>lt<span class="token punctuation">)</span><span class="token punctuation">;</span>
    f<span class="token punctuation">.</span><span class="token function">print_on</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ls<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  frame caller<span class="token punctuation">;</span> <span class="token comment">// the frozen caller in the chunk</span>
  freeze_result res <span class="token operator">=</span> <span class="token function">recurse_freeze</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> caller<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>res <span class="token operator">==</span> freeze_ok<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">finish_freeze</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> caller<span class="token punctuation">)</span><span class="token punctuation">;</span>
    _cont<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> res<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br></div></div><p>continuation_enter_cleanup实现</p> <div class="language-text line-numbers-mode"><pre class="language-text"><code>void static continuation_enter_cleanup(MacroAssembler* masm) {
#ifdef ASSERT
  Label L_good_sp;
  __ cmpptr(rsp, Address(r15_thread, JavaThread::cont_entry_offset()));
  __ jcc(Assembler::equal, L_good_sp);
  __ stop(&quot;Incorrect rsp at continuation_enter_cleanup&quot;);
  __ bind(L_good_sp);
#endif

  __ movptr(rbx, Address(rsp, ContinuationEntry::parent_cont_fastpath_offset()));
  __ movptr(Address(r15_thread, JavaThread::cont_fastpath_offset()), rbx);
  __ movq(rbx, Address(rsp, ContinuationEntry::parent_held_monitor_count_offset()));
  __ movq(Address(r15_thread, JavaThread::held_monitor_count_offset()), rbx);

  __ movptr(rbx, Address(rsp, ContinuationEntry::parent_offset()));
  __ movptr(Address(r15_thread, JavaThread::cont_entry_offset()), rbx);
  __ addptr(rsp, checked_cast&amp;lt;int32_t&gt;(ContinuationEntry::size()));
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><h3 id="enterspecial"><a href="#enterspecial" class="header-anchor">#</a> enterSpecial</h3> <p>Continuation的enterSpecial</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@IntrinsicCandidate</span>
<span class="token keyword">private</span> <span class="token keyword">native</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">enterSpecial</span><span class="token punctuation">(</span><span class="token class-name">Continuation</span> c<span class="token punctuation">,</span> <span class="token keyword">boolean</span> isContinue<span class="token punctuation">,</span> <span class="token keyword">boolean</span> isVirtualThread<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Hidden</span>
<span class="token annotation punctuation">@DontInline</span>
<span class="token annotation punctuation">@IntrinsicCandidate</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">enter</span><span class="token punctuation">(</span><span class="token class-name">Continuation</span> c<span class="token punctuation">,</span> <span class="token keyword">boolean</span> isContinue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// This method runs in the &quot;entry frame&quot;.</span>
    <span class="token comment">// A yield jumps to this method's caller as if returning from this method.</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        c<span class="token punctuation">.</span><span class="token function">enter0</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        c<span class="token punctuation">.</span><span class="token function">finish</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Hidden</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">enter0</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    target<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">gen_continuation_enter</span><span class="token punctuation">(</span><span class="token class-name">MacroAssembler</span><span class="token operator">*</span> masm<span class="token punctuation">,</span>
                                   <span class="token keyword">const</span> <span class="token class-name">VMRegPair</span><span class="token operator">*</span> regs<span class="token punctuation">,</span>
                                   <span class="token keyword">int</span><span class="token operator">&amp;</span> exception_offset<span class="token punctuation">,</span>
                                   <span class="token class-name">OopMapSet</span><span class="token operator">*</span> oop_maps<span class="token punctuation">,</span>
                                   <span class="token keyword">int</span><span class="token operator">&amp;</span> frame_complete<span class="token punctuation">,</span>
                                   <span class="token keyword">int</span><span class="token operator">&amp;</span> stack_slots<span class="token punctuation">,</span>
                                   <span class="token keyword">int</span><span class="token operator">&amp;</span> interpreted_entry_offset<span class="token punctuation">,</span>
                                   <span class="token keyword">int</span><span class="token operator">&amp;</span> compiled_entry_offset<span class="token punctuation">)</span> <span class="token punctuation">{</span>

  <span class="token comment">// enterSpecial(Continuation c, boolean isContinue, boolean isVirtualThread)</span>
  <span class="token keyword">int</span> pos_cont_obj   <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">int</span> pos_is_cont    <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token keyword">int</span> pos_is_virtual <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>

  <span class="token comment">// The platform-specific calling convention may present the arguments in various registers.</span>
  <span class="token comment">// To simplify the rest of the code, we expect the arguments to reside at these known</span>
  <span class="token comment">// registers, and we additionally check the placement here in case calling convention ever</span>
  <span class="token comment">// changes.</span>
  <span class="token class-name">Register</span> reg_cont_obj   <span class="token operator">=</span> c_rarg1<span class="token punctuation">;</span>
  <span class="token class-name">Register</span> reg_is_cont    <span class="token operator">=</span> c_rarg2<span class="token punctuation">;</span>
  <span class="token class-name">Register</span> reg_is_virtual <span class="token operator">=</span> c_rarg3<span class="token punctuation">;</span>

  <span class="token function">check_continuation_enter_argument</span><span class="token punctuation">(</span>regs<span class="token punctuation">[</span>pos_cont_obj<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">first</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>   reg_cont_obj<span class="token punctuation">,</span>   <span class="token string">&quot;Continuation object&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">check_continuation_enter_argument</span><span class="token punctuation">(</span>regs<span class="token punctuation">[</span>pos_is_cont<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">first</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    reg_is_cont<span class="token punctuation">,</span>    <span class="token string">&quot;isContinue&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">check_continuation_enter_argument</span><span class="token punctuation">(</span>regs<span class="token punctuation">[</span>pos_is_virtual<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">first</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> reg_is_virtual<span class="token punctuation">,</span> <span class="token string">&quot;isVirtualThread&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Utility methods kill rax, make sure there are no collisions</span>
  <span class="token function">assert_different_registers</span><span class="token punctuation">(</span>rax<span class="token punctuation">,</span> reg_cont_obj<span class="token punctuation">,</span> reg_is_cont<span class="token punctuation">,</span> reg_is_virtual<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token class-name">AddressLiteral</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token class-name">SharedRuntime</span><span class="token operator">::</span><span class="token function">get_resolve_static_call_stub</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                         relocInfo<span class="token operator">::</span><span class="token function">static_call_type</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  address start <span class="token operator">=</span> __ <span class="token function">pc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token class-name">Label</span> <span class="token class-name">L_thaw</span><span class="token punctuation">,</span> <span class="token class-name">L_exit</span><span class="token punctuation">;</span>

  <span class="token comment">// i2i entry used at interp_only_mode only</span>
  interpreted_entry_offset <span class="token operator">=</span> __ <span class="token function">pc</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start<span class="token punctuation">;</span>
  <span class="token punctuation">{</span>
#ifdef ASSERT
    <span class="token class-name">Label</span> is_interp_only<span class="token punctuation">;</span>
    __ <span class="token function">cmpb</span><span class="token punctuation">(</span><span class="token class-name">Address</span><span class="token punctuation">(</span>r15_thread<span class="token punctuation">,</span> <span class="token class-name">JavaThread</span><span class="token operator">::</span><span class="token function">interp_only_mode_offset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    __ <span class="token function">jcc</span><span class="token punctuation">(</span><span class="token class-name">Assembler</span><span class="token operator">::</span><span class="token function">notEqual</span><span class="token punctuation">,</span> is_interp_only<span class="token punctuation">)</span><span class="token punctuation">;</span>
    __ <span class="token function">stop</span><span class="token punctuation">(</span><span class="token string">&quot;enterSpecial interpreter entry called when not in interp_only_mode&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    __ <span class="token function">bind</span><span class="token punctuation">(</span>is_interp_only<span class="token punctuation">)</span><span class="token punctuation">;</span>
#endif

    __ <span class="token function">pop</span><span class="token punctuation">(</span>rax<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// return address</span>
    <span class="token comment">// Read interpreter arguments into registers (this is an ad-hoc i2c adapter)</span>
    __ <span class="token function">movptr</span><span class="token punctuation">(</span>c_rarg1<span class="token punctuation">,</span> <span class="token class-name">Address</span><span class="token punctuation">(</span>rsp<span class="token punctuation">,</span> <span class="token class-name">Interpreter</span><span class="token operator">::</span><span class="token function">stackElementSize</span><span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    __ <span class="token function">movl</span><span class="token punctuation">(</span>c_rarg2<span class="token punctuation">,</span>   <span class="token class-name">Address</span><span class="token punctuation">(</span>rsp<span class="token punctuation">,</span> <span class="token class-name">Interpreter</span><span class="token operator">::</span><span class="token function">stackElementSize</span><span class="token operator">*</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    __ <span class="token function">movl</span><span class="token punctuation">(</span>c_rarg3<span class="token punctuation">,</span>   <span class="token class-name">Address</span><span class="token punctuation">(</span>rsp<span class="token punctuation">,</span> <span class="token class-name">Interpreter</span><span class="token operator">::</span><span class="token function">stackElementSize</span><span class="token operator">*</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    __ <span class="token function">andptr</span><span class="token punctuation">(</span>rsp<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Ensure compiled code always sees stack at proper alignment</span>
    __ <span class="token function">push</span><span class="token punctuation">(</span>rax<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// return address</span>
    __ <span class="token function">push_cont_fastpath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    __ <span class="token function">enter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    stack_slots <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span> <span class="token comment">// will be adjusted in setup</span>
    <span class="token class-name">OopMap</span><span class="token operator">*</span> map <span class="token operator">=</span> <span class="token function">continuation_enter_setup</span><span class="token punctuation">(</span>masm<span class="token punctuation">,</span> stack_slots<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// The frame is complete here, but we only record it for the compiled entry, so the frame would appear unsafe,</span>
    <span class="token comment">// but that's okay because at the very worst we'll miss an async sample, but we're in interp_only_mode anyway.</span>

    __ <span class="token function">verify_oop</span><span class="token punctuation">(</span>reg_cont_obj<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">fill_continuation_entry</span><span class="token punctuation">(</span>masm<span class="token punctuation">,</span> reg_cont_obj<span class="token punctuation">,</span> reg_is_virtual<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// If continuation, call to thaw. Otherwise, resolve the call and exit.</span>
    __ <span class="token function">testptr</span><span class="token punctuation">(</span>reg_is_cont<span class="token punctuation">,</span> reg_is_cont<span class="token punctuation">)</span><span class="token punctuation">;</span>
    __ <span class="token function">jcc</span><span class="token punctuation">(</span><span class="token class-name">Assembler</span><span class="token operator">::</span><span class="token function">notZero</span><span class="token punctuation">,</span> <span class="token class-name">L_thaw</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// --- Resolve path</span>

    <span class="token comment">// Make sure the call is patchable</span>
    __ <span class="token function">align</span><span class="token punctuation">(</span><span class="token class-name">BytesPerWord</span><span class="token punctuation">,</span> __ <span class="token function">offset</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token class-name">NativeCall</span><span class="token operator">::</span><span class="token function">displacement_offset</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Emit stub for static call</span>
    <span class="token class-name">CodeBuffer</span><span class="token operator">*</span> cbuf <span class="token operator">=</span> masm<span class="token operator">-&gt;</span><span class="token function">code_section</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">outer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    address stub <span class="token operator">=</span> <span class="token class-name">CompiledStaticCall</span><span class="token operator">::</span><span class="token function">emit_to_interp_stub</span><span class="token punctuation">(</span><span class="token operator">*</span>cbuf<span class="token punctuation">,</span> __ <span class="token function">pc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>stub <span class="token operator">==</span> nullptr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">fatal</span><span class="token punctuation">(</span><span class="token string">&quot;CodeCache is full at gen_continuation_enter&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    __ <span class="token function">call</span><span class="token punctuation">(</span>resolve<span class="token punctuation">)</span><span class="token punctuation">;</span>
    oop_maps<span class="token operator">-&gt;</span><span class="token function">add_gc_map</span><span class="token punctuation">(</span>__ <span class="token function">pc</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start<span class="token punctuation">,</span> map<span class="token punctuation">)</span><span class="token punctuation">;</span>
    __ <span class="token function">post_call_nop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    __ <span class="token function">jmp</span><span class="token punctuation">(</span><span class="token class-name">L_exit</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// compiled entry</span>
  __ <span class="token function">align</span><span class="token punctuation">(</span><span class="token class-name">CodeEntryAlignment</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  compiled_entry_offset <span class="token operator">=</span> __ <span class="token function">pc</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start<span class="token punctuation">;</span>
  __ <span class="token function">enter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  stack_slots <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span> <span class="token comment">// will be adjusted in setup</span>
  <span class="token class-name">OopMap</span><span class="token operator">*</span> map <span class="token operator">=</span> <span class="token function">continuation_enter_setup</span><span class="token punctuation">(</span>masm<span class="token punctuation">,</span> stack_slots<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Frame is now completed as far as size and linkage.</span>
  frame_complete <span class="token operator">=</span> __ <span class="token function">pc</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start<span class="token punctuation">;</span>

  __ <span class="token function">verify_oop</span><span class="token punctuation">(</span>reg_cont_obj<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">fill_continuation_entry</span><span class="token punctuation">(</span>masm<span class="token punctuation">,</span> reg_cont_obj<span class="token punctuation">,</span> reg_is_virtual<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// If isContinue, call to thaw. Otherwise, call Continuation.enter(Continuation c, boolean isContinue)</span>
  __ <span class="token function">testptr</span><span class="token punctuation">(</span>reg_is_cont<span class="token punctuation">,</span> reg_is_cont<span class="token punctuation">)</span><span class="token punctuation">;</span>
  __ <span class="token function">jccb</span><span class="token punctuation">(</span><span class="token class-name">Assembler</span><span class="token operator">::</span><span class="token function">notZero</span><span class="token punctuation">,</span> <span class="token class-name">L_thaw</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// --- call Continuation.enter(Continuation c, boolean isContinue)</span>

  <span class="token comment">// Make sure the call is patchable</span>
  __ <span class="token function">align</span><span class="token punctuation">(</span><span class="token class-name">BytesPerWord</span><span class="token punctuation">,</span> __ <span class="token function">offset</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token class-name">NativeCall</span><span class="token operator">::</span><span class="token function">displacement_offset</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Emit stub for static call</span>
  <span class="token class-name">CodeBuffer</span><span class="token operator">*</span> cbuf <span class="token operator">=</span> masm<span class="token operator">-&gt;</span><span class="token function">code_section</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">outer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  address stub <span class="token operator">=</span> <span class="token class-name">CompiledStaticCall</span><span class="token operator">::</span><span class="token function">emit_to_interp_stub</span><span class="token punctuation">(</span><span class="token operator">*</span>cbuf<span class="token punctuation">,</span> __ <span class="token function">pc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>stub <span class="token operator">==</span> nullptr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">fatal</span><span class="token punctuation">(</span><span class="token string">&quot;CodeCache is full at gen_continuation_enter&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// The call needs to be resolved. There's a special case for this in</span>
  <span class="token comment">// SharedRuntime::find_callee_info_helper() which calls</span>
  <span class="token comment">// LinkResolver::resolve_continuation_enter() which resolves the call to</span>
  <span class="token comment">// Continuation.enter(Continuation c, boolean isContinue).</span>
  __ <span class="token function">call</span><span class="token punctuation">(</span>resolve<span class="token punctuation">)</span><span class="token punctuation">;</span>

  oop_maps<span class="token operator">-&gt;</span><span class="token function">add_gc_map</span><span class="token punctuation">(</span>__ <span class="token function">pc</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start<span class="token punctuation">,</span> map<span class="token punctuation">)</span><span class="token punctuation">;</span>
  __ <span class="token function">post_call_nop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  __ <span class="token function">jmpb</span><span class="token punctuation">(</span><span class="token class-name">L_exit</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// --- Thawing path</span>

  __ <span class="token function">bind</span><span class="token punctuation">(</span><span class="token class-name">L_thaw</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  __ <span class="token function">call</span><span class="token punctuation">(</span><span class="token class-name">RuntimeAddress</span><span class="token punctuation">(</span><span class="token class-name">StubRoutines</span><span class="token operator">::</span><span class="token function">cont_thaw</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token class-name">ContinuationEntry</span><span class="token operator">::</span><span class="token function">_return_pc_offset</span> <span class="token operator">=</span> __ <span class="token function">pc</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start<span class="token punctuation">;</span>
  oop_maps<span class="token operator">-&gt;</span><span class="token function">add_gc_map</span><span class="token punctuation">(</span>__ <span class="token function">pc</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start<span class="token punctuation">,</span> map<span class="token operator">-&gt;</span><span class="token function">deep_copy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  __ <span class="token function">post_call_nop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// --- Normal exit (resolve/thawing)</span>

  __ <span class="token function">bind</span><span class="token punctuation">(</span><span class="token class-name">L_exit</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">continuation_enter_cleanup</span><span class="token punctuation">(</span>masm<span class="token punctuation">)</span><span class="token punctuation">;</span>
  __ <span class="token function">pop</span><span class="token punctuation">(</span>rbp<span class="token punctuation">)</span><span class="token punctuation">;</span>
  __ <span class="token function">ret</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// --- Exception handling path</span>

  exception_offset <span class="token operator">=</span> __ <span class="token function">pc</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start<span class="token punctuation">;</span>

  <span class="token function">continuation_enter_cleanup</span><span class="token punctuation">(</span>masm<span class="token punctuation">)</span><span class="token punctuation">;</span>
  __ <span class="token function">pop</span><span class="token punctuation">(</span>rbp<span class="token punctuation">)</span><span class="token punctuation">;</span>

  __ <span class="token function">movptr</span><span class="token punctuation">(</span>c_rarg0<span class="token punctuation">,</span> r15_thread<span class="token punctuation">)</span><span class="token punctuation">;</span>
  __ <span class="token function">movptr</span><span class="token punctuation">(</span>c_rarg1<span class="token punctuation">,</span> <span class="token class-name">Address</span><span class="token punctuation">(</span>rsp<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// return address</span>

  <span class="token comment">// rax still holds the original exception oop, save it before the call</span>
  __ <span class="token function">push</span><span class="token punctuation">(</span>rax<span class="token punctuation">)</span><span class="token punctuation">;</span>

  __ <span class="token function">call_VM_leaf</span><span class="token punctuation">(</span><span class="token function">CAST_FROM_FN_PTR</span><span class="token punctuation">(</span>address<span class="token punctuation">,</span> <span class="token class-name">SharedRuntime</span><span class="token operator">::</span><span class="token function">exception_handler_for_return_address</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  __ <span class="token function">movptr</span><span class="token punctuation">(</span>rbx<span class="token punctuation">,</span> rax<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Continue at exception handler:</span>
  <span class="token comment">//   rax: exception oop</span>
  <span class="token comment">//   rbx: exception handler</span>
  <span class="token comment">//   rdx: exception pc</span>
  __ <span class="token function">pop</span><span class="token punctuation">(</span>rax<span class="token punctuation">)</span><span class="token punctuation">;</span>
  __ <span class="token function">verify_oop</span><span class="token punctuation">(</span>rax<span class="token punctuation">)</span><span class="token punctuation">;</span>
  __ <span class="token function">pop</span><span class="token punctuation">(</span>rdx<span class="token punctuation">)</span><span class="token punctuation">;</span>
  __ <span class="token function">jmp</span><span class="token punctuation">(</span>rbx<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br></div></div><h3 id="网络层适配"><a href="#网络层适配" class="header-anchor">#</a> 网络层适配</h3> <p>一部分负责处理IO的线程会阻塞在IO调用上，比如网络读写。
VirtualThread目前对于BIO进行了处理，使得VirtualThread调用BIO的read、write时不会阻塞CarrierThread。（但是NIO的Selector.select目前没有处理，即select会阻塞CarrierThread）</p> <p>以<code>java.net.Socket</code>的read为例，read通过NioSocketImpl实现。</p> <p>configureNonBlockingIfNeeded里判断如果是VirtualThread，则设置fd为非阻塞模式。
非阻塞模式，如果没有可读事件，会立刻返回，所以需要在while循环中不断等待读事件、被唤醒后再尝试读。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">class</span> <span class="token class-name">NioSocketImpl</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> <span class="token function">implRead</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> b<span class="token punctuation">,</span> <span class="token keyword">int</span> off<span class="token punctuation">,</span> <span class="token keyword">int</span> len<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> n <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token class-name">FileDescriptor</span> fd <span class="token operator">=</span> <span class="token function">beginRead</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>connectionReset<span class="token punctuation">)</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">SocketException</span><span class="token punctuation">(</span><span class="token string">&quot;Connection reset&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>isInputClosed<span class="token punctuation">)</span>
                <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> timeout <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>timeout<span class="token punctuation">;</span>
            <span class="token function">configureNonBlockingIfNeeded</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> timeout <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>timeout <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// read with timeout</span>
                n <span class="token operator">=</span> <span class="token function">timedRead</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> b<span class="token punctuation">,</span> off<span class="token punctuation">,</span> len<span class="token punctuation">,</span> MILLISECONDS<span class="token punctuation">.</span><span class="token function">toNanos</span><span class="token punctuation">(</span>timeout<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment">// read, no timeout</span>
                n <span class="token operator">=</span> <span class="token function">tryRead</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> b<span class="token punctuation">,</span> off<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token class-name">IOStatus</span><span class="token punctuation">.</span><span class="token function">okayToRetry</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isOpen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">park</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token class-name">Net</span><span class="token punctuation">.</span>POLLIN<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    n <span class="token operator">=</span> <span class="token function">tryRead</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> b<span class="token punctuation">,</span> off<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> n<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedIOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ConnectionResetException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            connectionReset <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">SocketException</span><span class="token punctuation">(</span><span class="token string">&quot;Connection reset&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> ioe<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// throw SocketException to maintain compatibility</span>
            <span class="token keyword">throw</span> <span class="token function">asSocketException</span><span class="token punctuation">(</span>ioe<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token function">endRead</span><span class="token punctuation">(</span>n <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br></div></div><p>tryRead会尝试一次读，如果没读完（UNAVAILABLE或状态为INTERRUPTED)，则会在while循环过程中，先park注册到Poller上，再tryRead。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>n <span class="token operator">=</span> <span class="token function">tryRead</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> b<span class="token punctuation">,</span> off<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token class-name">IOStatus</span><span class="token punctuation">.</span><span class="token function">okayToRetry</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isOpen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">park</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token class-name">Net</span><span class="token punctuation">.</span>POLLIN<span class="token punctuation">)</span><span class="token punctuation">;</span>
    n <span class="token operator">=</span> <span class="token function">tryRead</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> b<span class="token punctuation">,</span> off<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>park会在Poller中</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code> <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">park</span><span class="token punctuation">(</span><span class="token class-name">FileDescriptor</span> fd<span class="token punctuation">,</span> <span class="token keyword">int</span> event<span class="token punctuation">,</span> <span class="token keyword">long</span> nanos<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token class-name">Thread</span> t <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">isVirtual</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Poller</span><span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token function">fdVal</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">,</span> event<span class="token punctuation">,</span> nanos<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token operator">::</span><span class="token function">isOpen</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">isInterrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">InterruptedIOException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">class</span> <span class="token class-name">Poller</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">poll</span><span class="token punctuation">(</span><span class="token keyword">int</span> fdVal<span class="token punctuation">,</span> <span class="token keyword">int</span> event<span class="token punctuation">,</span> <span class="token keyword">long</span> nanos<span class="token punctuation">,</span> <span class="token class-name">BooleanSupplier</span> supplier<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> <span class="token class-name">IOException</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">assert</span> nanos <span class="token operator">&gt;=</span> <span class="token number">0L</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>event <span class="token operator">==</span> <span class="token class-name">Net</span><span class="token punctuation">.</span>POLLIN<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">readPoller</span><span class="token punctuation">(</span>fdVal<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span>fdVal<span class="token punctuation">,</span> nanos<span class="token punctuation">,</span> supplier<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>event <span class="token operator">==</span> <span class="token class-name">Net</span><span class="token punctuation">.</span>POLLOUT<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">writePoller</span><span class="token punctuation">(</span>fdVal<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span>fdVal<span class="token punctuation">,</span> nanos<span class="token punctuation">,</span> supplier<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">assert</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">poll</span><span class="token punctuation">(</span><span class="token keyword">int</span> fdVal<span class="token punctuation">,</span> <span class="token keyword">long</span> nanos<span class="token punctuation">,</span> <span class="token class-name">BooleanSupplier</span> supplier<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>USE_DIRECT_REGISTER<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">pollDirect</span><span class="token punctuation">(</span>fdVal<span class="token punctuation">,</span> nanos<span class="token punctuation">,</span> supplier<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token function">pollIndirect</span><span class="token punctuation">(</span>fdVal<span class="token punctuation">,</span> nanos<span class="token punctuation">,</span> supplier<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p>默认是pollIndirect，pollIndirect先把网络文件fd和Thread映射保存到map中。然后向队列提交一个请求。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">class</span> <span class="token class-name">Poller</span> <span class="token punctuation">{</span>
    <span class="token comment">// maps file descriptors to parked Thread</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">Thread</span><span class="token punctuation">&gt;</span></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// the queue of updates to the updater Thread</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">BlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Request</span><span class="token punctuation">&gt;</span></span> queue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedTransferQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">pollIndirect</span><span class="token punctuation">(</span><span class="token keyword">int</span> fdVal<span class="token punctuation">,</span> <span class="token keyword">long</span> nanos<span class="token punctuation">,</span> <span class="token class-name">BooleanSupplier</span> supplier<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Request</span> request <span class="token operator">=</span> <span class="token function">registerAsync</span><span class="token punctuation">(</span>fdVal<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">boolean</span> isOpen <span class="token operator">=</span> supplier<span class="token punctuation">.</span><span class="token function">getAsBoolean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>isOpen<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>nanos <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">LockSupport</span><span class="token punctuation">.</span><span class="token function">parkNanos</span><span class="token punctuation">(</span>nanos<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token class-name">LockSupport</span><span class="token punctuation">.</span><span class="token function">park</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            request<span class="token punctuation">.</span><span class="token function">awaitFinish</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">deregister</span><span class="token punctuation">(</span>fdVal<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token class-name">Request</span> <span class="token function">registerAsync</span><span class="token punctuation">(</span><span class="token keyword">int</span> fdVal<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Thread</span> previous <span class="token operator">=</span> map<span class="token punctuation">.</span><span class="token function">putIfAbsent</span><span class="token punctuation">(</span>fdVal<span class="token punctuation">,</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">assert</span> previous <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token class-name">Request</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Request</span><span class="token punctuation">(</span>fdVal<span class="token punctuation">)</span><span class="token punctuation">;</span>
        queue<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> request<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><p>单独会有一些Poller线程去负责监听这些fd的IO事件，并在有事件发生的时候，从map中获取对应的VirtualThread并unpark，
以便这些VitualThread继续读写。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">class</span> <span class="token class-name">Poller</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">Poller</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> prefix <span class="token operator">=</span> <span class="token punctuation">(</span>read<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">&quot;Read&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;Write&quot;</span><span class="token punctuation">;</span>
        <span class="token function">startThread</span><span class="token punctuation">(</span>prefix <span class="token operator">+</span> <span class="token string">&quot;-Poller&quot;</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token operator">::</span><span class="token function">pollLoop</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>USE_DIRECT_REGISTER<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">startThread</span><span class="token punctuation">(</span>prefix <span class="token operator">+</span> <span class="token string">&quot;-Updater&quot;</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token operator">::</span><span class="token function">updateLoop</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">pollLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">poll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">updateLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">Request</span> req <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                <span class="token keyword">while</span> <span class="token punctuation">(</span>req <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{</span>
                        req <span class="token operator">=</span> queue<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> ignore<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token function">implRegister</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span><span class="token function">fdVal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                req<span class="token punctuation">.</span><span class="token function">finish</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">class</span> <span class="token class-name">KQueuePoller</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">int</span> <span class="token function">poll</span><span class="token punctuation">(</span><span class="token keyword">int</span> timeout<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> n <span class="token operator">=</span> <span class="token class-name">KQueue</span><span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span>kqfd<span class="token punctuation">,</span> address<span class="token punctuation">,</span> MAX_EVENTS_TO_POLL<span class="token punctuation">,</span> timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;</span> n<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">long</span> keventAddress <span class="token operator">=</span> <span class="token class-name">KQueue</span><span class="token punctuation">.</span><span class="token function">getEvent</span><span class="token punctuation">(</span>address<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> fdVal <span class="token operator">=</span> <span class="token class-name">KQueue</span><span class="token punctuation">.</span><span class="token function">getDescriptor</span><span class="token punctuation">(</span>keventAddress<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">polled</span><span class="token punctuation">(</span>fdVal<span class="token punctuation">)</span><span class="token punctuation">;</span>
            i<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> n<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">Poller</span> <span class="token punctuation">{</span>
    <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">polled</span><span class="token punctuation">(</span><span class="token keyword">int</span> fdVal<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">wakeup</span><span class="token punctuation">(</span>fdVal<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">wakeup</span><span class="token punctuation">(</span><span class="token keyword">int</span> fdVal<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Thread</span> t <span class="token operator">=</span> map<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>fdVal<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>t <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">LockSupport</span><span class="token punctuation">.</span><span class="token function">unpark</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><h2 id="虚拟线程unpark唤醒的处理"><a href="#虚拟线程unpark唤醒的处理" class="header-anchor">#</a> 虚拟线程unpark唤醒的处理</h2> <p>一个线程唤醒另一个线程时，比如AQS中release的线程要唤醒在queue中等待的线程，是通过LockSupport.unpark来唤醒另外一个线程的。
这里判断如果是VirtualThread，则会判断state，
如果是PARKED状态，说明已经被切走，则CAS修改为RUNNABLE，并调用submitRunContinuation将该VirtualThread的Continuation
提交到调度器等待再次调度运行，运行Continuation的run方法。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">class</span> <span class="token class-name">VirtualThread</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token annotation punctuation">@ChangesCurrentThread</span>
    <span class="token keyword">void</span> <span class="token function">unpark</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Thread</span> currentThread <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">getAndSetParkPermit</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> currentThread <span class="token operator">!=</span> <span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> s <span class="token operator">=</span> <span class="token function">state</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">==</span> PARKED <span class="token operator">&amp;&amp;</span> <span class="token function">compareAndSetState</span><span class="token punctuation">(</span>PARKED<span class="token punctuation">,</span> RUNNABLE<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>currentThread <span class="token keyword">instanceof</span> <span class="token class-name">VirtualThread</span> vthread<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    vthread<span class="token punctuation">.</span><span class="token function">switchToCarrierThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{</span>
                        <span class="token function">submitRunContinuation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                        <span class="token function">switchToVirtualThread</span><span class="token punctuation">(</span>vthread<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token function">submitRunContinuation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">==</span> PINNED<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// unpark carrier thread when pinned.</span>
                <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token function">carrierThreadAccessLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">Thread</span> carrier <span class="token operator">=</span> carrierThread<span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>carrier <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token function">state</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> PINNED<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">unpark</span><span class="token punctuation">(</span>carrier<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><p>再次被调度器运行时，依然执行runContinuation，执行到Continuation的run方法。但是此时已经continuation不是第一次运行</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">boolean</span> isVirtualThread <span class="token operator">=</span> <span class="token punctuation">(</span>scope <span class="token operator">==</span> JLA<span class="token punctuation">.</span><span class="token function">virtualThreadContinuationScope</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isStarted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// is this the first run? (at this point we know !done)</span>
        <span class="token function">enterSpecial</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> isVirtualThread<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">assert</span> <span class="token operator">!</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">enterSpecial</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> isVirtualThread<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
<span class="token comment">//...    </span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>在enterSpecial实现中，如果传入的第二个参数(isContinue)是true，则会执行到Continuation的thaw逻辑。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>  <span class="token comment">// If isContinue, call to thaw. Otherwise, call Continuation.enter(Continuation c, boolean isContinue)</span>
  __ <span class="token function">testptr</span><span class="token punctuation">(</span>reg_is_cont<span class="token punctuation">,</span> reg_is_cont<span class="token punctuation">)</span><span class="token punctuation">;</span>
  __ <span class="token function">jccb</span><span class="token punctuation">(</span><span class="token class-name">Assembler</span><span class="token operator">::</span><span class="token function">notZero</span><span class="token punctuation">,</span> <span class="token class-name">L_thaw</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  

  <span class="token comment">// ...</span>
<span class="token comment">// --- Thawing path</span>

  __ <span class="token function">bind</span><span class="token punctuation">(</span><span class="token class-name">L_thaw</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  __ <span class="token function">call</span><span class="token punctuation">(</span><span class="token class-name">RuntimeAddress</span><span class="token punctuation">(</span><span class="token class-name">StubRoutines</span><span class="token operator">::</span><span class="token function">cont_thaw</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token class-name">ContinuationEntry</span><span class="token operator">::</span><span class="token function">_return_pc_offset</span> <span class="token operator">=</span> __ <span class="token function">pc</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start<span class="token punctuation">;</span>
  oop_maps<span class="token operator">-&gt;</span><span class="token function">add_gc_map</span><span class="token punctuation">(</span>__ <span class="token function">pc</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start<span class="token punctuation">,</span> map<span class="token operator">-&gt;</span><span class="token function">deep_copy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  __ <span class="token function">post_call_nop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// --- Normal exit (resolve/thawing)</span>

  __ <span class="token function">bind</span><span class="token punctuation">(</span><span class="token class-name">L_exit</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">continuation_enter_cleanup</span><span class="token punctuation">(</span>masm<span class="token punctuation">)</span><span class="token punctuation">;</span>
  __ <span class="token function">pop</span><span class="token punctuation">(</span>rbp<span class="token punctuation">)</span><span class="token punctuation">;</span>
  __ <span class="token function">ret</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><div class="language-java line-numbers-mode"><pre class="language-java"><code>template<span class="token generics"><span class="token punctuation">&lt;</span>typename <span class="token class-name">ConfigT</span><span class="token punctuation">&gt;</span></span>
<span class="token keyword">static</span> <span class="token function">JRT_LEAF</span><span class="token punctuation">(</span>intptr_t<span class="token operator">*</span><span class="token punctuation">,</span> <span class="token function">thaw</span><span class="token punctuation">(</span><span class="token class-name">JavaThread</span><span class="token operator">*</span> thread<span class="token punctuation">,</span> <span class="token keyword">int</span> kind<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token comment">// TODO: JRT_LEAF and NoHandleMark is problematic for JFR events.</span>
  <span class="token comment">// vFrameStreamCommon allocates Handles in RegisterMap for continuations.</span>
  <span class="token comment">// JRT_ENTRY instead?</span>
  <span class="token class-name">ResetNoHandleMark</span> rnhm<span class="token punctuation">;</span>

  <span class="token comment">// we might modify the code cache via BarrierSetNMethod::nmethod_entry_barrier</span>
  <span class="token function">MACOS_AARCH64_ONLY</span><span class="token punctuation">(</span><span class="token class-name">ThreadWXEnable</span> <span class="token function">__wx</span><span class="token punctuation">(</span><span class="token class-name">WXWrite</span><span class="token punctuation">,</span> thread<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token class-name">ConfigT</span><span class="token operator">::</span><span class="token function">thaw</span><span class="token punctuation">(</span>thread<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">Continuation</span><span class="token operator">::</span><span class="token function">thaw_kind</span><span class="token punctuation">)</span>kind<span class="token punctuation">)</span><span class="token punctuation">;</span>
JRT_END
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">static</span> intptr_t<span class="token operator">*</span> <span class="token function">thaw</span><span class="token punctuation">(</span><span class="token class-name">JavaThread</span><span class="token operator">*</span> thread<span class="token punctuation">,</span> <span class="token class-name">Continuation</span><span class="token operator">::</span><span class="token function">thaw_kind</span> kind<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> thaw_internal<span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SelfT</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>thread<span class="token punctuation">,</span> kind<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// returns new top sp</span>
<span class="token comment">// called after preparations (stack overflow check and making room)</span>
template<span class="token generics"><span class="token punctuation">&lt;</span>typename <span class="token class-name">ConfigT</span><span class="token punctuation">&gt;</span></span>
<span class="token keyword">static</span> inline intptr_t<span class="token operator">*</span> <span class="token function">thaw_internal</span><span class="token punctuation">(</span><span class="token class-name">JavaThread</span><span class="token operator">*</span> thread<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token class-name">Continuation</span><span class="token operator">::</span><span class="token function">thaw_kind</span> kind<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">assert</span><span class="token punctuation">(</span>thread <span class="token operator">==</span> <span class="token class-name">JavaThread</span><span class="token operator">::</span><span class="token function">current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;Must be current thread&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">CONT_JFR_ONLY</span><span class="token punctuation">(</span><span class="token class-name">EventContinuationThaw</span> event<span class="token punctuation">;</span><span class="token punctuation">)</span>

  <span class="token function">log_develop_trace</span><span class="token punctuation">(</span>continuations<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token string">&quot;~~~~ thaw kind: %d sp: &quot;</span> INTPTR_FORMAT<span class="token punctuation">,</span> kind<span class="token punctuation">,</span> <span class="token function">p2i</span><span class="token punctuation">(</span>thread<span class="token operator">-&gt;</span><span class="token function">last_continuation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">entry_sp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token class-name">ContinuationEntry</span><span class="token operator">*</span> entry <span class="token operator">=</span> thread<span class="token operator">-&gt;</span><span class="token function">last_continuation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">assert</span><span class="token punctuation">(</span>entry <span class="token operator">!=</span> nullptr<span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  oop oopCont <span class="token operator">=</span> entry<span class="token operator">-&gt;</span><span class="token function">cont_oop</span><span class="token punctuation">(</span>thread<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">assert</span><span class="token punctuation">(</span><span class="token operator">!</span>jdk_internal_vm_Continuation<span class="token operator">::</span><span class="token function">done</span><span class="token punctuation">(</span>oopCont<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">assert</span><span class="token punctuation">(</span>oopCont <span class="token operator">==</span> <span class="token function">get_continuation</span><span class="token punctuation">(</span>thread<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">verify_continuation</span><span class="token punctuation">(</span>oopCont<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">assert</span><span class="token punctuation">(</span>entry<span class="token operator">-&gt;</span><span class="token function">is_virtual_thread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token punctuation">(</span>entry<span class="token operator">-&gt;</span><span class="token function">scope</span><span class="token punctuation">(</span>thread<span class="token punctuation">)</span> <span class="token operator">==</span> java_lang_VirtualThread<span class="token operator">::</span><span class="token function">vthread_scope</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token class-name">ContinuationWrapper</span> <span class="token function">cont</span><span class="token punctuation">(</span>thread<span class="token punctuation">,</span> oopCont<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">log_develop_debug</span><span class="token punctuation">(</span>continuations<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token string">&quot;THAW #&quot;</span> INTPTR_FORMAT <span class="token string">&quot; &quot;</span> INTPTR_FORMAT<span class="token punctuation">,</span> cont<span class="token punctuation">.</span><span class="token function">hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">p2i</span><span class="token punctuation">(</span><span class="token punctuation">(</span>oopDesc<span class="token operator">*</span><span class="token punctuation">)</span>oopCont<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

#ifdef <span class="token class-name">ASSERT</span>
  <span class="token function">set_anchor_to_entry</span><span class="token punctuation">(</span>thread<span class="token punctuation">,</span> cont<span class="token punctuation">.</span><span class="token function">entry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">log_frames</span><span class="token punctuation">(</span>thread<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">clear_anchor</span><span class="token punctuation">(</span>thread<span class="token punctuation">)</span><span class="token punctuation">;</span>
#endif

  <span class="token class-name">Thaw</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ConfigT</span><span class="token punctuation">&gt;</span></span> <span class="token function">thw</span><span class="token punctuation">(</span>thread<span class="token punctuation">,</span> cont<span class="token punctuation">)</span><span class="token punctuation">;</span>
  intptr_t<span class="token operator">*</span> <span class="token keyword">const</span> sp <span class="token operator">=</span> thw<span class="token punctuation">.</span><span class="token function">thaw</span><span class="token punctuation">(</span>kind<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">assert</span><span class="token punctuation">(</span><span class="token function">is_aligned</span><span class="token punctuation">(</span>sp<span class="token punctuation">,</span> frame<span class="token operator">::</span><span class="token function">frame_alignment</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// All the frames have been thawed so we know they don't hold any monitors</span>
  <span class="token keyword">assert</span><span class="token punctuation">(</span>thread<span class="token operator">-&gt;</span><span class="token function">held_monitor_count</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">&quot;Must be&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

#ifdef ASSERT
  intptr_t<span class="token operator">*</span> sp0 <span class="token operator">=</span> sp<span class="token punctuation">;</span>
  <span class="token function">set_anchor</span><span class="token punctuation">(</span>thread<span class="token punctuation">,</span> sp0<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">log_frames</span><span class="token punctuation">(</span>thread<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">LoomVerifyAfterThaw</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">assert</span><span class="token punctuation">(</span><span class="token function">do_verify_after_thaw</span><span class="token punctuation">(</span>thread<span class="token punctuation">,</span> cont<span class="token punctuation">.</span><span class="token function">tail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> tty<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">assert</span><span class="token punctuation">(</span><span class="token class-name">ContinuationEntry</span><span class="token operator">::</span><span class="token function">assert_entry_frame_laid_out</span><span class="token punctuation">(</span>thread<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">clear_anchor</span><span class="token punctuation">(</span>thread<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token class-name">LogTarget</span><span class="token punctuation">(</span><span class="token class-name">Trace</span><span class="token punctuation">,</span> continuations<span class="token punctuation">)</span> lt<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>lt<span class="token punctuation">.</span><span class="token function">develop_is_enabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">LogStream</span> <span class="token function">ls</span><span class="token punctuation">(</span>lt<span class="token punctuation">)</span><span class="token punctuation">;</span>
    ls<span class="token punctuation">.</span><span class="token function">print_cr</span><span class="token punctuation">(</span><span class="token string">&quot;Jumping to frame (thaw):&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">frame</span><span class="token punctuation">(</span>sp<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">print_value_on</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ls<span class="token punctuation">,</span> nullptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
#endif

  <span class="token function">CONT_JFR_ONLY</span><span class="token punctuation">(</span>thw<span class="token punctuation">.</span><span class="token function">jfr_info</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">post_jfr_event</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>event<span class="token punctuation">,</span> cont<span class="token punctuation">.</span><span class="token function">continuation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> thread<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">)</span>

  <span class="token function">verify_continuation</span><span class="token punctuation">(</span>cont<span class="token punctuation">.</span><span class="token function">continuation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">log_develop_debug</span><span class="token punctuation">(</span>continuations<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token string">&quot;=== End of thaw #&quot;</span> INTPTR_FORMAT<span class="token punctuation">,</span> cont<span class="token punctuation">.</span><span class="token function">hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> sp<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br></div></div><p>thaw将VirtualThread栈从堆内存中复制会线程运行栈中</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>template <span class="token generics"><span class="token punctuation">&lt;</span>typename <span class="token class-name">ConfigT</span><span class="token punctuation">&gt;</span></span>
inline intptr_t<span class="token operator">*</span> <span class="token class-name">Thaw</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ConfigT</span><span class="token punctuation">&gt;</span></span><span class="token operator">::</span><span class="token function">thaw</span><span class="token punctuation">(</span><span class="token class-name">Continuation</span><span class="token operator">::</span><span class="token function">thaw_kind</span> kind<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">verify_continuation</span><span class="token punctuation">(</span>_cont<span class="token punctuation">.</span><span class="token function">continuation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">assert</span><span class="token punctuation">(</span><span class="token operator">!</span>jdk_internal_vm_Continuation<span class="token operator">::</span><span class="token function">done</span><span class="token punctuation">(</span>_cont<span class="token punctuation">.</span><span class="token function">continuation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">assert</span><span class="token punctuation">(</span><span class="token operator">!</span>_cont<span class="token punctuation">.</span><span class="token function">is_empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  stackChunkOop chunk <span class="token operator">=</span> _cont<span class="token punctuation">.</span><span class="token function">tail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">assert</span><span class="token punctuation">(</span>chunk <span class="token operator">!=</span> nullptr<span class="token punctuation">,</span> <span class="token string">&quot;guaranteed by prepare_thaw&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">assert</span><span class="token punctuation">(</span><span class="token operator">!</span>chunk<span class="token operator">-&gt;</span><span class="token function">is_empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;guaranteed by prepare_thaw&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  _barriers <span class="token operator">=</span> chunk<span class="token operator">-&gt;</span><span class="token function">requires_barriers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token function">LIKELY</span><span class="token punctuation">(</span><span class="token function">can_thaw_fast</span><span class="token punctuation">(</span>chunk<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">thaw_fast</span><span class="token punctuation">(</span>chunk<span class="token punctuation">)</span>
                                        <span class="token operator">:</span> <span class="token function">thaw_slow</span><span class="token punctuation">(</span>chunk<span class="token punctuation">,</span> kind <span class="token operator">!=</span> <span class="token class-name">Continuation</span><span class="token operator">::</span><span class="token function">thaw_top</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><div class="language-java line-numbers-mode"><pre class="language-java"><code>template <span class="token generics"><span class="token punctuation">&lt;</span>typename <span class="token class-name">ConfigT</span><span class="token punctuation">&gt;</span></span>
NOINLINE intptr_t<span class="token operator">*</span> <span class="token class-name">Thaw</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ConfigT</span><span class="token punctuation">&gt;</span></span><span class="token operator">::</span><span class="token function">thaw_fast</span><span class="token punctuation">(</span>stackChunkOop chunk<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">assert</span><span class="token punctuation">(</span>chunk <span class="token operator">==</span> _cont<span class="token punctuation">.</span><span class="token function">tail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">assert</span><span class="token punctuation">(</span><span class="token operator">!</span>chunk<span class="token operator">-&gt;</span><span class="token function">has_mixed_frames</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">assert</span><span class="token punctuation">(</span><span class="token operator">!</span>chunk<span class="token operator">-&gt;</span><span class="token function">requires_barriers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">assert</span><span class="token punctuation">(</span><span class="token operator">!</span>chunk<span class="token operator">-&gt;</span><span class="token function">has_bitmap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">assert</span><span class="token punctuation">(</span><span class="token operator">!</span>_thread<span class="token operator">-&gt;</span><span class="token function">is_interp_only_mode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token class-name">LogTarget</span><span class="token punctuation">(</span><span class="token class-name">Trace</span><span class="token punctuation">,</span> continuations<span class="token punctuation">)</span> lt<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>lt<span class="token punctuation">.</span><span class="token function">develop_is_enabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">LogStream</span> <span class="token function">ls</span><span class="token punctuation">(</span>lt<span class="token punctuation">)</span><span class="token punctuation">;</span>
    ls<span class="token punctuation">.</span><span class="token function">print_cr</span><span class="token punctuation">(</span><span class="token string">&quot;thaw_fast&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    chunk<span class="token operator">-&gt;</span><span class="token function">print_on</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>ls<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Below this heuristic, we thaw the whole chunk, above it we thaw just one frame.</span>
  <span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">int</span> threshold <span class="token operator">=</span> <span class="token number">500</span><span class="token punctuation">;</span> <span class="token comment">// words</span>

  <span class="token keyword">const</span> <span class="token keyword">int</span> full_chunk_size <span class="token operator">=</span> chunk<span class="token operator">-&gt;</span><span class="token function">stack_size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> chunk<span class="token operator">-&gt;</span><span class="token function">sp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// this initial size could be reduced if it's a partial thaw</span>
  <span class="token keyword">int</span> argsize<span class="token punctuation">,</span> thaw_size<span class="token punctuation">;</span>

  intptr_t<span class="token operator">*</span> <span class="token keyword">const</span> chunk_sp <span class="token operator">=</span> chunk<span class="token operator">-&gt;</span><span class="token function">start_address</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> chunk<span class="token operator">-&gt;</span><span class="token function">sp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  bool partial<span class="token punctuation">,</span> empty<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">LIKELY</span><span class="token punctuation">(</span><span class="token operator">!</span>TEST_THAW_ONE_CHUNK_FRAME <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>full_chunk_size <span class="token operator">&lt;</span> threshold<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">prefetch_chunk_pd</span><span class="token punctuation">(</span>chunk<span class="token operator">-&gt;</span><span class="token function">start_address</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> full_chunk_size<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// prefetch anticipating memcpy starting at highest address</span>

    partial <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    argsize <span class="token operator">=</span> chunk<span class="token operator">-&gt;</span><span class="token function">argsize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// must be called *before* clearing the chunk</span>
    <span class="token function">clear_chunk</span><span class="token punctuation">(</span>chunk<span class="token punctuation">)</span><span class="token punctuation">;</span>
    thaw_size <span class="token operator">=</span> full_chunk_size<span class="token punctuation">;</span>
    empty <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment">// thaw a single frame</span>
    partial <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    thaw_size <span class="token operator">=</span> <span class="token function">remove_top_compiled_frame_from_chunk</span><span class="token punctuation">(</span>chunk<span class="token punctuation">,</span> argsize<span class="token punctuation">)</span><span class="token punctuation">;</span>
    empty <span class="token operator">=</span> chunk<span class="token operator">-&gt;</span><span class="token function">is_empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Are we thawing the last frame(s) in the continuation</span>
  <span class="token keyword">const</span> bool is_last <span class="token operator">=</span> empty <span class="token operator">&amp;&amp;</span> chunk<span class="token operator">-&gt;</span><span class="token function">parent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> nullptr<span class="token punctuation">;</span>
  <span class="token keyword">assert</span><span class="token punctuation">(</span><span class="token operator">!</span>is_last <span class="token operator">||</span> argsize <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">log_develop_trace</span><span class="token punctuation">(</span>continuations<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token string">&quot;thaw_fast partial: %d is_last: %d empty: %d size: %d argsize: %d entrySP: &quot;</span> PTR_FORMAT<span class="token punctuation">,</span>
                              partial<span class="token punctuation">,</span> is_last<span class="token punctuation">,</span> empty<span class="token punctuation">,</span> thaw_size<span class="token punctuation">,</span> argsize<span class="token punctuation">,</span> <span class="token function">p2i</span><span class="token punctuation">(</span>_cont<span class="token punctuation">.</span><span class="token function">entrySP</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token class-name">ReconstructedStack</span> <span class="token function">rs</span><span class="token punctuation">(</span>_cont<span class="token punctuation">.</span><span class="token function">entrySP</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> thaw_size<span class="token punctuation">,</span> argsize<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// also copy metadata words at frame bottom</span>
  <span class="token function">copy_from_chunk</span><span class="token punctuation">(</span>chunk_sp <span class="token operator">-</span> frame<span class="token operator">::</span><span class="token function">metadata_words_at_bottom</span><span class="token punctuation">,</span> rs<span class="token punctuation">.</span><span class="token function">top</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> rs<span class="token punctuation">.</span><span class="token function">total_size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// update the ContinuationEntry</span>
  _cont<span class="token punctuation">.</span><span class="token function">set_argsize</span><span class="token punctuation">(</span>argsize<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">log_develop_trace</span><span class="token punctuation">(</span>continuations<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token string">&quot;setting entry argsize: %d&quot;</span><span class="token punctuation">,</span> _cont<span class="token punctuation">.</span><span class="token function">argsize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">assert</span><span class="token punctuation">(</span>rs<span class="token punctuation">.</span><span class="token function">bottom_sp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> _cont<span class="token punctuation">.</span><span class="token function">entry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">bottom_sender_sp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// install the return barrier if not last frame, or the entry's pc if last</span>
  <span class="token function">patch_return</span><span class="token punctuation">(</span>rs<span class="token punctuation">.</span><span class="token function">bottom_sp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> is_last<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// insert the back links from callee to caller frames</span>
  <span class="token function">patch_caller_links</span><span class="token punctuation">(</span>rs<span class="token punctuation">.</span><span class="token function">top</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> rs<span class="token punctuation">.</span><span class="token function">top</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> rs<span class="token punctuation">.</span><span class="token function">total_size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">assert</span><span class="token punctuation">(</span>is_last <span class="token operator">==</span> _cont<span class="token punctuation">.</span><span class="token function">is_empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">assert</span><span class="token punctuation">(</span>_cont<span class="token punctuation">.</span><span class="token function">chunk_invariant</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

#<span class="token keyword">if</span> CONT_JFR
  <span class="token class-name">EventContinuationThawFast</span> e<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">should_commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    e<span class="token punctuation">.</span><span class="token function">set_id</span><span class="token punctuation">(</span>cast_from_oop<span class="token generics"><span class="token punctuation">&lt;</span>u8<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>chunk<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    e<span class="token punctuation">.</span><span class="token function">set_size</span><span class="token punctuation">(</span>thaw_size <span class="token operator">&lt;&lt;</span> <span class="token class-name">LogBytesPerWord</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    e<span class="token punctuation">.</span><span class="token function">set_full</span><span class="token punctuation">(</span><span class="token operator">!</span>partial<span class="token punctuation">)</span><span class="token punctuation">;</span>
    e<span class="token punctuation">.</span><span class="token function">commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
#endif

#ifdef <span class="token class-name">ASSERT</span>
  <span class="token function">set_anchor</span><span class="token punctuation">(</span>_thread<span class="token punctuation">,</span> rs<span class="token punctuation">.</span><span class="token function">sp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">log_frames</span><span class="token punctuation">(</span>_thread<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">LoomDeoptAfterThaw</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">do_deopt_after_thaw</span><span class="token punctuation">(</span>_thread<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">clear_anchor</span><span class="token punctuation">(</span>_thread<span class="token punctuation">)</span><span class="token punctuation">;</span>
#endif

  <span class="token keyword">return</span> rs<span class="token punctuation">.</span><span class="token function">sp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br></div></div><p>除了主动唤醒，还有带有时间的park超时时间后的被动唤醒。
VirtualThread通过一个ScheduledExecutorService来执行定时任务唤醒，在非超时的唤醒情况通过cancel取消异步任务，并且还通过一个parkPermit字段方式重复唤醒。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ScheduledExecutorService</span> UNPARKER <span class="token operator">=</span> <span class="token function">createDelayedTaskScheduler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">void</span> <span class="token function">parkNanos</span><span class="token punctuation">(</span><span class="token keyword">long</span> nanos<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">assert</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">this</span><span class="token punctuation">;</span>

        <span class="token comment">// complete immediately if parking permit available or interrupted</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getAndSetParkPermit</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token operator">||</span> interrupted<span class="token punctuation">)</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>

        <span class="token comment">// park the thread for the waiting time</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>nanos <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">long</span> startTime <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">boolean</span> yielded <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> unparker <span class="token operator">=</span> <span class="token function">scheduleUnpark</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">::</span><span class="token function">unpark</span><span class="token punctuation">,</span> nanos<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">setState</span><span class="token punctuation">(</span>PARKING<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                yielded <span class="token operator">=</span> <span class="token function">yieldContinuation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// may throw</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                <span class="token keyword">assert</span> <span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>yielded <span class="token operator">==</span> <span class="token punctuation">(</span><span class="token function">state</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> RUNNING<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>yielded<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">assert</span> <span class="token function">state</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> PARKING<span class="token punctuation">;</span>
                    <span class="token function">setState</span><span class="token punctuation">(</span>RUNNING<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token function">cancel</span><span class="token punctuation">(</span>unparker<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// park on carrier thread for remaining time when pinned</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>yielded<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">long</span> deadline <span class="token operator">=</span> startTime <span class="token operator">+</span> nanos<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>deadline <span class="token operator">&lt;</span> <span class="token number">0L</span><span class="token punctuation">)</span>
                    deadline <span class="token operator">=</span> <span class="token class-name">Long</span><span class="token punctuation">.</span>MAX_VALUE<span class="token punctuation">;</span>
                <span class="token function">parkOnCarrierThread</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> deadline <span class="token operator">-</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br></div></div><h2 id="scheduler虚拟线程调度器"><a href="#scheduler虚拟线程调度器" class="header-anchor">#</a> scheduler虚拟线程调度器</h2> <p>虚拟线程的调度器使用的是ForkJoinPool，能够通过启动参数配置线程池大小等配置。</p> <p>使用ForkJoinPool而不是ThreadPoolExecutor的一个重要原因是ForkJoinPool支持work steal，当一个CarrierThread中的任务太多时，其他空闲的CarrierThread可以分担执行，充分利用CPU多核资源，避免单个核成为瓶颈。
ForkJoinPool队列默认是LIFO，VirtualThread配置的asyncMode为true使用的是FIFO。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">class</span> <span class="token class-name">VirtualThread</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ForkJoinPool</span> DEFAULT_SCHEDULER <span class="token operator">=</span> <span class="token function">createDefaultScheduler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token class-name">VirtualThread</span><span class="token punctuation">(</span><span class="token class-name">Executor</span> scheduler<span class="token punctuation">,</span> <span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token keyword">int</span> characteristics<span class="token punctuation">,</span> <span class="token class-name">Runnable</span> task<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> characteristics<span class="token punctuation">,</span> <span class="token comment">/*bound*/</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">requireNonNull</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// choose scheduler if not specified</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>scheduler <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Thread</span> parent <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>parent <span class="token keyword">instanceof</span> <span class="token class-name">VirtualThread</span> vparent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                scheduler <span class="token operator">=</span> vparent<span class="token punctuation">.</span>scheduler<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                scheduler <span class="token operator">=</span> DEFAULT_SCHEDULER<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">this</span><span class="token punctuation">.</span>scheduler <span class="token operator">=</span> scheduler<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>cont <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">VThreadContinuation</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> task<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>runContinuation <span class="token operator">=</span> <span class="token keyword">this</span><span class="token operator">::</span><span class="token function">runContinuation</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">ForkJoinPool</span> <span class="token function">createDefaultScheduler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ForkJoinWorkerThreadFactory</span> factory <span class="token operator">=</span> pool <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token class-name">PrivilegedAction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ForkJoinWorkerThread</span><span class="token punctuation">&gt;</span></span> pa <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token keyword">new</span> <span class="token class-name">CarrierThread</span><span class="token punctuation">(</span>pool<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token class-name">AccessController</span><span class="token punctuation">.</span><span class="token function">doPrivileged</span><span class="token punctuation">(</span>pa<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token class-name">PrivilegedAction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ForkJoinPool</span><span class="token punctuation">&gt;</span></span> pa <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> parallelism<span class="token punctuation">,</span> maxPoolSize<span class="token punctuation">,</span> minRunnable<span class="token punctuation">;</span>
            <span class="token class-name">String</span> parallelismValue <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">&quot;jdk.virtualThreadScheduler.parallelism&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> maxPoolSizeValue <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">&quot;jdk.virtualThreadScheduler.maxPoolSize&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> minRunnableValue <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">&quot;jdk.virtualThreadScheduler.minRunnable&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>parallelismValue <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                parallelism <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>parallelismValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                parallelism <span class="token operator">=</span> <span class="token class-name">Runtime</span><span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">availableProcessors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>maxPoolSizeValue <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                maxPoolSize <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>maxPoolSizeValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
                parallelism <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>parallelism<span class="token punctuation">,</span> maxPoolSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                maxPoolSize <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>parallelism<span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>minRunnableValue <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                minRunnable <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>minRunnableValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                minRunnable <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>parallelism <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token class-name">Thread<span class="token punctuation">.</span>UncaughtExceptionHandler</span> handler <span class="token operator">=</span> <span class="token punctuation">(</span>t<span class="token punctuation">,</span> e<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
            <span class="token keyword">boolean</span> asyncMode <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token comment">// FIFO</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ForkJoinPool</span><span class="token punctuation">(</span>parallelism<span class="token punctuation">,</span> factory<span class="token punctuation">,</span> handler<span class="token punctuation">,</span> asyncMode<span class="token punctuation">,</span>
                    <span class="token number">0</span><span class="token punctuation">,</span> maxPoolSize<span class="token punctuation">,</span> minRunnable<span class="token punctuation">,</span> pool <span class="token operator">-&gt;</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">,</span> SECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">AccessController</span><span class="token punctuation">.</span><span class="token function">doPrivileged</span><span class="token punctuation">(</span>pa<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br></div></div><h3 id="长时间运行的没有yield的virtualthread如何切换调度的"><a href="#长时间运行的没有yield的virtualthread如何切换调度的" class="header-anchor">#</a> 长时间运行的没有yield的VirtualThread如何切换调度的？</h3> <p>目前版本VirtualThread没有强制切换的逻辑，但是预留了preempted字段，应该是未之后提供强制切换长时间不yield的VirtualThread提供的准备。</p> <p>在阿里的wisp协程实现中，会有一个线程定期检查一个协程是否长时间运行，如果发现长时间运行，则会标记preempted，在safepoint时检查当前线程是否被
标记preempted，如果是则调用yield。</p> <h3 id="为什么持有monitor-lock时不能yield成功"><a href="#为什么持有monitor-lock时不能yield成功" class="header-anchor">#</a> 为什么持有monitor lock时不能yield成功？</h3> <ul><li>monitor lock会在线程栈中创建LockRecord，然后在monitor对象的对象头中install这个指针，如果因为yield发生了地址切换，会导致对象头指针失效。并且在VirtualThread解冻后复制回的新地址可能和之前不一样（比如由另一个Carrier线程来执行)</li> <li>2024年目前JDK正在解决这个问题</li></ul> <p>在阿里的wisp协程实现中，每个线程就像普通线程一样有自己的独立栈，不会移动内存，所以没有这个问题。另外在synchronized不成功需要阻塞时也调用了协程的yield。</p> <h2 id="virtualthread的看法"><a href="#virtualthread的看法" class="header-anchor">#</a> VirtualThread的看法</h2> <p>相信有很多朋友已经跃跃欲试，想在线上环境使用VirtualThread了，不过目前VirtualThread处于早期阶段，
真正使用前需要做好调研、压测、监控。尤其是核心业务更需要谨慎。
当前版本使用时有一些需要注意的问题</p> <ul><li>当一个VirtualThread在synchronized锁内产生yield，则yield会失败(pinned)，底层的CarrierThread也会pin住即阻塞住，导致该CarrierThread不能去执行其他待执行的VirtualThread，严重时导致系统阻塞。该问题需要根据使用的第三方库进行升级（比如mysql链接库等）或者等待JDK解决pinned问题</li> <li>VirtualThread的切换性能，目前VirtualThread在挂起时会讲运行栈复制到堆内存中，在切换回来时再从堆内存复制到线程栈上，大量切换会导致大量的内存复制等开销（尤其是线程栈比较深的情况）</li> <li>ThreadLocal的使用，如果大量创建VirtualThread，需要关注ThreadLocal内存使用情况和性能。</li></ul> <p>虽然有这些已知问题，但是
openjdk是全世界都在使用的项目，有专业的团队维护升级，相信VirtualThread会是大家未来的选择。</p> <h2 id="其他相关"><a href="#其他相关" class="header-anchor">#</a> 其他相关</h2> <h3 id="threadlocal"><a href="#threadlocal" class="header-anchor">#</a> ThreadLocal</h3> <p>在Java中，ThreadLocal存储在每个Thread对象的ThreadLocalMap中，key是ThreadLocal，value是ThreadLocal对应value。
但是对于VirtualThread，它的特点是可以创建非常多比如数百万个，并且有的时候VirtualThread的生命周期非常短。</p> <p>在一些缓存场景下，每个VirtualThread都自己对应一个ThreadLocal的value值可能会出现内存浪费。
比如在jdk的io处理中，会使用一些DirectByteBuffer的缓存，在<code>sun.nio.ch.Util</code>中就有bufferCache的缓存。
每个BufferCache中还有若干个ByteBuffer。这样每个VirtualThread有自己的很多DirectByteBuffer，很可能导致DirectMemory
超过配置上限导致oom。
为什么Utils类要用DirectByteBuffer写io数据？这是因为IO写操作接收的参数是内存数据的地址，而Java堆内存的地址，
可能会因为gc产生移动导致地址失效，所以要用DirectByteBuffer避免这个问题。</p> <div class="language-text line-numbers-mode"><pre class="language-text"><code>public class Util {

    // -- Caches --

    // The number of temp buffers in our pool
    private static final int TEMP_BUF_POOL_SIZE = IOUtil.IOV_MAX;

    // The max size allowed for a cached temp buffer, in bytes
    private static final long MAX_CACHED_BUFFER_SIZE = getMaxCachedBufferSize();

    // Per-carrier-thread cache of temporary direct buffers
    private static TerminatingThreadLocal&amp;lt;BufferCache&gt; bufferCache = new TerminatingThreadLocal&amp;lt;&gt;() {
        @Override
        protected BufferCache initialValue() {
            return new BufferCache();
        }
        @Override
        protected void threadTerminated(BufferCache cache) { // will never be null
            while (!cache.isEmpty()) {
                ByteBuffer bb = cache.removeFirst();
                free(bb);
            }
        }
    };
    
    public static ByteBuffer getTemporaryDirectBuffer(int size) {
        // If a buffer of this size is too large for the cache, there
        // should not be a buffer in the cache that is at least as
        // large. So we'll just create a new one. Also, we don't have
        // to remove the buffer from the cache (as this method does
        // below) given that we won't put the new buffer in the cache.
        if (isBufferTooLarge(size)) {
            return ByteBuffer.allocateDirect(size);
        }

        BufferCache cache = bufferCache.get();
        ByteBuffer buf = cache.get(size);
        if (buf != null) {
            return buf;
        } else {
            // No suitable buffer in the cache so we need to allocate a new
            // one. To avoid the cache growing then we remove the first
            // buffer from the cache and free it.
            if (!cache.isEmpty()) {
                buf = cache.removeFirst();
                free(buf);
            }
            return ByteBuffer.allocateDirect(size);
        }
    }
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br></div></div><p>那么jdk是如何解决的呢？
jdk通过给VirtualThread定义了CarrierThreadLocal这种ThreadLocal，CarrierThreadLocal
会将ThreadLocal保存到VirtualThread对应的CarrierThread中的ThreadLocalMap中，而sun.nio.ch.Util
中定义bufferCache的TerminatingThreadLocal就继承于CarrierThreadLocal。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CarrierThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">extends</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">T</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> JLA<span class="token punctuation">.</span><span class="token function">getCarrierThreadLocal</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">T</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        JLA<span class="token punctuation">.</span><span class="token function">setCarrierThreadLocal</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        JLA<span class="token punctuation">.</span><span class="token function">removeCarrierThreadLocal</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isPresent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> JLA<span class="token punctuation">.</span><span class="token function">isCarrierThreadLocalPresent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">JavaLangAccess</span> JLA <span class="token operator">=</span> <span class="token class-name">SharedSecrets</span><span class="token punctuation">.</span><span class="token function">getJavaLangAccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>在ThreadLocal类中定义了getCarrierThreadLocal和setCarrierThreadLocal实现，实现是将操作的线程对象替换成当前VirtualThread的carrier thread。</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>public class ThreadLocal<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    T <span class="token function-name function">getCarrierThreadLocal</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        assert this instanceof CarrierThreadLocal<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span><span class="token punctuation">;</span>
        <span class="token builtin class-name">return</span> get<span class="token punctuation">(</span>Thread.currentCarrierThread<span class="token punctuation">(</span><span class="token punctuation">))</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    void setCarrierThreadLocal<span class="token punctuation">(</span>T value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        assert this instanceof CarrierThreadLocal<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span><span class="token punctuation">;</span>
        set<span class="token punctuation">(</span>Thread.currentCarrierThread<span class="token punctuation">(</span><span class="token punctuation">)</span>, value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h2 id="学习资料"><a href="#学习资料" class="header-anchor">#</a> 学习资料</h2> <ul><li><a href="https://cr.openjdk.org/~rpressler/loom/Loom-Proposal.html" target="_blank" rel="noopener noreferrer">https://cr.openjdk.org/~rpressler/loom/Loom-Proposal.html<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://cr.openjdk.org/~rpressler/loom/loom/sol1_part1.html" target="_blank" rel="noopener noreferrer">https://cr.openjdk.org/~rpressler/loom/loom/sol1_part1.html<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://inside.java/2020/08/07/loom-performance/" target="_blank" rel="noopener noreferrer">用户态线程/协程的性能<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://cr.openjdk.org/~rpressler/loom/Loom-Proposal.html" target="_blank" rel="noopener noreferrer">Project Loom: Fibers and Continuations for the Java Virtual Machine<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://mp.weixin.qq.com/s?__biz=MzkxNTE3ODU0NA==&amp;mid=2247511572&amp;idx=1&amp;sn=0bbd13033a131fe8cf1d4c18b7f0646c&amp;chksm=c161fb4bf616725d7e181156294367a70719d71d099ae174f7dba0bea69e2bc3a0e282a5caaa&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer">虚拟线程原理及性能分析｜得物技术<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://juejin.cn/post/7007261636561993759" target="_blank" rel="noopener noreferrer">自研Java协程在腾讯的生产实践<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/liuzhengyang/liuzhengyang.github.io/edit/master/docs/md/jvm/jvm/virtualthread/virtual-thread.md" target="_blank" rel="noopener noreferrer">Edit this page</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/md/jvm/jvm/monitor.html" class="prev">
          synchronized、monitor lock加锁流程
        </a></span> <!----></p></div> </main></div> <aside class="page-sidebar"> <div class="page-side-toolbar"><div class="option-box-toc-fixed"><div class="toc-container-sidebar"><div class="pos-box"><div class="icon-arrow"></div> <div class="scroll-box" style="max-height:650px"><div style="font-weight:bold;text-align:center;">JDK Virtual Thread的实现</div> <hr> <div class="toc-box"><ul class="toc-sidebar-links"><li><a href="/md/jvm/jvm/virtualthread/virtual-thread.html#简介" class="toc-sidebar-link">简介</a><ul class="toc-sidebar-sub-headers"></ul></li><li><a href="/md/jvm/jvm/virtualthread/virtual-thread.html#优势" class="toc-sidebar-link">优势</a><ul class="toc-sidebar-sub-headers"></ul></li><li><a href="/md/jvm/jvm/virtualthread/virtual-thread.html#核心组件说明" class="toc-sidebar-link">核心组件说明</a><ul class="toc-sidebar-sub-headers"></ul></li><li><a href="/md/jvm/jvm/virtualthread/virtual-thread.html#核心流程" class="toc-sidebar-link">核心流程</a><ul class="toc-sidebar-sub-headers"></ul></li><li><a href="/md/jvm/jvm/virtualthread/virtual-thread.html#一些汇编基础" class="toc-sidebar-link">一些汇编基础</a><ul class="toc-sidebar-sub-headers"></ul></li><li><a href="/md/jvm/jvm/virtualthread/virtual-thread.html#虚拟线程创建、运行" class="toc-sidebar-link">虚拟线程创建、运行</a><ul class="toc-sidebar-sub-headers"><li class="toc-sidebar-sub-header"><a href="/md/jvm/jvm/virtualthread/virtual-thread.html#第一次运行时-enterspecial" class="toc-sidebar-link">第一次运行时（enterSpecial）</a></li><li class="toc-sidebar-sub-header"><a href="/md/jvm/jvm/virtualthread/virtual-thread.html#遇到需要yield的情况" class="toc-sidebar-link">遇到需要yield的情况</a></li><li class="toc-sidebar-sub-header"><a href="/md/jvm/jvm/virtualthread/virtual-thread.html#yield结束需要切换回来时" class="toc-sidebar-link">yield结束需要切换回来时</a></li></ul></li><li><a href="/md/jvm/jvm/virtualthread/virtual-thread.html#虚拟线程park阻塞的处理" class="toc-sidebar-link">虚拟线程park阻塞的处理</a><ul class="toc-sidebar-sub-headers"><li class="toc-sidebar-sub-header"><a href="/md/jvm/jvm/virtualthread/virtual-thread.html#enterspecial" class="toc-sidebar-link">enterSpecial</a></li><li class="toc-sidebar-sub-header"><a href="/md/jvm/jvm/virtualthread/virtual-thread.html#网络层适配" class="toc-sidebar-link">网络层适配</a></li></ul></li><li><a href="/md/jvm/jvm/virtualthread/virtual-thread.html#虚拟线程unpark唤醒的处理" class="toc-sidebar-link">虚拟线程unpark唤醒的处理</a><ul class="toc-sidebar-sub-headers"></ul></li><li><a href="/md/jvm/jvm/virtualthread/virtual-thread.html#scheduler虚拟线程调度器" class="toc-sidebar-link">scheduler虚拟线程调度器</a><ul class="toc-sidebar-sub-headers"><li class="toc-sidebar-sub-header"><a href="/md/jvm/jvm/virtualthread/virtual-thread.html#长时间运行的没有yield的virtualthread如何切换调度的" class="toc-sidebar-link">长时间运行的没有yield的VirtualThread如何切换调度的？</a></li><li class="toc-sidebar-sub-header"><a href="/md/jvm/jvm/virtualthread/virtual-thread.html#为什么持有monitor-lock时不能yield成功" class="toc-sidebar-link">为什么持有monitor lock时不能yield成功？</a></li></ul></li><li><a href="/md/jvm/jvm/virtualthread/virtual-thread.html#virtualthread的看法" class="toc-sidebar-link">VirtualThread的看法</a><ul class="toc-sidebar-sub-headers"></ul></li><li><a href="/md/jvm/jvm/virtualthread/virtual-thread.html#其他相关" class="toc-sidebar-link">其他相关</a><ul class="toc-sidebar-sub-headers"><li class="toc-sidebar-sub-header"><a href="/md/jvm/jvm/virtualthread/virtual-thread.html#threadlocal" class="toc-sidebar-link">ThreadLocal</a></li></ul></li><li><a href="/md/jvm/jvm/virtualthread/virtual-thread.html#学习资料" class="toc-sidebar-link">学习资料</a><ul class="toc-sidebar-sub-headers"></ul></li></ul></div></div></div></div></div> <div class="option-box-toc-over"><img src="/images/system/toc.png" class="nozoom"> <span class="show-txt">目录</span> <div class="toc-container"><div class="pos-box"><div class="icon-arrow"></div> <div class="scroll-box" style="max-height:550px"><div style="font-weight:bold;text-align:center;">JDK Virtual Thread的实现</div> <hr> <div class="toc-box"><ul class="toc-sidebar-links"><li><a href="/md/jvm/jvm/virtualthread/virtual-thread.html#简介" class="toc-sidebar-link">简介</a><ul class="toc-sidebar-sub-headers"></ul></li><li><a href="/md/jvm/jvm/virtualthread/virtual-thread.html#优势" class="toc-sidebar-link">优势</a><ul class="toc-sidebar-sub-headers"></ul></li><li><a href="/md/jvm/jvm/virtualthread/virtual-thread.html#核心组件说明" class="toc-sidebar-link">核心组件说明</a><ul class="toc-sidebar-sub-headers"></ul></li><li><a href="/md/jvm/jvm/virtualthread/virtual-thread.html#核心流程" class="toc-sidebar-link">核心流程</a><ul class="toc-sidebar-sub-headers"></ul></li><li><a href="/md/jvm/jvm/virtualthread/virtual-thread.html#一些汇编基础" class="toc-sidebar-link">一些汇编基础</a><ul class="toc-sidebar-sub-headers"></ul></li><li><a href="/md/jvm/jvm/virtualthread/virtual-thread.html#虚拟线程创建、运行" class="toc-sidebar-link">虚拟线程创建、运行</a><ul class="toc-sidebar-sub-headers"><li class="toc-sidebar-sub-header"><a href="/md/jvm/jvm/virtualthread/virtual-thread.html#第一次运行时-enterspecial" class="toc-sidebar-link">第一次运行时（enterSpecial）</a></li><li class="toc-sidebar-sub-header"><a href="/md/jvm/jvm/virtualthread/virtual-thread.html#遇到需要yield的情况" class="toc-sidebar-link">遇到需要yield的情况</a></li><li class="toc-sidebar-sub-header"><a href="/md/jvm/jvm/virtualthread/virtual-thread.html#yield结束需要切换回来时" class="toc-sidebar-link">yield结束需要切换回来时</a></li></ul></li><li><a href="/md/jvm/jvm/virtualthread/virtual-thread.html#虚拟线程park阻塞的处理" class="toc-sidebar-link">虚拟线程park阻塞的处理</a><ul class="toc-sidebar-sub-headers"><li class="toc-sidebar-sub-header"><a href="/md/jvm/jvm/virtualthread/virtual-thread.html#enterspecial" class="toc-sidebar-link">enterSpecial</a></li><li class="toc-sidebar-sub-header"><a href="/md/jvm/jvm/virtualthread/virtual-thread.html#网络层适配" class="toc-sidebar-link">网络层适配</a></li></ul></li><li><a href="/md/jvm/jvm/virtualthread/virtual-thread.html#虚拟线程unpark唤醒的处理" class="toc-sidebar-link">虚拟线程unpark唤醒的处理</a><ul class="toc-sidebar-sub-headers"></ul></li><li><a href="/md/jvm/jvm/virtualthread/virtual-thread.html#scheduler虚拟线程调度器" class="toc-sidebar-link">scheduler虚拟线程调度器</a><ul class="toc-sidebar-sub-headers"><li class="toc-sidebar-sub-header"><a href="/md/jvm/jvm/virtualthread/virtual-thread.html#长时间运行的没有yield的virtualthread如何切换调度的" class="toc-sidebar-link">长时间运行的没有yield的VirtualThread如何切换调度的？</a></li><li class="toc-sidebar-sub-header"><a href="/md/jvm/jvm/virtualthread/virtual-thread.html#为什么持有monitor-lock时不能yield成功" class="toc-sidebar-link">为什么持有monitor lock时不能yield成功？</a></li></ul></li><li><a href="/md/jvm/jvm/virtualthread/virtual-thread.html#virtualthread的看法" class="toc-sidebar-link">VirtualThread的看法</a><ul class="toc-sidebar-sub-headers"></ul></li><li><a href="/md/jvm/jvm/virtualthread/virtual-thread.html#其他相关" class="toc-sidebar-link">其他相关</a><ul class="toc-sidebar-sub-headers"><li class="toc-sidebar-sub-header"><a href="/md/jvm/jvm/virtualthread/virtual-thread.html#threadlocal" class="toc-sidebar-link">ThreadLocal</a></li></ul></li><li><a href="/md/jvm/jvm/virtualthread/virtual-thread.html#学习资料" class="toc-sidebar-link">学习资料</a><ul class="toc-sidebar-sub-headers"></ul></li></ul></div></div></div></div></div> <div class="option-box"><img src="/images/system/wechat.png" class="nozoom"> <span class="show-txt">手机看</span> <div class="toc-container"><div class="pos-box"><div class="icon-arrow"></div> <div class="scroll-box" style="text-align:center"><span style="font-size:0.9rem">微信扫一扫</span> <img height="180px" src="https://api.qrserver.com/v1/create-qr-code/?data=https://bytejava.cn/md/jvm/jvm/virtualthread/virtual-thread.html" style="margin:10px;">
                可以<b>手机看</b>或分享至<b>朋友圈</b></div></div></div></div> <div class="option-box"><img src="/images/personal/wechat-mp-logo.jpg" height="20" class="nozoom"> <span class="show-txt">公众号</span> <div class="toc-container"><div class="pos-box"><div class="icon-arrow"></div> <div class="scroll-box" style="text-align:center"><span style="font-size:0.9rem">关注公众号bytejava</span> <img src="/images/personal/wechat-mp.png" height="180" width></div></div></div></div> <div class="option-box"><img src="/images/system/toggle.png" width="30px" class="nozoom"> <span class="show-txt">左栏</span></div> <div class="option-box"><img src="/images/system/heart-1.png" width="25px" class="nozoom"> <span class="show-txt">赞赏我</span> <div class="toc-container"><div class="pos-box"><div class="icon-arrow"></div> <div class="scroll-box" style="text-align:center"><span style="font-size:0.8rem;font-weight:bold;">鼓励/支持/赞赏我</span> <img height="180px" src="/images/personal/encourage-head.jpg" style="margin:5px;"> <br>1. 不靠它生存但仍希望得到你的鼓励；
                <br>2. 时刻警醒自己保持技术人的初心，沉淀，分享，成长；
              </div></div></div></div> <div title="synchronized、monitor lock加锁流程" class="option-box" style="padding-left:2px;text-align:center;"><a href="/md/jvm/jvm/monitor.html"><img src="/images/system/pre2.png" width="30px" class="nozoom"> <span class="show-txt">上一篇</span></a></div> <!----></div>  <!----> </aside></div><div class="global-ui"></div></div>
    <script src="/assets/js/cg-styles.js?v=1729221831211" defer></script><script src="/assets/js/cg-4.js?v=1729221831211" defer></script><script src="/assets/js/cg-3.js?v=1729221831211" defer></script><script src="/assets/js/cg-225.js?v=1729221831211" defer></script><script src="/assets/js/cg-app.js?v=1729221831211" defer></script>
  </body>
</html>
