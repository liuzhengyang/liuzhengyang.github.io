<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>javaagent | bytejava Java进阶手册</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/favicon.ico">
    <script charset="utf-8" async="async" src="/js/jquery.min.js"></script>
    <script charset="utf-8" async="async" src="/js/global.js"></script>
    <script charset="utf-8" async="async" src="/js/fingerprint2.min.js"></script>
    <script charset="utf-8" async="async" src="https://s9.cnzz.com/z_stat.php?id=12782949&amp;web_id=1272949"></script>
    <script>
              var _hmt = _hmt || [];
              (function() {
                var hm = document.createElement("script");
                hm.src = "https://hm.baidu.com/hm.js?fa0fbf0fef3bba94118b912a64766cee";
                var s = document.getElementsByTagName("script")[0];
                s.parentNode.insertBefore(hm, s);
              })();
            </script>
    <meta name="description" content="包含: Java 基础，高并发缓存，JVM，中间件，字节码编程...">
    <meta property="og:title" content="javaagent">
    <meta property="og:type" content="article">
    <meta property="og:url" content="/md/jvm/jvm/javaagent.html">
    <meta name="twitter:title" content="javaagent">
    <meta name="twitter:url" content="/md/jvm/jvm/javaagent.html">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="robots" content="all">
    <meta name="author" content="bytejava">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="keywords" content="bytejava 高级Java，Java设计模式, 字节码编程, 中间件, Spring, Java基础, 面经手册">
    <meta name="apple-mobile-web-app-capable" content="yes">
    
    <link rel="preload" href="/assets/css/0.styles.8fb5e8ac.css" as="style"><link rel="preload" href="/assets/css/styles.css?v=1729221831211" as="style"><link rel="preload" href="/assets/js/cg-styles.js?v=1729221831211" as="script"><link rel="preload" href="/assets/js/cg-app.js?v=1729221831211" as="script"><link rel="preload" href="/assets/js/cg-4.js?v=1729221831211" as="script"><link rel="preload" href="/assets/js/cg-3.js?v=1729221831211" as="script"><link rel="preload" href="/assets/js/cg-199.js?v=1729221831211" as="script">
    <link rel="stylesheet" href="/assets/css/0.styles.8fb5e8ac.css"><link rel="stylesheet" href="/assets/css/styles.css?v=1729221831211">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">bytejava Java进阶手册</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java" class="dropdown-title"><span class="title">Java</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/java/basic/java线程池.html" class="nav-link">
  Java基础
</a></li><li class="dropdown-item"><!----> <a href="/md/java/compiler/javac.html" class="nav-link">
  Java编译器
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="JVM" class="dropdown-title"><span class="title">JVM</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/jvm/bytecode/class字节码文件格式.html" class="nav-link">
  字节码
</a></li><li class="dropdown-item"><!----> <a href="/md/jvm/jvm/javaagent.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  jvm
</a></li><li class="dropdown-item"><!----> <a href="/md/jvm/jvmti/jvmti介绍和开发.html" class="nav-link">
  jvmti
</a></li><li class="dropdown-item"><!----> <a href="/md/jvm/gc/g1/g1-all-intro.html" class="nav-link">
  G1 GC
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="缓存" class="dropdown-title"><span class="title">缓存</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/cache/redis/redis.html" class="nav-link">
  零基础到高并发应用专家，深入理解redis
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Spring" class="dropdown-title"><span class="title">Spring</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/spring/springboot启动请求处理过程.html" class="nav-link">
  Spring实现
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Kafka" class="dropdown-title"><span class="title">Kafka</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/kafka/kafka.html" class="nav-link">
  kafka
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="MyBatis" class="dropdown-title"><span class="title">MyBatis</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/mybatis/mybatis-use-general.html" class="nav-link">
  MyBatis
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="业务开发" class="dropdown-title"><span class="title">业务开发</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/develop/" class="nav-link">
  业务开发
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="中间件" class="dropdown-title"><span class="title">中间件</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/distribute/raft.html" class="nav-link">
  raft
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="算法" class="dropdown-title"><span class="title">算法</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/algorithm/leetcode.html" class="nav-link">
  算法
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="软技能通用技能" class="dropdown-title"><span class="title">软技能通用技能</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/soft/晋升答辩.html" class="nav-link">
  晋升答辩
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="专栏" class="dropdown-title"><span class="title">专栏</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/column/column.html" class="nav-link">
  订阅我的专栏
</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/liuzhengyang" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java" class="dropdown-title"><span class="title">Java</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/java/basic/java线程池.html" class="nav-link">
  Java基础
</a></li><li class="dropdown-item"><!----> <a href="/md/java/compiler/javac.html" class="nav-link">
  Java编译器
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="JVM" class="dropdown-title"><span class="title">JVM</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/jvm/bytecode/class字节码文件格式.html" class="nav-link">
  字节码
</a></li><li class="dropdown-item"><!----> <a href="/md/jvm/jvm/javaagent.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  jvm
</a></li><li class="dropdown-item"><!----> <a href="/md/jvm/jvmti/jvmti介绍和开发.html" class="nav-link">
  jvmti
</a></li><li class="dropdown-item"><!----> <a href="/md/jvm/gc/g1/g1-all-intro.html" class="nav-link">
  G1 GC
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="缓存" class="dropdown-title"><span class="title">缓存</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/cache/redis/redis.html" class="nav-link">
  零基础到高并发应用专家，深入理解redis
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Spring" class="dropdown-title"><span class="title">Spring</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/spring/springboot启动请求处理过程.html" class="nav-link">
  Spring实现
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Kafka" class="dropdown-title"><span class="title">Kafka</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/kafka/kafka.html" class="nav-link">
  kafka
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="MyBatis" class="dropdown-title"><span class="title">MyBatis</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/mybatis/mybatis-use-general.html" class="nav-link">
  MyBatis
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="业务开发" class="dropdown-title"><span class="title">业务开发</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/develop/" class="nav-link">
  业务开发
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="中间件" class="dropdown-title"><span class="title">中间件</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/distribute/raft.html" class="nav-link">
  raft
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="算法" class="dropdown-title"><span class="title">算法</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/algorithm/leetcode.html" class="nav-link">
  算法
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="软技能通用技能" class="dropdown-title"><span class="title">软技能通用技能</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/soft/晋升答辩.html" class="nav-link">
  晋升答辩
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="专栏" class="dropdown-title"><span class="title">专栏</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/column/column.html" class="nav-link">
  订阅我的专栏
</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/liuzhengyang" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>JVM</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/md/jvm/jvm/build-jdk.html" class="sidebar-link">在2024年使用Clion编译、debug、开发Java虚拟机(Mac版本)</a></li><li><a href="/md/jvm/jvm/javaagent.html" aria-current="page" class="active sidebar-link">javaagent</a></li><li><a href="/md/jvm/jvm/jstack.html" class="sidebar-link">jstack实现原理分析</a></li><li><a href="/md/jvm/jvm/string-deduplication.html" class="sidebar-link">String Deduplication</a></li><li><a href="/md/jvm/jvm/tlab.html" class="sidebar-link">TLAB</a></li><li><a href="/md/jvm/jvm/synchronizer.html" class="sidebar-link">synchronzier</a></li><li><a href="/md/jvm/jvm/monitor.html" class="sidebar-link">synchronized、monitor lock加锁流程</a></li><li><a href="/md/jvm/jvm/virtualthread/virtual-thread.html" class="sidebar-link">JDK Virtual Thread的实现</a></li></ul></section></li></ul> </aside> <div><main class="page"> <div class="theme-default-content content__default"><h1 id="javaagent"><a href="#javaagent" class="header-anchor">#</a> javaagent</h1> <h2 id="介绍"><a href="#介绍" class="header-anchor">#</a> 介绍</h2> <p>jdk提供了一种强大的可以对已有class代码进行运行时注入修改的能力。
javaagent可以在启动时通过-javaagent:agentJarPath或运行时attach加载agent包的方式使用，通过javaagent我们可以对特定的类进行字节码修改，
在方法执行前后注入特定的逻辑。
通过字节码修改，可以实现监控tracing、性能分析、在线诊断、代码热更新热部署等等各种能力。</p> <ul><li>监控tracing: 分布式tracing框架的Java类库(比如skywalking, brave, opentracing-java)常使用javaagent实现，因为tracing需要在各个第三方框架内注入tracing数据的统计收集逻辑，比如要在grpc、kafka中发送消息前后收集tracing日志，但是这些第三方的jar包我们不方便修改它们的代码，使用javaagent就成为了很好的选择。</li> <li>性能分析: 很多性能分析软件例如jprofiler使用javaagent技术，一般分析分为sampling和instrumentation两种方式，sample是通过类似jstack的方式采集方法的执行栈，instrumentation就是修改字节码来收集方法的执行次数、耗时等信息。</li> <li>在线诊断: arthas这样的软件使用javaagent技术在运行时将诊断逻辑注入到已有代码中，实现watch，trace等功能</li> <li>代码热更新、热部署: 通过javaagent技术，还能够实现Java代码的热更新，减少Java服务重启次数，提升开发效率，比如开源的https://github.com/HotswapProjects/HotswapAgent和https://github.com/dcevm/dcevm</li></ul> <h2 id="使用"><a href="#使用" class="header-anchor">#</a> 使用</h2> <h3 id="编写、打包、使用javaagent"><a href="#编写、打包、使用javaagent" class="header-anchor">#</a> 编写、打包、使用javaagent</h3> <p>我们以<a href="https://github.com/liuzhengyang/javaagent-example" target="_blank" rel="noopener noreferrer">javaagent-example<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>项目为例使用字节码实现一个最简单的AOP功能，在某个方法执行前打印字符串。</p> <p>编写javaagent需要在jar包中创建META-INF/MANIFEST.MF来配置agent的入口类等信息，通过maven的maven-assembly-plugin插件把resources文件夹下META-INF/MANIFEST.MF文件打包到jar包中。（</p> <p>maven pom相关配置示例如下。（除了maven-assembly-plugin，还可以用maven-shade-plugin)</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>build</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugins</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugin</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.maven.plugins<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>maven-compiler-plugin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>source</span><span class="token punctuation">&gt;</span></span>1.8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>source</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>target</span><span class="token punctuation">&gt;</span></span>1.8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>target</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugin</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugin</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.maven.plugins<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>maven-source-plugin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.0.1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>executions</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>execution</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span><span class="token punctuation">&gt;</span></span>attach-sources<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>id</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>phase</span><span class="token punctuation">&gt;</span></span>verify<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>phase</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>goals</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>goal</span><span class="token punctuation">&gt;</span></span>jar-no-fork<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>goal</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>goals</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>execution</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>executions</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugin</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugin</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.maven.plugins<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>maven-assembly-plugin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.6<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>descriptorRefs</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>descriptorRef</span><span class="token punctuation">&gt;</span></span>jar-with-dependencies<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>descriptorRef</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>descriptorRefs</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>archive</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>manifestFile</span><span class="token punctuation">&gt;</span></span>src/main/resources/META-INF/MANIFEST.MF<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>manifestFile</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>archive</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>executions</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>execution</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span><span class="token punctuation">&gt;</span></span>assemble-all<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>id</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>phase</span><span class="token punctuation">&gt;</span></span>package<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>phase</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>goals</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>goal</span><span class="token punctuation">&gt;</span></span>single<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>goal</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>goals</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>execution</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>executions</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugin</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugins</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>resources</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>resource</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>directory</span><span class="token punctuation">&gt;</span></span>${basedir}/src/main/resources<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>directory</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>resource</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>resource</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>directory</span><span class="token punctuation">&gt;</span></span>${basedir}/src/main/java<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>directory</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>resource</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>resources</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>build</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br></div></div><p>同时我们还需要在pom.xml添加我们要使用的字节码修改框架asm</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.ow2.asm<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>asm-all<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>5.1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>然后我们添加MANIFEST.MF文件（在resources/META-INF文件夹下，如果没有则进行创建）</p> <p>Premain-Class和Agent-Class都配置成agent的入口类。Can-Redefine-Classes表示agent是否需要redefine的能力，默认为false，还有一个Can-Retransform-Classes配置，
我们这里虽然声明了true但是其实没有使用redfine能力。</p> <div class="language-text line-numbers-mode"><pre class="language-text"><code>Manifest-Version: 1.0
Premain-Class: com.lzy.javaagent.AgentMain
Agent-Class: com.lzy.javaagent.AgentMain
Can-Redefine-Classes: true
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>最后编写Agent入口类，也就是上面的<code>com.lzy.javaagent.AgentMain</code></p> <p>javaagent的核心功能集中在通过premain/agentmain获得的Instrumentation对象上，通过Instrumentation
对象可以添加ClassFileTransformer、调用redefine/retransform方法，以实现修改类代码的能力。
我们要实现的简单的AOP，就是在类加载前，给Instrumentation添加我们的自定义的ClassFileTransformer，
ClassFileTransformer读取加载的类，然后通过字节码工具进行解析、修改，在AOP目标类的方法的执行前后打印我们想打印的字符串。
具体实现如下，其中ClassFileTransformer使用javassist框架进行字节码修改，后续的文章我们会详细介绍javassist的使用。</p> <p>AgentMain接收Instrumentation和String参数，这里我们把String参数用来指定AOP目标类</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AgentMain</span> <span class="token punctuation">{</span>
	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">premain</span><span class="token punctuation">(</span><span class="token class-name">String</span> agentOps<span class="token punctuation">,</span> <span class="token class-name">Instrumentation</span> inst<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">instrument</span><span class="token punctuation">(</span>agentOps<span class="token punctuation">,</span> inst<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">agentmain</span><span class="token punctuation">(</span><span class="token class-name">String</span> agentOps<span class="token punctuation">,</span> <span class="token class-name">Instrumentation</span> inst<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">instrument</span><span class="token punctuation">(</span>agentOps<span class="token punctuation">,</span> inst<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">/**
	 * agentOps is aop target classname
	 */</span>
	<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">instrument</span><span class="token punctuation">(</span><span class="token class-name">String</span> agentOps<span class="token punctuation">,</span> <span class="token class-name">Instrumentation</span> inst<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>agentOps<span class="token punctuation">)</span><span class="token punctuation">;</span>
		inst<span class="token punctuation">.</span><span class="token function">addTransformer</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">AOPTransformer</span><span class="token punctuation">(</span>agentOps<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>AOPTransformer实现ClassFileTransformer，在加载指定的类时，对类进行修改在方法调用前增加代码，打印方法名。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * @author liuzhengyang
 * 2022/4/13
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AOPTransformer</span> <span class="token keyword">implements</span> <span class="token class-name">ClassFileTransformer</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> className<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">AOPTransformer</span><span class="token punctuation">(</span><span class="token class-name">String</span> className<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>className <span class="token operator">=</span> className<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 注意这里的className是 a/b/C这样的而不是a.b.C
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">transform</span><span class="token punctuation">(</span><span class="token class-name">ClassLoader</span> loader<span class="token punctuation">,</span> <span class="token class-name">String</span> className<span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> classBeingRedefined<span class="token punctuation">,</span> <span class="token class-name">ProtectionDomain</span> protectionDomain<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> classfileBuffer<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IllegalClassFormatException</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>className <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 返回null表示不修改类字节码，和返回classfileBuffer是一样的效果。</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>className<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>className<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token char">'.'</span><span class="token punctuation">,</span> <span class="token char">'/'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">ClassPool</span> classPool <span class="token operator">=</span> <span class="token class-name">ClassPool</span><span class="token punctuation">.</span><span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            classPool<span class="token punctuation">.</span><span class="token function">appendClassPath</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LoaderClassPath</span><span class="token punctuation">(</span>loader<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            classPool<span class="token punctuation">.</span><span class="token function">appendSystemPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token class-name">CtClass</span> ctClass <span class="token operator">=</span> classPool<span class="token punctuation">.</span><span class="token function">makeClass</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ByteArrayInputStream</span><span class="token punctuation">(</span>classfileBuffer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">CtMethod</span><span class="token punctuation">[</span><span class="token punctuation">]</span> declaredMethods <span class="token operator">=</span> ctClass<span class="token punctuation">.</span><span class="token function">getDeclaredMethods</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">CtMethod</span> declaredMethod <span class="token operator">:</span> declaredMethods<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    declaredMethod<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span><span class="token string">&quot;System.out.println(\&quot;before invoke&quot;</span><span class="token operator">+</span> declaredMethod<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;\&quot;);&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">return</span> ctClass<span class="token punctuation">.</span><span class="token function">toBytecode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> classfileBuffer<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br></div></div><p>然后通过mvn clean package进行打包，在target目录下可以得到一个fatjar(包含javassist等依赖)，名为javaagent-1.0-SNAPSHOT-jar-with-dependencies.jar</p> <p>然后我们就可以通过-javaagent:/tmp/javaagent-1.0-SNAPSHOT-jar-with-dependencies.jar=com.lzy.javaagent.Test 来使用agent了，注意-javaagent:后面要换成自己的agentjar包的绝对路径，=后面是传入的参数，我们这里的com.lzy.javaagent.Test是我们要aop的类。
如果是IDEA中使用，可以
<img alt="img.png" data-src="/assets/images/bytecode/javaagent/javaagent.png" loading="lazy" class="lazy"></p> <p>例如我们编写一个简单的Test类</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>lzy<span class="token punctuation">.</span>javaagent</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * @author liuzhengyang
 * 2022/4/13
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Test</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">hello</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;hello&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">new</span> <span class="token class-name">Test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">hello</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>在idea中添加先运行一次，然后修改Run Configuration，在vm options中添加-javaagent:/Users/liuzhengyang/Code/opensource/javaagent-example/target/javaagent-1.0-SNAPSHOT-jar-with-dependencies.jar=com.lzy.javaagent.Test
运行，就可以看到AOP的效果了</p> <div class="language-text line-numbers-mode"><pre class="language-text"><code>com.lzy.javaagent.Test
before invokemain
before invokehello
hello
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h3 id="通过bytebuddy获取instrumentation"><a href="#通过bytebuddy获取instrumentation" class="header-anchor">#</a> 通过bytebuddy获取Instrumentation</h3> <p>有时修改-javaagent参数不是特别方便，比如使用方可能不方便或不知道怎么修改启动参数，有没有通过maven依赖代码调用的方式使用javaagent呢？
通过bytebuddy可以实现这一功能。</p> <p>首先pom依赖中添加byte-buddy-agent的maven依赖</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>net.bytebuddy<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>byte-buddy-agent<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.11.22<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>然后通过<code>ByteBuddyAgent.install()</code>，就可以很方便的获得Instrumentation对象，接下来就可以添加ClassFileTransformer、调用redefine等等。</p> <p>关于bytebuddy的使用和实现原理，我们会在后面文章中详细介绍。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestByteBuddyInstall</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Instrumentation</span> install <span class="token operator">=</span> <span class="token class-name">ByteBuddyAgent</span><span class="token punctuation">.</span><span class="token function">install</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>install<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        install.addTransformer();</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h3 id="instrumentation接口介绍"><a href="#instrumentation接口介绍" class="header-anchor">#</a> Instrumentation接口介绍</h3> <p>我们对<code>java.lang.instrument.Instrumentation</code>类的重要方法进行一下介绍</p> <table><thead><tr><th>方法</th> <th>说明</th></tr></thead> <tbody><tr><td><code>void addTransformer(ClassFileTransformer transformer)</code></td> <td>添加一个Transformer</td></tr> <tr><td><code>void	addTransformer(ClassFileTransformer transformer, boolean canRetransform)</code></td> <td>添加一个Transformer,如果canRetransform为true这个transformer在类被retransform的时候会调用</td></tr> <tr><td><code>void	appendToBootstrapClassLoaderSearch(JarFile jarfile)</code></td> <td>添加一个jar包让bootstrap classloader能够搜索到</td></tr> <tr><td><code>void	appendToSystemClassLoaderSearch(JarFile jarfile)</code></td> <td>添加一个jar包让system classloader能够搜索到</td></tr> <tr><td><code>Class[] getAllLoadedClasses()</code></td> <td>获取当前所有已经加载的类</td></tr> <tr><td><code>Class[] getInitiatedClasses(ClassLoader loader)</code></td> <td>获取某个classloader已经初始化过的类</td></tr> <tr><td><code>long	getObjectSize(Object objectToSize)</code></td> <td>获取某个对象的大小（不包含引用的传递大小，比如一个String字段，只计算这个字段的引用4byte）</td></tr> <tr><td><code>void	redefineClasses(ClassDefinition... definitions)</code></td> <td>对某个类进行redefine修改代码，注意默认jdk只能修改方法体，不能进行增减字段方法等，dcevm jdk可以实现更强大的修改功能</td></tr> <tr><td><code>boolean removeTransformer(ClassFileTransformer transformer)</code></td> <td>从Instrumentation中删除Transformer</td></tr> <tr><td><code>void	retransformClasses(Class&lt;?&gt;... classes)</code></td> <td>让一个已经加载的类重新transform，不过在retransform过程中和redefine一样，不能对类结构进行变更，只能修改方法体</td></tr></tbody></table> <h3 id="javaagent使用注意事项"><a href="#javaagent使用注意事项" class="header-anchor">#</a> javaagent使用注意事项</h3> <ul><li>javaagent的premain和agentmain的类是通过System ClassLoader(AppClassLoader)加载的，所以如果要和业务代码通信，需要考虑classloader不同的情况，一般要通过反射（可以传入指定classloader加载类）和业务代码通信。</li> <li>注意依赖冲突的问题，比如agent的fatjar中包含了某个第三方的类，业务代码中也包含了相同的第三方但是不同版本的类，由于classloader存在父类优先委派加载的情况，可能会导致类加载异常，所以一般会通过shaded修改第三方类库的包名或者通过classloader隔离</li></ul> <h2 id="实现"><a href="#实现" class="header-anchor">#</a> 实现</h2> <h3 id="meta-inf-manifest-mf文件"><a href="#meta-inf-manifest-mf文件" class="header-anchor">#</a> META-INF/MANIFEST.MF文件</h3> <p>javaagent在打包时，按照规范需要在jar包中的META-INF/MANIFEST.MF文件中声明javaagent的配置信息，
其中最关键的是Agent-Class、Premain-Class，这两个表示使用动态attach和-javaagent启动时调用的类，
JVM会在这个类中寻找对应的agentmain和premain方法执行。
Can-Redefine-Classes、Can-Retransform-Classes表示此javaagent是否需要使用Instrumentation的
redefine和retransform的能力。
修改类的字节码有两个时机，一个javaagent通过Instrumentation.addTransformer方法注入ClassFileTransformer，
在类加载时，jvm会调用各个ClassFileTransformer，ClassFileTransformer可以修改类的字节码，但是如果要在类已经加载后再去修改它的字节码，
就需要使用redefine和retransform。</p> <div class="language-text line-numbers-mode"><pre class="language-text"><code>Manifest-Version: 1.0
Archiver-Version: Plexus Archiver
Created-By: Apache Maven 3.6.3
Built-By: liuzhengyang
Build-Jdk: 11.0.11
Agent-Class: org.hotswap.agent.HotswapAgent
Can-Redefine-Classes: true
Can-Retransform-Classes: true
Implementation-Title: java-reload-agent-assembly
Implementation-Version: 1.0-SNAPSHOT
Premain-Class: org.hotswap.agent.HotswapAgent
Specification-Title: java-reload-agent-assembly
Specification-Version: 1.0-SNAPSHOT
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h3 id="javaagent-执行流程"><a href="#javaagent-执行流程" class="header-anchor">#</a> -javaagent: 执行流程</h3> <h4 id="参数解析"><a href="#参数解析" class="header-anchor">#</a> 参数解析</h4> <p>例如当我们通过-javaagent:/Users/liuzhengyang/Code/opensource/java-reload-agent/java-reload-agent-assembly/target/java-reload-agent.jar
启动时，</p> <p>以下代码位于jdk的arguments.cpp中，jvm解析传入的启动参数，对于-javaagent参数，会解析agent jar包路径和其他参数，并放到AgentLibraryList中。
AgentLibraryList是AgentLibrary的链表，AgentLibrary包含agent的名称参数等信息。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">match_option</span><span class="token punctuation">(</span>option<span class="token punctuation">,</span> <span class="token string">&quot;-javaagent:&quot;</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>tail<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token operator">!</span>INCLUDE_JVMTI</span></span>
      <span class="token function">jio_fprintf</span><span class="token punctuation">(</span>defaultStream<span class="token double-colon punctuation">::</span><span class="token function">error_stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string">&quot;Instrumentation agents are not supported in this VM\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> JNI_ERR<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>tail <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        size_t length <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>tail<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">char</span> <span class="token operator">*</span>options <span class="token operator">=</span> <span class="token function">NEW_C_HEAP_ARRAY</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">,</span> length<span class="token punctuation">,</span> mtArguments<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">jio_snprintf</span><span class="token punctuation">(</span>options<span class="token punctuation">,</span> length<span class="token punctuation">,</span> <span class="token string">&quot;%s&quot;</span><span class="token punctuation">,</span> tail<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">add_instrument_agent</span><span class="token punctuation">(</span><span class="token string">&quot;instrument&quot;</span><span class="token punctuation">,</span> options<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// java agents need module java.instrument</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">create_numbered_property</span><span class="token punctuation">(</span><span class="token string">&quot;jdk.module.addmods&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;java.instrument&quot;</span><span class="token punctuation">,</span> addmods_count<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> JNI_ENOMEM<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token expression"><span class="token operator">/</span></span></span>

<span class="token keyword">void</span> <span class="token class-name">Arguments</span><span class="token double-colon punctuation">::</span><span class="token function">add_instrument_agent</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> name<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> options<span class="token punctuation">,</span> <span class="token keyword">bool</span> absolute_path<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  _agentList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token function">AgentLibrary</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> options<span class="token punctuation">,</span> absolute_path<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

  <span class="token comment">// -agentlib and -agentpath arguments</span>
  <span class="token keyword">static</span> AgentLibraryList _agentList<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><h3 id="agentlibrary加载使用"><a href="#agentlibrary加载使用" class="header-anchor">#</a> agentLibrary加载使用</h3> <p>解析完启动参数后，jvm会创建vm，agentLibrary也是在这个过程中加载的。</p> <p>create_vm方法判断<code>Arguments::init_agents_at_startup()</code>为true(AgentLibraryList不为空列表)，则执行<code>create_vm_init_agents</code>。</p> <p>以下代码位于thread.cpp中。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code>jint <span class="token class-name">Threads</span><span class="token double-colon punctuation">::</span><span class="token function">create_vm</span><span class="token punctuation">(</span>JavaVMInitArgs<span class="token operator">*</span> args<span class="token punctuation">,</span> <span class="token keyword">bool</span><span class="token operator">*</span> canTryAgain<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">extern</span> <span class="token keyword">void</span> <span class="token function">JDK_Version_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Preinitialize version info.</span>
  <span class="token class-name">VM_Version</span><span class="token double-colon punctuation">::</span><span class="token function">early_initialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 省略其他代码...</span>

  <span class="token comment">// Launch -agentlib/-agentpath and converted -Xrun agents</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Arguments</span><span class="token double-colon punctuation">::</span><span class="token function">init_agents_at_startup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">create_vm_init_agents</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 省略其他代码...</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>create_vm_init_agents方法负责初始化各个AgentLibrary，lookup_agent_on_load负责查找加载AgentLibrary对应的JVMTI动态链接库，然后调用对应JVMTI动态链接库的on_load_entry回调方法</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">void</span> <span class="token class-name">Threads</span><span class="token double-colon punctuation">::</span><span class="token function">create_vm_init_agents</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">extern</span> <span class="token keyword">struct</span> <span class="token class-name">JavaVM_</span> main_vm<span class="token punctuation">;</span>
  AgentLibrary<span class="token operator">*</span> agent<span class="token punctuation">;</span>

  <span class="token class-name">JvmtiExport</span><span class="token double-colon punctuation">::</span><span class="token function">enter_onload_phase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span>agent <span class="token operator">=</span> <span class="token class-name">Arguments</span><span class="token double-colon punctuation">::</span><span class="token function">agents</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> agent <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> agent <span class="token operator">=</span> agent<span class="token operator">-&gt;</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// CDS dumping does not support native JVMTI agent.</span>
    <span class="token comment">// CDS dumping supports Java agent if the AllowArchivingWithJavaAgent diagnostic option is specified.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Arguments</span><span class="token double-colon punctuation">::</span><span class="token function">is_dumping_archive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>agent<span class="token operator">-&gt;</span><span class="token function">is_instrument_lib</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">vm_exit_during_cds_dumping</span><span class="token punctuation">(</span><span class="token string">&quot;CDS dumping does not support native JVMTI agent, name&quot;</span><span class="token punctuation">,</span> agent<span class="token operator">-&gt;</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>AllowArchivingWithJavaAgent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">vm_exit_during_cds_dumping</span><span class="token punctuation">(</span>
          <span class="token string">&quot;Must enable AllowArchivingWithJavaAgent in order to run Java agent during CDS dumping&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    OnLoadEntry_t  on_load_entry <span class="token operator">=</span> <span class="token function">lookup_agent_on_load</span><span class="token punctuation">(</span>agent<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>on_load_entry <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Invoke the Agent_OnLoad function</span>
      jint err <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>on_load_entry<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>main_vm<span class="token punctuation">,</span> agent<span class="token operator">-&gt;</span><span class="token function">options</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">!=</span> JNI_OK<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">vm_exit_during_initialization</span><span class="token punctuation">(</span><span class="token string">&quot;agent library failed to init&quot;</span><span class="token punctuation">,</span> agent<span class="token operator">-&gt;</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token function">vm_exit_during_initialization</span><span class="token punctuation">(</span><span class="token string">&quot;Could not find Agent_OnLoad function in the agent library&quot;</span><span class="token punctuation">,</span> agent<span class="token operator">-&gt;</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token class-name">JvmtiExport</span><span class="token double-colon punctuation">::</span><span class="token function">enter_primordial_phase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><p>lookup_agent_on_load方法负责查找对应的jvmti动态链接库，对于javaagent，jvm中已经内置了对应的动态库名为instrument，位于jdk的lib文件夹下，比如mac下
是lib/libinstrument.dylib，linux中是lib/libinstrument.so。</p> <div class="language-text line-numbers-mode"><pre class="language-text"><code>// Find a command line agent library and return its entry point for
//         -agentlib:  -agentpath:   -Xrun
// num_symbol_entries must be passed-in since only the caller knows the number of symbols in the array.
static OnLoadEntry_t lookup_on_load(AgentLibrary* agent,
                                    const char *on_load_symbols[],
                                    size_t num_symbol_entries) {
  OnLoadEntry_t on_load_entry = NULL;
  void *library = NULL;

  if (!agent-&gt;valid()) {
    char buffer[JVM_MAXPATHLEN];
    char ebuf[1024] = &quot;&quot;;
    const char *name = agent-&gt;name();
    const char *msg = &quot;Could not find agent library &quot;;

    // First check to see if agent is statically linked into executable
    if (os::find_builtin_agent(agent, on_load_symbols, num_symbol_entries)) {
      library = agent-&gt;os_lib();
    } else if (agent-&gt;is_absolute_path()) {
      library = os::dll_load(name, ebuf, sizeof ebuf);
      if (library == NULL) {
        const char *sub_msg = &quot; in absolute path, with error: &quot;;
        size_t len = strlen(msg) + strlen(name) + strlen(sub_msg) + strlen(ebuf) + 1;
        char *buf = NEW_C_HEAP_ARRAY(char, len, mtThread);
        jio_snprintf(buf, len, &quot;%s%s%s%s&quot;, msg, name, sub_msg, ebuf);
        // If we can't find the agent, exit.
        vm_exit_during_initialization(buf, NULL);
        FREE_C_HEAP_ARRAY(char, buf);
      }
    } else {
      // Try to load the agent from the standard dll directory
      if (os::dll_locate_lib(buffer, sizeof(buffer), Arguments::get_dll_dir(),
                             name)) {
        library = os::dll_load(buffer, ebuf, sizeof ebuf);
      }
      if (library == NULL) { // Try the library path directory.
        if (os::dll_build_name(buffer, sizeof(buffer), name)) {
          library = os::dll_load(buffer, ebuf, sizeof ebuf);
        }
        if (library == NULL) {
          const char *sub_msg = &quot; on the library path, with error: &quot;;
          const char *sub_msg2 = &quot;\nModule java.instrument may be missing from runtime image.&quot;;

          size_t len = strlen(msg) + strlen(name) + strlen(sub_msg) +
                       strlen(ebuf) + strlen(sub_msg2) + 1;
          char *buf = NEW_C_HEAP_ARRAY(char, len, mtThread);
          if (!agent-&gt;is_instrument_lib()) {
            jio_snprintf(buf, len, &quot;%s%s%s%s&quot;, msg, name, sub_msg, ebuf);
          } else {
            jio_snprintf(buf, len, &quot;%s%s%s%s%s&quot;, msg, name, sub_msg, ebuf, sub_msg2);
          }
          // If we can't find the agent, exit.
          vm_exit_during_initialization(buf, NULL);
          FREE_C_HEAP_ARRAY(char, buf);
        }
      }
    }
    agent-&gt;set_os_lib(library);
    agent-&gt;set_valid();
  }

  // Find the OnLoad function.
  on_load_entry =
    CAST_TO_FN_PTR(OnLoadEntry_t, os::find_agent_function(agent,
                                                          false,
                                                          on_load_symbols,
                                                          num_symbol_entries));
  return on_load_entry;
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br></div></div><p>instrument动态链接库的实现位于java/instrumentat/share/native/libinstrument
入口为InvocationAdapter.c，on_load_entry方法实现是DEF_Agent_OnLoad方法。
createNewJPLISAgent是创建一个JPLISAgent(Java Programming Language Instrumentation Services)
创建完成JPLISAgent后，会读取保存premainClass、jarfile、bootClassPath等信息。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code>JNIEXPORT jint JNICALL
<span class="token function">DEF_Agent_OnLoad</span><span class="token punctuation">(</span>JavaVM <span class="token operator">*</span>vm<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>tail<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span> reserved<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    JPLISInitializationError initerror  <span class="token operator">=</span> JPLIS_INIT_ERROR_NONE<span class="token punctuation">;</span>
    jint                     result     <span class="token operator">=</span> JNI_OK<span class="token punctuation">;</span>
    JPLISAgent <span class="token operator">*</span>             agent      <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

    initerror <span class="token operator">=</span> <span class="token function">createNewJPLISAgent</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token operator">&amp;</span>agent<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> initerror <span class="token operator">==</span> JPLIS_INIT_ERROR_NONE <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span>             oldLen<span class="token punctuation">,</span> newLen<span class="token punctuation">;</span>
        <span class="token keyword">char</span> <span class="token operator">*</span>          jarfile<span class="token punctuation">;</span>
        <span class="token keyword">char</span> <span class="token operator">*</span>          options<span class="token punctuation">;</span>
        jarAttribute<span class="token operator">*</span>   attributes<span class="token punctuation">;</span>
        <span class="token keyword">char</span> <span class="token operator">*</span>          premainClass<span class="token punctuation">;</span>
        <span class="token keyword">char</span> <span class="token operator">*</span>          bootClassPath<span class="token punctuation">;</span>

        <span class="token comment">/*
         * Parse &lt;jarfile&gt;[=options] into jarfile and options
         */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">parseArgumentTail</span><span class="token punctuation">(</span>tail<span class="token punctuation">,</span> <span class="token operator">&amp;</span>jarfile<span class="token punctuation">,</span> <span class="token operator">&amp;</span>options<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;-javaagent: memory allocation failure.\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> JNI_ERR<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">/*
         * Agent_OnLoad is specified to provide the agent options
         * argument tail in modified UTF8. However for 1.5.0 this is
         * actually in the platform encoding - see 5049313.
         *
         * Open zip/jar file and parse archive. If can't be opened or
         * not a zip file return error. Also if Premain-Class attribute
         * isn't present we return an error.
         */</span>
        attributes <span class="token operator">=</span> <span class="token function">readAttributes</span><span class="token punctuation">(</span>jarfile<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>attributes <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;Error opening zip file or JAR manifest missing : %s\n&quot;</span><span class="token punctuation">,</span> jarfile<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">free</span><span class="token punctuation">(</span>jarfile<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>options <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token function">free</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> JNI_ERR<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        premainClass <span class="token operator">=</span> <span class="token function">getAttribute</span><span class="token punctuation">(</span>attributes<span class="token punctuation">,</span> <span class="token string">&quot;Premain-Class&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>premainClass <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;Failed to find Premain-Class manifest attribute in %s\n&quot;</span><span class="token punctuation">,</span>
                jarfile<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">free</span><span class="token punctuation">(</span>jarfile<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>options <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token function">free</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">freeAttributes</span><span class="token punctuation">(</span>attributes<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> JNI_ERR<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">/* Save the jarfile name */</span>
        agent<span class="token operator">-&gt;</span>mJarfile <span class="token operator">=</span> jarfile<span class="token punctuation">;</span>

        <span class="token comment">/*
         * The value of the Premain-Class attribute becomes the agent
         * class name. The manifest is in UTF8 so need to convert to
         * modified UTF8 (see JNI spec).
         */</span>
        oldLen <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token function">strlen</span><span class="token punctuation">(</span>premainClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
        newLen <span class="token operator">=</span> <span class="token function">modifiedUtf8LengthOfUtf8</span><span class="token punctuation">(</span>premainClass<span class="token punctuation">,</span> oldLen<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>newLen <span class="token operator">==</span> oldLen<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            premainClass <span class="token operator">=</span> <span class="token function">strdup</span><span class="token punctuation">(</span>premainClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">char</span><span class="token operator">*</span> str <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span> newLen<span class="token operator">+</span><span class="token number">1</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>str <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">convertUtf8ToModifiedUtf8</span><span class="token punctuation">(</span>premainClass<span class="token punctuation">,</span> oldLen<span class="token punctuation">,</span> str<span class="token punctuation">,</span> newLen<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            premainClass <span class="token operator">=</span> str<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>premainClass <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;-javaagent: memory allocation failed\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">free</span><span class="token punctuation">(</span>jarfile<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>options <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token function">free</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">freeAttributes</span><span class="token punctuation">(</span>attributes<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> JNI_ERR<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">/*
         * If the Boot-Class-Path attribute is specified then we process
         * each relative URL and add it to the bootclasspath.
         */</span>
        bootClassPath <span class="token operator">=</span> <span class="token function">getAttribute</span><span class="token punctuation">(</span>attributes<span class="token punctuation">,</span> <span class="token string">&quot;Boot-Class-Path&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>bootClassPath <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">appendBootClassPath</span><span class="token punctuation">(</span>agent<span class="token punctuation">,</span> jarfile<span class="token punctuation">,</span> bootClassPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">/*
         * Convert JAR attributes into agent capabilities
         */</span>
        <span class="token function">convertCapabilityAttributes</span><span class="token punctuation">(</span>attributes<span class="token punctuation">,</span> agent<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">/*
         * Track (record) the agent class name and options data
         */</span>
        initerror <span class="token operator">=</span> <span class="token function">recordCommandLineData</span><span class="token punctuation">(</span>agent<span class="token punctuation">,</span> premainClass<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">/*
         * Clean-up
         */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>options <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token function">free</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">freeAttributes</span><span class="token punctuation">(</span>attributes<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">free</span><span class="token punctuation">(</span>premainClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">switch</span> <span class="token punctuation">(</span>initerror<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> JPLIS_INIT_ERROR_NONE<span class="token operator">:</span>
      result <span class="token operator">=</span> JNI_OK<span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> JPLIS_INIT_ERROR_CANNOT_CREATE_NATIVE_AGENT<span class="token operator">:</span>
      result <span class="token operator">=</span> JNI_ERR<span class="token punctuation">;</span>
      <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;java.lang.instrument/-javaagent: cannot create native agent.\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> JPLIS_INIT_ERROR_FAILURE<span class="token operator">:</span>
      result <span class="token operator">=</span> JNI_ERR<span class="token punctuation">;</span>
      <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;java.lang.instrument/-javaagent: initialization of native agent failed.\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> JPLIS_INIT_ERROR_ALLOCATION_FAILURE<span class="token operator">:</span>
      result <span class="token operator">=</span> JNI_ERR<span class="token punctuation">;</span>
      <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;java.lang.instrument/-javaagent: allocation failure.\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> JPLIS_INIT_ERROR_AGENT_CLASS_NOT_SPECIFIED<span class="token operator">:</span>
      result <span class="token operator">=</span> JNI_ERR<span class="token punctuation">;</span>
      <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;-javaagent: agent class not specified.\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">default</span><span class="token operator">:</span>
      result <span class="token operator">=</span> JNI_ERR<span class="token punctuation">;</span>
      <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;java.lang.instrument/-javaagent: unknown error\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br></div></div><h4 id="调用premain方法"><a href="#调用premain方法" class="header-anchor">#</a> 调用premain方法</h4> <p>在Thread::create_vm方法中，会调用post_vm_initialized，回调各个JVMTI动态链接库，其中instrument中</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token comment">// Notify JVMTI agents that VM initialization is complete - nop if no agents.</span>
  <span class="token class-name">JvmtiExport</span><span class="token double-colon punctuation">::</span><span class="token function">post_vm_initialized</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>其中instrument的JVMTI入口在InvocationAdapter.c的eventHandlerVMInit方法，eventHandlerVMInit中会调用JPLISAgent的processJavaStart方法
来启动javaagent中的premain方法。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token comment">/*
 *  JVMTI callback support
 *
 *  We have two &quot;stages&quot; of callback support.
 *  At OnLoad time, we install a VMInit handler.
 *  When the VMInit handler runs, we remove the VMInit handler and install a
 *  ClassFileLoadHook handler.
 */</span>

<span class="token keyword">void</span> JNICALL
<span class="token function">eventHandlerVMInit</span><span class="token punctuation">(</span> jvmtiEnv <span class="token operator">*</span>      jvmtienv<span class="token punctuation">,</span>
                    JNIEnv <span class="token operator">*</span>        jnienv<span class="token punctuation">,</span>
                    jthread         thread<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    JPLISEnvironment <span class="token operator">*</span> environment  <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    jboolean           success      <span class="token operator">=</span> JNI_FALSE<span class="token punctuation">;</span>

    environment <span class="token operator">=</span> <span class="token function">getJPLISEnvironment</span><span class="token punctuation">(</span>jvmtienv<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* process the premain calls on the all the JPL agents */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>environment <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">abortJVM</span><span class="token punctuation">(</span>jnienv<span class="token punctuation">,</span> JPLIS_ERRORMESSAGE_CANNOTSTART <span class="token string">&quot;, getting JPLIS environment failed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    jthrowable outstandingException <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token comment">/*
     * Add the jarfile to the system class path
     */</span>
    JPLISAgent <span class="token operator">*</span> agent <span class="token operator">=</span> environment<span class="token operator">-&gt;</span>mAgent<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">appendClassPath</span><span class="token punctuation">(</span>agent<span class="token punctuation">,</span> agent<span class="token operator">-&gt;</span>mJarfile<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;Unable to add %s to system class path - &quot;</span>
                <span class="token string">&quot;the system class loader does not define the &quot;</span>
                <span class="token string">&quot;appendToClassPathForInstrumentation method or the method failed\n&quot;</span><span class="token punctuation">,</span>
                agent<span class="token operator">-&gt;</span>mJarfile<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">free</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>agent<span class="token operator">-&gt;</span>mJarfile<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">abortJVM</span><span class="token punctuation">(</span>jnienv<span class="token punctuation">,</span> JPLIS_ERRORMESSAGE_CANNOTSTART <span class="token string">&quot;, appending to system class path failed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">free</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>agent<span class="token operator">-&gt;</span>mJarfile<span class="token punctuation">)</span><span class="token punctuation">;</span>
    agent<span class="token operator">-&gt;</span>mJarfile <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

    outstandingException <span class="token operator">=</span> <span class="token function">preserveThrowable</span><span class="token punctuation">(</span>jnienv<span class="token punctuation">)</span><span class="token punctuation">;</span>
    success <span class="token operator">=</span> <span class="token function">processJavaStart</span><span class="token punctuation">(</span> environment<span class="token operator">-&gt;</span>mAgent<span class="token punctuation">,</span> jnienv<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">restoreThrowable</span><span class="token punctuation">(</span>jnienv<span class="token punctuation">,</span> outstandingException<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* if we fail to start cleanly, bring down the JVM */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span>success <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">abortJVM</span><span class="token punctuation">(</span>jnienv<span class="token punctuation">,</span> JPLIS_ERRORMESSAGE_CANNOTSTART <span class="token string">&quot;, processJavaStart failed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br></div></div><p>processJavaStart负责调用agent jar包中的premain方法。
createInstrumentationImpl创建Instrumentation类的实例(sun.instrument.InstrumentationImpl)
startJavaAgent会调用agent中的premain方法，传入Instrumentation类实例和agent参数。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token comment">/*
 * If this call fails, the JVM launch will ultimately be aborted,
 * so we don't have to be super-careful to clean up in partial failure
 * cases.
 */</span>
jboolean
<span class="token function">processJavaStart</span><span class="token punctuation">(</span>   JPLISAgent <span class="token operator">*</span>    agent<span class="token punctuation">,</span>
                    JNIEnv <span class="token operator">*</span>        jnienv<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    jboolean    result<span class="token punctuation">;</span>

    <span class="token comment">/*
     *  OK, Java is up now. We can start everything that needs Java.
     */</span>

    <span class="token comment">/*
     *  First make our fallback InternalError throwable.
     */</span>
    result <span class="token operator">=</span> <span class="token function">initializeFallbackError</span><span class="token punctuation">(</span>jnienv<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">jplis_assert_msg</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> <span class="token string">&quot;fallback init failed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/*
     *  Now make the InstrumentationImpl instance.
     */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> result <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        result <span class="token operator">=</span> <span class="token function">createInstrumentationImpl</span><span class="token punctuation">(</span>jnienv<span class="token punctuation">,</span> agent<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">jplis_assert_msg</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> <span class="token string">&quot;instrumentation instance creation failed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token comment">/*
     *  Register a handler for ClassFileLoadHook (without enabling this event).
     *  Turn off the VMInit handler.
     */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> result <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        result <span class="token operator">=</span> <span class="token function">setLivePhaseEventHandlers</span><span class="token punctuation">(</span>agent<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">jplis_assert_msg</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> <span class="token string">&quot;setting of live phase VM handlers failed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/*
     *  Load the Java agent, and call the premain.
     */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> result <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        result <span class="token operator">=</span> <span class="token function">startJavaAgent</span><span class="token punctuation">(</span>agent<span class="token punctuation">,</span> jnienv<span class="token punctuation">,</span>
                                agent<span class="token operator">-&gt;</span>mAgentClassName<span class="token punctuation">,</span> agent<span class="token operator">-&gt;</span>mOptionsString<span class="token punctuation">,</span>
                                agent<span class="token operator">-&gt;</span>mPremainCaller<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">jplis_assert_msg</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> <span class="token string">&quot;agent load/premain call failed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/*
     * Finally surrender all of the tracking data that we don't need any more.
     * If something is wrong, skip it, we will be aborting the JVM anyway.
     */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> result <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">deallocateCommandLineData</span><span class="token punctuation">(</span>agent<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br></div></div><h2 id="can-redefine-classes和can-retransform-classes的作用"><a href="#can-redefine-classes和can-retransform-classes的作用" class="header-anchor">#</a> Can-Redefine-Classes和Can-Retransform-Classes的作用</h2> <p><a href="https://docs.oracle.com/en/java/javase/11/docs/specs/jvmti.html" target="_blank" rel="noopener noreferrer">jvmti<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h3 id="运行时attach加载agent"><a href="#运行时attach加载agent" class="header-anchor">#</a> 运行时attach加载agent</h3> <p>在启动时通过javaagent加载agent在一些情况下不太方便，比如有时候我们想对运行中的程序进行一些类的变更，
比如进行性能分析或者程序诊断，如果要修改启动参数重启，可能会导致现场被破坏，修改参数重启也不是很方便，这时jdk提供的动态attach加载agent功能就非常方便了。
arthas和jprofiler均能这种方式。</p> <p>attach和loadAgent代码实例如下，首先通过VirtualMachine.attach attach到本机的某个java进程，
得到VirtualMachine, 然后调用VirtualMachine的loadAgent方法加载调用具体的路径的javaagent jar包。</p> <p>这个是由jdk的AttachListener实现的，除了attach后加载javaagent，jdk中的jstack，jcmd等命令也都是使用AttachListener机制和jvm通信的。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">String</span> pid <span class="token operator">=</span> <span class="token string">&quot;要attach的目标进程id&quot;</span><span class="token punctuation">;</span>
<span class="token class-name">String</span> agentPath <span class="token operator">=</span> <span class="token string">&quot;javaagent jar包的绝对路径&quot;</span><span class="token punctuation">;</span>
<span class="token class-name">String</span> agentOptions <span class="token operator">=</span> <span class="token string">&quot;可选的传给agentmain方法的参数&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token class-name">VirtualMachine</span> virtualMachine <span class="token operator">=</span> <span class="token class-name">VirtualMachine</span><span class="token punctuation">.</span><span class="token function">attach</span><span class="token punctuation">(</span>pid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    virtualMachine<span class="token punctuation">.</span><span class="token function">loadAgent</span><span class="token punctuation">(</span>agentPath<span class="token punctuation">,</span> agentOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
    virtualMachine<span class="token punctuation">.</span><span class="token function">detach</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h4 id="attach客户端"><a href="#attach客户端" class="header-anchor">#</a> attach客户端</h4> <p>jvm在tmpdir目录下(linux下是/tmp)创建<code>.java_pid&lt;pid&gt;</code>文件(<code>&lt;pid&gt;</code>是进程id)用来和客户端通信，
默认情况下不会提前创建，客户端会通过向目标java进程发送QUIT信号，java进程收到QUIT后会创建这个通信文件。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">VirtualMachineImpl</span><span class="token punctuation">(</span><span class="token class-name">AttachProvider</span> provider<span class="token punctuation">,</span> <span class="token class-name">String</span> vmid<span class="token punctuation">)</span>
        <span class="token keyword">throws</span> <span class="token class-name">AttachNotSupportedException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span>
<span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>provider<span class="token punctuation">,</span> vmid<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> pid<span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        pid <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>vmid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NumberFormatException</span> x<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">AttachNotSupportedException</span><span class="token punctuation">(</span><span class="token string">&quot;Invalid process identifier&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Find the socket file. If not found then we attempt to start the</span>
    <span class="token comment">// attach mechanism in the target VM by sending it a QUIT signal.</span>
    <span class="token comment">// Then we attempt to find the socket file again.</span>
    <span class="token class-name">File</span> socket_file <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>tmpdir<span class="token punctuation">,</span> <span class="token string">&quot;.java_pid&quot;</span> <span class="token operator">+</span> pid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    socket_path <span class="token operator">=</span> socket_file<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>socket_file<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">File</span> f <span class="token operator">=</span> <span class="token function">createAttachFile</span><span class="token punctuation">(</span>pid<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">sendQuitTo</span><span class="token punctuation">(</span>pid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ...</span>

    <span class="token keyword">int</span> s <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token function">connect</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> socket_path<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        <span class="token function">close</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><p>创建完VirtualMachine以及socket通信后，就可以向jvm发送消息了。
loadAgent调用loadAgentLibrary传入instrument表示使用这个JVMTI动态链接库，并且传入args参数。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">loadAgent</span><span class="token punctuation">(</span><span class="token class-name">String</span> agent<span class="token punctuation">,</span> <span class="token class-name">String</span> options<span class="token punctuation">)</span>
        <span class="token keyword">throws</span> <span class="token class-name">AgentLoadException</span><span class="token punctuation">,</span> <span class="token class-name">AgentInitializationException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span>
<span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token class-name">String</span> args <span class="token operator">=</span> agent<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>options <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        args <span class="token operator">=</span> args <span class="token operator">+</span> <span class="token string">&quot;=&quot;</span> <span class="token operator">+</span> options<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token function">loadAgentLibrary</span><span class="token punctuation">(</span><span class="token string">&quot;instrument&quot;</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">AgentInitializationException</span> x<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>loadAgentLibrary</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/*
private void loadAgentLibrary(String agentLibrary, boolean isAbsolute, String options)
throws AgentLoadException, AgentInitializationException, IOException
{
InputStream in = execute(&quot;load&quot;, agentLibrary, isAbsolute ? &quot;true&quot; : &quot;false&quot;, options);
// ...
}
</span></code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>execute负责通过<code>.java_pid&lt;pid&gt;</code>这个socket文件和jvm进行通信发送cmd和相关参数。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">InputStream</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">String</span> cmd<span class="token punctuation">,</span> <span class="token class-name">Object</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">AgentLoadException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> s <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// connect to target VM</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token function">connect</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> socket_path<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> x<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">close</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> x<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token function">writeString</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> PROTOCOL_VERSION<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">writeString</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> cmd<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token number">3</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;</span> args<span class="token punctuation">.</span>length <span class="token operator">&amp;&amp;</span> args<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">writeString</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span>args<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token function">writeString</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token comment">// ...</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><h4 id="attachlistener"><a href="#attachlistener" class="header-anchor">#</a> AttachListener</h4> <p>AttachListener提供jvm外部和jvm通信的通道。</p> <p>AttachListener初始化时默认不启动(降低资源消耗），Attach客户端会先判断是否有<code>.java_pid&lt;pid&gt;</code>文件，如果没有
向java进程发送QUIT信号，jvm监听这个信号，如果没有启动AttachListener则会进行AttachListener创建初始化</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code>os<span class="token punctuation">.</span>cpp中的signal_thread_entry方法
<span class="token keyword">switch</span> <span class="token punctuation">(</span>sig<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">case</span> SIGBREAK<span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>DisableAttachMechanism<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          AttachListenerState cur_state <span class="token operator">=</span> <span class="token class-name">AttachListener</span><span class="token double-colon punctuation">::</span><span class="token function">transit_state</span><span class="token punctuation">(</span>AL_INITIALIZING<span class="token punctuation">,</span> AL_NOT_INITIALIZED<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>cur_state <span class="token operator">==</span> AL_INITIALIZING<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>cur_state <span class="token operator">==</span> AL_NOT_INITIALIZED<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">AttachListener</span><span class="token double-colon punctuation">::</span><span class="token function">is_init_trigger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token keyword">continue</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token class-name">AttachListener</span><span class="token double-colon punctuation">::</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token keyword">char</span> thread_name<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">&quot;Attach Listener&quot;</span><span class="token punctuation">;</span>
  Handle string <span class="token operator">=</span> java_lang_String<span class="token double-colon punctuation">::</span><span class="token function">create_from_str</span><span class="token punctuation">(</span>thread_name<span class="token punctuation">,</span> THREAD<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">has_init_error</span><span class="token punctuation">(</span>THREAD<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">set_state</span><span class="token punctuation">(</span>AL_NOT_INITIALIZED<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  Handle <span class="token function">thread_group</span> <span class="token punctuation">(</span>THREAD<span class="token punctuation">,</span> <span class="token class-name">Universe</span><span class="token double-colon punctuation">::</span><span class="token function">system_thread_group</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  Handle thread_oop <span class="token operator">=</span> <span class="token class-name">JavaCalls</span><span class="token double-colon punctuation">::</span><span class="token function">construct_new_instance</span><span class="token punctuation">(</span><span class="token class-name">SystemDictionary</span><span class="token double-colon punctuation">::</span><span class="token function">Thread_klass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                       vmSymbols<span class="token double-colon punctuation">::</span><span class="token function">threadgroup_string_void_signature</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                       thread_group<span class="token punctuation">,</span>
                       string<span class="token punctuation">,</span>
                       THREAD<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">has_init_error</span><span class="token punctuation">(</span>THREAD<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">set_state</span><span class="token punctuation">(</span>AL_NOT_INITIALIZED<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  Klass<span class="token operator">*</span> group <span class="token operator">=</span> <span class="token class-name">SystemDictionary</span><span class="token double-colon punctuation">::</span><span class="token function">ThreadGroup_klass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  JavaValue <span class="token function">result</span><span class="token punctuation">(</span>T_VOID<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">JavaCalls</span><span class="token double-colon punctuation">::</span><span class="token function">call_special</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>result<span class="token punctuation">,</span>
                        thread_group<span class="token punctuation">,</span>
                        group<span class="token punctuation">,</span>
                        vmSymbols<span class="token double-colon punctuation">::</span><span class="token function">add_method_name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        vmSymbols<span class="token double-colon punctuation">::</span><span class="token function">thread_void_signature</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        thread_oop<span class="token punctuation">,</span>
                        THREAD<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">has_init_error</span><span class="token punctuation">(</span>THREAD<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">set_state</span><span class="token punctuation">(</span>AL_NOT_INITIALIZED<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token punctuation">{</span> MutexLocker <span class="token function">mu</span><span class="token punctuation">(</span>Threads_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    JavaThread<span class="token operator">*</span> listener_thread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">JavaThread</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>attach_listener_thread_entry<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Check that thread and osthread were created</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>listener_thread <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token operator">||</span> listener_thread<span class="token operator">-&gt;</span><span class="token function">osthread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">vm_exit_during_initialization</span><span class="token punctuation">(</span><span class="token string">&quot;java.lang.OutOfMemoryError&quot;</span><span class="token punctuation">,</span>
                                    os<span class="token double-colon punctuation">::</span><span class="token function">native_thread_creation_failed_msg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    java_lang_Thread<span class="token double-colon punctuation">::</span><span class="token function">set_thread</span><span class="token punctuation">(</span><span class="token function">thread_oop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> listener_thread<span class="token punctuation">)</span><span class="token punctuation">;</span>
    java_lang_Thread<span class="token double-colon punctuation">::</span><span class="token function">set_daemon</span><span class="token punctuation">(</span><span class="token function">thread_oop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    listener_thread<span class="token operator">-&gt;</span><span class="token function">set_threadObj</span><span class="token punctuation">(</span><span class="token function">thread_oop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Threads</span><span class="token double-colon punctuation">::</span><span class="token function">add</span><span class="token punctuation">(</span>listener_thread<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Thread</span><span class="token double-colon punctuation">::</span><span class="token function">start</span><span class="token punctuation">(</span>listener_thread<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br></div></div><p>其中不同类型的交互抽象成了AttachOperation，目前已经支持的
operation如下。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token comment">// names must be of length &lt;= AttachOperation::name_length_max</span>
<span class="token keyword">static</span> AttachOperationFunctionInfo funcs<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token punctuation">{</span> <span class="token string">&quot;agentProperties&quot;</span><span class="token punctuation">,</span>  get_agent_properties <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> <span class="token string">&quot;datadump&quot;</span><span class="token punctuation">,</span>         data_dump <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> <span class="token string">&quot;dumpheap&quot;</span><span class="token punctuation">,</span>         dump_heap <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> <span class="token string">&quot;load&quot;</span><span class="token punctuation">,</span>             load_agent <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> <span class="token string">&quot;properties&quot;</span><span class="token punctuation">,</span>       get_system_properties <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> <span class="token string">&quot;threaddump&quot;</span><span class="token punctuation">,</span>       thread_dump <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> <span class="token string">&quot;inspectheap&quot;</span><span class="token punctuation">,</span>      heap_inspection <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> <span class="token string">&quot;setflag&quot;</span><span class="token punctuation">,</span>          set_flag <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> <span class="token string">&quot;printflag&quot;</span><span class="token punctuation">,</span>        print_flag <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> <span class="token string">&quot;jcmd&quot;</span><span class="token punctuation">,</span>             jcmd <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> <span class="token constant">NULL</span><span class="token punctuation">,</span>               <span class="token constant">NULL</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>调用VirtualMachine.load方法会发送一个load类型的AttachOperation，对应的处理函数是load_agent</p> <div class="language-text line-numbers-mode"><pre class="language-text"><code>// Implementation of &quot;load&quot; command.
static jint load_agent(AttachOperation* op, outputStream* out) {
  // get agent name and options
  const char* agent = op-&gt;arg(0);
  const char* absParam = op-&gt;arg(1);
  const char* options = op-&gt;arg(2);

  // If loading a java agent then need to ensure that the java.instrument module is loaded
  if (strcmp(agent, &quot;instrument&quot;) == 0) {
    Thread* THREAD = Thread::current();
    ResourceMark rm(THREAD);
    HandleMark hm(THREAD);
    JavaValue result(T_OBJECT);
    Handle h_module_name = java_lang_String::create_from_str(&quot;java.instrument&quot;, THREAD);
    JavaCalls::call_static(&amp;amp;result,
                           SystemDictionary::module_Modules_klass(),
                           vmSymbols::loadModule_name(),
                           vmSymbols::loadModule_signature(),
                           h_module_name,
                           THREAD);
    if (HAS_PENDING_EXCEPTION) {
      java_lang_Throwable::print(PENDING_EXCEPTION, out);
      CLEAR_PENDING_EXCEPTION;
      return JNI_ERR;
    }
  }

  return JvmtiExport::load_agent_library(agent, absParam, options, out);
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><h3 id="classfiletransformer是如何注册、调用的"><a href="#classfiletransformer是如何注册、调用的" class="header-anchor">#</a> ClassFileTransformer是如何注册、调用的</h3> <h4 id="classfiletransformer注册"><a href="#classfiletransformer注册" class="header-anchor">#</a> ClassFileTransformer注册</h4> <p>Instrumentation.addTransformer会将Transformer保存到TransformerManager类中，按照能否retransform分为两个TransformerManager，每个TransformerManager中通过数组保存Transformer。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span>
<span class="token function">addTransformer</span><span class="token punctuation">(</span><span class="token class-name">ClassFileTransformer</span> transformer<span class="token punctuation">,</span> <span class="token keyword">boolean</span> canRetransform<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>transformer <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NullPointerException</span><span class="token punctuation">(</span><span class="token string">&quot;null passed as 'transformer' in addTransformer&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>canRetransform<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isRetransformClassesSupported</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UnsupportedOperationException</span><span class="token punctuation">(</span>
              <span class="token string">&quot;adding retransformable transformers is not supported in this environment&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mRetransfomableTransformerManager <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mRetransfomableTransformerManager <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TransformerManager</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        mRetransfomableTransformerManager<span class="token punctuation">.</span><span class="token function">addTransformer</span><span class="token punctuation">(</span>transformer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mRetransfomableTransformerManager<span class="token punctuation">.</span><span class="token function">getTransformerCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">setHasRetransformableTransformers</span><span class="token punctuation">(</span>mNativeAgent<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        mTransformerManager<span class="token punctuation">.</span><span class="token function">addTransformer</span><span class="token punctuation">(</span>transformer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mTransformerManager<span class="token punctuation">.</span><span class="token function">getTransformerCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">setHasTransformers</span><span class="token punctuation">(</span>mNativeAgent<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span>
<span class="token function">addTransformer</span><span class="token punctuation">(</span> <span class="token class-name">ClassFileTransformer</span>    transformer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">TransformerInfo</span><span class="token punctuation">[</span><span class="token punctuation">]</span> oldList <span class="token operator">=</span> mTransformerList<span class="token punctuation">;</span>
    <span class="token class-name">TransformerInfo</span><span class="token punctuation">[</span><span class="token punctuation">]</span> newList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TransformerInfo</span><span class="token punctuation">[</span>oldList<span class="token punctuation">.</span>length <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">arraycopy</span><span class="token punctuation">(</span>   oldList<span class="token punctuation">,</span>
                        <span class="token number">0</span><span class="token punctuation">,</span>
                        newList<span class="token punctuation">,</span>
                        <span class="token number">0</span><span class="token punctuation">,</span>
                        oldList<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
    newList<span class="token punctuation">[</span>oldList<span class="token punctuation">.</span>length<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TransformerInfo</span><span class="token punctuation">(</span>transformer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    mTransformerList <span class="token operator">=</span> newList<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h4 id="classfiletransformer调用"><a href="#classfiletransformer调用" class="header-anchor">#</a> ClassFileTransformer调用</h4> <p>那么ClassFileTransformer是如何被调用的呢，以类加载时调用ClassFileTransformer为例。</p> <p>在jvm加载类时，会回调各个jvmti调用类加载事件回调接口ClassFileLoadHook。其中jvm把能够retransform和不能retramform分为两个jvmtiEnv环境，
分别调用这两个jvmti的回调方法，所以对于类加载时的transform，通过addTransformer无论参数canRetransform是否为true都能调用到。</p> <p><img alt="img.png" data-src="/assets/images/bytecode/javaagent/javaagent-02.png" loading="lazy" class="lazy"></p> <p>instrument jvmti的ClassFileLoadHook实现是调用InstrumentationImpl的transform方法。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">void</span>
<span class="token function">transformClassFile</span><span class="token punctuation">(</span>             JPLISAgent <span class="token operator">*</span>            agent<span class="token punctuation">,</span>
                                JNIEnv <span class="token operator">*</span>                jnienv<span class="token punctuation">,</span>
                                jobject                 loaderObject<span class="token punctuation">,</span>
                                <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span>             name<span class="token punctuation">,</span>
                                jclass                  classBeingRedefined<span class="token punctuation">,</span>
                                jobject                 protectionDomain<span class="token punctuation">,</span>
                                jint                    class_data_len<span class="token punctuation">,</span>
                                <span class="token keyword">const</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">*</span>    class_data<span class="token punctuation">,</span>
                                jint<span class="token operator">*</span>                   new_class_data_len<span class="token punctuation">,</span>
                                <span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span>         new_class_data<span class="token punctuation">,</span>
                                jboolean                is_retransformer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...省略</span>
            transformedBufferObject <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>jnienv<span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">CallObjectMethod</span><span class="token punctuation">(</span>
                                                jnienv<span class="token punctuation">,</span>
                                                agent<span class="token operator">-&gt;</span>mInstrumentationImpl<span class="token punctuation">,</span>
                                                agent<span class="token operator">-&gt;</span>mTransform<span class="token punctuation">,</span>
                                                moduleObject<span class="token punctuation">,</span>
                                                loaderObject<span class="token punctuation">,</span>
                                                classNameStringObject<span class="token punctuation">,</span>
                                                classBeingRedefined<span class="token punctuation">,</span>
                                                protectionDomain<span class="token punctuation">,</span>
                                                classFileBufferObject<span class="token punctuation">,</span>
                                                is_retransformer<span class="token punctuation">)</span><span class="token punctuation">;</span>
            errorOutstanding <span class="token operator">=</span> <span class="token function">checkForAndClearThrowable</span><span class="token punctuation">(</span>jnienv<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">jplis_assert_msg</span><span class="token punctuation">(</span><span class="token operator">!</span>errorOutstanding<span class="token punctuation">,</span> <span class="token string">&quot;transform method call failed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span>errorOutstanding <span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token operator">*</span>new_class_data_len <span class="token operator">=</span> <span class="token punctuation">(</span>transformedBufferSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token operator">*</span>new_class_data     <span class="token operator">=</span> resultBuffer<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// ...省略</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br></div></div><p>InstrumentationImpl的transform方法的实现是根据当前是否是retransform来选择TransformerManager，然后调用TransformerManager的transform方法。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// WARNING: the native code knows the name &amp; signature of this method</span>
    <span class="token keyword">private</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token function">transform</span><span class="token punctuation">(</span>  <span class="token class-name">Module</span>              <span class="token keyword">module</span><span class="token punctuation">,</span>
                <span class="token class-name">ClassLoader</span>         loader<span class="token punctuation">,</span>
                <span class="token class-name">String</span>              classname<span class="token punctuation">,</span>
                <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span>            classBeingRedefined<span class="token punctuation">,</span>
                <span class="token class-name">ProtectionDomain</span>    protectionDomain<span class="token punctuation">,</span>
                <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span>              classfileBuffer<span class="token punctuation">,</span>
                <span class="token keyword">boolean</span>             isRetransformer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">TransformerManager</span> mgr <span class="token operator">=</span> isRetransformer<span class="token operator">?</span>
                                        mRetransfomableTransformerManager <span class="token operator">:</span>
                                        mTransformerManager<span class="token punctuation">;</span>
        <span class="token comment">// module is null when not a class load or when loading a class in an</span>
        <span class="token comment">// unnamed module and this is the first type to be loaded in the package.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">module</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>classBeingRedefined <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">module</span> <span class="token operator">=</span> classBeingRedefined<span class="token punctuation">.</span><span class="token function">getModule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token keyword">module</span> <span class="token operator">=</span> <span class="token punctuation">(</span>loader <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token class-name"><span class="token namespace">jdk<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>loader<span class="token punctuation">.</span></span>BootLoader</span><span class="token punctuation">.</span><span class="token function">getUnnamedModule</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                                          <span class="token operator">:</span> loader<span class="token punctuation">.</span><span class="token function">getUnnamedModule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mgr <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// no manager, no transform</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> mgr<span class="token punctuation">.</span><span class="token function">transform</span><span class="token punctuation">(</span>   <span class="token keyword">module</span><span class="token punctuation">,</span>
                                    loader<span class="token punctuation">,</span>
                                    classname<span class="token punctuation">,</span>
                                    classBeingRedefined<span class="token punctuation">,</span>
                                    protectionDomain<span class="token punctuation">,</span>
                                    classfileBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><p>TransformerManager的transform方法实现逻辑是依次调用Transformer数组中的各个Transformer（就像server中的Filter)，然后把最终的bytes结果返回。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token function">transform</span><span class="token punctuation">(</span>  <span class="token class-name">Module</span>              <span class="token keyword">module</span><span class="token punctuation">,</span>
                <span class="token class-name">ClassLoader</span>         loader<span class="token punctuation">,</span>
                <span class="token class-name">String</span>              classname<span class="token punctuation">,</span>
                <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span>            classBeingRedefined<span class="token punctuation">,</span>
                <span class="token class-name">ProtectionDomain</span>    protectionDomain<span class="token punctuation">,</span>
                <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span>              classfileBuffer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">boolean</span> someoneTouchedTheBytecode <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

        <span class="token class-name">TransformerInfo</span><span class="token punctuation">[</span><span class="token punctuation">]</span>  transformerList <span class="token operator">=</span> <span class="token function">getSnapshotTransformerList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span>  bufferToUse <span class="token operator">=</span> classfileBuffer<span class="token punctuation">;</span>

        <span class="token comment">// order matters, gotta run 'em in the order they were added</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span> <span class="token keyword">int</span> x <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> x <span class="token operator">&lt;</span> transformerList<span class="token punctuation">.</span>length<span class="token punctuation">;</span> x<span class="token operator">++</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">TransformerInfo</span>         transformerInfo <span class="token operator">=</span> transformerList<span class="token punctuation">[</span>x<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token class-name">ClassFileTransformer</span>    transformer <span class="token operator">=</span> transformerInfo<span class="token punctuation">.</span><span class="token function">transformer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span>                  transformedBytes <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                transformedBytes <span class="token operator">=</span> transformer<span class="token punctuation">.</span><span class="token function">transform</span><span class="token punctuation">(</span>   <span class="token keyword">module</span><span class="token punctuation">,</span>
                                                            loader<span class="token punctuation">,</span>
                                                            classname<span class="token punctuation">,</span>
                                                            classBeingRedefined<span class="token punctuation">,</span>
                                                            protectionDomain<span class="token punctuation">,</span>
                                                            bufferToUse<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// don't let any one transformer mess it up for the others.</span>
                <span class="token comment">// This is where we need to put some logging. What should go here? FIXME</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span> transformedBytes <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
                someoneTouchedTheBytecode <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                bufferToUse <span class="token operator">=</span> transformedBytes<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// if someone modified it, return the modified buffer.</span>
        <span class="token comment">// otherwise return null to mean &quot;no transforms occurred&quot;</span>
        <span class="token keyword">byte</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> result<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span> someoneTouchedTheBytecode <span class="token punctuation">)</span> <span class="token punctuation">{</span>
            result <span class="token operator">=</span> bufferToUse<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
            result <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br></div></div><h3 id="redefine的实现"><a href="#redefine的实现" class="header-anchor">#</a> redefine的实现</h3> <p>jvmtiEnv.cpp中定义了RedefineClasses方法的入口，会委托给VM_RedefineClasses执行。
VM_RedefineClasses是jvm中定义的一种VM_Operation实现, VMThread::execute会判断VM_Operation是否需要在safepoint中执行，
如果需要会进入safepoint，然后调用对应VM_Operation的evaluate方法，VM_Operation的evaluate会调用doit方法</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token comment">// 位于jvmtiEnv.cpp中</span>
<span class="token class-name">JvmtiEnv</span><span class="token double-colon punctuation">::</span><span class="token function">RedefineClasses</span><span class="token punctuation">(</span>jint class_count<span class="token punctuation">,</span> <span class="token keyword">const</span> jvmtiClassDefinition<span class="token operator">*</span> class_definitions<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token comment">//TODO: add locking</span>
  VM_RedefineClasses <span class="token function">op</span><span class="token punctuation">(</span>class_count<span class="token punctuation">,</span> class_definitions<span class="token punctuation">,</span> jvmti_class_load_kind_redefine<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">VMThread</span><span class="token double-colon punctuation">::</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>op<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>op<span class="token punctuation">.</span><span class="token function">check_error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token comment">/* end RedefineClasses */</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>VM_RedefineClasses代码位于jvmtiRedefineClasses.cpp</p> <p>doit方法的逻辑是</p> <ul><li>标记正在栈上执行的方法，栈上执行的方法还会执行旧的代码。</li> <li>对每个类进行redefine</li> <li>清理JIT的compiled code，范围是对redefined的类有依赖的代码</li> <li>调整JvmtiExport的increment_redefinition_count</li> <li>清理redefine类旧的metadata</li></ul> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">void</span> <span class="token class-name">VM_RedefineClasses</span><span class="token double-colon punctuation">::</span><span class="token function">doit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  Thread <span class="token operator">*</span>thread <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token double-colon punctuation">::</span><span class="token function">current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ... 标记正在栈上执行的方法，栈上执行的方法还会执行旧的代码。</span>
  <span class="token comment">// Mark methods seen on stack and everywhere else so old methods are not</span>
  <span class="token comment">// cleaned up if they're on the stack.</span>
  MetadataOnStackMark <span class="token function">md_on_stack</span><span class="token punctuation">(</span><span class="token comment">/*walk_all_metadata*/</span><span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">/*redefinition_walk*/</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  HandleMark <span class="token function">hm</span><span class="token punctuation">(</span>thread<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// make sure any handles created are deleted</span>
                           <span class="token comment">// before the stack walk again.</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> _class_count<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">redefine_single_class</span><span class="token punctuation">(</span>_class_defs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>klass<span class="token punctuation">,</span> _scratch_classes<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> thread<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 清理JIT的compiled code</span>
  <span class="token comment">// Flush all compiled code that depends on the classes redefined.</span>
  <span class="token function">flush_dependent_code</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 调整常量池缓存和指向变更的类的方法的类的vtable</span>
  <span class="token comment">// Adjust constantpool caches and vtables for all classes</span>
  <span class="token comment">// that reference methods of the evolved classes.</span>
  <span class="token comment">// Have to do this after all classes are redefined and all methods that</span>
  <span class="token comment">// are redefined are marked as old.</span>
  AdjustAndCleanMetadata <span class="token function">adjust_and_clean_metadata</span><span class="token punctuation">(</span>thread<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">ClassLoaderDataGraph</span><span class="token double-colon punctuation">::</span><span class="token function">classes_do</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>adjust_and_clean_metadata<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// JSR-292 support</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>_any_class_has_resolved_methods<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">bool</span> trace_name_printed <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token class-name">ResolvedMethodTable</span><span class="token double-colon punctuation">::</span><span class="token function">adjust_method_entries</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>trace_name_printed<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 增加classRedefinedCount，在java.lang.Class中获取反射数据会判断这个值，发现变化后会重新读取类的反射数据。</span>
  <span class="token comment">// Increment flag indicating that some invariants are no longer true.</span>
  <span class="token comment">// See jvmtiExport.hpp for detailed explanation.</span>
  <span class="token class-name">JvmtiExport</span><span class="token double-colon punctuation">::</span><span class="token function">increment_redefinition_count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 清理redefine类旧的metadata</span>
  <span class="token comment">// Clean up any metadata now unreferenced while MetadataOnStackMark is set.</span>
  <span class="token class-name">ClassLoaderDataGraph</span><span class="token double-colon punctuation">::</span><span class="token function">clean_deallocate_lists</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br></div></div><p>redefine_single_class是更新每个单独的calss</p> <ul><li>清理断点和缓存，对依赖的JIT compiled code进行去优化（deoptimization)</li> <li>调整常量池缓存和指向这个类的方法的类的vtable</li> <li>增加classRedefinedCount，在java.lang.Class中获取反射数据会判断这个值，发现变化后会重新读取类的反射数据。</li></ul> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">void</span> <span class="token class-name">VM_RedefineClasses</span><span class="token double-colon punctuation">::</span><span class="token function">redefine_single_class</span><span class="token punctuation">(</span>jclass the_jclass<span class="token punctuation">,</span>
       InstanceKlass<span class="token operator">*</span> scratch_class<span class="token punctuation">,</span> TRAPS<span class="token punctuation">)</span> <span class="token punctuation">{</span>

  HandleMark <span class="token function">hm</span><span class="token punctuation">(</span>THREAD<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// make sure handles from this call are freed</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">log_is_enabled</span><span class="token punctuation">(</span>Info<span class="token punctuation">,</span> redefine<span class="token punctuation">,</span> <span class="token keyword">class</span><span class="token punctuation">,</span> timer<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    _timer_rsc_phase1<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  InstanceKlass<span class="token operator">*</span> the_class <span class="token operator">=</span> <span class="token function">get_ik</span><span class="token punctuation">(</span>the_jclass<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Set some flags to control and optimize adjusting method entries</span>
  _has_redefined_Object <span class="token operator">|=</span> the_class <span class="token operator">==</span> <span class="token class-name">SystemDictionary</span><span class="token double-colon punctuation">::</span><span class="token function">Object_klass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  _has_null_class_loader <span class="token operator">|=</span> the_class<span class="token operator">-&gt;</span><span class="token function">class_loader</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

  <span class="token comment">// Remove all breakpoints in methods of this class</span>
  JvmtiBreakpoints<span class="token operator">&amp;</span> jvmti_breakpoints <span class="token operator">=</span> <span class="token class-name">JvmtiCurrentBreakpoints</span><span class="token double-colon punctuation">::</span><span class="token function">get_jvmti_breakpoints</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  jvmti_breakpoints<span class="token punctuation">.</span><span class="token function">clearall_in_class_at_safepoint</span><span class="token punctuation">(</span>the_class<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Mark all compiled code that depends on this class</span>
  <span class="token function">mark_dependent_code</span><span class="token punctuation">(</span>the_class<span class="token punctuation">)</span><span class="token punctuation">;</span>

  _old_methods <span class="token operator">=</span> the_class<span class="token operator">-&gt;</span><span class="token function">methods</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  _new_methods <span class="token operator">=</span> scratch_class<span class="token operator">-&gt;</span><span class="token function">methods</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  _the_class <span class="token operator">=</span> the_class<span class="token punctuation">;</span>
  <span class="token function">compute_added_deleted_matching_methods</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">update_jmethod_ids</span><span class="token punctuation">(</span>THREAD<span class="token punctuation">)</span><span class="token punctuation">;</span>

  _any_class_has_resolved_methods <span class="token operator">=</span> the_class<span class="token operator">-&gt;</span><span class="token function">has_resolved_methods</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> _any_class_has_resolved_methods<span class="token punctuation">;</span>

  <span class="token comment">// Attach new constant pool to the original klass. The original</span>
  <span class="token comment">// klass still refers to the old constant pool (for now).</span>
  scratch_class<span class="token operator">-&gt;</span><span class="token function">constants</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">set_pool_holder</span><span class="token punctuation">(</span>the_class<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token number">0</span></span></span>
  <span class="token comment">// In theory, with constant pool merging in place we should be able</span>
  <span class="token comment">// to save space by using the new, merged constant pool in place of</span>
  <span class="token comment">// the old constant pool(s). By &quot;pool(s)&quot; I mean the constant pool in</span>
  <span class="token comment">// the klass version we are replacing now and any constant pool(s) in</span>
  <span class="token comment">// previous versions of klass. Nice theory, doesn't work in practice.</span>
  <span class="token comment">// When this code is enabled, even simple programs throw NullPointer</span>
  <span class="token comment">// exceptions. I'm guessing that this is caused by some constant pool</span>
  <span class="token comment">// cache difference between the new, merged constant pool and the</span>
  <span class="token comment">// constant pool that was just being used by the klass. I'm keeping</span>
  <span class="token comment">// this code around to archive the idea, but the code has to remain</span>
  <span class="token comment">// disabled for now.</span>

  <span class="token comment">// Attach each old method to the new constant pool. This can be</span>
  <span class="token comment">// done here since we are past the bytecode verification and</span>
  <span class="token comment">// constant pool optimization phases.</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> _old_methods<span class="token operator">-&gt;</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Method<span class="token operator">*</span> method <span class="token operator">=</span> _old_methods<span class="token operator">-&gt;</span><span class="token function">at</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
    method<span class="token operator">-&gt;</span><span class="token function">set_constants</span><span class="token punctuation">(</span>scratch_class<span class="token operator">-&gt;</span><span class="token function">constants</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// NOTE: this doesn't work because you can redefine the same class in two</span>
  <span class="token comment">// threads, each getting their own constant pool data appended to the</span>
  <span class="token comment">// original constant pool.  In order for the new methods to work when they</span>
  <span class="token comment">// become old methods, they need to keep their updated copy of the constant pool.</span>

  <span class="token punctuation">{</span>
    <span class="token comment">// walk all previous versions of the klass</span>
    InstanceKlass <span class="token operator">*</span>ik <span class="token operator">=</span> the_class<span class="token punctuation">;</span>
    PreviousVersionWalker <span class="token function">pvw</span><span class="token punctuation">(</span>ik<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">do</span> <span class="token punctuation">{</span>
      ik <span class="token operator">=</span> pvw<span class="token punctuation">.</span><span class="token function">next_previous_version</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>ik <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token comment">// attach previous version of klass to the new constant pool</span>
        ik<span class="token operator">-&gt;</span><span class="token function">set_constants</span><span class="token punctuation">(</span>scratch_class<span class="token operator">-&gt;</span><span class="token function">constants</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Attach each method in the previous version of klass to the</span>
        <span class="token comment">// new constant pool</span>
        Array<span class="token operator">&lt;</span>Method<span class="token operator">*</span><span class="token operator">&gt;</span><span class="token operator">*</span> prev_methods <span class="token operator">=</span> ik<span class="token operator">-&gt;</span><span class="token function">methods</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> prev_methods<span class="token operator">-&gt;</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          Method<span class="token operator">*</span> method <span class="token operator">=</span> prev_methods<span class="token operator">-&gt;</span><span class="token function">at</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
          method<span class="token operator">-&gt;</span><span class="token function">set_constants</span><span class="token punctuation">(</span>scratch_class<span class="token operator">-&gt;</span><span class="token function">constants</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>ik <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

  <span class="token comment">// Replace methods and constantpool</span>
  the_class<span class="token operator">-&gt;</span><span class="token function">set_methods</span><span class="token punctuation">(</span>_new_methods<span class="token punctuation">)</span><span class="token punctuation">;</span>
  scratch_class<span class="token operator">-&gt;</span><span class="token function">set_methods</span><span class="token punctuation">(</span>_old_methods<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// To prevent potential GCing of the old methods,</span>
                                          <span class="token comment">// and to be able to undo operation easily.</span>

  Array<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span><span class="token operator">*</span> old_ordering <span class="token operator">=</span> the_class<span class="token operator">-&gt;</span><span class="token function">method_ordering</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  the_class<span class="token operator">-&gt;</span><span class="token function">set_method_ordering</span><span class="token punctuation">(</span>scratch_class<span class="token operator">-&gt;</span><span class="token function">method_ordering</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  scratch_class<span class="token operator">-&gt;</span><span class="token function">set_method_ordering</span><span class="token punctuation">(</span>old_ordering<span class="token punctuation">)</span><span class="token punctuation">;</span>

  ConstantPool<span class="token operator">*</span> old_constants <span class="token operator">=</span> the_class<span class="token operator">-&gt;</span><span class="token function">constants</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  the_class<span class="token operator">-&gt;</span><span class="token function">set_constants</span><span class="token punctuation">(</span>scratch_class<span class="token operator">-&gt;</span><span class="token function">constants</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  scratch_class<span class="token operator">-&gt;</span><span class="token function">set_constants</span><span class="token punctuation">(</span>old_constants<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// See the previous comment.</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token number">0</span></span></span>
  <span class="token comment">// We are swapping the guts of &quot;the new class&quot; with the guts of &quot;the</span>
  <span class="token comment">// class&quot;. Since the old constant pool has just been attached to &quot;the</span>
  <span class="token comment">// new class&quot;, it seems logical to set the pool holder in the old</span>
  <span class="token comment">// constant pool also. However, doing this will change the observable</span>
  <span class="token comment">// class hierarchy for any old methods that are still executing. A</span>
  <span class="token comment">// method can query the identity of its &quot;holder&quot; and this query uses</span>
  <span class="token comment">// the method's constant pool link to find the holder. The change in</span>
  <span class="token comment">// holding class from &quot;the class&quot; to &quot;the new class&quot; can confuse</span>
  <span class="token comment">// things.</span>
  <span class="token comment">//</span>
  <span class="token comment">// Setting the old constant pool's holder will also cause</span>
  <span class="token comment">// verification done during vtable initialization below to fail.</span>
  <span class="token comment">// During vtable initialization, the vtable's class is verified to be</span>
  <span class="token comment">// a subtype of the method's holder. The vtable's class is &quot;the</span>
  <span class="token comment">// class&quot; and the method's holder is gotten from the constant pool</span>
  <span class="token comment">// link in the method itself. For &quot;the class&quot;'s directly implemented</span>
  <span class="token comment">// methods, the method holder is &quot;the class&quot; itself (as gotten from</span>
  <span class="token comment">// the new constant pool). The check works fine in this case. The</span>
  <span class="token comment">// check also works fine for methods inherited from super classes.</span>
  <span class="token comment">//</span>
  <span class="token comment">// Miranda methods are a little more complicated. A miranda method is</span>
  <span class="token comment">// provided by an interface when the class implementing the interface</span>
  <span class="token comment">// does not provide its own method.  These interfaces are implemented</span>
  <span class="token comment">// internally as an InstanceKlass. These special instanceKlasses</span>
  <span class="token comment">// share the constant pool of the class that &quot;implements&quot; the</span>
  <span class="token comment">// interface. By sharing the constant pool, the method holder of a</span>
  <span class="token comment">// miranda method is the class that &quot;implements&quot; the interface. In a</span>
  <span class="token comment">// non-redefine situation, the subtype check works fine. However, if</span>
  <span class="token comment">// the old constant pool's pool holder is modified, then the check</span>
  <span class="token comment">// fails because there is no class hierarchy relationship between the</span>
  <span class="token comment">// vtable's class and &quot;the new class&quot;.</span>

  old_constants<span class="token operator">-&gt;</span><span class="token function">set_pool_holder</span><span class="token punctuation">(</span><span class="token function">scratch_class</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

  <span class="token comment">// track number of methods that are EMCP for add_previous_version() call below</span>
  <span class="token keyword">int</span> emcp_method_count <span class="token operator">=</span> <span class="token function">check_methods_and_mark_as_obsolete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">transfer_old_native_function_registrations</span><span class="token punctuation">(</span>the_class<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// The class file bytes from before any retransformable agents mucked</span>
  <span class="token comment">// with them was cached on the scratch class, move to the_class.</span>
  <span class="token comment">// Note: we still want to do this if nothing needed caching since it</span>
  <span class="token comment">// should get cleared in the_class too.</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>the_class<span class="token operator">-&gt;</span><span class="token function">get_cached_class_file</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// the_class doesn't have a cache yet so copy it</span>
    the_class<span class="token operator">-&gt;</span><span class="token function">set_cached_class_file</span><span class="token punctuation">(</span>scratch_class<span class="token operator">-&gt;</span><span class="token function">get_cached_class_file</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>scratch_class<span class="token operator">-&gt;</span><span class="token function">get_cached_class_file</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span>
           the_class<span class="token operator">-&gt;</span><span class="token function">get_cached_class_file</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// The same class can be present twice in the scratch classes list or there</span>
    <span class="token comment">// are multiple concurrent RetransformClasses calls on different threads.</span>
    <span class="token comment">// In such cases we have to deallocate scratch_class cached_class_file.</span>
    os<span class="token double-colon punctuation">::</span><span class="token function">free</span><span class="token punctuation">(</span>scratch_class<span class="token operator">-&gt;</span><span class="token function">get_cached_class_file</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// NULL out in scratch class to not delete twice.  The class to be redefined</span>
  <span class="token comment">// always owns these bytes.</span>
  scratch_class<span class="token operator">-&gt;</span><span class="token function">set_cached_class_file</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Replace inner_classes</span>
  Array<span class="token operator">&lt;</span>u2<span class="token operator">&gt;</span><span class="token operator">*</span> old_inner_classes <span class="token operator">=</span> the_class<span class="token operator">-&gt;</span><span class="token function">inner_classes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  the_class<span class="token operator">-&gt;</span><span class="token function">set_inner_classes</span><span class="token punctuation">(</span>scratch_class<span class="token operator">-&gt;</span><span class="token function">inner_classes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  scratch_class<span class="token operator">-&gt;</span><span class="token function">set_inner_classes</span><span class="token punctuation">(</span>old_inner_classes<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Initialize the vtable and interface table after</span>
  <span class="token comment">// methods have been rewritten</span>
  <span class="token comment">// no exception should happen here since we explicitly</span>
  <span class="token comment">// do not check loader constraints.</span>
  <span class="token comment">// compare_and_normalize_class_versions has already checked:</span>
  <span class="token comment">//  - classloaders unchanged, signatures unchanged</span>
  <span class="token comment">//  - all instanceKlasses for redefined classes reused &amp; contents updated</span>
  the_class<span class="token operator">-&gt;</span><span class="token function">vtable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">initialize_vtable</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> THREAD<span class="token punctuation">)</span><span class="token punctuation">;</span>
  the_class<span class="token operator">-&gt;</span><span class="token function">itable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">initialize_itable</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> THREAD<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">assert</span><span class="token punctuation">(</span><span class="token operator">!</span>HAS_PENDING_EXCEPTION <span class="token operator">||</span> <span class="token punctuation">(</span>THREAD<span class="token operator">-&gt;</span><span class="token function">pending_exception</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">is_a</span><span class="token punctuation">(</span><span class="token class-name">SystemDictionary</span><span class="token double-colon punctuation">::</span><span class="token function">ThreadDeath_klass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;redefine exception&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Leave arrays of jmethodIDs and itable index cache unchanged</span>

  <span class="token comment">// Copy the &quot;source file name&quot; attribute from new class version</span>
  the_class<span class="token operator">-&gt;</span><span class="token function">set_source_file_name_index</span><span class="token punctuation">(</span>
    scratch_class<span class="token operator">-&gt;</span><span class="token function">source_file_name_index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Copy the &quot;source debug extension&quot; attribute from new class version</span>
  the_class<span class="token operator">-&gt;</span><span class="token function">set_source_debug_extension</span><span class="token punctuation">(</span>
    scratch_class<span class="token operator">-&gt;</span><span class="token function">source_debug_extension</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    scratch_class<span class="token operator">-&gt;</span><span class="token function">source_debug_extension</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span>
    <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token function">strlen</span><span class="token punctuation">(</span>scratch_class<span class="token operator">-&gt;</span><span class="token function">source_debug_extension</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Use of javac -g could be different in the old and the new</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>scratch_class<span class="token operator">-&gt;</span><span class="token function">access_flags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">has_localvariable_table</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span>
      the_class<span class="token operator">-&gt;</span><span class="token function">access_flags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">has_localvariable_table</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    AccessFlags flags <span class="token operator">=</span> the_class<span class="token operator">-&gt;</span><span class="token function">access_flags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>scratch_class<span class="token operator">-&gt;</span><span class="token function">access_flags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">has_localvariable_table</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      flags<span class="token punctuation">.</span><span class="token function">set_has_localvariable_table</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      flags<span class="token punctuation">.</span><span class="token function">clear_has_localvariable_table</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    the_class<span class="token operator">-&gt;</span><span class="token function">set_access_flags</span><span class="token punctuation">(</span>flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">swap_annotations</span><span class="token punctuation">(</span>the_class<span class="token punctuation">,</span> scratch_class<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Replace minor version number of class file</span>
  u2 old_minor_version <span class="token operator">=</span> the_class<span class="token operator">-&gt;</span><span class="token function">minor_version</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  the_class<span class="token operator">-&gt;</span><span class="token function">set_minor_version</span><span class="token punctuation">(</span>scratch_class<span class="token operator">-&gt;</span><span class="token function">minor_version</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  scratch_class<span class="token operator">-&gt;</span><span class="token function">set_minor_version</span><span class="token punctuation">(</span>old_minor_version<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Replace major version number of class file</span>
  u2 old_major_version <span class="token operator">=</span> the_class<span class="token operator">-&gt;</span><span class="token function">major_version</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  the_class<span class="token operator">-&gt;</span><span class="token function">set_major_version</span><span class="token punctuation">(</span>scratch_class<span class="token operator">-&gt;</span><span class="token function">major_version</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  scratch_class<span class="token operator">-&gt;</span><span class="token function">set_major_version</span><span class="token punctuation">(</span>old_major_version<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Replace CP indexes for class and name+type of enclosing method</span>
  u2 old_class_idx  <span class="token operator">=</span> the_class<span class="token operator">-&gt;</span><span class="token function">enclosing_method_class_index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  u2 old_method_idx <span class="token operator">=</span> the_class<span class="token operator">-&gt;</span><span class="token function">enclosing_method_method_index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  the_class<span class="token operator">-&gt;</span><span class="token function">set_enclosing_method_indices</span><span class="token punctuation">(</span>
    scratch_class<span class="token operator">-&gt;</span><span class="token function">enclosing_method_class_index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    scratch_class<span class="token operator">-&gt;</span><span class="token function">enclosing_method_method_index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  scratch_class<span class="token operator">-&gt;</span><span class="token function">set_enclosing_method_indices</span><span class="token punctuation">(</span>old_class_idx<span class="token punctuation">,</span> old_method_idx<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Replace fingerprint data</span>
  the_class<span class="token operator">-&gt;</span><span class="token function">set_has_passed_fingerprint_check</span><span class="token punctuation">(</span>scratch_class<span class="token operator">-&gt;</span><span class="token function">has_passed_fingerprint_check</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  the_class<span class="token operator">-&gt;</span><span class="token function">store_fingerprint</span><span class="token punctuation">(</span>scratch_class<span class="token operator">-&gt;</span><span class="token function">get_stored_fingerprint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  the_class<span class="token operator">-&gt;</span><span class="token function">set_has_been_redefined</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>the_class<span class="token operator">-&gt;</span><span class="token function">should_be_initialized</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Class was already initialized, so AOT has only seen the original version.</span>
    <span class="token comment">// We need to let AOT look at it again.</span>
    <span class="token class-name">AOTLoader</span><span class="token double-colon punctuation">::</span><span class="token function">load_for_klass</span><span class="token punctuation">(</span>the_class<span class="token punctuation">,</span> THREAD<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// keep track of previous versions of this class</span>
  the_class<span class="token operator">-&gt;</span><span class="token function">add_previous_version</span><span class="token punctuation">(</span>scratch_class<span class="token punctuation">,</span> emcp_method_count<span class="token punctuation">)</span><span class="token punctuation">;</span>

  _timer_rsc_phase1<span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">log_is_enabled</span><span class="token punctuation">(</span>Info<span class="token punctuation">,</span> redefine<span class="token punctuation">,</span> <span class="token keyword">class</span><span class="token punctuation">,</span> timer<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    _timer_rsc_phase2<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>the_class<span class="token operator">-&gt;</span><span class="token function">oop_map_cache</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Flush references to any obsolete methods from the oop map cache</span>
    <span class="token comment">// so that obsolete methods are not pinned.</span>
    the_class<span class="token operator">-&gt;</span><span class="token function">oop_map_cache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">flush_obsolete_entries</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">increment_class_counter</span><span class="token punctuation">(</span><span class="token punctuation">(</span>InstanceKlass <span class="token operator">*</span><span class="token punctuation">)</span>the_class<span class="token punctuation">,</span> THREAD<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">{</span>
    ResourceMark <span class="token function">rm</span><span class="token punctuation">(</span>THREAD<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// increment the classRedefinedCount field in the_class and in any</span>
    <span class="token comment">// direct and indirect subclasses of the_class</span>
    <span class="token function">log_info</span><span class="token punctuation">(</span>redefine<span class="token punctuation">,</span> <span class="token keyword">class</span><span class="token punctuation">,</span> load<span class="token punctuation">)</span>
      <span class="token punctuation">(</span><span class="token string">&quot;redefined name=%s, count=%d (avail_mem=&quot;</span> UINT64_FORMAT <span class="token string">&quot;K)&quot;</span><span class="token punctuation">,</span>
       the_class<span class="token operator">-&gt;</span><span class="token function">external_name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> java_lang_Class<span class="token double-colon punctuation">::</span><span class="token function">classRedefinedCount</span><span class="token punctuation">(</span>the_class<span class="token operator">-&gt;</span><span class="token function">java_mirror</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> os<span class="token double-colon punctuation">::</span><span class="token function">available_memory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;&gt;</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Events</span><span class="token double-colon punctuation">::</span><span class="token function">log_redefinition</span><span class="token punctuation">(</span>THREAD<span class="token punctuation">,</span> <span class="token string">&quot;redefined class name=%s, count=%d&quot;</span><span class="token punctuation">,</span>
                             the_class<span class="token operator">-&gt;</span><span class="token function">external_name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                             java_lang_Class<span class="token double-colon punctuation">::</span><span class="token function">classRedefinedCount</span><span class="token punctuation">(</span>the_class<span class="token operator">-&gt;</span><span class="token function">java_mirror</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token punctuation">}</span>
  _timer_rsc_phase2<span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token comment">// end redefine_single_class()</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br><span class="line-number">188</span><br><span class="line-number">189</span><br><span class="line-number">190</span><br><span class="line-number">191</span><br><span class="line-number">192</span><br><span class="line-number">193</span><br><span class="line-number">194</span><br><span class="line-number">195</span><br><span class="line-number">196</span><br><span class="line-number">197</span><br><span class="line-number">198</span><br><span class="line-number">199</span><br><span class="line-number">200</span><br><span class="line-number">201</span><br><span class="line-number">202</span><br><span class="line-number">203</span><br><span class="line-number">204</span><br><span class="line-number">205</span><br><span class="line-number">206</span><br><span class="line-number">207</span><br><span class="line-number">208</span><br><span class="line-number">209</span><br><span class="line-number">210</span><br><span class="line-number">211</span><br><span class="line-number">212</span><br><span class="line-number">213</span><br><span class="line-number">214</span><br><span class="line-number">215</span><br><span class="line-number">216</span><br><span class="line-number">217</span><br><span class="line-number">218</span><br><span class="line-number">219</span><br><span class="line-number">220</span><br><span class="line-number">221</span><br><span class="line-number">222</span><br><span class="line-number">223</span><br><span class="line-number">224</span><br><span class="line-number">225</span><br><span class="line-number">226</span><br><span class="line-number">227</span><br><span class="line-number">228</span><br><span class="line-number">229</span><br><span class="line-number">230</span><br><span class="line-number">231</span><br><span class="line-number">232</span><br><span class="line-number">233</span><br><span class="line-number">234</span><br><span class="line-number">235</span><br><span class="line-number">236</span><br><span class="line-number">237</span><br><span class="line-number">238</span><br><span class="line-number">239</span><br><span class="line-number">240</span><br><span class="line-number">241</span><br><span class="line-number">242</span><br><span class="line-number">243</span><br><span class="line-number">244</span><br><span class="line-number">245</span><br><span class="line-number">246</span><br><span class="line-number">247</span><br><span class="line-number">248</span><br><span class="line-number">249</span><br><span class="line-number">250</span><br><span class="line-number">251</span><br><span class="line-number">252</span><br><span class="line-number">253</span><br><span class="line-number">254</span><br><span class="line-number">255</span><br><span class="line-number">256</span><br><span class="line-number">257</span><br><span class="line-number">258</span><br></div></div><h3 id="retransform的实现"><a href="#retransform的实现" class="header-anchor">#</a> retransform的实现</h3> <p>retransform可以理解为获取要transform的类的字节码，通过所有的canRetransform的ClassFileTramsformer
进行transform，最终得到transform后的字节码，然后调用redefine修改字节码。所以retransform的修改限制比如不能增减字段方法等和redefine是一致的。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token comment">// 代码位于jvmtiEnv.cpp中</span>
<span class="token class-name">JvmtiEnv</span><span class="token double-colon punctuation">::</span><span class="token function">RetransformClasses</span><span class="token punctuation">(</span>jint class_count<span class="token punctuation">,</span> <span class="token keyword">const</span> jclass<span class="token operator">*</span> classes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">int</span> index<span class="token punctuation">;</span>
  JavaThread<span class="token operator">*</span> current_thread <span class="token operator">=</span> <span class="token class-name">JavaThread</span><span class="token double-colon punctuation">::</span><span class="token function">current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  ResourceMark <span class="token function">rm</span><span class="token punctuation">(</span>current_thread<span class="token punctuation">)</span><span class="token punctuation">;</span>

  jvmtiClassDefinition<span class="token operator">*</span> class_definitions <span class="token operator">=</span>
                            <span class="token function">NEW_RESOURCE_ARRAY</span><span class="token punctuation">(</span>jvmtiClassDefinition<span class="token punctuation">,</span> class_count<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">NULL_CHECK</span><span class="token punctuation">(</span>class_definitions<span class="token punctuation">,</span> JVMTI_ERROR_OUT_OF_MEMORY<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span>index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> index <span class="token operator">&lt;</span> class_count<span class="token punctuation">;</span> index<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    HandleMark <span class="token function">hm</span><span class="token punctuation">(</span>current_thread<span class="token punctuation">)</span><span class="token punctuation">;</span>

    jclass jcls <span class="token operator">=</span> classes<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">;</span>
    oop k_mirror <span class="token operator">=</span> <span class="token class-name">JNIHandles</span><span class="token double-colon punctuation">::</span><span class="token function">resolve_external_guard</span><span class="token punctuation">(</span>jcls<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>k_mirror <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> JVMTI_ERROR_INVALID_CLASS<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>k_mirror<span class="token operator">-&gt;</span><span class="token function">is_a</span><span class="token punctuation">(</span><span class="token class-name">SystemDictionary</span><span class="token double-colon punctuation">::</span><span class="token function">Class_klass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> JVMTI_ERROR_INVALID_CLASS<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">VM_RedefineClasses</span><span class="token double-colon punctuation">::</span><span class="token function">is_modifiable_class</span><span class="token punctuation">(</span>k_mirror<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> JVMTI_ERROR_UNMODIFIABLE_CLASS<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    Klass<span class="token operator">*</span> klass <span class="token operator">=</span> java_lang_Class<span class="token double-colon punctuation">::</span><span class="token function">as_Klass</span><span class="token punctuation">(</span>k_mirror<span class="token punctuation">)</span><span class="token punctuation">;</span>

    jint status <span class="token operator">=</span> klass<span class="token operator">-&gt;</span><span class="token function">jvmti_class_status</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>status <span class="token operator">&amp;</span> <span class="token punctuation">(</span>JVMTI_CLASS_STATUS_ERROR<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> JVMTI_ERROR_INVALID_CLASS<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    InstanceKlass<span class="token operator">*</span> ik <span class="token operator">=</span> <span class="token class-name">InstanceKlass</span><span class="token double-colon punctuation">::</span><span class="token function">cast</span><span class="token punctuation">(</span>klass<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ik<span class="token operator">-&gt;</span><span class="token function">get_cached_class_file_bytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Not cached, we need to reconstitute the class file from the</span>
      <span class="token comment">// VM representation. We don't attach the reconstituted class</span>
      <span class="token comment">// bytes to the InstanceKlass here because they have not been</span>
      <span class="token comment">// validated and we're not at a safepoint.</span>
      JvmtiClassFileReconstituter <span class="token function">reconstituter</span><span class="token punctuation">(</span>ik<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>reconstituter<span class="token punctuation">.</span><span class="token function">get_error</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> JVMTI_ERROR_NONE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> reconstituter<span class="token punctuation">.</span><span class="token function">get_error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      class_definitions<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>class_byte_count <span class="token operator">=</span> <span class="token punctuation">(</span>jint<span class="token punctuation">)</span>reconstituter<span class="token punctuation">.</span><span class="token function">class_file_size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      class_definitions<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>class_bytes      <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>
                                                       reconstituter<span class="token punctuation">.</span><span class="token function">class_file_bytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// it is cached, get it from the cache</span>
      class_definitions<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>class_byte_count <span class="token operator">=</span> ik<span class="token operator">-&gt;</span><span class="token function">get_cached_class_file_len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      class_definitions<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>class_bytes      <span class="token operator">=</span> ik<span class="token operator">-&gt;</span><span class="token function">get_cached_class_file_bytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    class_definitions<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>klass              <span class="token operator">=</span> jcls<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 通过transform后，得到最新的class_definitions，再调用RedefineClasses修改类的字节码</span>
  VM_RedefineClasses <span class="token function">op</span><span class="token punctuation">(</span>class_count<span class="token punctuation">,</span> class_definitions<span class="token punctuation">,</span> jvmti_class_load_kind_retransform<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">VMThread</span><span class="token double-colon punctuation">::</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>op<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>op<span class="token punctuation">.</span><span class="token function">check_error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token comment">/* end RetransformClasses */</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br></div></div><h2 id="注意事项"><a href="#注意事项" class="header-anchor">#</a> 注意事项</h2> <p>在开发javaagent程序时，如果使用attach后load agent的方式，目前jdk有一个问题时，load一个agent之后，jvm有agent的类缓存机制，
之后即使再更新javaagent文件，javaagent的类也不会更新，所以开发时如果发现效果和代码不一致，很有可能是这个原因导致。一个简单的解决方式是重启
被attach的进程。</p> <h2 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h2> <p>本文我们掌握了javaagent的常见应用场景比如分布式tracing、性能分析、在线诊断、热更新等。
了解了如何创建一个javaagent来实现AOP功能以及如何使用它。
了解了javaagent在启动时加载和运行时加载的两种使用方式，还有通过ByteBuddyAgent.install()的使用方式。
了解了VirtualMachine.attach()以及loadAgent是如何通过Attach Listener与jvm通信的。
了解了jvm中的instrument动态链接库的实现。</p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/liuzhengyang/liuzhengyang.github.io/edit/master/docs/md/jvm/jvm/javaagent.md" target="_blank" rel="noopener noreferrer">Edit this page</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/md/jvm/jvm/build-jdk.html" class="prev">
          在2024年使用Clion编译、debug、开发Java虚拟机(Mac版本)
        </a></span> <span class="next"><a href="/md/jvm/jvm/jstack.html">
          jstack实现原理分析
        </a>
        →
      </span></p></div> </main></div> <aside class="page-sidebar"> <div class="page-side-toolbar"><div class="option-box-toc-fixed"><div class="toc-container-sidebar"><div class="pos-box"><div class="icon-arrow"></div> <div class="scroll-box" style="max-height:650px"><div style="font-weight:bold;text-align:center;">javaagent</div> <hr> <div class="toc-box"><ul class="toc-sidebar-links"><li><a href="/md/jvm/jvm/javaagent.html#介绍" class="toc-sidebar-link">介绍</a><ul class="toc-sidebar-sub-headers"></ul></li><li><a href="/md/jvm/jvm/javaagent.html#使用" class="toc-sidebar-link">使用</a><ul class="toc-sidebar-sub-headers"><li class="toc-sidebar-sub-header"><a href="/md/jvm/jvm/javaagent.html#编写、打包、使用javaagent" class="toc-sidebar-link">编写、打包、使用javaagent</a></li><li class="toc-sidebar-sub-header"><a href="/md/jvm/jvm/javaagent.html#通过bytebuddy获取instrumentation" class="toc-sidebar-link">通过bytebuddy获取Instrumentation</a></li><li class="toc-sidebar-sub-header"><a href="/md/jvm/jvm/javaagent.html#instrumentation接口介绍" class="toc-sidebar-link">Instrumentation接口介绍</a></li><li class="toc-sidebar-sub-header"><a href="/md/jvm/jvm/javaagent.html#javaagent使用注意事项" class="toc-sidebar-link">javaagent使用注意事项</a></li></ul></li><li><a href="/md/jvm/jvm/javaagent.html#实现" class="toc-sidebar-link">实现</a><ul class="toc-sidebar-sub-headers"><li class="toc-sidebar-sub-header"><a href="/md/jvm/jvm/javaagent.html#meta-inf-manifest-mf文件" class="toc-sidebar-link">META-INF/MANIFEST.MF文件</a></li><li class="toc-sidebar-sub-header"><a href="/md/jvm/jvm/javaagent.html#javaagent-执行流程" class="toc-sidebar-link">-javaagent: 执行流程</a></li><li class="toc-sidebar-sub-header"><a href="/md/jvm/jvm/javaagent.html#agentlibrary加载使用" class="toc-sidebar-link">agentLibrary加载使用</a></li></ul></li><li><a href="/md/jvm/jvm/javaagent.html#can-redefine-classes和can-retransform-classes的作用" class="toc-sidebar-link">Can-Redefine-Classes和Can-Retransform-Classes的作用</a><ul class="toc-sidebar-sub-headers"><li class="toc-sidebar-sub-header"><a href="/md/jvm/jvm/javaagent.html#运行时attach加载agent" class="toc-sidebar-link">运行时attach加载agent</a></li><li class="toc-sidebar-sub-header"><a href="/md/jvm/jvm/javaagent.html#classfiletransformer是如何注册、调用的" class="toc-sidebar-link">ClassFileTransformer是如何注册、调用的</a></li><li class="toc-sidebar-sub-header"><a href="/md/jvm/jvm/javaagent.html#redefine的实现" class="toc-sidebar-link">redefine的实现</a></li><li class="toc-sidebar-sub-header"><a href="/md/jvm/jvm/javaagent.html#retransform的实现" class="toc-sidebar-link">retransform的实现</a></li></ul></li><li><a href="/md/jvm/jvm/javaagent.html#注意事项" class="toc-sidebar-link">注意事项</a><ul class="toc-sidebar-sub-headers"></ul></li><li><a href="/md/jvm/jvm/javaagent.html#总结" class="toc-sidebar-link">总结</a><ul class="toc-sidebar-sub-headers"></ul></li></ul></div></div></div></div></div> <div class="option-box-toc-over"><img src="/images/system/toc.png" class="nozoom"> <span class="show-txt">目录</span> <div class="toc-container"><div class="pos-box"><div class="icon-arrow"></div> <div class="scroll-box" style="max-height:550px"><div style="font-weight:bold;text-align:center;">javaagent</div> <hr> <div class="toc-box"><ul class="toc-sidebar-links"><li><a href="/md/jvm/jvm/javaagent.html#介绍" class="toc-sidebar-link">介绍</a><ul class="toc-sidebar-sub-headers"></ul></li><li><a href="/md/jvm/jvm/javaagent.html#使用" class="toc-sidebar-link">使用</a><ul class="toc-sidebar-sub-headers"><li class="toc-sidebar-sub-header"><a href="/md/jvm/jvm/javaagent.html#编写、打包、使用javaagent" class="toc-sidebar-link">编写、打包、使用javaagent</a></li><li class="toc-sidebar-sub-header"><a href="/md/jvm/jvm/javaagent.html#通过bytebuddy获取instrumentation" class="toc-sidebar-link">通过bytebuddy获取Instrumentation</a></li><li class="toc-sidebar-sub-header"><a href="/md/jvm/jvm/javaagent.html#instrumentation接口介绍" class="toc-sidebar-link">Instrumentation接口介绍</a></li><li class="toc-sidebar-sub-header"><a href="/md/jvm/jvm/javaagent.html#javaagent使用注意事项" class="toc-sidebar-link">javaagent使用注意事项</a></li></ul></li><li><a href="/md/jvm/jvm/javaagent.html#实现" class="toc-sidebar-link">实现</a><ul class="toc-sidebar-sub-headers"><li class="toc-sidebar-sub-header"><a href="/md/jvm/jvm/javaagent.html#meta-inf-manifest-mf文件" class="toc-sidebar-link">META-INF/MANIFEST.MF文件</a></li><li class="toc-sidebar-sub-header"><a href="/md/jvm/jvm/javaagent.html#javaagent-执行流程" class="toc-sidebar-link">-javaagent: 执行流程</a></li><li class="toc-sidebar-sub-header"><a href="/md/jvm/jvm/javaagent.html#agentlibrary加载使用" class="toc-sidebar-link">agentLibrary加载使用</a></li></ul></li><li><a href="/md/jvm/jvm/javaagent.html#can-redefine-classes和can-retransform-classes的作用" class="toc-sidebar-link">Can-Redefine-Classes和Can-Retransform-Classes的作用</a><ul class="toc-sidebar-sub-headers"><li class="toc-sidebar-sub-header"><a href="/md/jvm/jvm/javaagent.html#运行时attach加载agent" class="toc-sidebar-link">运行时attach加载agent</a></li><li class="toc-sidebar-sub-header"><a href="/md/jvm/jvm/javaagent.html#classfiletransformer是如何注册、调用的" class="toc-sidebar-link">ClassFileTransformer是如何注册、调用的</a></li><li class="toc-sidebar-sub-header"><a href="/md/jvm/jvm/javaagent.html#redefine的实现" class="toc-sidebar-link">redefine的实现</a></li><li class="toc-sidebar-sub-header"><a href="/md/jvm/jvm/javaagent.html#retransform的实现" class="toc-sidebar-link">retransform的实现</a></li></ul></li><li><a href="/md/jvm/jvm/javaagent.html#注意事项" class="toc-sidebar-link">注意事项</a><ul class="toc-sidebar-sub-headers"></ul></li><li><a href="/md/jvm/jvm/javaagent.html#总结" class="toc-sidebar-link">总结</a><ul class="toc-sidebar-sub-headers"></ul></li></ul></div></div></div></div></div> <div class="option-box"><img src="/images/system/wechat.png" class="nozoom"> <span class="show-txt">手机看</span> <div class="toc-container"><div class="pos-box"><div class="icon-arrow"></div> <div class="scroll-box" style="text-align:center"><span style="font-size:0.9rem">微信扫一扫</span> <img height="180px" src="https://api.qrserver.com/v1/create-qr-code/?data=https://bytejava.cn/md/jvm/jvm/javaagent.html" style="margin:10px;">
                可以<b>手机看</b>或分享至<b>朋友圈</b></div></div></div></div> <div class="option-box"><img src="/images/personal/wechat-mp-logo.jpg" height="20" class="nozoom"> <span class="show-txt">公众号</span> <div class="toc-container"><div class="pos-box"><div class="icon-arrow"></div> <div class="scroll-box" style="text-align:center"><span style="font-size:0.9rem">关注公众号bytejava</span> <img src="/images/personal/wechat-mp.png" height="180" width></div></div></div></div> <div class="option-box"><img src="/images/system/toggle.png" width="30px" class="nozoom"> <span class="show-txt">左栏</span></div> <div class="option-box"><img src="/images/system/heart-1.png" width="25px" class="nozoom"> <span class="show-txt">赞赏我</span> <div class="toc-container"><div class="pos-box"><div class="icon-arrow"></div> <div class="scroll-box" style="text-align:center"><span style="font-size:0.8rem;font-weight:bold;">鼓励/支持/赞赏我</span> <img height="180px" src="/images/personal/encourage-head.jpg" style="margin:5px;"> <br>1. 不靠它生存但仍希望得到你的鼓励；
                <br>2. 时刻警醒自己保持技术人的初心，沉淀，分享，成长；
              </div></div></div></div> <div title="在2024年使用Clion编译、debug、开发Java虚拟机(Mac版本)" class="option-box" style="padding-left:2px;text-align:center;"><a href="/md/jvm/jvm/build-jdk.html"><img src="/images/system/pre2.png" width="30px" class="nozoom"> <span class="show-txt">上一篇</span></a></div> <div title="jstack实现原理分析" class="option-box" style="padding-left:2px;text-align:center;"><a href="/md/jvm/jvm/jstack.html"><img src="/images/system/next2.png" width="30px" class="nozoom"> <span class="show-txt">下一篇</span></a></div></div>  <!----> </aside></div><div class="global-ui"></div></div>
    <script src="/assets/js/cg-styles.js?v=1729221831211" defer></script><script src="/assets/js/cg-4.js?v=1729221831211" defer></script><script src="/assets/js/cg-3.js?v=1729221831211" defer></script><script src="/assets/js/cg-199.js?v=1729221831211" defer></script><script src="/assets/js/cg-app.js?v=1729221831211" defer></script>
  </body>
</html>
