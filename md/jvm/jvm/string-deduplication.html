<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>String Deduplication | bytejava Java进阶手册</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/favicon.ico">
    <script charset="utf-8" async="async" src="/js/jquery.min.js"></script>
    <script charset="utf-8" async="async" src="/js/global.js"></script>
    <script charset="utf-8" async="async" src="/js/fingerprint2.min.js"></script>
    <script charset="utf-8" async="async" src="https://s9.cnzz.com/z_stat.php?id=12782949&amp;web_id=1272949"></script>
    <script>
              var _hmt = _hmt || [];
              (function() {
                var hm = document.createElement("script");
                hm.src = "https://hm.baidu.com/hm.js?fa0fbf0fef3bba94118b912a64766cee";
                var s = document.getElementsByTagName("script")[0];
                s.parentNode.insertBefore(hm, s);
              })();
            </script>
    <meta name="description" content="包含: Java 基础，高并发缓存，JVM，中间件，字节码编程...">
    <meta property="og:title" content="String Deduplication">
    <meta property="og:type" content="article">
    <meta property="og:url" content="/md/jvm/jvm/string-deduplication.html">
    <meta name="twitter:title" content="String Deduplication">
    <meta name="twitter:url" content="/md/jvm/jvm/string-deduplication.html">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="robots" content="all">
    <meta name="author" content="bytejava">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="keywords" content="bytejava 高级Java，Java设计模式, 字节码编程, 中间件, Spring, Java基础, 面经手册">
    <meta name="apple-mobile-web-app-capable" content="yes">
    
    <link rel="preload" href="/assets/css/0.styles.8fb5e8ac.css" as="style"><link rel="preload" href="/assets/css/styles.css?v=1729221831211" as="style"><link rel="preload" href="/assets/js/cg-styles.js?v=1729221831211" as="script"><link rel="preload" href="/assets/js/cg-app.js?v=1729221831211" as="script"><link rel="preload" href="/assets/js/cg-4.js?v=1729221831211" as="script"><link rel="preload" href="/assets/js/cg-3.js?v=1729221831211" as="script"><link rel="preload" href="/assets/js/cg-217.js?v=1729221831211" as="script">
    <link rel="stylesheet" href="/assets/css/0.styles.8fb5e8ac.css"><link rel="stylesheet" href="/assets/css/styles.css?v=1729221831211">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">bytejava Java进阶手册</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java" class="dropdown-title"><span class="title">Java</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/java/basic/java线程池.html" class="nav-link">
  Java基础
</a></li><li class="dropdown-item"><!----> <a href="/md/java/compiler/javac.html" class="nav-link">
  Java编译器
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="JVM" class="dropdown-title"><span class="title">JVM</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/jvm/bytecode/class字节码文件格式.html" class="nav-link">
  字节码
</a></li><li class="dropdown-item"><!----> <a href="/md/jvm/jvm/javaagent.html" class="nav-link">
  jvm
</a></li><li class="dropdown-item"><!----> <a href="/md/jvm/jvmti/jvmti介绍和开发.html" class="nav-link">
  jvmti
</a></li><li class="dropdown-item"><!----> <a href="/md/jvm/gc/g1/g1-all-intro.html" class="nav-link">
  G1 GC
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="缓存" class="dropdown-title"><span class="title">缓存</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/cache/redis/redis.html" class="nav-link">
  零基础到高并发应用专家，深入理解redis
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Spring" class="dropdown-title"><span class="title">Spring</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/spring/springboot启动请求处理过程.html" class="nav-link">
  Spring实现
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Kafka" class="dropdown-title"><span class="title">Kafka</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/kafka/kafka.html" class="nav-link">
  kafka
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="MyBatis" class="dropdown-title"><span class="title">MyBatis</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/mybatis/mybatis-use-general.html" class="nav-link">
  MyBatis
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="业务开发" class="dropdown-title"><span class="title">业务开发</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/develop/" class="nav-link">
  业务开发
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="中间件" class="dropdown-title"><span class="title">中间件</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/distribute/raft.html" class="nav-link">
  raft
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="算法" class="dropdown-title"><span class="title">算法</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/algorithm/leetcode.html" class="nav-link">
  算法
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="软技能通用技能" class="dropdown-title"><span class="title">软技能通用技能</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/soft/晋升答辩.html" class="nav-link">
  晋升答辩
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="专栏" class="dropdown-title"><span class="title">专栏</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/column/column.html" class="nav-link">
  订阅我的专栏
</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/liuzhengyang" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java" class="dropdown-title"><span class="title">Java</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/java/basic/java线程池.html" class="nav-link">
  Java基础
</a></li><li class="dropdown-item"><!----> <a href="/md/java/compiler/javac.html" class="nav-link">
  Java编译器
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="JVM" class="dropdown-title"><span class="title">JVM</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/jvm/bytecode/class字节码文件格式.html" class="nav-link">
  字节码
</a></li><li class="dropdown-item"><!----> <a href="/md/jvm/jvm/javaagent.html" class="nav-link">
  jvm
</a></li><li class="dropdown-item"><!----> <a href="/md/jvm/jvmti/jvmti介绍和开发.html" class="nav-link">
  jvmti
</a></li><li class="dropdown-item"><!----> <a href="/md/jvm/gc/g1/g1-all-intro.html" class="nav-link">
  G1 GC
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="缓存" class="dropdown-title"><span class="title">缓存</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/cache/redis/redis.html" class="nav-link">
  零基础到高并发应用专家，深入理解redis
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Spring" class="dropdown-title"><span class="title">Spring</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/spring/springboot启动请求处理过程.html" class="nav-link">
  Spring实现
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Kafka" class="dropdown-title"><span class="title">Kafka</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/kafka/kafka.html" class="nav-link">
  kafka
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="MyBatis" class="dropdown-title"><span class="title">MyBatis</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/mybatis/mybatis-use-general.html" class="nav-link">
  MyBatis
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="业务开发" class="dropdown-title"><span class="title">业务开发</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/develop/" class="nav-link">
  业务开发
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="中间件" class="dropdown-title"><span class="title">中间件</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/distribute/raft.html" class="nav-link">
  raft
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="算法" class="dropdown-title"><span class="title">算法</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/algorithm/leetcode.html" class="nav-link">
  算法
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="软技能通用技能" class="dropdown-title"><span class="title">软技能通用技能</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/soft/晋升答辩.html" class="nav-link">
  晋升答辩
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="专栏" class="dropdown-title"><span class="title">专栏</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/column/column.html" class="nav-link">
  订阅我的专栏
</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/liuzhengyang" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>JVM</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/md/jvm/jvm/build-jdk.html" class="sidebar-link">在2024年使用Clion编译、debug、开发Java虚拟机(Mac版本)</a></li><li><a href="/md/jvm/jvm/javaagent.html" class="sidebar-link">javaagent</a></li><li><a href="/md/jvm/jvm/jstack.html" class="sidebar-link">jstack实现原理分析</a></li><li><a href="/md/jvm/jvm/string-deduplication.html" aria-current="page" class="active sidebar-link">String Deduplication</a></li><li><a href="/md/jvm/jvm/tlab.html" class="sidebar-link">TLAB</a></li><li><a href="/md/jvm/jvm/synchronizer.html" class="sidebar-link">synchronzier</a></li><li><a href="/md/jvm/jvm/monitor.html" class="sidebar-link">synchronized、monitor lock加锁流程</a></li><li><a href="/md/jvm/jvm/virtualthread/virtual-thread.html" class="sidebar-link">JDK Virtual Thread的实现</a></li></ul></section></li></ul> </aside> <div><main class="page"> <div class="theme-default-content content__default"><h1 id="string-deduplication"><a href="#string-deduplication" class="header-anchor">#</a> String Deduplication</h1> <h2 id="介绍"><a href="#介绍" class="header-anchor">#</a> 介绍</h2> <p>string deduplication即字符串去重是JDK在1.8开始提供的功能，目的是减少相同内容字符串的内存占用，相同内容是指equals为true的两个字符串。
目前只有在使用G1收集器的情况下才能开启，默认不开启，开启方法为增加 <code>-XX:+UseStringDeduplication</code>启动参数。</p> <h2 id="实现机制"><a href="#实现机制" class="header-anchor">#</a> 实现机制</h2> <p>java.lang.String字符串对象的数据保存在内部的byte[] value即一个名为value的byte数组中</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">String</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> value<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>在一次gc之后，回收的heap区域中的活对象(live objects)都会被访问一遍，对于每个string对象，
我们都会查看是否能够进行deduplication。
判断规则是根据对象的age，大于一定年龄才进行deduplication，因为如果string对象是一个临时对象，
进行deduplication没有太大价值。</p> <p>如果确认一个字符串对象可以进行deduplication，则会把对象引用插入到一个队列中。</p> <p>会有一个deduplication线程来处理这个队列，从队列中取出字符串对象，然后判断尝试对字符串中的byte数组进行去重。</p> <p>内部有一个hashtable来追踪string对象的byte数组。</p> <p>在去重的时候，会到hashtable中查找是否有相同的byte数组，如果有，会把后面的字符串的byte数组换成已有的相同的byte数组并释放掉自己原有的byte数组
引用好让这块内存能够通过GC释放。如果在hashtable中没有找到相同的byte数组，则会把byte数组写入到hashtable中，hashtable对于byte数组的引用是弱引用
避免内存泄露。</p> <h3 id="deduplicate对象的选择条件。"><a href="#deduplicate对象的选择条件。" class="header-anchor">#</a> deduplicate对象的选择条件。</h3> <p>对于young gc和mixed gc，判断一个对象是否要进行deduplicate的条件是</p> <ol><li>开启了-XX:+UseStringDeduplication</li> <li>对象类型是String类型，判断对象的klass和_string_klass_or_null相同，如果没有开启-XX:+UseStringDeduplication，_string_klass_or_null是null所以这样都不会进行deduplicate</li> <li>从young gen复制过来的对象</li> <li>如果是复制到young gen(survivor)，则对象年龄即age需要等于-XX:StringDeduplicationAgeThreshold=3的配置值，默认是3；如果是复制到old gen（晋升的情况），则age需要小于StringDeduplicationAgeThreshold</li></ol> <p>最后的判断条件是什么目的呢？</p> <p>如果对象晋升到old gen，则需要进行一次deduplicate，因为再不deduplicate就只能等待full gc时进行deduplicate了(mixed gc的时候即使选择了old gen的region也不会进行deduplicate)。
判断age小于StringDeduplicationAgeThreshold是避免重复deduplicate，因为晋升到old gen的时候age不变，如果age已经大于等于StringDeduplicationAgeThreshold时了
说明之前已经进行过deduplicate了。</p> <div class="language-text line-numbers-mode"><pre class="language-text"><code>// Candidate selection policy for young/mixed GC.
// If to is young then age should be the new (survivor's) age.
// if to is old then age should be the age of the copied from object.
static bool is_candidate_from_evacuation(const Klass* klass,
                                       G1HeapRegionAttr from,
                                       G1HeapRegionAttr to,
                                       uint age) {
return StringDedup::is_enabled_string(klass) &amp;amp;&amp;amp;
       from.is_young() &amp;amp;&amp;amp;
       (to.is_young() ?
        StringDedup::is_threshold_age(age) :
        StringDedup::is_below_threshold_age(age));
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>对于FullGC的情况，则判断开启了-XX:+UseStringDeduplication、对象是String类型并且在young gen中并且age小于StringDeduplicationAgeThreshold。</p> <div class="language-text line-numbers-mode"><pre class="language-text"><code>if (StringDedup::is_enabled() &amp;amp;&amp;amp;
  java_lang_String::is_instance_inlined(obj) &amp;amp;&amp;amp;
  G1StringDedup::is_candidate_from_mark(obj)) {
  _string_dedup_requests.add(obj);
}
bool G1StringDedup::is_candidate_from_mark(oop java_string) {
  // Candidate if string is being evacuated from young to old but has not
  // reached the deduplication age threshold, i.e. has not previously been a
  // candidate during its life in the young generation.
  return G1CollectedHeap::heap()-&gt;heap_region_containing(java_string)-&gt;is_young() &amp;amp;&amp;amp;
         StringDedup::is_below_threshold_age(java_string-&gt;age());
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h3 id="deduplication-queue"><a href="#deduplication-queue" class="header-anchor">#</a> deduplication queue</h3> <p>deduplication queue是GC线程和Deduplication线程之间通信的通道，GC线程
在gc时，把可以deduplicate的String对象，放到队列中，Deduplicate线程
不断从队列中获取待deduplicate的对象。
每个GC线程都有自己的Requests对象，来减少线程间的冲突。</p> <p>入队相关代码</p> <p>在G1ParScanThreadState::do_copy_to_survivor_space方法中</p> <div class="language-text line-numbers-mode"><pre class="language-text"><code>// Check for deduplicating young Strings.
if (G1StringDedup::is_candidate_from_evacuation(klass,
                                                region_attr,
                                                dest_attr,
                                                age)) {
  // Record old; request adds a new weak reference, which reference
  // processing expects to refer to a from-space object.
  _string_dedup_requests.add(old);
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h3 id="deduplication-thread"><a href="#deduplication-thread" class="header-anchor">#</a> Deduplication Thread</h3> <p>deduplication线程是一个jvm内部的线程，和Java应用属于并发执行关系，
通过jstack可以看到这个名为StringDedupProcessor的线程。</p> <p>do_oop方法判断字符串是否为null、进行尝试去重、hashtable扩容、hashtable清理。</p> <div class="language-text line-numbers-mode"><pre class="language-text"><code>virtual void do_oop(oop* ref) {
    if (_processor-&gt;yield_or_continue(_joiner, Stat::Phase::process)) {
      oop java_string = NativeAccess&amp;lt;ON_PHANTOM_OOP_REF&gt;::oop_load(ref);
      release_ref(ref);
      // Dedup java_string, after checking for various reasons to skip it.
      if (java_string == nullptr) {
        // String became unreachable before we got a chance to process it.
        _cur_stat.inc_skipped_dead();
      } else if (java_lang_String::value(java_string) == nullptr) {
        // Request during String construction, before its value array has
        // been initialized.
        _cur_stat.inc_skipped_incomplete();
      } else {
        Table::deduplicate(java_string);
        if (Table::is_grow_needed()) {
          _cur_stat.report_process_pause();
          _processor-&gt;cleanup_table(_joiner, true /* grow_only */, false /* force */);
          _cur_stat.report_process_resume();
        }
      }
    }
  }
};
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>去重的具体处理，在hashtable中查找和当前字符串的value(byte数组)内容相同的byte array，
如果找到，并且不是同一个数组对象，则对当前的字符串替换value引用。
如果没找到，则将当前的value插入到hashtable中。</p> <div class="language-text line-numbers-mode"><pre class="language-text"><code>void StringDedup::Table::deduplicate(oop java_string) {
  assert(java_lang_String::is_instance(java_string), &quot;precondition&quot;);
  _cur_stat.inc_inspected();
  if ((StringTable::shared_entry_count() &gt; 0) &amp;amp;&amp;amp;
      try_deduplicate_shared(java_string)) {
    return;                     // Done if deduplicated against shared StringTable.
  }
  typeArrayOop value = java_lang_String::value(java_string);
  uint hash_code = compute_hash(value);
  TableValue tv = find(value, hash_code);
  if (tv.is_empty()) {
    // Not in table.  Create a new table entry.
    install(value, hash_code);
  } else {
    _cur_stat.inc_known();
    typeArrayOop found = cast_from_oop&amp;lt;typeArrayOop&gt;(tv.resolve());
    assert(found != nullptr, &quot;invariant&quot;);
    // Deduplicate if value array differs from what's in the table.
    if (found != value) {
      if (deduplicate_if_permitted(java_string, found)) {
        _cur_stat.inc_deduped(found-&gt;size() * HeapWordSize);
      } else {
        // If string marked deduplication_forbidden then we can't update its
        // value.  Instead, replace the array in the table with the new one,
        // as java_string is probably in the StringTable.  That makes it a
        // good target for future deduplications as it is probably intended
        // to live for some time.
        tv.replace(value);
        _cur_stat.inc_replaced();
      }
    }
  }
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><h3 id="deduplication-hashtable"><a href="#deduplication-hashtable" class="header-anchor">#</a> deduplication hashtable</h3> <p>deduplication hashtable需要记录所有请求去重的字符串的byte array数据，
并且在没有引用之后清理。
hashtable和Java里的HashMap类似，也是Bucket数组组成，每个Bucket是一个逻辑上的链表，
实际上是用动态长度的数组来代替链表节省空间（next指针等）</p> <div class="language-text line-numbers-mode"><pre class="language-text"><code>class StringDedup::Table : AllStatic {
private:
  class Bucket;
  class CleanupState;
  class Resizer;
  class Cleaner;
  enum class DeadState;

  // Values in the table are weak references to jbyte[] Java objects.  The
  // String's coder isn't recorded, even though it affects how String access
  // would interpret that array.  For the purposes of deduplication we don't
  // care about that distinction; two Strings with equivalent arrays but
  // different coders can be deduplicated to share a single array.  We also
  // can't depend on the coder value being correct here, since GC requests
  // can provide the deduplication thread with access to a String that is
  // incompletely constructed; the value could be set before the coder.
  using TableValue = WeakHandle;  // 弱引用

  // Weak storage for the string data in the table.
  static OopStorage* _table_storage;
  static Bucket* _buckets;
  static size_t _number_of_buckets;
  static size_t _number_of_entries;
  static size_t _grow_threshold;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><div class="language-text line-numbers-mode"><pre class="language-text"><code>class StringDedup::Table::Bucket {
  GrowableArrayCHeap&amp;lt;uint, mtStringDedup&gt; _hashes;
  GrowableArrayCHeap&amp;lt;TableValue, mtStringDedup&gt; _values;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>在hashtable中元素超过threshold时，也会像HashMap一样扩容，数量变少时（清理没有引用的数据），也会进行缩容（shrink)</p> <h3 id="string-deduplication-log分析"><a href="#string-deduplication-log分析" class="header-anchor">#</a> string deduplication log分析</h3> <p>对于JDK17，通过增加-XX:stringdedup*=debug
对于JDK11，通过增加-XX:gc+stringdedup=debug
可以打开string deduplication的详细日志。</p> <div class="language-text line-numbers-mode"><pre class="language-text"><code>[15.950s][info ][stringdedup             ] Concurrent String Deduplication 1032/41424.0B (new), 168/5208.0B (deduped), avg 12.5%, 17.502ms of 24.439ms

1032/41424.0B (new)表示向hashtable中新增了1032个byte数组，总体大小41424.0B

168/5208.0B (deduped)表示本次对168个字符串的byte数组进行了去重，总体大小5208.0B

avg 12.5%表示从应用启动到现在，去重的字符串的占比。

17.502ms of 24.439ms 前面的17.502ms是_process_elapsed表示用于deduplication的时间，不包含
后面的24.439ms表示的是concurrent deduplication整体处理的时间，除了进行deduplication外还有cleanup_table（清理没有强引用的weakreference引用的byte array)


[15.950s][debug][stringdedup             ]   Last Process: 1/17.502ms, Idle: 1/2604.480ms, Blocked: 0/0.000ms
[15.950s][debug][stringdedup             ]   Last Cleanup Table: 1/6.764ms
[15.950s][debug][stringdedup             ]     Inspected:            1466
[15.950s][debug][stringdedup             ]       Known:               434( 29.6%)
[15.950s][debug][stringdedup             ]       Shared:                0(  0.0%)
[15.950s][debug][stringdedup             ]       New:                1032( 70.4%) 41424.0B
[15.950s][debug][stringdedup             ]       Replaced:             14(  1.4%)
[15.950s][debug][stringdedup             ]       Deleted:            2218(214.9%)
[15.950s][debug][stringdedup             ]     Deduplicated:          168( 11.5%)  5208.0B( 12.6%)
[15.950s][debug][stringdedup             ]     Skipped: 4 (dead), 0 (incomplete), 0 (shared)
[15.950s][debug][stringdedup             ]   Total Process: 8/139.331ms, Idle: 8/14716.313ms, Blocked: 0/0.000ms

Last这部分表示最近一次string deduplication。

Inspected: 1466表示这次处理了1466个字符串去重请求
Known: 434( 29.6%) 表示其中434个字符串中hashtable中有重复的byte array，29.6%表示占本次处理的字符串的比例是29.6%
Shared: 上共享内存的统计，一般用的比较少。
New: 1032( 70.4%) 41424.0B 表示hashtable中新增加了1032个byte array，总内存大小41424.0B
Replaced: 14(1.4%) 表示替换hashtable的数量，因为有的字符串不能替换value，则hashtable会替换value成新的value
Deleted: 2218(214.9%)表示删除了2218个byte array，是删除的没有引用的数据。
Deduplicated: 168( 11.5%)  5208.0B( 12.6%) Deduplicated表示给168字符串替换了value。Known和deduplicated的区别是Known中的有可能是相同的array数组对象，不用替换。

[15.950s][debug][stringdedup             ]   Total Cleanup Table: 1/6.764ms
[15.950s][debug][stringdedup             ]     Inspected:            9825
[15.950s][debug][stringdedup             ]       Known:              2826( 28.8%)
[15.950s][debug][stringdedup             ]       Shared:                0(  0.0%)
[15.951s][debug][stringdedup             ]       New:                6999( 71.2%)   298.5K
[15.951s][debug][stringdedup             ]       Replaced:             19(  0.3%)
[15.951s][debug][stringdedup             ]       Deleted:            2218( 31.7%)
[15.951s][debug][stringdedup             ]     Deduplicated:          976(  9.9%) 38088.0B( 12.5%)
[15.951s][debug][stringdedup             ]     Skipped: 20 (dead), 0 (incomplete), 0 (shared)
[15.951s][debug][stringdedup             ] Table: 4781 values in 503 buckets, 0 dead (2)

Total表示总的deduplication统计，和Last的统计含义类似，不再赘述。
Table: 4781 values in 503 buckets表示一共4781个value在503个bucket中。

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br></div></div><h2 id="配置建议"><a href="#配置建议" class="header-anchor">#</a> 配置建议</h2> <p>如果你的业务场景中，会有比较多的重复的字符串对象常驻在内存中，比如有比较多的本地缓存，缓存中存储的数据有比较多的重复字符串，建议开启。通过一定的CPU开销换取更低的内存占用。</p> <p>在实际使用中，我们发现开启UseStringDeduplication能够降低old gen的大小（有比较多本地缓存这类数据的情况下），但是
UseStringDeduplication会带来一定程度的gc暂停时间变长。</p> <p>如果觉得去重占用过多CPU，可以关闭（默认关闭）或调大<code>-XX:StringDeduplicationAgeThreshold=3</code></p> <h2 id="参考"><a href="#参考" class="header-anchor">#</a> 参考</h2> <ul><li><a href="https://openjdk.org/jeps/192" target="_blank" rel="noopener noreferrer">JEP 192: String Deduplication in G1<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/liuzhengyang/liuzhengyang.github.io/edit/master/docs/md/jvm/jvm/string-deduplication.md" target="_blank" rel="noopener noreferrer">Edit this page</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/md/jvm/jvm/jstack.html" class="prev">
          jstack实现原理分析
        </a></span> <span class="next"><a href="/md/jvm/jvm/tlab.html">
          TLAB
        </a>
        →
      </span></p></div> </main></div> <aside class="page-sidebar"> <div class="page-side-toolbar"><div class="option-box-toc-fixed"><div class="toc-container-sidebar"><div class="pos-box"><div class="icon-arrow"></div> <div class="scroll-box" style="max-height:650px"><div style="font-weight:bold;text-align:center;">String Deduplication</div> <hr> <div class="toc-box"><ul class="toc-sidebar-links"><li><a href="/md/jvm/jvm/string-deduplication.html#介绍" class="toc-sidebar-link">介绍</a><ul class="toc-sidebar-sub-headers"></ul></li><li><a href="/md/jvm/jvm/string-deduplication.html#实现机制" class="toc-sidebar-link">实现机制</a><ul class="toc-sidebar-sub-headers"><li class="toc-sidebar-sub-header"><a href="/md/jvm/jvm/string-deduplication.html#deduplicate对象的选择条件。" class="toc-sidebar-link">deduplicate对象的选择条件。</a></li><li class="toc-sidebar-sub-header"><a href="/md/jvm/jvm/string-deduplication.html#deduplication-queue" class="toc-sidebar-link">deduplication queue</a></li><li class="toc-sidebar-sub-header"><a href="/md/jvm/jvm/string-deduplication.html#deduplication-thread" class="toc-sidebar-link">Deduplication Thread</a></li><li class="toc-sidebar-sub-header"><a href="/md/jvm/jvm/string-deduplication.html#deduplication-hashtable" class="toc-sidebar-link">deduplication hashtable</a></li><li class="toc-sidebar-sub-header"><a href="/md/jvm/jvm/string-deduplication.html#string-deduplication-log分析" class="toc-sidebar-link">string deduplication log分析</a></li></ul></li><li><a href="/md/jvm/jvm/string-deduplication.html#配置建议" class="toc-sidebar-link">配置建议</a><ul class="toc-sidebar-sub-headers"></ul></li><li><a href="/md/jvm/jvm/string-deduplication.html#参考" class="toc-sidebar-link">参考</a><ul class="toc-sidebar-sub-headers"></ul></li></ul></div></div></div></div></div> <div class="option-box-toc-over"><img src="/images/system/toc.png" class="nozoom"> <span class="show-txt">目录</span> <div class="toc-container"><div class="pos-box"><div class="icon-arrow"></div> <div class="scroll-box" style="max-height:550px"><div style="font-weight:bold;text-align:center;">String Deduplication</div> <hr> <div class="toc-box"><ul class="toc-sidebar-links"><li><a href="/md/jvm/jvm/string-deduplication.html#介绍" class="toc-sidebar-link">介绍</a><ul class="toc-sidebar-sub-headers"></ul></li><li><a href="/md/jvm/jvm/string-deduplication.html#实现机制" class="toc-sidebar-link">实现机制</a><ul class="toc-sidebar-sub-headers"><li class="toc-sidebar-sub-header"><a href="/md/jvm/jvm/string-deduplication.html#deduplicate对象的选择条件。" class="toc-sidebar-link">deduplicate对象的选择条件。</a></li><li class="toc-sidebar-sub-header"><a href="/md/jvm/jvm/string-deduplication.html#deduplication-queue" class="toc-sidebar-link">deduplication queue</a></li><li class="toc-sidebar-sub-header"><a href="/md/jvm/jvm/string-deduplication.html#deduplication-thread" class="toc-sidebar-link">Deduplication Thread</a></li><li class="toc-sidebar-sub-header"><a href="/md/jvm/jvm/string-deduplication.html#deduplication-hashtable" class="toc-sidebar-link">deduplication hashtable</a></li><li class="toc-sidebar-sub-header"><a href="/md/jvm/jvm/string-deduplication.html#string-deduplication-log分析" class="toc-sidebar-link">string deduplication log分析</a></li></ul></li><li><a href="/md/jvm/jvm/string-deduplication.html#配置建议" class="toc-sidebar-link">配置建议</a><ul class="toc-sidebar-sub-headers"></ul></li><li><a href="/md/jvm/jvm/string-deduplication.html#参考" class="toc-sidebar-link">参考</a><ul class="toc-sidebar-sub-headers"></ul></li></ul></div></div></div></div></div> <div class="option-box"><img src="/images/system/wechat.png" class="nozoom"> <span class="show-txt">手机看</span> <div class="toc-container"><div class="pos-box"><div class="icon-arrow"></div> <div class="scroll-box" style="text-align:center"><span style="font-size:0.9rem">微信扫一扫</span> <img height="180px" src="https://api.qrserver.com/v1/create-qr-code/?data=https://bytejava.cn/md/jvm/jvm/string-deduplication.html" style="margin:10px;">
                可以<b>手机看</b>或分享至<b>朋友圈</b></div></div></div></div> <div class="option-box"><img src="/images/personal/wechat-mp-logo.jpg" height="20" class="nozoom"> <span class="show-txt">公众号</span> <div class="toc-container"><div class="pos-box"><div class="icon-arrow"></div> <div class="scroll-box" style="text-align:center"><span style="font-size:0.9rem">关注公众号bytejava</span> <img src="/images/personal/wechat-mp.png" height="180" width></div></div></div></div> <div class="option-box"><img src="/images/system/toggle.png" width="30px" class="nozoom"> <span class="show-txt">左栏</span></div> <div class="option-box"><img src="/images/system/heart-1.png" width="25px" class="nozoom"> <span class="show-txt">赞赏我</span> <div class="toc-container"><div class="pos-box"><div class="icon-arrow"></div> <div class="scroll-box" style="text-align:center"><span style="font-size:0.8rem;font-weight:bold;">鼓励/支持/赞赏我</span> <img height="180px" src="/images/personal/encourage-head.jpg" style="margin:5px;"> <br>1. 不靠它生存但仍希望得到你的鼓励；
                <br>2. 时刻警醒自己保持技术人的初心，沉淀，分享，成长；
              </div></div></div></div> <div title="jstack实现原理分析" class="option-box" style="padding-left:2px;text-align:center;"><a href="/md/jvm/jvm/jstack.html"><img src="/images/system/pre2.png" width="30px" class="nozoom"> <span class="show-txt">上一篇</span></a></div> <div title="TLAB" class="option-box" style="padding-left:2px;text-align:center;"><a href="/md/jvm/jvm/tlab.html"><img src="/images/system/next2.png" width="30px" class="nozoom"> <span class="show-txt">下一篇</span></a></div></div>  <!----> </aside></div><div class="global-ui"></div></div>
    <script src="/assets/js/cg-styles.js?v=1729221831211" defer></script><script src="/assets/js/cg-4.js?v=1729221831211" defer></script><script src="/assets/js/cg-3.js?v=1729221831211" defer></script><script src="/assets/js/cg-217.js?v=1729221831211" defer></script><script src="/assets/js/cg-app.js?v=1729221831211" defer></script>
  </body>
</html>
