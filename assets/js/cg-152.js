(window.webpackJsonp=window.webpackJsonp||[]).push([[152],{584:function(t,a,s){"use strict";s.r(a);var n=s(34),e=Object(n.a)({},(function(){var t=this,a=t.$createElement,s=t._self._c||a;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h1",{attrs:{id:"class字节码文件格式"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#class字节码文件格式"}},[t._v("#")]),t._v(" class字节码文件格式")]),t._v(" "),s("p",[t._v("掌握jvm 字节码，最关键的是学习class文件格式以及字节码指令集等细节，今天我们来学习class字节码文件格式(jdk8版本)。")]),t._v(" "),s("p",[t._v("Java代码经过javac编译器编译成class文件，JVM虚拟机读取class文件执行其中的代码。")]),t._v(" "),s("p",[t._v("通过JVM虚拟机规范，实现了jvm跨平台、跨语言的能力，JVM规范中非常重要的一部分就是class字节码文件格式。")]),t._v(" "),s("h2",{attrs:{id:"class文件结构"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#class文件结构"}},[t._v("#")]),t._v(" class文件结构")]),t._v(" "),s("p",[t._v("class文件的整体结构如下图所示，其中u1,u2,u4分别表示1个、2个、4个字节长度的无符号数据，无符号byte数据按照具体的场景可以用来表示数字、字符等。\n结构中还可以使用复合结构，比如cp_info, cp_info结构也会在规范中进行定义。")]),t._v(" "),s("div",{staticClass:"language-text line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("ClassFile {\n       u4             magic;\n       u2             minor_version;\n       u2             major_version;\n       u2             constant_pool_count;\n       cp_info        constant_pool[constant_pool_count-1];\n       u2             access_flags;\n       u2             this_class;\n       u2             super_class;\n       u2             interfaces_count;\n       u2             interfaces[interfaces_count];\n       u2             fields_count;\n       field_info     fields[fields_count];\n       u2             methods_count;\n       method_info    methods[methods_count];\n       u2             attributes_count;\n       attribute_info attributes[attributes_count];\n}\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br"),s("span",{staticClass:"line-number"},[t._v("10")]),s("br"),s("span",{staticClass:"line-number"},[t._v("11")]),s("br"),s("span",{staticClass:"line-number"},[t._v("12")]),s("br"),s("span",{staticClass:"line-number"},[t._v("13")]),s("br"),s("span",{staticClass:"line-number"},[t._v("14")]),s("br"),s("span",{staticClass:"line-number"},[t._v("15")]),s("br"),s("span",{staticClass:"line-number"},[t._v("16")]),s("br"),s("span",{staticClass:"line-number"},[t._v("17")]),s("br"),s("span",{staticClass:"line-number"},[t._v("18")]),s("br")])]),s("h3",{attrs:{id:"magic"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#magic"}},[t._v("#")]),t._v(" magic")]),t._v(" "),s("p",[t._v("魔法字符串，固定为0xCAFEBABE")]),t._v(" "),s("h3",{attrs:{id:"minor-version-major-version"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#minor-version-major-version"}},[t._v("#")]),t._v(" minor_version, major_version")]),t._v(" "),s("p",[t._v("分别是class文件的小版本号和大版本号，jvm规范要求运行的jvm版本必须大于等于（更严格说是能支持，不过目前大于等于即可）class文件的major_version才能运行，否则抛出异常。")]),t._v(" "),s("h3",{attrs:{id:"constant-pool-count"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#constant-pool-count"}},[t._v("#")]),t._v(" constant_pool_count")]),t._v(" "),s("p",[t._v("常量池数量，是下面的常量池表的长度加一，因为index=0的常量引用没有使用。")]),t._v(" "),s("h3",{attrs:{id:"constant-pool"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#constant-pool"}},[t._v("#")]),t._v(" constant_pool[]")]),t._v(" "),s("p",[t._v("常量池表，每个常量池的结构cp_info如下，常量池可以表示字符串常量、类名、接口名、方法等信息，这些常量池会在class文件中其他地方进行引用（比如字段中字段类型、字段名等）。\n常量通过index进行引用，常量之间也可以通过index进行引用。")]),t._v(" "),s("p",[t._v("cp_info中的tag字段用来标识当前的常量类型，不同的常量类型有不同的子结构，然后就可以用具体的结构来解析info[]这个byte数组。\n常量的结构有，")]),t._v(" "),s("div",{staticClass:"language-text line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("cp_info {\n    u1 tag;\n    u1 info[];\n}\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br")])]),s("table",[s("thead",[s("tr",[s("th",[t._v("Constant type")]),t._v(" "),s("th",[t._v("tag value")])])]),t._v(" "),s("tbody",[s("tr",[s("td",[t._v("CONSTANT_Class")]),t._v(" "),s("td",[t._v("7")])]),t._v(" "),s("tr",[s("td",[t._v("CONSTANT_Fieldref")]),t._v(" "),s("td",[t._v("9")])]),t._v(" "),s("tr",[s("td",[t._v("CONSTANT_Methodref")]),t._v(" "),s("td",[t._v("10")])]),t._v(" "),s("tr",[s("td",[t._v("CONSTANT_InterfaceMethodref")]),t._v(" "),s("td",[t._v("11")])]),t._v(" "),s("tr",[s("td",[t._v("CONSTANT_Integer")]),t._v(" "),s("td",[t._v("3")])]),t._v(" "),s("tr",[s("td",[t._v("CONSTANT_Float")]),t._v(" "),s("td",[t._v("4")])]),t._v(" "),s("tr",[s("td",[t._v("CONSTANT_Long")]),t._v(" "),s("td",[t._v("5")])]),t._v(" "),s("tr",[s("td",[t._v("CONSTANT_Double")]),t._v(" "),s("td",[t._v("6")])]),t._v(" "),s("tr",[s("td",[t._v("CONSTANT_NameAndType")]),t._v(" "),s("td",[t._v("12")])]),t._v(" "),s("tr",[s("td",[t._v("CONSTANT_Utf8")]),t._v(" "),s("td",[t._v("1")])]),t._v(" "),s("tr",[s("td",[t._v("CONSTANT_MethodHandle")]),t._v(" "),s("td",[t._v("15")])]),t._v(" "),s("tr",[s("td",[t._v("CONSTANT_MethodType")]),t._v(" "),s("td",[t._v("16")])]),t._v(" "),s("tr",[s("td",[t._v("CONSTANT_InvokeDynamic")]),t._v(" "),s("td",[t._v("18")])])])]),t._v(" "),s("p",[t._v("我们提前查看一下各个常量类型的结构，给后面介绍Field, Method做铺垫。")]),t._v(" "),s("div",{staticClass:"language-text line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("CONSTANT_Class_info {\n    u1 tag;\n    u2 name_index;\n}\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br")])]),s("h4",{attrs:{id:"constant-class-info"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#constant-class-info"}},[t._v("#")]),t._v(" CONSTANT_Class_info")]),t._v(" "),s("p",[t._v("CONSTANT_Class_info表示类或接口")]),t._v(" "),s("div",{staticClass:"language-text line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("CONSTANT_Class_info {\n    u1 tag;\n    u2 name_index;\n}\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br")])]),s("p",[t._v("tag: 是CONSTANT_Class对应的值(7)\nname_index: name_index是这个类或接口的类名的字符串常量的index")]),t._v(" "),s("h4",{attrs:{id:"constant-fieldref-info-constant-methodref-info-constant-interfacemethodref-info"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#constant-fieldref-info-constant-methodref-info-constant-interfacemethodref-info"}},[t._v("#")]),t._v(" CONSTANT_Fieldref_info, CONSTANT_Methodref_info, CONSTANT_InterfaceMethodref_info")]),t._v(" "),s("div",{staticClass:"language-text line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("CONSTANT_Fieldref_info {\n    u1 tag;\n    u2 class_index;\n    u2 name_and_type_index;\n}\n\nCONSTANT_Methodref_info {\n    u1 tag;\n    u2 class_index;\n    u2 name_and_type_index;\n}\n\nCONSTANT_InterfaceMethodref_info {\n    u1 tag;\n    u2 class_index;\n    u2 name_and_type_index;\n}\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br"),s("span",{staticClass:"line-number"},[t._v("10")]),s("br"),s("span",{staticClass:"line-number"},[t._v("11")]),s("br"),s("span",{staticClass:"line-number"},[t._v("12")]),s("br"),s("span",{staticClass:"line-number"},[t._v("13")]),s("br"),s("span",{staticClass:"line-number"},[t._v("14")]),s("br"),s("span",{staticClass:"line-number"},[t._v("15")]),s("br"),s("span",{staticClass:"line-number"},[t._v("16")]),s("br"),s("span",{staticClass:"line-number"},[t._v("17")]),s("br")])]),s("p",[t._v("字段引用、方法引用、接口方法引用这三个结构比较类似，都是各自的tag以及class_index和name_and_type_index")]),t._v(" "),s("p",[t._v("class_index: 这个字段、方法所在类的class的常量的index")]),t._v(" "),s("p",[t._v("name_and_type_index: 这个字段的名称和类型结构常量CONSTANT_NameAndType_info的index。name分别是字段名和方法名，类型是字段、方法的descriptor描述符。")]),t._v(" "),s("h4",{attrs:{id:"constant-string-info"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#constant-string-info"}},[t._v("#")]),t._v(" CONSTANT_String_info")]),t._v(" "),s("p",[t._v("字符串常量结构")]),t._v(" "),s("p",[t._v("string_index: 指向CONSTANT_Utf8_info的index")]),t._v(" "),s("div",{staticClass:"language-text line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("CONSTANT_String_info {\n    u1 tag;\n    u2 string_index;\n}\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br")])]),s("h4",{attrs:{id:"constant-integer-info-constant-float-info"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#constant-integer-info-constant-float-info"}},[t._v("#")]),t._v(" CONSTANT_Integer_info, CONSTANT_Float_info")]),t._v(" "),s("p",[t._v("整数和浮点数常量结构，对应的数值占用4个字节。")]),t._v(" "),s("div",{staticClass:"language-text line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("CONSTANT_Integer_info {\n    u1 tag;\n    u4 bytes;\n}\n\nCONSTANT_Float_info {\n    u1 tag;\n    u4 bytes;\n}\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br")])]),s("h4",{attrs:{id:"constant-long-info-constant-double-info"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#constant-long-info-constant-double-info"}},[t._v("#")]),t._v(" CONSTANT_Long_info, CONSTANT_Double_info")]),t._v(" "),s("p",[t._v("这两个常量结构分别存储long和double类型的数值，大小占用8个字节\nhigh_bytes和low_bytes分别表示高位和低位的数据，以long为例，对应值为"),s("code",[t._v("((long) high_bytes << 32) + low_bytes")])]),t._v(" "),s("div",{staticClass:"language-text line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("CONSTANT_Long_info {\n    u1 tag;\n    u4 high_bytes;\n    u4 low_bytes;\n}\n\nCONSTANT_Double_info {\n    u1 tag;\n    u4 high_bytes;\n    u4 low_bytes;\n}\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br"),s("span",{staticClass:"line-number"},[t._v("10")]),s("br"),s("span",{staticClass:"line-number"},[t._v("11")]),s("br")])]),s("h4",{attrs:{id:"constant-nameandtype-info"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#constant-nameandtype-info"}},[t._v("#")]),t._v(" CONSTANT_NameAndType_info")]),t._v(" "),s("p",[t._v("CONSTANT_NameAndType_info常量用来表示名称和类型，在前面的CONSTANT_Fieldref_info, CONSTANT_Methodref_info, CONSTANT_InterfaceMethodref_info\n常量中有使用，结构如下")]),t._v(" "),s("div",{staticClass:"language-text line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("CONSTANT_NameAndType_info {\n    u1 tag;\n    u2 name_index;\n    u2 descriptor_index;\n}\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br")])]),s("p",[t._v("name_index: 指向对应名称的utf8常量的CONSTANT_Utf8_info的index\ndescriptor_index: 指向类型描述符的CONSTANT_Utf8_info的index。")]),t._v(" "),s("h4",{attrs:{id:"field-descriptor和method-descriptor"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#field-descriptor和method-descriptor"}},[t._v("#")]),t._v(" Field Descriptor和Method Descriptor")]),t._v(" "),s("p",[t._v("在jvm中，数据分为primitive type(基本类型，比如int, long)和reference type（引用类型），类型的描述符规则如下")]),t._v(" "),s("table",[s("thead",[s("tr",[s("th",[t._v("类型")]),t._v(" "),s("th",[t._v("描述符")])])]),t._v(" "),s("tbody",[s("tr",[s("td",[t._v("byte")]),t._v(" "),s("td",[t._v("B")])]),t._v(" "),s("tr",[s("td",[t._v("char")]),t._v(" "),s("td",[t._v("C")])]),t._v(" "),s("tr",[s("td",[t._v("double")]),t._v(" "),s("td",[t._v("D")])]),t._v(" "),s("tr",[s("td",[t._v("float")]),t._v(" "),s("td",[t._v("F")])]),t._v(" "),s("tr",[s("td",[t._v("int")]),t._v(" "),s("td",[t._v("I")])]),t._v(" "),s("tr",[s("td",[t._v("long")]),t._v(" "),s("td",[t._v("J")])]),t._v(" "),s("tr",[s("td",[t._v("short")]),t._v(" "),s("td",[t._v("S")])]),t._v(" "),s("tr",[s("td",[t._v("boolean")]),t._v(" "),s("td",[t._v("Z")])]),t._v(" "),s("tr",[s("td",[t._v("reference,引用类型")]),t._v(" "),s("td",[t._v("LClassName;")])]),t._v(" "),s("tr",[s("td",[t._v("数组")]),t._v(" "),s("td",[t._v("[")])])])]),t._v(" "),s("p",[t._v("引用类型的ClassName是/间隔的字符串，比如"),s("code",[t._v("java.lang.String")]),t._v("的描述符为"),s("code",[t._v("Ljava/lang/String;")]),t._v("\n数组是在对应的类型前加[，比如"),s("code",[t._v("int[]")]),t._v("描述符为"),s("code",[t._v("[I")]),t._v(", "),s("code",[t._v("String[]")]),t._v("描述符为"),s("code",[t._v("[Ljava/lang/String;")]),t._v(", 多维数组距离 "),s("code",[t._v("int[][]")]),t._v("描述符为"),s("code",[t._v("[[I")])]),t._v(" "),s("p",[t._v("Field Descriptor是对应字段的类型的描述符\nMethod Descriptor为( {ParameterDescriptor} ) ReturnDescriptor，比如"),s("code",[t._v("public String test(int a, Long b)")]),t._v("的方法描述符为"),s("code",[t._v("(ILjava/lang/Long)Ljava/lang/String;")]),t._v("，如果返回值是void，则使用V")]),t._v(" "),s("h4",{attrs:{id:"constant-utf8-info"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#constant-utf8-info"}},[t._v("#")]),t._v(" CONSTANT_Utf8_info")]),t._v(" "),s("p",[t._v("CONSTANT_Utf8_info常量存储utf8编码的字符串内容，包含一个字符串长度字段和对应长度的byte数组。")]),t._v(" "),s("div",{staticClass:"language-text line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("CONSTANT_Utf8_info {\n    u1 tag;\n    u2 length;\n    u1 bytes[length];\n}\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br")])]),s("h3",{attrs:{id:"class-access-flags"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#class-access-flags"}},[t._v("#")]),t._v(" class access_flags")]),t._v(" "),s("p",[t._v("access_flags用来表示当前类的一些bit信息（类似bitmap），这样用2个字节的空间就可以表示16个标记信息。")]),t._v(" "),s("table",[s("thead",[s("tr",[s("th",[t._v("Flag Name")]),t._v(" "),s("th",[t._v("Value")]),t._v(" "),s("th",[t._v("表头")])])]),t._v(" "),s("tbody",[s("tr",[s("td",[t._v("ACC_PUBLIC")]),t._v(" "),s("td",[t._v("0x0001")]),t._v(" "),s("td",[t._v("表示当前类/接口是否是public")])]),t._v(" "),s("tr",[s("td",[t._v("ACC_FINAL")]),t._v(" "),s("td",[t._v("0x0010")]),t._v(" "),s("td",[t._v("是否声明了final")])]),t._v(" "),s("tr",[s("td",[t._v("ACC_SUPER")]),t._v(" "),s("td",[t._v("0x0020")]),t._v(" "),s("td",[t._v("都是true, 为了兼容旧版本的字节码的标记")])]),t._v(" "),s("tr",[s("td",[t._v("ACC_INTERFACE")]),t._v(" "),s("td",[t._v("0x0200")]),t._v(" "),s("td",[t._v("是否是接口")])]),t._v(" "),s("tr",[s("td",[t._v("ACC_ABSTRACT")]),t._v(" "),s("td",[t._v("0x0400")]),t._v(" "),s("td",[t._v("是否是抽象类，接口也是抽象类")])]),t._v(" "),s("tr",[s("td",[t._v("ACC_SYNTHETIC")]),t._v(" "),s("td",[t._v("0x1000")]),t._v(" "),s("td",[t._v("表示不是代码中生成的类，比如jdk为实现lambda表达式在运行时生成的一些类")])]),t._v(" "),s("tr",[s("td",[t._v("ACC_ANNOTATION")]),t._v(" "),s("td",[t._v("0x2000")]),t._v(" "),s("td",[t._v("是否是@interface这样的注解类")])]),t._v(" "),s("tr",[s("td",[t._v("ACC_ENUM")]),t._v(" "),s("td",[t._v("0x4000")]),t._v(" "),s("td",[t._v("是否枚举类")])])])]),t._v(" "),s("h3",{attrs:{id:"fields"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#fields"}},[t._v("#")]),t._v(" Fields")]),t._v(" "),s("p",[t._v("Fields是field_info的数组，每个field_info结构如下。")]),t._v(" "),s("div",{staticClass:"language-text line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("field_info {\n    u2             access_flags;\n    u2             name_index;\n    u2             descriptor_index;\n    u2             attributes_count;\n    attribute_info attributes[attributes_count];\n}\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br")])]),s("p",[t._v("access_flags: 字段的access_flags，和class的access_flags类似，用来描述字段的public,private,volatile等等标识信息。")]),t._v(" "),s("table",[s("thead",[s("tr",[s("th",[t._v("Flag Name")]),t._v(" "),s("th",[t._v("Value")]),t._v(" "),s("th",[t._v("描述")])])]),t._v(" "),s("tbody",[s("tr",[s("td",[t._v("ACC_PUBLIC")]),t._v(" "),s("td",[t._v("0x0001")]),t._v(" "),s("td",[t._v("是否是public字段")])]),t._v(" "),s("tr",[s("td",[t._v("ACC_PRIVATE")]),t._v(" "),s("td",[t._v("0x0002")]),t._v(" "),s("td",[t._v("是否是private字段")])]),t._v(" "),s("tr",[s("td",[t._v("ACC_PROTECTED")]),t._v(" "),s("td",[t._v("0x0004")]),t._v(" "),s("td",[t._v("是否是static字段")])]),t._v(" "),s("tr",[s("td",[t._v("ACC_STATIC")]),t._v(" "),s("td",[t._v("0x0008")]),t._v(" "),s("td",[t._v("是否是static字段")])]),t._v(" "),s("tr",[s("td",[t._v("ACC_FINAL")]),t._v(" "),s("td",[t._v("0x0010")]),t._v(" "),s("td",[t._v("是否是final字段")])]),t._v(" "),s("tr",[s("td",[t._v("ACC_VOLATILE")]),t._v(" "),s("td",[t._v("0x0040")]),t._v(" "),s("td",[t._v("是否是volatile字段")])]),t._v(" "),s("tr",[s("td",[t._v("ACC_TRANSIENT")]),t._v(" "),s("td",[t._v("0x0080")]),t._v(" "),s("td",[t._v("是否是transient字段")])]),t._v(" "),s("tr",[s("td",[t._v("ACC_SYNTHETIC")]),t._v(" "),s("td",[t._v("0x1000")]),t._v(" "),s("td",[t._v("单元格")])]),t._v(" "),s("tr",[s("td",[t._v("ACC_ENUM")]),t._v(" "),s("td",[t._v("0x4000")]),t._v(" "),s("td",[t._v("单元格")])])])]),t._v(" "),s("p",[t._v("name_index: 字段名称的CONSTANT_Utf8_info常量index\ndescriptor_index: 字段类型描述符的CONSTANT_Utf8_info常量index\nattributes_count: 字段的属性数量\nattributes: 字段的属性，结构为attribute_info，比如ConstantValue，描述常量字段的常量值，属性的结构稍后介绍。")]),t._v(" "),s("h3",{attrs:{id:"methods"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#methods"}},[t._v("#")]),t._v(" Methods")]),t._v(" "),s("p",[t._v("类中所有的方法包括构造函数("),s("code",[t._v("<init>")]),t._v(")、静态初始化方法("),s("code",[t._v("<clinit>")]),t._v(")，都使用method_info结构，在一个类中，方法名称和方法签名联合起来必须唯一")]),t._v(" "),s("div",{staticClass:"language-text line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("method_info {\n    u2             access_flags;\n    u2             name_index;\n    u2             descriptor_index;\n    u2             attributes_count;\n    attribute_info attributes[attributes_count];\n}\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br")])]),s("p",[t._v("access_flags: 方法的标识数据，包括public, private, synchronized等等信息")]),t._v(" "),s("table",[s("thead",[s("tr",[s("th",[t._v("Flag Name")]),t._v(" "),s("th",[t._v("Value")]),t._v(" "),s("th",[t._v("描述")])])]),t._v(" "),s("tbody",[s("tr",[s("td",[t._v("ACC_PUBLIC")]),t._v(" "),s("td",[t._v("0x0001")]),t._v(" "),s("td",[t._v("public方法")])]),t._v(" "),s("tr",[s("td",[t._v("ACC_PRIVATE")]),t._v(" "),s("td",[t._v("0x0002")]),t._v(" "),s("td",[t._v("private方法")])]),t._v(" "),s("tr",[s("td",[t._v("ACC_PROTECTED")]),t._v(" "),s("td",[t._v("0x0004")]),t._v(" "),s("td",[t._v("protected方法")])]),t._v(" "),s("tr",[s("td",[t._v("ACC_STATIC")]),t._v(" "),s("td",[t._v("0x0008")]),t._v(" "),s("td",[t._v("static方法")])]),t._v(" "),s("tr",[s("td",[t._v("ACC_FINAL")]),t._v(" "),s("td",[t._v("0x0010")]),t._v(" "),s("td",[t._v("final方法")])]),t._v(" "),s("tr",[s("td",[t._v("ACC_SYNCHRONIZED")]),t._v(" "),s("td",[t._v("0x0020")]),t._v(" "),s("td",[t._v("synchronized方法（方法维度的synchronized声明，不同于synchronized代码块的monitor_enter和monitor_exit)")])]),t._v(" "),s("tr",[s("td",[t._v("ACC_BRIDGE")]),t._v(" "),s("td",[t._v("0x0040")]),t._v(" "),s("td",[t._v("是否是transient字段")])]),t._v(" "),s("tr",[s("td",[t._v("ACC_VARARGS")]),t._v(" "),s("td",[t._v("0x0080")]),t._v(" "),s("td",[t._v("有可变参数的方法")])]),t._v(" "),s("tr",[s("td",[t._v("ACC_NATIVE")]),t._v(" "),s("td",[t._v("0x0100")]),t._v(" "),s("td",[t._v("native方法")])]),t._v(" "),s("tr",[s("td",[t._v("ACC_ABSTRACT")]),t._v(" "),s("td",[t._v("0x0400")]),t._v(" "),s("td",[t._v("抽象方法")])]),t._v(" "),s("tr",[s("td",[t._v("ACC_STRICT")]),t._v(" "),s("td",[t._v("0x0800")]),t._v(" "),s("td",[t._v("浮点数模式是FT-strict的，这个很少见")])]),t._v(" "),s("tr",[s("td",[t._v("ACC_SYNTHETIC")]),t._v(" "),s("td",[t._v("0x1000")]),t._v(" "),s("td",[t._v("是否是合成方法，即不再源代码中的方法")])])])]),t._v(" "),s("p",[t._v("name_index: 指向方法名的CONSTANT_Utf8_info常量\ndescriptor_index: 指向方法描述符的CONSTANT_Utf8_info常量\nattributes_count: 方法的属性数量\nattributes[]: 方法的各个属性，其中比较关键的是名字为Code的属性，包含的是方法体的字节码指令。")]),t._v(" "),s("h3",{attrs:{id:"attributes属性"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#attributes属性"}},[t._v("#")]),t._v(" Attributes属性")]),t._v(" "),s("p",[t._v("Attributes属性在classfile, field_info, method_info中都有使用，结构如下")]),t._v(" "),s("div",{staticClass:"language-text line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("attribute_info {\n    u2 attribute_name_index;\n    u4 attribute_length;\n    u1 info[attribute_length];\n}\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br")])]),s("p",[t._v("attribute_name_index: 指向属性的名称的CONSTANT_Utf8_info常量\nattribute_length: 属性信息的字节长度，即info的长度\ninfo[]: 属性的具体信息，每种属性有自己的结构")]),t._v(" "),s("p",[t._v("属性有ConstantValue,Code,StackMapTable,Exceptions,BootstrapMethods等等很多种属性，我们这里重点介绍一下ConstantValue和Code。")]),t._v(" "),s("h4",{attrs:{id:"constantvalue属性"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#constantvalue属性"}},[t._v("#")]),t._v(" ConstantValue属性")]),t._v(" "),s("p",[t._v("常量值属性用来表示常量字段的常量值，数值（int,long,float等）和字符串字段能够声明成常量。")]),t._v(" "),s("div",{staticClass:"language-text line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("ConstantValue_attribute {\n    u2 attribute_name_index;\n    u4 attribute_length;\n    u2 constantvalue_index;\n}\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br")])]),s("p",[t._v('attribute_name_index: 指向"ConstantValue"的CONSTANT_Utf8_info\nattribute_length: 2，因为constantvalue_index是两个byte长度的index\nconstantvalue_index: 指向具体的常量池中的常量，按照类型不同分为CONSTANT_Long,CONSTANT_Float,CONSTANT_Double,CONSTANT_Integer(int, short, char, byte, boolean都用CONSTANT_Integer),CONSTANT_String,')]),t._v(" "),s("h4",{attrs:{id:"code属性"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#code属性"}},[t._v("#")]),t._v(" Code属性")]),t._v(" "),s("p",[t._v("Code属性用来表示方法体中的代码字节码。")]),t._v(" "),s("div",{staticClass:"language-text line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("Code_attribute {\n    u2 attribute_name_index;\n    u4 attribute_length;\n    u2 max_stack;\n    u2 max_locals;\n    u4 code_length;\n    u1 code[code_length];\n    u2 exception_table_length;\n    {   u2 start_pc;\n        u2 end_pc;\n        u2 handler_pc;\n        u2 catch_type;\n    } exception_table[exception_table_length];\n    u2 attributes_count;\n    attribute_info attributes[attributes_count];\n}\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br"),s("span",{staticClass:"line-number"},[t._v("10")]),s("br"),s("span",{staticClass:"line-number"},[t._v("11")]),s("br"),s("span",{staticClass:"line-number"},[t._v("12")]),s("br"),s("span",{staticClass:"line-number"},[t._v("13")]),s("br"),s("span",{staticClass:"line-number"},[t._v("14")]),s("br"),s("span",{staticClass:"line-number"},[t._v("15")]),s("br"),s("span",{staticClass:"line-number"},[t._v("16")]),s("br")])]),s("p",[t._v('attribute_name_index: 指向"Code"的CONSTANT_Utf8_info常量\nattribute_length: 后面所有的字段信息的字节数\nmax_stack: 方法的字节码指令执行过程中需要的操作数栈的最大栈层数，关于方法字节码指令的执行，在字节码指令文章中进行介绍。\nmax_locals: 方法的字节码指令执行过程中需要的本地变量表的最大长度（注意局部变量表的元素长度是4字节，long和double变量在局部变量表中占两个位置）\ncode_length: 方法体的字节码的长度\ncode[]: 方法体的字节码\nexception_table_length: 异常表的长度\nexception_table[]: 异常表数组，每个异常表包含start_pc,end_pc,handler_pc,catch_type。pc是指code[]数组中的索引，也就是从code[]字节码数组start_pc(包含)到end_pc(不包含)中的字节码执行时出现catch_type(指向异常类的CONSTANT_Class_info常量)异常，则转到code[]的handler_pc位置来处理异常。\nattributes_count: Code属性的数量\nattributes[]: Code属性数组，比如LineNumberTable，LocalVariableTable, LocalVariableTypeTable, StackMapTable')]),t._v(" "),s("p",[t._v("其他的属性可以参考"),s("a",{attrs:{href:"https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-4.html#jvms-4.7",target:"_blank",rel:"noopener noreferrer"}},[t._v("jvm规范"),s("OutboundLink")],1)]),t._v(" "),s("h2",{attrs:{id:"如何解析class文件"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#如何解析class文件"}},[t._v("#")]),t._v(" 如何解析class文件")]),t._v(" "),s("p",[t._v("假如我们现在有一个class文件，想去查看其中的Java源代码，该如何实现呢？有如下几种方法。")]),t._v(" "),s("h3",{attrs:{id:"通过javap"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#通过javap"}},[t._v("#")]),t._v(" 通过javap")]),t._v(" "),s("p",[t._v("javap是jdk里自带的反编译工具，可以打印出更加可读的class字节码信息。")]),t._v(" "),s("div",{staticClass:"language-shell line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[t._v("javap -c -cp /Users/liuzhengyang/Code/work/code-test/target/classes/ test.Test\n\nCompiled from "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Test.java"')]),t._v("\npublic class test.Test "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  public test.Test"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    Code:\n       "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(": aload_0\n       "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(": invokespecial "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v('#1                  // Method java/lang/Object."<init>":()V')]),t._v("\n       "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("4")]),t._v(": "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("return")]),t._v("\n\n  public java.lang.String hello"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    Code:\n       "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(": ldc           "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#2                  // String hello world")]),t._v("\n       "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v(": areturn\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br"),s("span",{staticClass:"line-number"},[t._v("10")]),s("br"),s("span",{staticClass:"line-number"},[t._v("11")]),s("br"),s("span",{staticClass:"line-number"},[t._v("12")]),s("br"),s("span",{staticClass:"line-number"},[t._v("13")]),s("br"),s("span",{staticClass:"line-number"},[t._v("14")]),s("br"),s("span",{staticClass:"line-number"},[t._v("15")]),s("br")])]),s("p",[t._v("javap参数说明")]),t._v(" "),s("table",[s("thead",[s("tr",[s("th",[t._v("参数")]),t._v(" "),s("th",[t._v("说明")])])]),t._v(" "),s("tbody",[s("tr",[s("td",[t._v("-cp")]),t._v(" "),s("td",[t._v("指定classpath, javap需要到classpath中寻找class文件")])]),t._v(" "),s("tr",[s("td",[t._v("-p")]),t._v(" "),s("td",[t._v("默认情况下javap不打印出private的方法、字段，通过-p可以打印全部信息")])]),t._v(" "),s("tr",[s("td",[t._v("-c")]),t._v(" "),s("td",[t._v("默认情况下javap不打印出方法的body字节码，通过-c可以打印")])]),t._v(" "),s("tr",[s("td",[t._v("-v")]),t._v(" "),s("td",[t._v("打印最全的信息，包括常量池、方法stack size、方法本地变量表等等")])])])]),t._v(" "),s("h3",{attrs:{id:"通过idea反编译"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#通过idea反编译"}},[t._v("#")]),t._v(" 通过IDEA反编译")]),t._v(" "),s("p",[t._v("把class文件拖动到IDEA中即可查看到反编译的java代码结果，相比javap更加易读。")]),t._v(" "),s("h3",{attrs:{id:"通过arthas-jad命令"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#通过arthas-jad命令"}},[t._v("#")]),t._v(" 通过arthas jad命令")]),t._v(" "),s("p",[t._v("如果要查看运行中的程序中使用到的代码，可以使用arthas的"),s("a",{attrs:{href:"https://arthas.aliyun.com/doc/jad.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("jad"),s("OutboundLink")],1),t._v("命令。")]),t._v(" "),s("h2",{attrs:{id:"更多资料"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#更多资料"}},[t._v("#")]),t._v(" 更多资料")]),t._v(" "),s("p",[t._v("更详细的资料包括java语言规范、java虚拟机规范可以在"),s("a",{attrs:{href:"https://docs.oracle.com/javase/specs/index.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("Java Language and Virtual Machine Specifications"),s("OutboundLink")],1),t._v("中找到")]),t._v(" "),s("h2",{attrs:{id:"总结"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#总结"}},[t._v("#")]),t._v(" 总结")]),t._v(" "),s("p",[t._v("本篇文章介绍了class文件的结构，包括常量池、字段、方法、属性等，详细了解了每个数据的结构，最后了解查看class文件的几种方式。")])])}),[],!1,null,null,null);a.default=e.exports}}]);