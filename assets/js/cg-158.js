(window.webpackJsonp=window.webpackJsonp||[]).push([[158],{589:function(s,a,e){"use strict";e.r(a);var n=e(34),l=Object(n.a)({},(function(){var s=this,a=s.$createElement,e=s._self._c||a;return e("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[e("h1",{attrs:{id:"classloader"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#classloader"}},[s._v("#")]),s._v(" classloader")]),s._v(" "),e("h2",{attrs:{id:"parallel-capable"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#parallel-capable"}},[s._v("#")]),s._v(" parallel capable")]),s._v(" "),e("p",[s._v("parallel capable是指classloader能够并行加载不同的class。")]),s._v(" "),e("p",[s._v("classloader需要在自己的static代码块中调用"),e("code",[s._v("java.lang.ClassLoader.registerAsParallelCapable()")]),s._v("来使得自己\n具备parallel功能，但是一个前提是自己的所有的super class（继承体系）全部都已经registerAsParallelCapable")]),s._v(" "),e("p",[s._v("比如URLClassLoader中")]),s._v(" "),e("div",{staticClass:"language-text line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("public class URLClassLoader extends SecureClassLoader implements Closeable {\n    static {\n        SharedSecrets.setJavaNetURLClassLoaderAccess(\n            new JavaNetURLClassLoaderAccess() {\n                @Override\n                public AccessControlContext getAccessControlContext(URLClassLoader u) {\n                    return u.acc;\n                }\n            }\n        );\n        ClassLoader.registerAsParallelCapable();\n    }\n} \n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br")])]),e("p",[s._v("而URLClassLoader的父类SecureClassLoader也调用了registerAsParallelCapable.\nregister在ClassLoader实现。会判断super class已经register，")]),s._v(" "),e("div",{staticClass:"language-text line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("static boolean register(Class&lt;? extends ClassLoader> c) {\n    synchronized (loaderTypes) {\n        if (loaderTypes.contains(c.getSuperclass())) {\n            // register the class loader as parallel capable\n            // if and only if all of its super classes are.\n            // Note: given current classloading sequence, if\n            // the immediate super class is parallel capable,\n            // all the super classes higher up must be too.\n            loaderTypes.add(c);\n            return true;\n        } else {\n            return false;\n        }\n    }\n}\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br")])]),e("p",[s._v("如果没有parallel capable，则class load时会使用当前ClassLoader对象作为锁进行synchronized，所以类加载是串行的。\n如果是parallel capable，则class load会使用每个className对应一个Object对象作为锁进行加锁。")]),s._v(" "),e("div",{staticClass:"language-text line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("protected Class&lt;?> loadClass(String name, boolean resolve)\n        throws ClassNotFoundException\n    {\n        synchronized (getClassLoadingLock(name)) {\n            // First, check if the class has already been loaded\n            Class&lt;?> c = findLoadedClass(name);\n            if (c == null) {\n                long t0 = System.nanoTime();\n     \n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br")])]),e("div",{staticClass:"language-text line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("protected Object getClassLoadingLock(String className) {\n    Object lock = this;\n    if (parallelLockMap != null) {\n        Object newLock = new Object();\n        lock = parallelLockMap.putIfAbsent(className, newLock);\n        if (lock == null) {\n            lock = newLock;\n        }\n    }\n    return lock;\n}\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br")])])])}),[],!1,null,null,null);a.default=l.exports}}]);