(window.webpackJsonp=window.webpackJsonp||[]).push([[292],{722:function(a,s,t){"use strict";t.r(s);var e=t(34),n=Object(e.a)({},(function(){var a=this,s=a.$createElement,t=a._self._c||s;return t("ContentSlotsDistributor",{attrs:{"slot-key":a.$parent.slotKey}},[t("h1",{attrs:{id:"netty-buffer"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#netty-buffer"}},[a._v("#")]),a._v(" netty-buffer")]),a._v(" "),t("h2",{attrs:{id:"核心概念"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#核心概念"}},[a._v("#")]),a._v(" 核心概念")]),a._v(" "),t("ul",[t("li",[a._v("ByteBuf: netty中的"),t("code",[a._v("ByteBuffer")]),a._v("、"),t("code",[a._v("byte[]")]),a._v("的封装")]),a._v(" "),t("li",[a._v("ByteBufAllocator: 负责申请、回收ByteBuf的Allocator")]),a._v(" "),t("li",[a._v("PoolChunk")]),a._v(" "),t("li",[a._v("PoolArena")]),a._v(" "),t("li",[a._v("PooledByteBuf")]),a._v(" "),t("li",[a._v("PooledUnsafeDirectByteBuf")]),a._v(" "),t("li",[a._v("PooledDirectByteBuf")]),a._v(" "),t("li",[a._v("PoolSubpage")]),a._v(" "),t("li",[a._v("PoolThreadCache")]),a._v(" "),t("li",[a._v("LeakAware: 内存泄露的追踪检查，即allocate后没有release")]),a._v(" "),t("li",[a._v("ReferenceCounted: 引用计算判断ByteBuf是否有引用，对于bytebuf来说不存在互相引用问题，也就没有gc里的循环依赖问题，不需要使用tracing。")])]),a._v(" "),t("h2",{attrs:{id:"netty-byte-buf的使用"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#netty-byte-buf的使用"}},[a._v("#")]),a._v(" netty byte buf的使用")]),a._v(" "),t("p",[a._v("读写数据")]),a._v(" "),t("p",[a._v("写")]),a._v(" "),t("p",[a._v("writeAndFlush")]),a._v(" "),t("p",[a._v("AbstractChannel.writeAndFlush方法")]),a._v(" "),t("p",[a._v("最终调用AbstractChannelHandlerContext.write，会调用safeExecute向executor(EventExecutorGroup)中提交WriteAndFlushTask任务。")]),a._v(" "),t("p",[a._v("netty中线程和channel的关系是什么样的？每个channel创建的时候，会绑定到EventLoopGroup中的一个EventLoop上（一个线程），后续都是由这一个线程\n负责该连接的读写。")]),a._v(" "),t("p",[a._v("WriteTask的run实现。")]),a._v(" "),t("p",[a._v("最后MessageToByteEncoder中会把"),t("code",[a._v("Object msg")]),a._v("转换成ByteBuf，这里会从netty的allocator中申请ByteBuf。")]),a._v(" "),t("div",{staticClass:"language-java line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-java"}},[t("code",[a._v("\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br")])]),t("div",{staticClass:"language-java line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-java"}},[t("code",[a._v("\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br")])]),t("h2",{attrs:{id:"abstractbytebufallocator"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#abstractbytebufallocator"}},[a._v("#")]),a._v(" AbstractByteBufAllocator")]),a._v(" "),t("h3",{attrs:{id:"calculatenewcapacity"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#calculatenewcapacity"}},[a._v("#")]),a._v(" calculateNewCapacity")]),a._v(" "),t("h2",{attrs:{id:"pooledbytebufallocator"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#pooledbytebufallocator"}},[a._v("#")]),a._v(" PooledByteBufAllocator")]),a._v(" "),t("h3",{attrs:{id:"poolarena"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#poolarena"}},[a._v("#")]),a._v(" PoolArena")]),a._v(" "),t("p",[a._v("内存划分成不同的区域，减少线程间冲突。\n每个PoolArena又包含了tinySubpagePools和smallSubpagePools，这两个都是PoolSubpage数组，还有6个PoolChunkList。")]),a._v(" "),t("div",{staticClass:"language-java line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-java"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("class")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("PoolArena")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("private")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("final")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("PoolSubpage")]),t("span",{pre:!0,attrs:{class:"token generics"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("<")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("T")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(">")])]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),a._v(" tinySubpagePools"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("private")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("final")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("PoolSubpage")]),t("span",{pre:!0,attrs:{class:"token generics"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("<")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("T")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(">")])]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),a._v(" smallSubpagePools"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("private")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("final")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("PoolChunkList")]),t("span",{pre:!0,attrs:{class:"token generics"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("<")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("T")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(">")])]),a._v(" q050"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("private")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("final")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("PoolChunkList")]),t("span",{pre:!0,attrs:{class:"token generics"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("<")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("T")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(">")])]),a._v(" q025"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("private")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("final")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("PoolChunkList")]),t("span",{pre:!0,attrs:{class:"token generics"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("<")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("T")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(">")])]),a._v(" q000"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("private")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("final")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("PoolChunkList")]),t("span",{pre:!0,attrs:{class:"token generics"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("<")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("T")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(">")])]),a._v(" qInit"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("private")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("final")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("PoolChunkList")]),t("span",{pre:!0,attrs:{class:"token generics"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("<")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("T")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(">")])]),a._v(" q075"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("private")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("final")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("PoolChunkList")]),t("span",{pre:!0,attrs:{class:"token generics"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("<")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("T")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(">")])]),a._v(" q100"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br"),t("span",{staticClass:"line-number"},[a._v("2")]),t("br"),t("span",{staticClass:"line-number"},[a._v("3")]),t("br"),t("span",{staticClass:"line-number"},[a._v("4")]),t("br"),t("span",{staticClass:"line-number"},[a._v("5")]),t("br"),t("span",{staticClass:"line-number"},[a._v("6")]),t("br"),t("span",{staticClass:"line-number"},[a._v("7")]),t("br"),t("span",{staticClass:"line-number"},[a._v("8")]),t("br"),t("span",{staticClass:"line-number"},[a._v("9")]),t("br"),t("span",{staticClass:"line-number"},[a._v("10")]),t("br"),t("span",{staticClass:"line-number"},[a._v("11")]),t("br"),t("span",{staticClass:"line-number"},[a._v("12")]),t("br")])]),t("h3",{attrs:{id:"poolchunklist"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#poolchunklist"}},[a._v("#")]),a._v(" PoolChunkList")]),a._v(" "),t("p",[a._v("PoolChunkList是PoolChunk的链表。\nq050,q025,q000,qInit,q075,q100表示了不同使用率的PoolChunk，当链表中的某个PoolChunk的使用率不满足当前使用率范围时，则会移动到前后的PoolChunkList中。")]),a._v(" "),t("p",[a._v("qInit: [0, 25%)\nq000:  [1, 50%)\nq025:  [25%, 75%)\nq050:  [50%, 100%)\nq075:  [75%, 100%)\nq100:  [100%, 100%]")]),a._v(" "),t("div",{staticClass:"language-java line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-java"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("final")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("class")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("PoolChunkList")]),t("span",{pre:!0,attrs:{class:"token generics"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("<")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("T")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(">")])]),a._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("implements")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("PoolChunkListMetric")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("private")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("static")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("final")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("Iterator")]),t("span",{pre:!0,attrs:{class:"token generics"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("<")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("PoolChunkMetric")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(">")])]),a._v(" EMPTY_METRICS "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("Collections")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),t("span",{pre:!0,attrs:{class:"token generics"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("<")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("PoolChunkMetric")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(">")])]),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("emptyList")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("iterator")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("private")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("final")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("PoolArena")]),t("span",{pre:!0,attrs:{class:"token generics"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("<")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("T")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(">")])]),a._v(" arena"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("private")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("final")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("PoolChunkList")]),t("span",{pre:!0,attrs:{class:"token generics"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("<")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("T")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(">")])]),a._v(" nextList"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("private")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("final")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("int")]),a._v(" minUsage"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("private")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("final")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("int")]),a._v(" maxUsage"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("private")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("final")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("int")]),a._v(" maxCapacity"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("private")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("PoolChunk")]),t("span",{pre:!0,attrs:{class:"token generics"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("<")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("T")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(">")])]),a._v(" head"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("// This is only update once when create the linked like list of PoolChunkList in PoolArena constructor.")]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("private")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("PoolChunkList")]),t("span",{pre:!0,attrs:{class:"token generics"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("<")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("T")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(">")])]),a._v(" prevList"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("// TODO: Test if adding padding helps under contention")]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("//private long pad0, pad1, pad2, pad3, pad4, pad5, pad6, pad7;")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br"),t("span",{staticClass:"line-number"},[a._v("2")]),t("br"),t("span",{staticClass:"line-number"},[a._v("3")]),t("br"),t("span",{staticClass:"line-number"},[a._v("4")]),t("br"),t("span",{staticClass:"line-number"},[a._v("5")]),t("br"),t("span",{staticClass:"line-number"},[a._v("6")]),t("br"),t("span",{staticClass:"line-number"},[a._v("7")]),t("br"),t("span",{staticClass:"line-number"},[a._v("8")]),t("br"),t("span",{staticClass:"line-number"},[a._v("9")]),t("br"),t("span",{staticClass:"line-number"},[a._v("10")]),t("br"),t("span",{staticClass:"line-number"},[a._v("11")]),t("br"),t("span",{staticClass:"line-number"},[a._v("12")]),t("br"),t("span",{staticClass:"line-number"},[a._v("13")]),t("br"),t("span",{staticClass:"line-number"},[a._v("14")]),t("br"),t("span",{staticClass:"line-number"},[a._v("15")]),t("br")])]),t("h3",{attrs:{id:"poolchunk"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#poolchunk"}},[a._v("#")]),a._v(" PoolChunk")]),a._v(" "),t("h3",{attrs:{id:"poolsubpage"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#poolsubpage"}},[a._v("#")]),a._v(" PoolSubpage")]),a._v(" "),t("h3",{attrs:{id:"poolthreadcache"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#poolthreadcache"}},[a._v("#")]),a._v(" PoolThreadCache")]),a._v(" "),t("p",[a._v("线程本地缓存，减少冲突，提高分配效率。")]),a._v(" "),t("h3",{attrs:{id:"memoryregioncache"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#memoryregioncache"}},[a._v("#")]),a._v(" MemoryRegionCache")]),a._v(" "),t("div",{staticClass:"language-java line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-java"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("private")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("abstract")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("static")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("class")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("MemoryRegionCache")]),t("span",{pre:!0,attrs:{class:"token generics"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("<")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("T")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(">")])]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("private")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("final")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("int")]),a._v(" size"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("private")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("final")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("Queue")]),t("span",{pre:!0,attrs:{class:"token generics"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("<")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("Entry")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("<")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("T")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(">")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(">")])]),a._v(" queue"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("private")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("final")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("SizeClass")]),a._v(" sizeClass"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("private")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("int")]),a._v(" allocations"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br"),t("span",{staticClass:"line-number"},[a._v("2")]),t("br"),t("span",{staticClass:"line-number"},[a._v("3")]),t("br"),t("span",{staticClass:"line-number"},[a._v("4")]),t("br"),t("span",{staticClass:"line-number"},[a._v("5")]),t("br"),t("span",{staticClass:"line-number"},[a._v("6")]),t("br")])]),t("h3",{attrs:{id:"不同大小内存的分配策略"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#不同大小内存的分配策略"}},[a._v("#")]),a._v(" 不同大小内存的分配策略")]),a._v(" "),t("h4",{attrs:{id:"tiny-small"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#tiny-small"}},[a._v("#")]),a._v(" tiny, small")]),a._v(" "),t("p",[a._v("pageSize是8K。\n当申请的大小小于8K时，会使用PoolSubpage。\n如果申请的大小小于512B，则认为是tiny。\n否则大于等于512B小于8K，则认为是small。\ntiny和small，都会先到PoolThreadCache中尝试申请（PoolThreadCache中的tinySubPageDirectCache和smallSubPageDirectCaches)。")]),a._v(" "),t("h4",{attrs:{id:"normal"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#normal"}},[a._v("#")]),a._v(" normal")]),a._v(" "),t("p",[a._v("大于等于8K，小于等于chunkSize(默认16M)的是normal。")]),a._v(" "),t("h4",{attrs:{id:"huge"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#huge"}},[a._v("#")]),a._v(" huge")]),a._v(" "),t("p",[a._v("如果申请的内存大小大于chunk size，则认为是huge巨型内存申请。\n会直接创建一个PoolChunk，创建ByteBuffer，不会放到Arena中管理，使用Java的回收机制释放ByteBuffer对应的直接内存。")]),a._v(" "),t("h3",{attrs:{id:"关键概念"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#关键概念"}},[a._v("#")]),a._v(" 关键概念")]),a._v(" "),t("p",[a._v("Chunk、ChunkSize\nArena\nPoolThreadLocalCache\ncache size")]),a._v(" "),t("h3",{attrs:{id:"关键静态属性"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#关键静态属性"}},[a._v("#")]),a._v(" 关键静态属性")]),a._v(" "),t("ul",[t("li",[a._v("DEFAULT_PAGE_SIZE, 默认页大小，默认为8192即8k，通过"),t("code",[a._v("io.netty.allocator.pageSize")]),a._v("属性配置，比如"),t("code",[a._v("java -Dio.netty.allocator.pageSize=4096")])]),a._v(" "),t("li",[a._v("DEFAULT_MAX_ORDER，计算chunk size时，会把页大小左移DEFAULT_MAX_ORDER位作为chunk size，默认11，即默认8k * 2048 = 16M")])]),a._v(" "),t("h3",{attrs:{id:"validateandcalculatechunksize"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#validateandcalculatechunksize"}},[a._v("#")]),a._v(" validateAndCalculateChunkSize")]),a._v(" "),t("h3",{attrs:{id:"poolthreadlocalcache"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#poolthreadlocalcache"}},[a._v("#")]),a._v(" PoolThreadLocalCache")]),a._v(" "),t("h3",{attrs:{id:"netty使用的直接内存什么时候回收释放"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#netty使用的直接内存什么时候回收释放"}},[a._v("#")]),a._v(" netty使用的直接内存什么时候回收释放？")]),a._v(" "),t("h2",{attrs:{id:"netty-监控统计"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#netty-监控统计"}},[a._v("#")]),a._v(" netty 监控统计")]),a._v(" "),t("p",[a._v("如何查看netty占用了多少direct memory内存？\n通过arthas获取")]),a._v(" "),t("h2",{attrs:{id:"参考"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#参考"}},[a._v("#")]),a._v(" 参考")]),a._v(" "),t("ul",[t("li",[t("a",{attrs:{href:"https://learn.lianglianglee.com/%E4%B8%93%E6%A0%8F/Netty%20%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8E%20RPC%20%E5%AE%9E%E8%B7%B5-%E5%AE%8C/12%20%20%E4%BB%96%E5%B1%B1%E4%B9%8B%E7%9F%B3%EF%BC%9A%E9%AB%98%E6%80%A7%E8%83%BD%E5%86%85%E5%AD%98%E5%88%86%E9%85%8D%E5%99%A8%20jemalloc%20%E5%9F%BA%E6%9C%AC%E5%8E%9F%E7%90%86.md",target:"_blank",rel:"noopener noreferrer"}},[a._v("他山之石：高性能内存分配器 jemalloc 基本原理"),t("OutboundLink")],1)])])])}),[],!1,null,null,null);s.default=n.exports}}]);