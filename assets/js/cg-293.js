(window.webpackJsonp=window.webpackJsonp||[]).push([[293],{724:function(e,s,n){"use strict";n.r(s);var a=n(34),t=Object(a.a)({},(function(){var e=this,s=e.$createElement,n=e._self._c||s;return n("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[n("h1",{attrs:{id:"netty-event-loop"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#netty-event-loop"}},[e._v("#")]),e._v(" netty event loop")]),e._v(" "),n("h2",{attrs:{id:"eventloop执行过程"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#eventloop执行过程"}},[e._v("#")]),e._v(" EventLoop执行过程")]),e._v(" "),n("h3",{attrs:{id:"nioeventloop"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#nioeventloop"}},[e._v("#")]),e._v(" NioEventLoop")]),e._v(" "),n("div",{staticClass:"language-text line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("    protected void run() {\n        for (;;) {\n            try {\n                try {\n                    switch (selectStrategy.calculateStrategy(selectNowSupplier, hasTasks())) {\n                    case SelectStrategy.CONTINUE:\n                        continue;\n\n                    case SelectStrategy.BUSY_WAIT:\n                        // fall-through to SELECT since the busy-wait is not supported with NIO\n\n                    case SelectStrategy.SELECT:\n                        select(wakenUp.getAndSet(false));\n\n")])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br"),n("span",{staticClass:"line-number"},[e._v("3")]),n("br"),n("span",{staticClass:"line-number"},[e._v("4")]),n("br"),n("span",{staticClass:"line-number"},[e._v("5")]),n("br"),n("span",{staticClass:"line-number"},[e._v("6")]),n("br"),n("span",{staticClass:"line-number"},[e._v("7")]),n("br"),n("span",{staticClass:"line-number"},[e._v("8")]),n("br"),n("span",{staticClass:"line-number"},[e._v("9")]),n("br"),n("span",{staticClass:"line-number"},[e._v("10")]),n("br"),n("span",{staticClass:"line-number"},[e._v("11")]),n("br"),n("span",{staticClass:"line-number"},[e._v("12")]),n("br"),n("span",{staticClass:"line-number"},[e._v("13")]),n("br"),n("span",{staticClass:"line-number"},[e._v("14")]),n("br")])]),n("p",[e._v("默认的calculateStrategy，判断是否有taskQueue里有task，如果有，调用"),n("code",[e._v("selectNow()")]),e._v("，\n"),n("code",[e._v("selectNow()")]),e._v("方法和"),n("code",[e._v("select()")]),e._v("方法不同之处在于selectNow不会阻塞，如果没有可select的会职级返回。\n如果没有task，则返回SelectStrategy.SELECT。")]),e._v(" "),n("div",{staticClass:"language-text line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("final class DefaultSelectStrategy implements SelectStrategy {\n    static final SelectStrategy INSTANCE = new DefaultSelectStrategy();\n\n    private DefaultSelectStrategy() { }\n\n    @Override\n    public int calculateStrategy(IntSupplier selectSupplier, boolean hasTasks) throws Exception {\n        return hasTasks ? selectSupplier.get() : SelectStrategy.SELECT;\n    }\n}\n")])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br"),n("span",{staticClass:"line-number"},[e._v("3")]),n("br"),n("span",{staticClass:"line-number"},[e._v("4")]),n("br"),n("span",{staticClass:"line-number"},[e._v("5")]),n("br"),n("span",{staticClass:"line-number"},[e._v("6")]),n("br"),n("span",{staticClass:"line-number"},[e._v("7")]),n("br"),n("span",{staticClass:"line-number"},[e._v("8")]),n("br"),n("span",{staticClass:"line-number"},[e._v("9")]),n("br"),n("span",{staticClass:"line-number"},[e._v("10")]),n("br")])]),n("p",[e._v("ioRatio用于控制EventLoop处理io事件的比例，默认是50%。\n首先记录ioStartTime，再调用processSelectKeys处理selected出来的SelectionKey。\n处理完计算ioTime，然后再相对ioTime一定比例的时间去处理taskQueue里的任务。")]),e._v(" "),n("div",{staticClass:"language-text line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("final int ioRatio = this.ioRatio;\nif (ioRatio == 100) {\n    try {\n        processSelectedKeys();\n    } finally {\n        // Ensure we always run tasks.\n        runAllTasks();\n    }\n} else {\n    final long ioStartTime = System.nanoTime();\n    try {\n        processSelectedKeys();\n    } finally {\n        // Ensure we always run tasks.\n        final long ioTime = System.nanoTime() - ioStartTime;\n        runAllTasks(ioTime * (100 - ioRatio) / ioRatio);\n    }\n}\n")])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br"),n("span",{staticClass:"line-number"},[e._v("3")]),n("br"),n("span",{staticClass:"line-number"},[e._v("4")]),n("br"),n("span",{staticClass:"line-number"},[e._v("5")]),n("br"),n("span",{staticClass:"line-number"},[e._v("6")]),n("br"),n("span",{staticClass:"line-number"},[e._v("7")]),n("br"),n("span",{staticClass:"line-number"},[e._v("8")]),n("br"),n("span",{staticClass:"line-number"},[e._v("9")]),n("br"),n("span",{staticClass:"line-number"},[e._v("10")]),n("br"),n("span",{staticClass:"line-number"},[e._v("11")]),n("br"),n("span",{staticClass:"line-number"},[e._v("12")]),n("br"),n("span",{staticClass:"line-number"},[e._v("13")]),n("br"),n("span",{staticClass:"line-number"},[e._v("14")]),n("br"),n("span",{staticClass:"line-number"},[e._v("15")]),n("br"),n("span",{staticClass:"line-number"},[e._v("16")]),n("br"),n("span",{staticClass:"line-number"},[e._v("17")]),n("br"),n("span",{staticClass:"line-number"},[e._v("18")]),n("br")])]),n("p",[e._v("runAllTask先从scheduledTaskQueue里取到期的task放到taskQueue里。\n然后pollTask直到到达超时时间。")]),e._v(" "),n("div",{staticClass:"language-text line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("protected boolean runAllTasks(long timeoutNanos) {\n    fetchFromScheduledTaskQueue();\n    Runnable task = pollTask();\n    if (task == null) {\n        afterRunningAllTasks();\n        return false;\n    }\n\n    final long deadline = ScheduledFutureTask.nanoTime() + timeoutNanos;\n    long runTasks = 0;\n    long lastExecutionTime;\n    for (;;) {\n        safeExecute(task);\n\n        runTasks ++;\n\n        // Check timeout every 64 tasks because nanoTime() is relatively expensive.\n        // XXX: Hard-coded value - will make it configurable if it is really a problem.\n        if ((runTasks &amp; 0x3F) == 0) {\n            lastExecutionTime = ScheduledFutureTask.nanoTime();\n            if (lastExecutionTime >= deadline) {\n                break;\n            }\n        }\n\n        task = pollTask();\n        if (task == null) {\n            lastExecutionTime = ScheduledFutureTask.nanoTime();\n            break;\n        }\n    }\n\n    afterRunningAllTasks();\n    this.lastExecutionTime = lastExecutionTime;\n    return true;\n}\n")])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br"),n("span",{staticClass:"line-number"},[e._v("3")]),n("br"),n("span",{staticClass:"line-number"},[e._v("4")]),n("br"),n("span",{staticClass:"line-number"},[e._v("5")]),n("br"),n("span",{staticClass:"line-number"},[e._v("6")]),n("br"),n("span",{staticClass:"line-number"},[e._v("7")]),n("br"),n("span",{staticClass:"line-number"},[e._v("8")]),n("br"),n("span",{staticClass:"line-number"},[e._v("9")]),n("br"),n("span",{staticClass:"line-number"},[e._v("10")]),n("br"),n("span",{staticClass:"line-number"},[e._v("11")]),n("br"),n("span",{staticClass:"line-number"},[e._v("12")]),n("br"),n("span",{staticClass:"line-number"},[e._v("13")]),n("br"),n("span",{staticClass:"line-number"},[e._v("14")]),n("br"),n("span",{staticClass:"line-number"},[e._v("15")]),n("br"),n("span",{staticClass:"line-number"},[e._v("16")]),n("br"),n("span",{staticClass:"line-number"},[e._v("17")]),n("br"),n("span",{staticClass:"line-number"},[e._v("18")]),n("br"),n("span",{staticClass:"line-number"},[e._v("19")]),n("br"),n("span",{staticClass:"line-number"},[e._v("20")]),n("br"),n("span",{staticClass:"line-number"},[e._v("21")]),n("br"),n("span",{staticClass:"line-number"},[e._v("22")]),n("br"),n("span",{staticClass:"line-number"},[e._v("23")]),n("br"),n("span",{staticClass:"line-number"},[e._v("24")]),n("br"),n("span",{staticClass:"line-number"},[e._v("25")]),n("br"),n("span",{staticClass:"line-number"},[e._v("26")]),n("br"),n("span",{staticClass:"line-number"},[e._v("27")]),n("br"),n("span",{staticClass:"line-number"},[e._v("28")]),n("br"),n("span",{staticClass:"line-number"},[e._v("29")]),n("br"),n("span",{staticClass:"line-number"},[e._v("30")]),n("br"),n("span",{staticClass:"line-number"},[e._v("31")]),n("br"),n("span",{staticClass:"line-number"},[e._v("32")]),n("br"),n("span",{staticClass:"line-number"},[e._v("33")]),n("br"),n("span",{staticClass:"line-number"},[e._v("34")]),n("br"),n("span",{staticClass:"line-number"},[e._v("35")]),n("br"),n("span",{staticClass:"line-number"},[e._v("36")]),n("br")])]),n("h3",{attrs:{id:"select逻辑"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#select逻辑"}},[e._v("#")]),e._v(" select逻辑")]),e._v(" "),n("p",[e._v("select传入的等待时间，会通过scheduledTasksQueue中最近的任务距离当前时间来确定。\n如果timeoutMillis已经小于等于0，则调用一次selectNow就返回。")]),e._v(" "),n("div",{staticClass:"language-text line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("private void select(boolean oldWakenUp) throws IOException {\n    Selector selector = this.selector;\n    try {\n        int selectCnt = 0;\n        long currentTimeNanos = System.nanoTime();\n        long selectDeadLineNanos = currentTimeNanos + delayNanos(currentTimeNanos);\n\n        for (;;) {\n            long timeoutMillis = (selectDeadLineNanos - currentTimeNanos + 500000L) / 1000000L;\n            if (timeoutMillis &lt;= 0) {\n                if (selectCnt == 0) {\n                    selector.selectNow();\n                    selectCnt = 1;\n                }\n                break;\n            }\n")])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br"),n("span",{staticClass:"line-number"},[e._v("3")]),n("br"),n("span",{staticClass:"line-number"},[e._v("4")]),n("br"),n("span",{staticClass:"line-number"},[e._v("5")]),n("br"),n("span",{staticClass:"line-number"},[e._v("6")]),n("br"),n("span",{staticClass:"line-number"},[e._v("7")]),n("br"),n("span",{staticClass:"line-number"},[e._v("8")]),n("br"),n("span",{staticClass:"line-number"},[e._v("9")]),n("br"),n("span",{staticClass:"line-number"},[e._v("10")]),n("br"),n("span",{staticClass:"line-number"},[e._v("11")]),n("br"),n("span",{staticClass:"line-number"},[e._v("12")]),n("br"),n("span",{staticClass:"line-number"},[e._v("13")]),n("br"),n("span",{staticClass:"line-number"},[e._v("14")]),n("br"),n("span",{staticClass:"line-number"},[e._v("15")]),n("br"),n("span",{staticClass:"line-number"},[e._v("16")]),n("br")])]),n("p",[e._v("如果taskQueue有新任务提交，则将wakenUp通过cas设置为true，再调用selectNow返回。")]),e._v(" "),n("div",{staticClass:"language-text line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("    // If a task was submitted when wakenUp value was true, the task didn't get a chance to call\n    // Selector#wakeup. So we need to check task queue again before executing select operation.\n    // If we don't, the task might be pended until select operation was timed out.\n    // It might be pended until idle timeout if IdleStateHandler existed in pipeline.\n    if (hasTasks() &amp;&amp; wakenUp.compareAndSet(false, true)) {\n        selector.selectNow();\n        selectCnt = 1;\n        break;\n    }\n")])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br"),n("span",{staticClass:"line-number"},[e._v("3")]),n("br"),n("span",{staticClass:"line-number"},[e._v("4")]),n("br"),n("span",{staticClass:"line-number"},[e._v("5")]),n("br"),n("span",{staticClass:"line-number"},[e._v("6")]),n("br"),n("span",{staticClass:"line-number"},[e._v("7")]),n("br"),n("span",{staticClass:"line-number"},[e._v("8")]),n("br"),n("span",{staticClass:"line-number"},[e._v("9")]),n("br")])]),n("p",[e._v("scheduleTaskQueue和taskQueue都没有要执行的任务，则执行"),n("code",[e._v("selector.select(timeoutMillis)")]),e._v("。")]),e._v(" "),n("div",{staticClass:"language-text line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v(" int selectedKeys = selector.select(timeoutMillis);\n selectCnt ++;\n")])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br")])]),n("p",[e._v("selector.select调用完成后给selectCnt加一，如下几种情况都会退出当前select方法的for循环。")]),e._v(" "),n("ul",[n("li",[e._v("selectKeys不为0（说明有io事件)")]),e._v(" "),n("li",[e._v("或者oldWakenUp为true（外部调用select时wakenUp为true）")]),e._v(" "),n("li",[e._v("或者wakenUp为true")]),e._v(" "),n("li",[e._v("或者taskQueue里有任务")]),e._v(" "),n("li",[e._v("或者scheduledTask里有任务")])]),e._v(" "),n("div",{staticClass:"language-text line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v(" if (selectedKeys != 0 || oldWakenUp || wakenUp.get() || hasTasks() || hasScheduledTasks()) {\n    // - Selected something,\n    // - waken up by user, or\n    // - the task queue has a pending task.\n    // - a scheduled task is ready for processing\n    break;\n}\n")])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br"),n("span",{staticClass:"line-number"},[e._v("3")]),n("br"),n("span",{staticClass:"line-number"},[e._v("4")]),n("br"),n("span",{staticClass:"line-number"},[e._v("5")]),n("br"),n("span",{staticClass:"line-number"},[e._v("6")]),n("br"),n("span",{staticClass:"line-number"},[e._v("7")]),n("br")])]),n("p",[e._v("否则如果selectKeys为0，则计算当前时间距离上次select的时间是否大于timeoutMillis。\n如果不大于，说明可能出现了死循环bug，判断一下selectCnt是否大于SELECTOR_AUTO_REBUILD_THRESHOLD（默认512），如果大于，则重新创建selector。")]),e._v(" "),n("div",{staticClass:"language-text line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("long time = System.nanoTime();\nif (time - TimeUnit.MILLISECONDS.toNanos(timeoutMillis) >= currentTimeNanos) {\n    // timeoutMillis elapsed without anything selected.\n    selectCnt = 1;\n} else if (SELECTOR_AUTO_REBUILD_THRESHOLD > 0 &amp;&amp;\n        selectCnt >= SELECTOR_AUTO_REBUILD_THRESHOLD) {\n    // The code exists in an extra method to ensure the method is not too big to inline as this\n    // branch is not very likely to get hit very frequently.\n    selector = selectRebuildSelector(selectCnt);\n    selectCnt = 1;\n    break;\n}\n\ncurrentTimeNanos = time;\n")])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br"),n("span",{staticClass:"line-number"},[e._v("3")]),n("br"),n("span",{staticClass:"line-number"},[e._v("4")]),n("br"),n("span",{staticClass:"line-number"},[e._v("5")]),n("br"),n("span",{staticClass:"line-number"},[e._v("6")]),n("br"),n("span",{staticClass:"line-number"},[e._v("7")]),n("br"),n("span",{staticClass:"line-number"},[e._v("8")]),n("br"),n("span",{staticClass:"line-number"},[e._v("9")]),n("br"),n("span",{staticClass:"line-number"},[e._v("10")]),n("br"),n("span",{staticClass:"line-number"},[e._v("11")]),n("br"),n("span",{staticClass:"line-number"},[e._v("12")]),n("br"),n("span",{staticClass:"line-number"},[e._v("13")]),n("br"),n("span",{staticClass:"line-number"},[e._v("14")]),n("br")])])])}),[],!1,null,null,null);s.default=t.exports}}]);